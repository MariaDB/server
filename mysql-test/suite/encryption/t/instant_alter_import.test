--source include/have_innodb.inc
--source include/have_sequence.inc
--source include/have_file_key_management_plugin.inc

SET GLOBAL innodb_encrypt_tables = ON;
SET GLOBAL innodb_encryption_threads = 4;


--let $MYSQLD_DATADIR= `SELECT @@datadir`

CREATE TABLE t1 (id INT PRIMARY KEY AUTO_INCREMENT, i2 INT, i1 INT)
  ENGINE=INNODB ENCRYPTED=YES ENCRYPTION_KEY_ID=4;

INSERT INTO t1 (i2) SELECT 4 FROM seq_1_to_1024;
ALTER TABLE t1 DROP COLUMN i2, ALGORITHM=INSTANT;

CREATE TABLE t2 LIKE t1;
ALTER TABLE t2 DISCARD TABLESPACE;

FLUSH TABLE t1 FOR EXPORT;

--copy_file $MYSQLD_DATADIR/test/t1.ibd $MYSQLD_DATADIR/test/t2.ibd
--copy_file $MYSQLD_DATADIR/test/t1.cfg $MYSQLD_DATADIR/test/t2.cfg

UNLOCK TABLES;
ALTER TABLE t2 IMPORT TABLESPACE;

DROP TABLE t2, t1;


CREATE TABLE t1 (id INT PRIMARY KEY AUTO_INCREMENT, i2 INT, i1 INT)
  ENGINE=INNODB ENCRYPTED=YES ENCRYPTION_KEY_ID=4 PAGE_COMPRESSED=1;

INSERT INTO t1 (i2) SELECT 4 FROM seq_1_to_1024;
ALTER TABLE t1 DROP COLUMN i2, ALGORITHM=INSTANT;

CREATE TABLE t2 LIKE t1;
ALTER TABLE t2 DISCARD TABLESPACE;

FLUSH TABLE t1 FOR EXPORT;

--copy_file $MYSQLD_DATADIR/test/t1.ibd $MYSQLD_DATADIR/test/t2.ibd
--copy_file $MYSQLD_DATADIR/test/t1.cfg $MYSQLD_DATADIR/test/t2.cfg

UNLOCK TABLES;
ALTER TABLE t2 IMPORT TABLESPACE;

DROP TABLE t2, t1;


SET GLOBAL innodb_encrypt_tables = OFF;
SET GLOBAL innodb_encryption_threads = 0;
