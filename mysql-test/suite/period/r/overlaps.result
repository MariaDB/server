create or replace table t(id int, s date, e date,
period for p(s,e),
primary key(id, p without overlaps));
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `s` date NOT NULL,
  `e` date NOT NULL,
  PERIOD FOR `p` (`s`, `e`),
  PRIMARY KEY (`id`,`p` WITHOUT OVERLAPS)
) ENGINE=MyISAM DEFAULT CHARSET=latin1
insert into t values (1, '2003-01-01', '2003-03-01'),
(1, '2003-05-01', '2003-07-01');
insert into t values (1, '2003-02-01', '2003-04-01');
ERROR 23000: Can't write; duplicate key in table 't'
insert into t values (1, '2003-04-01', '2003-06-01');
ERROR 23000: Can't write; duplicate key in table 't'
insert into t values (1, '2003-05-15', '2003-06-15');
ERROR 23000: Can't write; duplicate key in table 't'
insert into t values (1, '2003-04-01', '2003-08-01');
ERROR 23000: Can't write; duplicate key in table 't'
insert into t values (1, '2003-03-01', '2003-05-01');
# expand/shrink period
update t set s= '2002-12-01' where s = '2003-01-01';
update t set s= '2003-01-01' where s = '2002-12-01';
update t set e= '2003-08-01' where s = '2003-05-01';
update t set e= '2003-07-01' where s = '2003-05-01';
# move left/right
update t set s= '2002-12-15', e= '2003-01-15' where s = '2003-01-01';
update t set s= '2003-01-01', e= '2003-02-01' where s = '2002-12-15';
# diminish/enlarge
update t set s= '2003-01-10', e= '2003-01-20' where s = '2003-01-01';
update t set s= '2003-01-01', e= '2003-02-01' where s = '2003-01-10';
# intersect left/right, strict inclusion/containment
update t set e= '2003-04-01' where s = '2003-01-01';
ERROR 23000: Can't write; duplicate key in table 't'
update t set s= '2003-04-01' where s = '2003-05-01';
ERROR 23000: Can't write; duplicate key in table 't'
update t set s= '2003-03-10', e= '2003-03-20' where s = '2003-01-01';
ERROR 23000: Can't write; duplicate key in table 't'
update t set s= '2003-04-01', e= '2003-08-01' where s = '2003-03-01';
ERROR 23000: Can't write; duplicate key in table 't'
# inclusion/containment with partial match
update t set s= '2003-03-01', e= '2003-04-01' where s = '2003-01-01';
ERROR 23000: Can't write; duplicate key in table 't'
update t set s= '2003-04-01', e= '2003-05-01' where s = '2003-01-01';
ERROR 23000: Can't write; duplicate key in table 't'
update t set s= '2003-03-01' where s = '2003-05-01';
ERROR 23000: Can't write; duplicate key in table 't'
update t set e= '2003-05-01' where s = '2003-01-01';
ERROR 23000: Can't write; duplicate key in table 't'
select * from t where year(s) = 2003;
id	s	e
1	2003-01-01	2003-02-01
1	2003-03-01	2003-05-01
1	2003-05-01	2003-07-01
create or replace table t(id int, s date, e date,
period for p(s,e),
primary key(id, q without overlaps));
ERROR HY000: Period `q` is not found in table
create or replace table t(id int, s date, e date,
primary key(id, p without overlaps));
ERROR HY000: Period `p` is not found in table
create or replace table t(id int, s date, e date,
period for p(s,e),
primary key(id, s, p without overlaps));
ERROR HY000: Key `(null)` should not contain period fields in order to make it WITHOUT OVERLAPS
create or replace table t(id int, s date, e date,
period for p(s,e),
primary key(id));
insert into t values (1, '2003-03-01', '2003-05-01');
insert into t values (1, '2003-04-01', '2003-05-01');
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
create or replace table t(id int, u int, s date, e date,
period for p(s,e),
primary key(id, p without overlaps),
unique(u));
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `u` int(11) DEFAULT NULL,
  `s` date NOT NULL,
  `e` date NOT NULL,
  PERIOD FOR `p` (`s`, `e`),
  PRIMARY KEY (`id`,`p` WITHOUT OVERLAPS),
  UNIQUE KEY `u` (`u`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1
insert into t values (1, 1, '2003-03-01', '2003-05-01');
insert into t values (1, 2, '2003-05-01', '2003-07-01');
insert into t values (1, 3, '2003-04-01', '2003-05-01');
ERROR 23000: Can't write; duplicate key in table 't'
create or replace table t(id int, u int, s date, e date,
period for p(s,e),
primary key(id, p without overlaps),
unique(u, p without overlaps));
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `u` int(11) DEFAULT NULL,
  `s` date NOT NULL,
  `e` date NOT NULL,
  PERIOD FOR `p` (`s`, `e`),
  PRIMARY KEY (`id`,`p` WITHOUT OVERLAPS),
  UNIQUE KEY `u` (`u`,`p` WITHOUT OVERLAPS)
) ENGINE=MyISAM DEFAULT CHARSET=latin1
insert into t values (1, 1, '2003-03-01', '2003-05-01');
insert into t values (1, 2, '2003-05-01', '2003-07-01');
insert into t values (2, 1, '2003-05-01', '2003-07-01');
create or replace table t(id int, s date, e date,
period for p(s,e)) engine=innodb;
insert into t values (1, '2003-01-01', '2003-03-01'),
(1, '2003-05-01', '2003-07-01'),
(1, '2003-02-01', '2003-04-01');
alter table t add primary key(id, p without overlaps);
ERROR 23000: Can't write; duplicate key in table 't'
# Historical rows are not checked against constraints
set @@system_versioning_alter_history= keep;
alter table t add system versioning;
delete from t;
alter table t add primary key(id, p without overlaps);
insert into t values (1, '2003-01-01', '2003-03-01'),
(1, '2003-03-01', '2003-05-01');
# `without overlaps` is not lost on alter table
alter table t add y int;
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `s` date NOT NULL,
  `e` date NOT NULL,
  `y` int(11) DEFAULT NULL,
  PERIOD FOR `p` (`s`, `e`),
  PRIMARY KEY (`id`,`p` WITHOUT OVERLAPS)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
alter table t drop y;
create or replace table t1 like t;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `s` date NOT NULL,
  `e` date NOT NULL,
  PERIOD FOR `p` (`s`, `e`),
  PRIMARY KEY (`id`,`p` WITHOUT OVERLAPS)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
create or replace table t1 (x int, s date, e date,
period for p(s,e),
primary key(x, p without overlaps)
) partition by key (x);
ERROR HY000: Period WITHOUT OVERLAPS is not implemented for partitioned tables
create or replace table t1 (x int, s date, e date,
period for p(s,e),
primary key(x, p without overlaps));
alter table t1 partition by key (x);
ERROR HY000: Period WITHOUT OVERLAPS is not implemented for partitioned tables
create or replace table t1 (x int, s date, e date, period for p (s, e))
partition by hash (x);
alter table t1 add primary key (x, p without overlaps);
ERROR HY000: Period WITHOUT OVERLAPS is not implemented for partitioned tables
create or replace table t2 (x int, s date, e date,
period for p (s, e),
key(x, p without overlaps));
ERROR HY000: Period WITHOUT OVERLAPS is only allowed for unique keys
create or replace database test;
