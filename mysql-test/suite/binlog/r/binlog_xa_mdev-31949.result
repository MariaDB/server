call mtr.add_suppression("Found 1 prepared XA transactions");
call mtr.add_suppression("unknown option");
CREATE TABLE t31949 (a INT PRIMARY KEY) ENGINE=Innodb;
CREATE VIEW v_processlist  as SELECT * FROM performance_schema.threads where type = 'FOREGROUND';
XA START '1';
INSERT INTO t31949 SET a=1;
XA END '1';
XA PREPARE '1';
# Kill and restart
# xid '1' most be recovered
XA RECOVER;
formatID	gtrid_length	bqual_length	data
1	1	0	1
# COMMIT from an external connection
XA COMMIT '1';
FLUSH LOGS;
# Kill and restart
# xid '1' must be committed
XA RECOVER;
formatID	gtrid_length	bqual_length	data
select count(*) = 1 from t31949;
count(*) = 1
1
XA START '2';
INSERT INTO t31949 SET a=2;
XA END '2';
XA PREPARE '2';
# ROLLBACK from the native connection
XA ROLLBACK '2';
FLUSH LOGS;
# Kill and restart
# xid '1' must be rolled back
XA RECOVER;
formatID	gtrid_length	bqual_length	data
select count(*) = 1 from t31949;
count(*) = 1
1
XA START '3';
INSERT INTO t31949 SET a=3;
XA END '3';
XA PREPARE '3';
# COMMIT from the native connection
XA COMMIT '3';
FLUSH LOGS;
# Kill and restart
# xid '3' must be committed
XA RECOVER;
formatID	gtrid_length	bqual_length	data
select count(*) = 2 from t31949;
count(*) = 2
1
connect con4,127.0.0.1,root,,test,$MASTER_MYPORT,;
XA START '4';
INSERT INTO t31949 SET a=4;
XA END '4';
XA PREPARE '4';
disconnect con4;
connection default;
# ROLLBACK from an external connection
XA ROLLBACK '4';
FLUSH LOGS;
# Kill and restart
# xid '4' must be rolled back
XA RECOVER;
formatID	gtrid_length	bqual_length	data
select count(*) = 2 from t31949;
count(*) = 2
1
DROP TABLE t31949;
DROP VIEW v_processlist;
End of the tests
