RESET MASTER;
CREATE TABLE t1 (a INT PRIMARY KEY, b MEDIUMTEXT) ENGINE=Innodb;
# case A: Binlog CP after XAP
set @@global.max_binlog_size=4096;
connect con1,localhost,root,,;
SET SESSION binlog_annotate_row_events=OFF;
XA START '1';
INSERT INTO t1 SET a=1,b=repeat('b',@@global.max_binlog_size);;
XA END '1';
XA PREPARE '1';
### Repeatable check block in the cases A,B.
connection default;
show binary logs;
Log_name	File_size
master-bin.000001	#
master-bin.000002	#
*** the old  must show the prepared xa
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000001	#	Gtid	#	#	XA START X'31',X'',1 GTID #-#-#
master-bin.000001	#	Table_map	#	#	table_id: # (test.t1)
master-bin.000001	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
master-bin.000001	#	Query	#	#	XA END X'31',X'',1
master-bin.000001	#	XA_prepare	#	#	XA PREPARE X'31',X'',1
master-bin.000001	#	Rotate	#	#	master-bin.000002;pos=POS
*** the current master-bin.000001 must show the checkpoint event with its name ***
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000002	#	Format_desc	#	#	SERVER_VERSION, BINLOG_VERSION
master-bin.000002	#	Gtid_list	#	#	[#-#-#]
master-bin.000002	#	Binlog_checkpoint	#	#	master-bin.000001
master-bin.000002	#	Binlog_checkpoint	#	#	master-bin.000002
### end of check block
# case B: Binlog CP after XAC
connection default;
SET STATEMENT  binlog_annotate_row_events=OFF FOR INSERT INTO t1 SET a=2,b=repeat('b', 3530);
connection con1;
XA COMMIT '1';
### Repeatable check block in the cases A,B.
connection default;
show binary logs;
Log_name	File_size
master-bin.000001	#
master-bin.000002	#
master-bin.000003	#
*** the old master-bin.000002 must show the committed xa
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000002	#	Gtid	#	#	GTID #-#-#
master-bin.000002	#	Query	#	#	XA COMMIT X'31',X'',1
master-bin.000002	#	Rotate	#	#	master-bin.000003;pos=POS
*** the current master-bin.000002 must show the checkpoint event with its name ***
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000003	#	Format_desc	#	#	SERVER_VERSION, BINLOG_VERSION
master-bin.000003	#	Gtid_list	#	#	[#-#-#]
master-bin.000003	#	Binlog_checkpoint	#	#	master-bin.000002
master-bin.000003	#	Binlog_checkpoint	#	#	master-bin.000003
### end of check block
disconnect con1;
connection default;
DROP TABLE t1;
set @@global.max_binlog_size=1073741824;
