--source have_federatedx.inc
--source include/federated.inc

connection default;

set global federated_pushdown=1;

connection slave;

DROP TABLE IF EXISTS federated.t1;

CREATE TABLE federated.t1 (
  id int(20) NOT NULL,
  name varchar(16) NOT NULL default ''
)
DEFAULT CHARSET=latin1;

INSERT INTO federated.t1 VALUES
  (3,'xxx'), (7,'yyy'), (4,'xxx'), (1,'zzz'), (5,'yyy');

DROP TABLE IF EXISTS federated.t2;

CREATE TABLE federated.t2 (
  name varchar(16) NOT NULL default ''
)
DEFAULT CHARSET=latin1;

INSERT INTO federated.t2 VALUES
  ('yyy'), ('www'), ('yyy'), ('xxx'), ('www'), ('yyy'), ('www');


connection master;

DROP TABLE IF EXISTS federated.t1;

--replace_result $SLAVE_MYPORT SLAVE_PORT
eval
CREATE TABLE federated.t1 (
  id int(20) NOT NULL,
  name varchar(16) NOT NULL default ''
)
ENGINE="FEDERATED" DEFAULT CHARSET=latin1
CONNECTION='mysql://root@127.0.0.1:$SLAVE_MYPORT/federated/t1';

DROP TABLE IF EXISTS federated.t2;

--replace_result $SLAVE_MYPORT SLAVE_PORT
eval
CREATE TABLE federated.t2 (
  name varchar(16) NOT NULL default ''
)
ENGINE="FEDERATED" DEFAULT CHARSET=latin1
CONNECTION='mysql://root@127.0.0.1:$SLAVE_MYPORT/federated/t2';

SELECT * FROM federated.t1;

SELECT id FROM federated.t1 WHERE id < 5;

SELECT count(*), name FROM federated.t1 WHERE id < 5 GROUP BY name;

SELECT * FROM federated.t1, federated.t2
  WHERE federated.t1.name = federated.t2.name;

SELECT * FROM federated.t1 LEFT JOIN federated.t2
              ON federated.t1.name = federated.t2.name
  WHERE federated.t1.id > 1;

SELECT * FROM federated.t1
  WHERE id IN (SELECT count(*) FROM federated.t2 GROUP BY name);

EXPLAIN
SELECT id FROM federated.t1 WHERE id < 5;
 
EXPLAIN EXTENDED
SELECT id FROM federated.t1 WHERE id < 5;

EXPLAIN FORMAT=JSON
SELECT id FROM federated.t1 WHERE id < 5;

ANALYZE
SELECT id FROM federated.t1 WHERE id < 5;

--source include/analyze-format.inc
ANALYZE FORMAT=JSON
SELECT id FROM federated.t1 WHERE id < 5;

CREATE TABLE federated.t3 (
  name varchar(16) NOT NULL default ''
)
DEFAULT CHARSET=latin1;

INSERT INTO federated.t3 VALUES
  ('yyy'), ('www'), ('yyy'), ('xxx'), ('www'), ('yyy'), ('www');

SELECT *
FROM federated.t3, (SELECT * FROM federated.t1 WHERE id > 3) t
WHERE federated.t3.name=t.name;

EXPLAIN
SELECT *
FROM federated.t3, (SELECT * FROM federated.t1 WHERE id > 3) t
WHERE federated.t3.name=t.name;

EXPLAIN FORMAT=JSON
SELECT *
FROM federated.t3, (SELECT * FROM federated.t1 WHERE id > 3) t
WHERE federated.t3.name=t.name;

ANALYZE
SELECT *
FROM federated.t3, (SELECT * FROM federated.t1 WHERE id > 3) t
WHERE federated.t3.name=t.name;

SELECT *
FROM federated.t3, (SELECT t1.name FROM federated.t1
                    WHERE id IN (SELECT count(*)
                                 FROM federated.t2 GROUP BY name)) t
WHERE federated.t3.name=t.name;

EXPLAIN
SELECT *
FROM federated.t3, (SELECT t1.name FROM federated.t1
                    WHERE id IN (SELECT count(*)
                                 FROM federated.t2 GROUP BY name)) t
WHERE federated.t3.name=t.name;

--source include/analyze-format.inc
ANALYZE FORMAT=JSON
SELECT *
FROM federated.t3, (SELECT t1.name FROM federated.t1
                    WHERE id IN (SELECT count(*)
                                 FROM federated.t2 GROUP BY name)) t
WHERE federated.t3.name=t.name;

SELECT t.id, federated.t3.name
FROM federated.t3,
     ( SELECT * FROM federated.t1 WHERE id < 3
       UNION
       SELECT * FROM federated.t1 WHERE id >= 5) t
WHERE federated.t3.name=t.name;

EXPLAIN
SELECT t.id, federated.t3.name
FROM federated.t3,
     ( SELECT * FROM federated.t1 WHERE id < 3
       UNION
       SELECT * FROM federated.t1 WHERE id >= 5) t
WHERE federated.t3.name=t.name;

--echo #
--echo # MDEV-21887: federatedx crashes on SELECT ... INTO query in select_handler code
--echo #

CREATE TABLE federated.t4 (
  id int(20) NOT NULL,
  name varchar(16) NOT NULL default ''
) engine=myisam;
insert into federated.t4 select * from federated.t1;

--sorted_result
select * from federated.t4;

select name into @var from federated.t1 where id=3 limit 1 ;
select @var;
select name into outfile 'tmp.txt' from federated.t1;

let $path=`select concat(@@datadir, 'test/tmp.txt')`;
remove_file $path;

--echo #
--echo # MDEV-22993: Crash on EXPLAIN with PUSHED DOWN SELECT and subquery
--echo #

explain
select * from federated.t1
where name in (select name from federated.t2);

explain format=json
select * from federated.t1
where name in (select name from federated.t2);

--echo #
--echo # MDEV-22993, testcase #2: EXPLAIN output doesn't make sense when
--echo #   derived table pushdown is used.
--echo #

create table t5 (a int) engine=myisam;
insert into t5 values (1),(2);

--echo # Must not show lines with id=3
explain 
select * from t5, 
(select id from federated.t1
 where name in (select name from federated.t2) or name like 'foo%') as TQ;

--echo # Must not show elements with select_id=3
explain format=json
select * from t5, 
(select id from federated.t1
 where name in (select name from federated.t2) or name like 'foo%') as TQ;

drop table t5;

DROP TABLE federated.t1, federated.t2, federated.t3, federated.t4;

connection slave;
DROP TABLE federated.t1, federated.t2;

connection default;

--echo #
--echo # MDEV-23778: Derived handler used for big derived tables
--echo #

connection slave;

CREATE TABLE federated.t1 (
  a varchar(100) NOT NULL default '123'
)
DEFAULT CHARSET=latin1;

CREATE TABLE federated.t2 LIKE federated.t1;

DELIMITER $$;
BEGIN NOT ATOMIC
  DECLARE i INT DEFAULT 0;
  START TRANSACTION;
  WHILE i < 70000 DO
    INSERT INTO federated.t1 VALUES (i);
    SET i = i + 1;
  END WHILE;
  COMMIT;
END
$$

DELIMITER ;$$

connection master;

--replace_result $SLAVE_MYPORT SLAVE_PORT
eval
CREATE TABLE federated.t1 (
  a varchar(100) NOT NULL default '123'
)
ENGINE="FEDERATED" DEFAULT CHARSET=latin1
CONNECTION='mysql://root@127.0.0.1:$SLAVE_MYPORT/federated/t1';


--replace_result $SLAVE_MYPORT SLAVE_PORT
eval
CREATE TABLE federated.t2 (
  a varchar(100) NOT NULL default '123'
)
ENGINE="FEDERATED" DEFAULT CHARSET=latin1
CONNECTION='mysql://root@127.0.0.1:$SLAVE_MYPORT/federated/t2';

SELECT COUNT(DISTINCT a) FROM federated.t1;

INSERT INTO federated.t2
  SELECT * FROM (SELECT * FROM federated.t1 LIMIT 100) dt;
SELECT COUNT(DISTINCT a) FROM federated.t2;

TRUNCATE TABLE federated.t2;
INSERT INTO federated.t2
  SELECT * FROM (SELECT * FROM federated.t1 LIMIT 70000) dt;
SELECT COUNT(DISTINCT a) FROM federated.t2;


--echo #
--echo # MDEV-25080: Allow pushdown of queries involving UNIONs
--echo #   in outer select to foreign engines
--echo #

connection master;

TRUNCATE TABLE federated.t1;
TRUNCATE TABLE federated.t2;

INSERT INTO federated.t1 VALUES ('abc'), ('bcd'), ('cde');
INSERT INTO federated.t2 VALUES ('abc'), ('bcd'), ('cde'), ('def'), ('efg');

CREATE TABLE t3 (a varchar(30)) ENGINE=MyISAM;
CREATE TABLE t4 (a varchar(30)) ENGINE=MyISAM;

INSERT INTO t3 VALUES ('t3_myisam1'), ('t3_myisam2'), ('t3_myisam3');
INSERT INTO t4 VALUES ('t4_myisam1'), ('t4_myisam2'), ('t4_myisam3');

--echo # Pushdown of the whole UNION
SELECT * from federated.t1 UNION SELECT * from federated.t2;
EXPLAIN SELECT * from federated.t1 UNION SELECT * from federated.t2;

--echo # Pushdown of a part of the UNION
SELECT * from federated.t1 UNION SELECT * from t3;
EXPLAIN SELECT * from federated.t1 UNION SELECT * from t3;

SELECT * from federated.t1 UNION ALL SELECT * from federated.t2;
EXPLAIN SELECT * from federated.t1 UNION ALL SELECT * from federated.t2;

EXPLAIN FORMAT=JSON SELECT * from federated.t1 UNION ALL
  SELECT * from federated.t2;

ANALYZE SELECT * from federated.t1 UNION ALL SELECT * from federated.t2;

ANALYZE FORMAT=JSON SELECT * from federated.t1 UNION ALL
  SELECT * from federated.t2;

SELECT * from federated.t1 EXCEPT SELECT * from federated.t2;

EXPLAIN EXTENDED SELECT * from federated.t1 EXCEPT
  SELECT * from federated.t2;

EXPLAIN FORMAT=JSON SELECT * from federated.t1 EXCEPT
  SELECT * from federated.t2;

SELECT * from federated.t1 INTERSECT SELECT * from federated.t2;

EXPLAIN PARTITIONS SELECT * from federated.t1 INTERSECT
  SELECT * from federated.t2;

EXPLAIN FORMAT=JSON SELECT * from federated.t1 INTERSECT
  SELECT * from federated.t2;

--echo # More than two SELECTs in a UNIT:
SELECT * from federated.t1 INTERSECT
  SELECT * from federated.t2 UNION ALL
  SELECT * from federated.t2 EXCEPT
  SELECT * from federated.t1;

EXPLAIN
  SELECT count(*) from federated.t1 INTERSECT
  SELECT count(*) from federated.t2 UNION ALL
  SELECT count(*)+20 from federated.t2 EXCEPT
  SELECT count(*)+5 from federated.t1;
  
EXPLAIN FORMAT=JSON
  SELECT count(*) from federated.t1 INTERSECT
  SELECT count(*) from federated.t2 UNION ALL
  SELECT count(*)+20 from federated.t2 EXCEPT
  SELECT count(*)+5 from federated.t1;
  
ANALYZE
  SELECT count(*) from federated.t1 INTERSECT
  SELECT count(*) from federated.t2 UNION
  SELECT count(*)+20 from federated.t2 EXCEPT
  SELECT count(*)+5 from federated.t1;

--echo # UNION inside a derived table: the whole derived table must be pushed
SELECT * FROM 
  (SELECT * FROM federated.t1 UNION ALL SELECT * FROM federated.t2) q;

EXPLAIN 
  SELECT * FROM 
    (SELECT a FROM federated.t1 UNION ALL SELECT * FROM federated.t2) q;

--echo # There is an uncacheable side effect due to fetch into @var,
--echo # so the UNION cannot be pushed down as a whole.
--echo # But separate SELECTs can be pushed, and the results are combined
--echo # at the server side

--disable_warnings

SELECT count(*) FROM federated.t1 UNION
  SELECT count(*) FROM federated.t1 EXCEPT
  SELECT count(*)+1 FROM federated.t1
  INTO @var;

EXPLAIN SELECT count(*) FROM federated.t1 UNION
  SELECT count(*) FROM federated.t2 EXCEPT
  SELECT count(*)+1 FROM federated.t1
  INTO @var;

EXPLAIN FORMAT=JSON SELECT count(*) FROM federated.t1 UNION
  SELECT count(*) FROM federated.t2 EXCEPT
  SELECT count(*)+2 FROM federated.t2
  INTO @var;

--enable_warnings

--echo # Prepared statements
PREPARE stmt FROM "SELECT * from federated.t1 INTERSECT
  SELECT * from federated.t2 UNION ALL
  SELECT * from federated.t2 EXCEPT
  SELECT * from federated.t1";

EXECUTE stmt;
EXECUTE stmt;
EXECUTE stmt;

PREPARE stmt FROM "EXPLAIN SELECT * from federated.t1 INTERSECT
  SELECT * from federated.t2 UNION ALL
  SELECT * from federated.t2 EXCEPT
  SELECT * from federated.t1";

EXECUTE stmt;
EXECUTE stmt;

--echo # UNIONs of mixed Federated/MyISAM tables, pushing parts of UNIONs
SELECT * FROM federated.t1 UNION SELECT * FROM t3;
EXPLAIN SELECT * FROM federated.t1 UNION SELECT * FROM t3;

SELECT * FROM federated.t1 UNION ALL
  SELECT * FROM t3 EXCEPT
  SELECT * FROM federated.t2;
EXPLAIN SELECT * FROM federated.t1 UNION ALL
  SELECT * FROM t3 EXCEPT
  SELECT * FROM federated.t2;

SELECT * FROM t3 UNION ALL
  SELECT * FROM federated.t1 EXCEPT
  SELECT * FROM t4 INTERSECT
  SELECT * FROM federated.t2;
EXPLAIN SELECT * FROM t3 UNION ALL
  SELECT * FROM federated.t1 EXCEPT
  SELECT * FROM t4 INTERSECT
  SELECT * FROM federated.t2;

SELECT * FROM federated.t2 UNION ALL
  SELECT * FROM t3 EXCEPT
  SELECT * FROM t4 INTERSECT
  SELECT * FROM federated.t1;
EXPLAIN SELECT * FROM federated.t2 UNION ALL
  SELECT * FROM t3 EXCEPT
  SELECT * FROM t4 INTERSECT
  SELECT * FROM federated.t1;

--echo # Parenthesis must not prevent the whole UNIONs pushdown
EXPLAIN (SELECT * FROM federated.t1 UNION
  SELECT * FROM federated.t2) UNION ALL
  SELECT * FROM federated.t1;

(SELECT * FROM federated.t1 UNION
  SELECT * FROM federated.t2) UNION ALL
  SELECT * FROM federated.t1;

EXPLAIN (SELECT * FROM federated.t1 UNION SELECT * FROM federated.t2)
  UNION ALL (SELECT * FROM federated.t1 UNION SELECT * FROM federated.t2);

(SELECT * FROM federated.t1 UNION SELECT * FROM federated.t2) UNION ALL
  (SELECT * FROM federated.t1 UNION SELECT * FROM federated.t2);

DROP TABLES federated.t1, federated.t2, t3, t4;

connection slave;
DROP TABLE federated.t1, federated.t2;

connection default;

set global federated_pushdown=0;

source include/federated_cleanup.inc;

