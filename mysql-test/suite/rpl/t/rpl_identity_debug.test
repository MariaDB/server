-- source include/master-slave.inc
-- source include/have_innodb.inc
-- source include/have_sequence.inc

#create table t1(x int GENERATED BY DEFAULT AS IDENTITY CACHE 3, source text) engine=innodb;
create table t1(x int unique auto_increment, source text) engine=innodb;
insert into t1 values();
show create table t1;
sync_slave_with_master;
show create table t1;
connection master;
let $i=12;

# Avoid warning about unsafe statement
let $values1= `select group_concat('("first")' separator ',') from seq_1_to_$i`;
let $values2= `select group_concat('("second")' separator ',') from seq_1_to_$i`;

eval set debug_sync= "ha_write_row_start signal write1 wait_for step1"; # execute $i";
--send
--eval insert t1(source) select 'first' from seq_1_to_$i where seq*seq < 1000;
connect master2,localhost,root,,test,$MASTER_MYPORT,;
eval set debug_sync= "ha_write_row_start signal write2 wait_for step2"; # execute $i";
--send
--eval insert t1(source) select 'second' from seq_1_to_$i where seq*seq < 1000;

connect master_master,localhost,root,,test,$MASTER_MYPORT,;
# while ($i) {
      set debug_sync= "now wait_for write1";
 #     set debug_sync= "now wait_for write2";
      set debug_sync= "now signal step1";
      set debug_sync= "now signal step2";
      dec $i;
# }

connection master2;
reap;

select * from t1;

sync_slave_with_master;

select * from t1;

disconnect master2;
connection master;
drop table t1;

--source include/rpl_end.inc
