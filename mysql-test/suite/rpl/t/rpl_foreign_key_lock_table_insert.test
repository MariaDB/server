--source include/have_binlog_format_row.inc
--source include/master-slave.inc
--source include/have_innodb.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc

connection slave;
--let $default_fk_slave_exec_mode= `SELECT @@global.slave_exec_mode`

# 1. Set SLAVE_EXEC_MODE as IDEMPOTENT
#    and execute INSERT with locked table.
connection slave;
SET GLOBAL SLAVE_EXEC_MODE='IDEMPOTENT';

connection master;
CREATE TABLE t1 ( id varchar(100) , PRIMARY KEY (id)) engine=innodb;
 
CREATE TABLE t2 ( id varchar(100) , a varchar(100),
  PRIMARY KEY (id,a),
  KEY a (a),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;
 
CREATE TABLE t3 ( a varchar(100),  b varchar(100) ,
  PRIMARY KEY (a, b),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;
 
LOCK TABLES t1 WRITE;
INSERT INTO t1 VALUES ('a');
UNLOCK TABLES;

# Cleanup
DROP TABLE t3, t2, t1;
--sync_slave_with_master


# 2. Set SLAVE_EXEC_MODE as STRICT
#    and execute INSERT with locked table.
connection slave;
SET GLOBAL SLAVE_EXEC_MODE='STRICT';

connection master;
CREATE TABLE t1 ( id varchar(100) , PRIMARY KEY (id)) engine=innodb;
 
CREATE TABLE t2 ( id varchar(100) , a varchar(100),
  PRIMARY KEY (id,a),
  KEY a (a),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;
 
CREATE TABLE t3 ( a varchar(100),  b varchar(100) ,
  PRIMARY KEY (a, b),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;
 
LOCK TABLES t1 WRITE;
INSERT INTO t1 VALUES ('a');
UNLOCK TABLES;

# Cleanup
DROP TABLE t3, t2, t1;
--sync_slave_with_master

connection slave;
SET DEBUG_SYNC= 'RESET';
SET @@GLOBAL.debug_dbug = @saved_dbug;
SET GLOBAL SLAVE_EXEC_MODE=DEFAULT;

# 3. Set SLAVE_EXEC_MODE as IDEMPOTENT
#    and execute INSERT with locked table.
connection slave;
SET GLOBAL SLAVE_EXEC_MODE='IDEMPOTENT';

connection master;
CREATE TABLE t1 ( id varchar(100) , PRIMARY KEY (id)) engine=innodb;
 
CREATE TABLE t2 ( id varchar(100) , a varchar(100),
  PRIMARY KEY (id,a),
  KEY a (a),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;
 
CREATE TABLE t3 ( a varchar(100),  b varchar(100) ,
  PRIMARY KEY (a, b),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;
 
FLUSH TABLES WITH READ LOCK;
--error ER_CANT_UPDATE_WITH_READLOCK
INSERT INTO t1 VALUES ('a');
UNLOCK TABLES;

# Cleanup
DROP TABLE t3, t2, t1;
--sync_slave_with_master


# 4. Set SLAVE_EXEC_MODE as STRICT
#    and execute INSERT with locked table.
connection slave;
SET GLOBAL SLAVE_EXEC_MODE='STRICT';

connection master;
CREATE TABLE t1 ( id varchar(100) , PRIMARY KEY (id)) engine=innodb;
 
CREATE TABLE t2 ( id varchar(100) , a varchar(100),
  PRIMARY KEY (id,a),
  KEY a (a),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;
 
CREATE TABLE t3 ( a varchar(100),  b varchar(100) ,
  PRIMARY KEY (a, b),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;
 
FLUSH TABLES WITH READ LOCK;
--error ER_CANT_UPDATE_WITH_READLOCK
INSERT INTO t1 VALUES ('a');
UNLOCK TABLES;

# Cleanup
DROP TABLE t3, t2, t1;
--sync_slave_with_master

connection slave;
--eval set global slave_exec_mode='$default_fk_slave_exec_mode'

--source include/rpl_end.inc
