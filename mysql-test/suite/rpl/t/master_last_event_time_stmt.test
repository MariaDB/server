#
# Statement specific tests for master_last_event_time
#
--source include/have_binlog_format_statement.inc
--source include/have_innodb.inc
--let $rpl_topology=1->2->3
--source include/rpl_init.inc

# Server_3 state is maintained by master_last_event_time.inc
--connection server_3
--source include/stop_slave.inc

--connection server_1
call mtr.add_suppression("Unsafe statement written to the binary log using statement format since BINLOG_FORMAT = STATEMENT");
alter table mysql.gtid_slave_pos engine=innodb;
create table t1 (a int) engine=aria;
create table t2 (a int) engine=innodb;
--source include/save_master_gtid.inc

--echo #
--echo # Ensure that the slave doesn't overwrite exec_time when binlogging
--echo #

--let $slave_delay= 3

--connection server_2
--source include/sync_with_master_gtid.inc
--source include/stop_slave.inc
--replace_result $slave_delay SLAVE_DELAY
--eval change master to master_delay=$slave_delay
--source include/start_slave.inc

--connection server_1
--echo # Sleep 2 to ensure DDL and DML have different binlog timestamps
--sleep 2
--let $t1_time_begin= `select truncate(@@timestamp,0)`
--connection server_2
flush logs;
--connection server_1
--replace_result $t1_time_begin TIMESTAMP
--eval set @@timestamp= $t1_time_begin
--disable_warnings
insert into t1 values (sleep(2));
--source include/save_master_gtid.inc
--enable_warnings

--echo # Waiting for slave to delay and commit transaction..
--connection server_2
--source include/sync_with_master_gtid.inc

# Slave will replicate the above with a row event which will be very fast
# compared to the master event.
# Check the exec time is not 0 (which is typical for very fast row events)

--let $datadir= `select @@datadir`
--let $filename= query_get_value(SHOW MASTER STATUS, File, 1)
--let $slave_local_binlog=$datadir/$filename
--let $slave_outfile=$MYSQLTEST_VARDIR/tmp/slave_binlog.sql
--echo # MYSQL_BINLOG slave_local_binlog > slave_outfile
--exec $MYSQL_BINLOG $slave_local_binlog > $slave_outfile
--let $assert_count=0
--let $assert_text= Ensure slave doesn't overwrite exec_time in the binlog event
--let $assert_select=exec_time=0
--let $assert_file= $slave_outfile
--source include/assert_grep.inc

--source master_last_event_time.inc

--connection server_2
--source include/stop_slave.inc
change master to master_delay=0;
--source include/start_slave.inc
--connection server_3
--source include/start_slave.inc

--echo #
--echo # Cleanup
--connection server_1
drop table t1;
drop table t2;

--source include/rpl_end.inc
--remove_file $slave_outfile
--echo # End of master_last_event_time_stmt
