-- source include/have_binlog_format_statement.inc
-- source include/master-slave.inc

connection default;
source main/global_temporary_table.test;
sync_slave_with_master;
connection master;

#Safety
set @old_timeout= @@global.lock_wait_timeout;
set lock_wait_timeout= 5;
set global lock_wait_timeout= 5;

create table t(x int, txt text);
create global temporary table gtt(x int) on commit preserve rows;

insert t values (1, 'one'), (2,'two'), (3, 'three'), (4, 'four');
insert gtt values (2),(3),(5);

--connect (con1,localhost,root,,)
insert gtt values (4),(6);
--connection master

update t, gtt set t.txt= CONCAT(t.txt, ' tables') where t.x = gtt.x;

--connection con1
update t, gtt set t.txt= CONCAT(t.txt, ' databases') where t.x = gtt.x;
truncate gtt;
--connection master
select * from t;

sync_slave_with_master;
select * from t;
connection master;

--connection master
truncate gtt;
drop table t;
drop table gtt;
set global lock_wait_timeout= @old_timeout;

--echo # MDEV-38125 Assertion !thd->rgi_slave failed on INSERT under LOCK TABLES
create table t(x int);
create global temporary table src(x int) on commit preserve rows;
insert src values(1);
lock tables t write, src write;
set binlog_format=row;
insert t values(1);
unlock tables;
truncate src;
set binlog_format=statement;
drop table t;
drop table src;
sync_slave_with_master;
connection master;

--echo # MDEV-37941 Assertion `!thd->rgi_slave' failed on INSERT w/ parallel slave
call mtr.add_suppression("Slave: Failed to open tricky_table.test Error_code: 1944");
create global temporary table tricky_table (c int);
set sql_log_bin = 0;
drop table tricky_table;
create table tricky_table (c int);
set sql_log_bin = 1;

insert into tricky_table values (1);
--connection slave
--echo # ER_GTID_OPEN_TABLE_FAILED is 1944
--let $slave_sql_errno= 1944
--source include/wait_for_slave_sql_error_and_skip.inc
--connection master
drop table tricky_table;
sync_slave_with_master;
connection master;

--disconnect con1
--source include/rpl_end.inc
