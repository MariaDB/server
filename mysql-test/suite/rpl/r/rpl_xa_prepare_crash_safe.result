include/master-slave.inc
[connection master]
connect  master2,localhost,root,,;
connection master;
CALL mtr.add_suppression("Found 1 prepared XA transactions");
CALL mtr.add_suppression("Found 2 prepared XA transactions");
CALL mtr.add_suppression("Found 3 prepared XA transactions");
CREATE TABLE t ( f INT ) ENGINE=INNODB;
XA START 'xa1';
INSERT INTO t VALUES (20);
XA END 'xa1';
XA PREPARE 'xa1';
connection slave;
include/stop_slave.inc
connection master1;
use test;
xa start 'xa2';
insert into t values (30);
xa end 'xa2';
SET DEBUG_SYNC="simulate_hang_after_binlog_prepare SIGNAL reached WAIT_FOR go";
xa prepare 'xa2';
connection master2;
XA START 'xa3';
INSERT INTO t VALUES (40);
XA END 'xa3';
SET GLOBAL DEBUG_DBUG="d,simulate_crash_after_binlog_prepare";
XA PREPARE 'xa3';
ERROR HY000: Lost connection to MySQL server during query
connection master1;
ERROR HY000: Lost connection to MySQL server during query
connection master;
connection default;
connection server_1;
connection master;
include/assert_grep.inc [Binlog XA PREPARE event should be successfully recovered]
include/assert_grep.inc [Binlog XA crash recovery should successfully finish]
connection slave;
include/start_slave.inc
connection master;
SELECT * FROM t;
f
XA RECOVER;
formatID	gtrid_length	bqual_length	data
1	3	0	xa3
1	3	0	xa1
1	3	0	xa2
XA COMMIT 'xa1';
XA COMMIT 'xa2';
XA COMMIT 'xa3';
SELECT * FROM t;
f
20
30
40
connection slave;
SELECT * FROM t;
f
20
30
40
connection master;
DROP TABLE t;
connection slave;
include/rpl_end.inc
