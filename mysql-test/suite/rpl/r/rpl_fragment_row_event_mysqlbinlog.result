include/rpl_init.inc [topology=1->2, 2->3]
#
#
# Test setup
connection server_1;
set @@global.binlog_row_event_fragment_threshold= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_1;
connect  server_1,127.0.0.1,root,,test,$SERVER_MYPORT_1,;
connection server_2;
include/stop_slave.inc
set @@global.binlog_row_event_fragment_threshold= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_2;
connect  server_2,127.0.0.1,root,,test,$SERVER_MYPORT_2,;
include/start_slave.inc
connection server_3;
include/stop_slave.inc
set @@global.binlog_row_event_fragment_threshold= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_3;
connect  server_3,127.0.0.1,root,,test,$SERVER_MYPORT_3,;
include/start_slave.inc
#
#
# Test cases 1a-1c) Regular row events that surpass
# binlog_row_event_fragment_threshold should be fragmented
connection server_2;
include/stop_slave.inc
connection server_3;
include/stop_slave.inc
#
# Initialize test data
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 12 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 12 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 12 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Reset data state on server_2 for mysqlbinlog replay
connection server_2;
set statement sql_log_bin=0 for drop table t1;
# MYSQL_BINLOG mysqld_datadir/binlog_insert_filename --result-file=binlog_analysis_file
# Show how many Partial_rows_log_events use mysqlbinlog @0, @1 fragmentation (ev_len > 1024)
FOUND 12 matches in binlog_base64_output.sql
# Show how many Partial_rows_log_events use regular BINLOG base64 output (ev_len <= 1024)
#  Note: 1 always comes from the Format_description_log_event
FOUND 1 matches in binlog_base64_output.sql
# MYSQL_SLAVE --init-command="set sql_log_bin=0" < binlog_analysis_file
# Ensuring mysqlbinlog event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1]
#
# Cleanup test case
connection server_2;
include/start_slave.inc
connection server_3;
include/start_slave.inc
connection server_1;
drop table t1;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
#
#
# Test cases 1d-1f) Compressed row events that surpass
# binlog_row_event_fragment_threshold should be fragmented
connection server_1;
set @@global.log_bin_compress= 1;
connection server_2;
set @@global.log_bin_compress= 1;
connection server_3;
set @@global.log_bin_compress= 1;
connection server_2;
include/stop_slave.inc
connection server_3;
include/stop_slave.inc
#
# Initialize test data
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 12 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 12 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 12 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Reset data state on server_2 for mysqlbinlog replay
connection server_2;
set statement sql_log_bin=0 for drop table t1;
# MYSQL_BINLOG mysqld_datadir/binlog_insert_filename --result-file=binlog_analysis_file
# Show how many Partial_rows_log_events use mysqlbinlog @0, @1 fragmentation (ev_len > 1024)
FOUND 12 matches in binlog_base64_output.sql
# Show how many Partial_rows_log_events use regular BINLOG base64 output (ev_len <= 1024)
#  Note: 1 always comes from the Format_description_log_event
FOUND 1 matches in binlog_base64_output.sql
# MYSQL_SLAVE --init-command="set sql_log_bin=0" < binlog_analysis_file
# Ensuring mysqlbinlog event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1]
#
# Cleanup test case
connection server_2;
include/start_slave.inc
connection server_3;
include/start_slave.inc
connection server_1;
drop table t1;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
connection server_1;
set @@global.log_bin_compress= 0;
connection server_2;
set @@global.log_bin_compress= 0;
connection server_3;
set @@global.log_bin_compress= 0;
#
#
# Test Case 2) A transaction with multiple Rows_log_events can be
# replicated
connection server_2;
include/stop_slave.inc
connection server_3;
include/stop_slave.inc
#
# Initialize test data
connection server_1;
connection server_2;
connection server_3;
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
create table t2 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
include/diff_tables.inc [server_1:test.t2, server_2:test.t2, server_3:test.t2]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 18 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Ensure SHOW BINLOG EVENTS shows Partial_rows_log_event data
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000005	#	Binlog_checkpoint	#	#	master-bin.000005
master-bin.000005	#	Gtid	#	#	GTID #-#-#
master-bin.000005	#	Query	#	#	use `test`; create table t1 (a int, b longblob) engine=innodb
master-bin.000005	#	Gtid	#	#	GTID #-#-#
master-bin.000005	#	Query	#	#	use `test`; create table t2 (a int, b longblob) engine=innodb
master-bin.000005	#	Gtid	#	#	BEGIN GTID #-#-#
master-bin.000005	#	Annotate_rows	#	#	insert into t1 select seq,repeat(seq,512) from seq_1_to_10
master-bin.000005	#	Table_map	#	#	table_id: # (test.t1)
master-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
master-bin.000005	#	Xid	#	#	COMMIT /* XID */
master-bin.000005	#	Gtid	#	#	BEGIN GTID #-#-#
master-bin.000005	#	Annotate_rows	#	#	insert into t2 select 1 as a, group_concat(b) as b from t1
master-bin.000005	#	Table_map	#	#	table_id: # (test.t2)
master-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
master-bin.000005	#	Annotate_rows	#	#	insert into t1 select 11 as a, group_concat(b) as b from t1
master-bin.000005	#	Table_map	#	#	table_id: # (test.t1)
master-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
master-bin.000005	#	Xid	#	#	COMMIT /* XID */
master-bin.000005	#	Rotate	#	#	master-bin.000006;pos=POS
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 18 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Ensure SHOW BINLOG EVENTS shows Partial_rows_log_event data
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-bin.000005	#	Binlog_checkpoint	#	#	slave-bin.000005
slave-bin.000005	#	Gtid	#	#	GTID #-#-#
slave-bin.000005	#	Query	#	#	use `test`; create table t1 (a int, b longblob) engine=innodb
slave-bin.000005	#	Gtid	#	#	GTID #-#-#
slave-bin.000005	#	Query	#	#	use `test`; create table t2 (a int, b longblob) engine=innodb
slave-bin.000005	#	Gtid	#	#	BEGIN GTID #-#-#
slave-bin.000005	#	Annotate_rows	#	#	insert into t1 select seq,repeat(seq,512) from seq_1_to_10
slave-bin.000005	#	Table_map	#	#	table_id: # (test.t1)
slave-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
slave-bin.000005	#	Xid	#	#	COMMIT /* XID */
slave-bin.000005	#	Gtid	#	#	BEGIN GTID #-#-#
slave-bin.000005	#	Annotate_rows	#	#	insert into t2 select 1 as a, group_concat(b) as b from t1
slave-bin.000005	#	Table_map	#	#	table_id: # (test.t2)
slave-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
slave-bin.000005	#	Annotate_rows	#	#	insert into t1 select 11 as a, group_concat(b) as b from t1
slave-bin.000005	#	Table_map	#	#	table_id: # (test.t1)
slave-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
slave-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
slave-bin.000005	#	Xid	#	#	COMMIT /* XID */
slave-bin.000005	#	Rotate	#	#	slave-bin.000006;pos=POS
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 18 matches in binlog_insert_frags.out
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Ensure SHOW BINLOG EVENTS shows Partial_rows_log_event data
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000005	#	Binlog_checkpoint	#	#	master-bin.000005
master-bin.000005	#	Gtid	#	#	GTID #-#-#
master-bin.000005	#	Query	#	#	use `test`; create table t1 (a int, b longblob) engine=innodb
master-bin.000005	#	Gtid	#	#	GTID #-#-#
master-bin.000005	#	Query	#	#	use `test`; create table t2 (a int, b longblob) engine=innodb
master-bin.000005	#	Gtid	#	#	BEGIN GTID #-#-#
master-bin.000005	#	Annotate_rows	#	#	insert into t1 select seq,repeat(seq,512) from seq_1_to_10
master-bin.000005	#	Table_map	#	#	table_id: # (test.t1)
master-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
master-bin.000005	#	Xid	#	#	COMMIT /* XID */
master-bin.000005	#	Gtid	#	#	BEGIN GTID #-#-#
master-bin.000005	#	Annotate_rows	#	#	insert into t2 select 1 as a, group_concat(b) as b from t1
master-bin.000005	#	Table_map	#	#	table_id: # (test.t2)
master-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
master-bin.000005	#	Annotate_rows	#	#	insert into t1 select 11 as a, group_concat(b) as b from t1
master-bin.000005	#	Table_map	#	#	table_id: # (test.t1)
master-bin.000005	#	Partial_rows	#	#	Fragment 1 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 2 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 3 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 4 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 5 of 6
master-bin.000005	#	Partial_rows	#	#	Fragment 6 of 6
master-bin.000005	#	Xid	#	#	COMMIT /* XID */
master-bin.000005	#	Rotate	#	#	master-bin.000006;pos=POS
# Reset data state on server_2 for mysqlbinlog replay
connection server_2;
set statement sql_log_bin=0 for drop table t1;
set statement sql_log_bin=0 for drop table t2;
# MYSQL_BINLOG mysqld_datadir/binlog_insert_filename --result-file=binlog_analysis_file
# Show how many Partial_rows_log_events use mysqlbinlog @0, @1 fragmentation (ev_len > 1024)
FOUND 18 matches in binlog_base64_output.sql
# Show how many Partial_rows_log_events use regular BINLOG base64 output (ev_len <= 1024)
#  Note: 1 always comes from the Format_description_log_event
FOUND 1 matches in binlog_base64_output.sql
# MYSQL_SLAVE --init-command="set sql_log_bin=0" < binlog_analysis_file
# Ensuring mysqlbinlog event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1]
#
# Cleanup test case
connection server_2;
include/start_slave.inc
connection server_3;
include/start_slave.inc
connection server_1;
drop table t1;
drop table t2;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
#
#
# Cleanup
connection server_1;
set @@global.binlog_row_event_fragment_threshold= 1073741824;
set @@global.net_buffer_length= 16384;
disconnect server_1;
connect  server_1,127.0.0.1,root,,test,$SERVER_MYPORT_1,;
connection server_2;
include/stop_slave.inc
set @@global.binlog_row_event_fragment_threshold= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
disconnect server_2;
connect  server_2,127.0.0.1,root,,test,$SERVER_MYPORT_2,;
connection server_3;
include/stop_slave.inc
set @@global.binlog_row_event_fragment_threshold= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
disconnect server_3;
connect  server_3,127.0.0.1,root,,test,$SERVER_MYPORT_3,;
include/rpl_end.inc
# End of rpl_fragment_row_event.test
