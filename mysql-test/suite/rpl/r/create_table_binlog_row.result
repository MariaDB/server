include/master-slave.inc
[connection master]
create table t10 (p int primary key, new int) engine=innodb;
insert into t10 values (1,1),(2,2),(3,1);
create table t11 (new int) engine=myisam;
create function func_with_sideeffect(arg int)
returns integer
begin
insert into t11 set new=arg;
return arg+1;
end |
set @@global.binlog_annotate_row_events=1;
# Tables innodb, innodb, myisam
# Should be logged
CREATE TABLE t1 (new int primary key, dup int) engine=innodb;
insert into t1 select new,func_with_sideeffect(p) as 'dup' from t10;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
drop table t1;
CREATE TABLE t1 (new int primary key) engine=innodb select new,func_with_sideeffect(p) from t10;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
# Tables myisam, innodb, myisam
# Should be logged
CREATE TABLE t1 (new int primary key) engine=myisam select new,func_with_sideeffect(p+10) from t10;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
alter table t11 engine=innodb;
# Tables myisam, innodb, innodb
# Should not be logged
CREATE TABLE t1 (new int primary key) engine=myisam select new,func_with_sideeffect(p+20) from t10;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
alter table t10 engine=myisam;
# Tables innodb, innodb, innodb
# Should not be logged
CREATE TABLE t1 (new int primary key) engine=innodb select new,func_with_sideeffect(p+30) from t10;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
# Tables innodb, myisam, innodb
# Should not be logged
CREATE TABLE t1 (new int primary key) engine=innodb select new,func_with_sideeffect(p+40) from t10;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
show binlog events  from <binlog_start>;
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000001	#	Gtid_list	1	#	[]
master-bin.000001	#	Binlog_checkpoint	1	#	master-bin.000001
master-bin.000001	#	Gtid	1	#	GTID #-#-#
master-bin.000001	#	Query	1	#	use `test`; CREATE TABLE t1 (new int primary key, dup int) engine=innodb
master-bin.000001	#	Gtid	1	#	BEGIN GTID #-#-#
master-bin.000001	#	Annotate_rows	1	#	insert into t11 set new= NAME_CONST('arg',1)
master-bin.000001	#	Table_map	1	#	table_id: # (test.t11)
master-bin.000001	#	Write_rows_v1	1	#	table_id: # flags: STMT_END_F
master-bin.000001	#	Query	1	#	COMMIT
master-bin.000001	#	Gtid	1	#	GTID #-#-#
master-bin.000001	#	Query	1	#	use `test`; DROP TABLE `t1` /* generated by server */
master-bin.000001	#	Gtid	1	#	BEGIN GTID #-#-#
master-bin.000001	#	Annotate_rows	1	#	insert into t11 set new= NAME_CONST('arg',1)
master-bin.000001	#	Table_map	1	#	table_id: # (test.t11)
master-bin.000001	#	Write_rows_v1	1	#	table_id: # flags: STMT_END_F
master-bin.000001	#	Query	1	#	COMMIT
master-bin.000001	#	Gtid	1	#	BEGIN GTID #-#-#
master-bin.000001	#	Annotate_rows	1	#	insert into t11 set new= NAME_CONST('arg',11)
master-bin.000001	#	Table_map	1	#	table_id: # (test.t11)
master-bin.000001	#	Write_rows_v1	1	#	table_id: # flags: STMT_END_F
master-bin.000001	#	Query	1	#	COMMIT
master-bin.000001	#	Gtid	1	#	GTID #-#-#
master-bin.000001	#	Query	1	#	use `test`; alter table t11 engine=innodb
master-bin.000001	#	Gtid	1	#	GTID #-#-#
master-bin.000001	#	Query	1	#	use `test`; alter table t10 engine=myisam
drop table t10,t11;
drop function func_with_sideeffect;
set @@global.binlog_annotate_row_events=default;
connection slave;
End of the tests
include/rpl_end.inc
