include/master-slave.inc
[connection master]
connection slave;
connection slave;
SET GLOBAL SLAVE_EXEC_MODE='IDEMPOTENT';
connection master;
CREATE TABLE t1 ( id varchar(100) , PRIMARY KEY (id)) engine=innodb;
CREATE TABLE t2 ( id varchar(100) , a varchar(100),
PRIMARY KEY (id,a),
KEY a (a),
CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;
CREATE TABLE t3 ( a varchar(100),  b varchar(100) ,
PRIMARY KEY (a, b),
CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;
LOCK TABLES t1 WRITE;
INSERT INTO t1 VALUES ('a');
UNLOCK TABLES;
DROP TABLE t3, t2, t1;
connection slave;
connection slave;
SET GLOBAL SLAVE_EXEC_MODE='STRICT';
connection master;
CREATE TABLE t1 ( id varchar(100) , PRIMARY KEY (id)) engine=innodb;
CREATE TABLE t2 ( id varchar(100) , a varchar(100),
PRIMARY KEY (id,a),
KEY a (a),
CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;
CREATE TABLE t3 ( a varchar(100),  b varchar(100) ,
PRIMARY KEY (a, b),
CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;
LOCK TABLES t1 WRITE;
INSERT INTO t1 VALUES ('a');
UNLOCK TABLES;
DROP TABLE t3, t2, t1;
connection slave;
connection slave;
SET DEBUG_SYNC= 'RESET';
SET @@GLOBAL.debug_dbug = @saved_dbug;
SET GLOBAL SLAVE_EXEC_MODE=DEFAULT;
connection slave;
SET GLOBAL SLAVE_EXEC_MODE='IDEMPOTENT';
connection master;
CREATE TABLE t1 ( id varchar(100) , PRIMARY KEY (id)) engine=innodb;
CREATE TABLE t2 ( id varchar(100) , a varchar(100),
PRIMARY KEY (id,a),
KEY a (a),
CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;
CREATE TABLE t3 ( a varchar(100),  b varchar(100) ,
PRIMARY KEY (a, b),
CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;
FLUSH TABLES WITH READ LOCK;
INSERT INTO t1 VALUES ('a');
ERROR HY000: Can't execute the query because you have a conflicting read lock
UNLOCK TABLES;
DROP TABLE t3, t2, t1;
connection slave;
connection slave;
SET GLOBAL SLAVE_EXEC_MODE='STRICT';
connection master;
CREATE TABLE t1 ( id varchar(100) , PRIMARY KEY (id)) engine=innodb;
CREATE TABLE t2 ( id varchar(100) , a varchar(100),
PRIMARY KEY (id,a),
KEY a (a),
CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;
CREATE TABLE t3 ( a varchar(100),  b varchar(100) ,
PRIMARY KEY (a, b),
CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;
FLUSH TABLES WITH READ LOCK;
INSERT INTO t1 VALUES ('a');
ERROR HY000: Can't execute the query because you have a conflicting read lock
UNLOCK TABLES;
DROP TABLE t3, t2, t1;
connection slave;
connection slave;
set global slave_exec_mode='STRICT';
include/rpl_end.inc
