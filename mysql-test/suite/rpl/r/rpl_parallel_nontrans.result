include/master-slave.inc
[connection master]
connection slave;
include/stop_slave.inc
SET STATEMENT sql_log_bin=0 FOR
ALTER TABLE mysql.gtid_slave_pos ENGINE=InnoDB;
SET STATEMENT sql_log_bin=0 FOR
CALL mtr.add_suppression("Slave SQL: Modifying non-transactional table\\(s\\) in GTID .* not allowed in optimistic/aggressive parallel replication mode");
SET @old_default_engine= @@GLOBAL.default_storage_engine;
SET GLOBAL default_storage_engine=MyISAM;
SET @old_parallel_threads= @@GLOBAL.slave_parallel_threads;
SET GLOBAL slave_parallel_threads= 4;
SET @old_parallel_mode= @@GLOBAL.slave_parallel_mode;
SET GLOBAL slave_parallel_mode= optimistic;
include/start_slave.inc
connection master;
SET default_storage_engine=InnoDB;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT);
SHOW CREATE TABLE t1;
Table	t1
Create Table	CREATE TABLE `t1` (
  `a` int(11) NOT NULL,
  `b` int(11) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
INSERT INTO t1 VALUES (1, 0);
INSERT INTO t1 VALUES (2, 1), (3, 1), (4, 1);
INSERT INTO t1 VALUES (10, 2);
INSERT INTO t1 VALUES (11, 2);
UPDATE t1 SET b=3 WHERE a=1;
DELETE FROM t1 WHERE a=3;
UPDATE t1 SET b=4 WHERE a=10;
include/save_master_gtid.inc
connection slave;
include/wait_for_slave_sql_error.inc [errno=0]
include/stop_slave_io.inc
SET GLOBAL slave_parallel_mode= conservative;
include/start_slave.inc
include/sync_with_master_gtid.inc
SHOW CREATE TABLE t1;
Table	t1
Create Table	CREATE TABLE `t1` (
  `a` int(11) NOT NULL,
  `b` int(11) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
connection slave;
include/stop_slave.inc
SET GLOBAL default_storage_engine= @old_default_engine;
SET GLOBAL slave_parallel_threads= @old_parallel_threads;
SET GLOBAL slave_parallel_mode= @old_parallel_mode;
include/start_slave.inc
connection master;
DROP TABLE t1;
include/rpl_end.inc
