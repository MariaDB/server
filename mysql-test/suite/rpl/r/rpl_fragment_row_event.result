include/rpl_init.inc [topology=1->2, 2->3]
# Setup Defaults for rpl_fragment_row_event.inc
#
#
# Test case ) Boundary Testing
#
# A rows event at its maximum unfragmented length (i.e. the length of
# slave_max_allowed_packet minus the Rows_log event metadata (e.g.
# headers)) should not fragment, and replication replay should work both
# via traditional replication as well as mysqlbinlog.
connection server_1;
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_1;
connect  server_1,127.0.0.1,root,,test,$SERVER_MYPORT_1,;
connection server_2;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_2;
connect  server_2,127.0.0.1,root,,test,$SERVER_MYPORT_2,;
connection server_3;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_3;
connect  server_3,127.0.0.1,root,,test,$SERVER_MYPORT_3,;
#
# Initialize test data
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000001 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
NOT FOUND matches in binlog_insert_frags.out
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000001 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
NOT FOUND matches in binlog_insert_frags.out
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000001 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
NOT FOUND matches in binlog_insert_frags.out
# Reset data state on server_2 for mysqlbinlog replay
connection server_2;
set statement sql_log_bin=0 for drop table t1;
# MYSQL_BINLOG mysqld_datadir/binlog_insert_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# Ensuring mysqlbinlog event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1]
#
# Cleanup test case
connection server_1;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
connection server_2;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_3;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_1;
drop table t1;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
#
# If rows event surpasses its maximum unfragmented length by 1, it
# should fragment into 2 pieces, and replication replay should work
# both via traditional replication as well as mysqlbinlog.
connection server_1;
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_1;
connect  server_1,127.0.0.1,root,,test,$SERVER_MYPORT_1,;
connection server_2;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_2;
connect  server_2,127.0.0.1,root,,test,$SERVER_MYPORT_2,;
connection server_3;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_3;
connect  server_3,127.0.0.1,root,,test,$SERVER_MYPORT_3,;
#
# Initialize test data
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000003 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 2 matches in binlog_insert_frags.out
Partial_rows (1 / 2)
Partial_rows (2 / 2)
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000003 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 2 matches in binlog_insert_frags.out
Partial_rows (1 / 2)
Partial_rows (2 / 2)
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000003 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 2 matches in binlog_insert_frags.out
Partial_rows (1 / 2)
Partial_rows (2 / 2)
# Reset data state on server_2 for mysqlbinlog replay
connection server_2;
set statement sql_log_bin=0 for drop table t1;
# MYSQL_BINLOG mysqld_datadir/binlog_insert_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# Ensuring mysqlbinlog event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1]
#
# Cleanup test case
connection server_1;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
connection server_2;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_3;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_1;
drop table t1;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
#
#
# Test case ) Regular row events that surpass
# slave_max_allowed_packet should be fragmented
connection server_1;
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_1;
connect  server_1,127.0.0.1,root,,test,$SERVER_MYPORT_1,;
connection server_2;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_2;
connect  server_2,127.0.0.1,root,,test,$SERVER_MYPORT_2,;
connection server_3;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_3;
connect  server_3,127.0.0.1,root,,test,$SERVER_MYPORT_3,;
#
# Initialize test data
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000005 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000005 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000005 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
#
# Test Update_rows_log_event fragmentation
connection server_1;
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Update_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Update_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Update_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000006 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
# Server_2 binlogs for Update_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000006 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
# Server_3 binlogs for Update_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000006 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
#
# Test Delete_rows_log_event fragmentation
connection server_1;
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Delete_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Delete_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Delete_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Delete_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_3 binlogs for Delete_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Reset data state on server_2 for mysqlbinlog replay
connection server_2;
set statement sql_log_bin=0 for drop table t1;
# MYSQL_BINLOG mysqld_datadir/binlog_insert_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# MYSQL_BINLOG mysqld_datadir/binlog_update_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# MYSQL_BINLOG mysqld_datadir/binlog_delete_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# Ensuring mysqlbinlog event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1]
#
# Cleanup test case
connection server_1;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
connection server_2;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_3;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_1;
drop table t1;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
#
#
# Test case ) Compressed row events that surpass
# slave_max_allowed_packet should be fragmented
connection server_1;
set @@global.log_bin_compress= 1;
connection server_2;
set @@global.log_bin_compress= 1;
connection server_3;
set @@global.log_bin_compress= 1;
connection server_1;
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_1;
connect  server_1,127.0.0.1,root,,test,$SERVER_MYPORT_1,;
connection server_2;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_2;
connect  server_2,127.0.0.1,root,,test,$SERVER_MYPORT_2,;
connection server_3;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_3;
connect  server_3,127.0.0.1,root,,test,$SERVER_MYPORT_3,;
#
# Initialize test data
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000009 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000009 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000009 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
#
# Test Update_rows_log_event fragmentation
connection server_1;
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Update_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Update_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Update_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000010 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
# Server_2 binlogs for Update_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000010 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
# Server_3 binlogs for Update_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000010 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
#
# Test Delete_rows_log_event fragmentation
connection server_1;
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Delete_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Delete_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Delete_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Delete_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_3 binlogs for Delete_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Reset data state on server_2 for mysqlbinlog replay
connection server_2;
set statement sql_log_bin=0 for drop table t1;
# MYSQL_BINLOG mysqld_datadir/binlog_insert_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# MYSQL_BINLOG mysqld_datadir/binlog_update_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# MYSQL_BINLOG mysqld_datadir/binlog_delete_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# Ensuring mysqlbinlog event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1]
#
# Cleanup test case
connection server_1;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
connection server_2;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_3;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_1;
drop table t1;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
connection server_1;
set @@global.log_bin_compress= 0;
connection server_2;
set @@global.log_bin_compress= 0;
connection server_3;
set @@global.log_bin_compress= 0;
#
#
# Test case ) Parallel replication
connection server_2;
include/stop_slave.inc
set @@global.slave_parallel_threads= 4;
include/start_slave.inc
connection server_3;
include/stop_slave.inc
set @@global.slave_parallel_threads= 4;
include/start_slave.inc
connection server_1;
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_1;
connect  server_1,127.0.0.1,root,,test,$SERVER_MYPORT_1,;
connection server_2;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_2;
connect  server_2,127.0.0.1,root,,test,$SERVER_MYPORT_2,;
connection server_3;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_3;
connect  server_3,127.0.0.1,root,,test,$SERVER_MYPORT_3,;
#
# Initialize test data
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000013 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000013 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000013 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
#
# Test Update_rows_log_event fragmentation
connection server_1;
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Update_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Update_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Update_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000014 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
# Server_2 binlogs for Update_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000014 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
# Server_3 binlogs for Update_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000014 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
#
# Test Delete_rows_log_event fragmentation
connection server_1;
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Delete_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Delete_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Delete_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Delete_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_3 binlogs for Delete_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Reset data state on server_2 for mysqlbinlog replay
connection server_2;
set statement sql_log_bin=0 for drop table t1;
# MYSQL_BINLOG mysqld_datadir/binlog_insert_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# MYSQL_BINLOG mysqld_datadir/binlog_update_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# MYSQL_BINLOG mysqld_datadir/binlog_delete_filename | MYSQL_SLAVE --init-command="set sql_log_bin=0"
# Ensuring mysqlbinlog event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1]
#
# Cleanup test case
connection server_1;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
connection server_2;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_3;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_1;
drop table t1;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
connection server_2;
include/stop_slave.inc
set @@global.slave_parallel_threads= 0;;
include/start_slave.inc
connection server_3;
include/stop_slave.inc
set @@global.slave_parallel_threads= 0;;
include/start_slave.inc
#
#
# Test case ) Chain replication with different slave_max_allowed_packet
# configurations
connection server_1;
set @@global.slave_max_allowed_packet= 1024;
set @@global.net_buffer_length= 1024;
disconnect server_1;
connect  server_1,127.0.0.1,root,,test,$SERVER_MYPORT_1,;
connection server_2;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 16384;
set @@global.net_buffer_length= 16384;
disconnect server_2;
connect  server_2,127.0.0.1,root,,test,$SERVER_MYPORT_2,;
connection server_3;
include/stop_slave.inc
set @@global.slave_max_allowed_packet= 16384;
set @@global.net_buffer_length= 16384;
disconnect server_3;
connect  server_3,127.0.0.1,root,,test,$SERVER_MYPORT_3,;
#
# Initialize test data
connection server_1;
create table t1 (a int, b longblob) engine=innodb;
#
# Test Write_rows_log_event fragmentation
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Write_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Write_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Write_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000017 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
FOUND 13 matches in binlog_insert_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Write_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000017 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
NOT FOUND matches in binlog_insert_frags.out
# Server_3 binlogs for Write_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000017 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_insert_frags.out --base64-output=never
NOT FOUND matches in binlog_insert_frags.out
#
# Test Update_rows_log_event fragmentation
connection server_1;
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Update_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Update_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Update_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.1/data//master-bin.000018 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
FOUND 12 matches in binlog_update_frags.out
Partial_rows (1 / 12)
Partial_rows (2 / 12)
Partial_rows (3 / 12)
Partial_rows (4 / 12)
Partial_rows (5 / 12)
Partial_rows (6 / 12)
Partial_rows (7 / 12)
Partial_rows (8 / 12)
Partial_rows (9 / 12)
Partial_rows (10 / 12)
Partial_rows (11 / 12)
Partial_rows (12 / 12)
# Server_2 binlogs for Update_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.2/data//slave-bin.000018 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
NOT FOUND matches in binlog_update_frags.out
# Server_3 binlogs for Update_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG /home/brandon/workspace/server/build/mysql-test/var/mysqld.3/data//master-bin.000018 --result-file=/home/brandon/workspace/server/build/mysql-test/var/binlog_update_frags.out --base64-output=never
NOT FOUND matches in binlog_update_frags.out
#
# Test Delete_rows_log_event fragmentation
connection server_1;
include/save_master_gtid.inc
connection server_2;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
include/stop_slave.inc
# Ensuring Delete_rows replication event replay is consistent..
include/diff_tables.inc [server_1:test.t1, server_2:test.t1, server_3:test.t1]
# Ensuring Delete_rows data was fragmented into Partial_rows_log_events
# Server_1 binlogs for Delete_rows event
connection server_1;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
FOUND 13 matches in binlog_delete_frags.out
Partial_rows (1 / 7)
Partial_rows (2 / 7)
Partial_rows (3 / 7)
Partial_rows (4 / 7)
Partial_rows (5 / 7)
Partial_rows (6 / 7)
Partial_rows (7 / 7)
Partial_rows (1 / 6)
Partial_rows (2 / 6)
Partial_rows (3 / 6)
Partial_rows (4 / 6)
Partial_rows (5 / 6)
Partial_rows (6 / 6)
# Server_2 binlogs for Delete_rows event
connection server_2;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
NOT FOUND matches in binlog_delete_frags.out
# Server_3 binlogs for Delete_rows event
connection server_3;
flush logs;
# MYSQL_BINLOG binlog_file_param --result-file=binlog_analysis_file --base64-output=never
NOT FOUND matches in binlog_delete_frags.out
#
# Cleanup test case
connection server_1;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
connection server_2;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_3;
set @@global.slave_max_allowed_packet= 1073741824;
set @@global.net_buffer_length= 16384;
include/start_slave.inc
connection server_1;
drop table t1;
flush logs;
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
flush logs;
connection server_3;
include/sync_with_master_gtid.inc
flush logs;
include/rpl_end.inc
# End of rpl_fragment_row_event.test
