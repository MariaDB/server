include/master-slave.inc
[connection master]
connection master;
set @old_timeout= @@global.rpl_semi_sync_master_timeout;
set @old_enabled= @@global.rpl_semi_sync_master_enabled;
set @@global.rpl_semi_sync_master_timeout= 2000;
set @@global.rpl_semi_sync_master_enabled=1;
connection slave;
include/stop_slave.inc
set @old_enabled= @@global.rpl_semi_sync_slave_enabled;
set @@global.rpl_semi_sync_slave_enabled=1;
include/start_slave.inc
connection master;
#
# Initialize test data
connection master;
create table t1 (a int) engine=innodb;
insert into t1 values (1);
include/save_master_gtid.inc
connection slave;
include/sync_with_master_gtid.inc
# Creating filtered database and statements
connection master;
set @old_skip_replication= @@session.skip_replication;
set session skip_replication=1;
create database db_ignore;
set session skip_replication= @old_skip_replication;
use db_ignore;
create table t_ignore (a int) engine=innodb;
insert into t_ignore values (1);
# Creating a non-filtered transaction which should be ACKed
connection master;
use test;
insert into t1 values (2);
# Ensure semi-sync did not timeout..
include/assert_grep.inc [Semi-sync timeout should not occur]
# ..PASS
# Ensuring semi-sync is still on..
connection master;
# ..PASS
# Ensuring the later non-filtered transaction is ACKed
# ..PASS
#
# Cleanup
connection master;
drop database db_ignore;
drop table t1;
set @@global.rpl_semi_sync_master_timeout= @old_timeout;
set @@global.rpl_semi_sync_master_enabled= @old_enabled;
connection slave;
set @@global.rpl_semi_sync_slave_enabled= @old_enabled;
include/rpl_end.inc
# End of rpl_semi_sync_binlog_dump_filter.test
