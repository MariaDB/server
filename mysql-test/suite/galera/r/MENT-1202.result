connection node_2;
connection node_1;
CREATE TABLE p (
i VARCHAR(100) PRIMARY KEY,
j INT
);
CREATE TABLE c (
i INT PRIMARY KEY AUTO_INCREMENT,
fk VARCHAR(100),
KEY (fk),
CONSTRAINT FOREIGN KEY (fk) REFERENCES p(i)
);
INSERT INTO p VALUES('aaaa', 0);
INSERT INTO p VALUES('aaab', 0);
INSERT INTO p VALUES('aaac', 0);
SET GLOBAL wsrep_slave_threads = 3;
SET GLOBAL DEBUG_DBUG = "d,sync.wsrep_apply_cb";
connection node_1;
SET SESSION wsrep_sync_wait=0;
START TRANSACTION;
INSERT INTO c VALUES(1, 'aaab');
connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1a;
SET SESSION wsrep_sync_wait=0;
connection node_2;
UPDATE p SET j = 20;
connection node_1a;
SET SESSION DEBUG_SYNC = "now WAIT_FOR sync.wsrep_apply_cb_reached";
SET GLOBAL wsrep_provider_options = 'dbug=d,apply_monitor_slave_enter_sync';
connection node_2;
UPDATE p SET j = 21;
connection node_1a;
SET SESSION wsrep_on = 0;
SET SESSION wsrep_on = 1;
SET GLOBAL wsrep_provider_options = 'dbug=';
SET GLOBAL wsrep_provider_options = 'dbug=d,commit_monitor_master_enter_sync';
connection node_1;
COMMIT;
connection node_1a;
SET SESSION wsrep_on = 0;
SET SESSION wsrep_on = 1;
SET GLOBAL wsrep_provider_options = 'dbug=';
SET GLOBAL wsrep_provider_options = 'signal=commit_monitor_master_enter_sync';
SET GLOBAL wsrep_provider_options = 'dbug=';
SET GLOBAL DEBUG_DBUG = "";
SET DEBUG_SYNC = "now SIGNAL signal.wsrep_apply_cb";
SET GLOBAL debug_dbug = NULL;
SET debug_sync='RESET';
SET GLOBAL wsrep_provider_options = 'signal=apply_monitor_slave_enter_sync';
SET GLOBAL wsrep_provider_options = 'dbug=';
connection node_1;
SELECT * FROM p;
i	j
aaaa	21
aaab	21
aaac	21
SELECT * FROM c;
i	fk
1	aaab
SET GLOBAL wsrep_slave_threads = DEFAULT;
connection node_2;
SELECT * FROM p;
i	j
aaaa	21
aaab	21
aaac	21
SELECT * FROM c;
i	fk
1	aaab
connection node_1;
DROP TABLE c;
DROP TABLE p;
