--source include/galera_cluster.inc

#
# Delete parent row that is needed for insert to child
#
CREATE TABLE parent (f1 INTEGER PRIMARY KEY, f2 INTEGER) ENGINE=INNODB;
CREATE TABLE child (f1 INTEGER PRIMARY KEY, p_id INTEGER,
                 f2 INTEGER,
                 CONSTRAINT fk_1 FOREIGN KEY (p_id) REFERENCES parent (f1) ON DELETE CASCADE)  ;
CREATE TABLE grandchild (f1 INTEGER PRIMARY KEY, p_id INTEGER,
                 f2 INTEGER,
                 CONSTRAINT fk_2 FOREIGN KEY (p_id) REFERENCES child (p_id))  ;

INSERT INTO parent VALUES (1, 1),(2,2);
INSERT INTO child VALUES (1, 1, 1);

--connection node_1
--echo # Make node 1 tolerate split-brain
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=true';
SET GLOBAL wsrep_provider_options = 'pc.weight=2';

--connection node_2
--let $wait_condition = SELECT COUNT(*) = 1 FROM child;
--source include/wait_condition.inc

SET SESSION wsrep_on=OFF;
DELETE FROM child WHERE f1 = 1;

--connection node_1
--echo # Fails in node_2 with Foreign key warning in table: `test`.`grandchild` constraint `fk_2` failed err: adding an index entry to a child table failed.
INSERT INTO grandchild VALUES (1,1,1);

--echo # Restart node_2, force SST. This is needed as node_2 is on inconsistent state
--connection node_2
--source include/shutdown_mysqld.inc
--remove_file $MYSQLTEST_VARDIR/mysqld.2/data/grastate.dat

--connection node_1
--let $wait_condition = SELECT VARIABLE_VALUE = 1 FROM INFORMATION_SCHEMA.GLOBAL_STATUS WHERE VARIABLE_NAME = 'wsrep_cluster_size'
--source include/wait_condition.inc

--connection node_2
--echo Starting server ...
let $restart_noprint=2;
--source include/start_mysqld.inc

--let $wait_condition = SELECT VARIABLE_VALUE = 2 FROM INFORMATION_SCHEMA.GLOBAL_STATUS WHERE VARIABLE_NAME = 'wsrep_cluster_size';
--source include/wait_condition.inc

--let $assert_count = 1
--let $assert_file = $MYSQLTEST_VARDIR/log/mysqld.2.err
--let $assert_text = Foreign key warning in table: \`test\`\.\`grandchild\` constraint \`fk_2\` failed err: adding an index entry to a child table failed.
--let $assert_select = Foreign key warning in table: \`test\`\.\`grandchild\` constraint \`fk_2\` failed err: adding an index entry to a child table failed.
--source include/assert_grep.inc

--connection node_1
drop table grandchild;
drop table child;
drop table parent;
# restore provider options
SET GLOBAL wsrep_provider_options = 'pc.ignore_sb=false';
SET GLOBAL wsrep_provider_options = 'pc.weight=1';

--connection node_2
call mtr.add_suppression("WSREP: Foreign key warning in table");
# These are required because test intentionally causes inconsistency
call mtr.add_suppression("WSREP: Event 3 Write_rows_v1 apply failed");
call mtr.add_suppression("WSREP: Inconsistency detected: Inconsistent by consensus on");
call mtr.add_suppression("WSREP: Failed to apply write set");
