--source include/galera_cluster.inc

if (!$SERVER_AUDIT_SO) {
    skip No SERVER_AUDIT plugin;
}

--connection node_1
install plugin server_audit soname 'server_audit';
SET GLOBAL server_audit_logging=ON;

--connection node_2
SET GLOBAL server_audit_logging=ON;

--connection node_1
CREATE TABLE t1(a INT);

--echo # Now checking the logs.

--connection node_2
INSERT INTO t1 VALUES (1);

let $MYSQLD_DATADIR= `SELECT @@datadir`;
--replace_regex /[0-9]* [0-9][0-9]:[0-9][0-9]:[0-9][0-9]\,[^,]*\,/TIME,HOSTNAME,/ /\,[1-9][0-9]*\,/,1,/ /\,[1-9][0-9]*/,ID/
cat_file $MYSQLD_DATADIR/server_audit.log;

--echo # resetting the test state
SET GLOBAL server_audit_logging=DEFAULT;

--connection node_1
DROP TABLE t1;
SET GLOBAL server_audit_logging=DEFAULT;

UNINSTALL PLUGIN server_audit;

remove_file $MYSQLD_DATADIR/server_audit.log;
