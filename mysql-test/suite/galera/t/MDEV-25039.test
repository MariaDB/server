#
# MDEV-38216 was failing after MDEV-25039 changes.
#

--source include/galera_cluster.inc
--source include/have_innodb.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc
--source include/have_perfschema.inc

--echo #
--echo # 1. LOCK TABLE and INSERT
--echo #

#
# Setup
#
--connection node_1
CREATE TABLE t1 (
  id varchar(100),
  PRIMARY KEY (id)) engine=innodb;

CREATE TABLE t2 (
  id varchar(100) , a varchar(100),
  PRIMARY KEY (id,a),
  KEY a (a),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;

CREATE TABLE t3 (
  a varchar(100),
  b varchar(100) ,
  PRIMARY KEY (a, b),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;

LOCK TABLES t1 WRITE;
INSERT INTO t1 VALUES ('a');
UNLOCK TABLES;


#
# Verify insert has succeded.
#
--connection node_2
--let $wait_condition = SELECT COUNT(*) = 1 FROM test.t1
--source include/wait_condition.inc

select * from t1;

--connection node_1
select * from t1;


#
# Cleanup
#
DROP TABLE t3, t2, t1;


--echo #
--echo # 2. FLUSH TABLES WITH READ LOCK and INSERT
--echo #

#
# Setup
#
--connection node_1
CREATE TABLE t1 (
  id varchar(100),
  PRIMARY KEY (id)) engine=innodb;

CREATE TABLE t2 (
  id varchar(100) , a varchar(100),
  PRIMARY KEY (id,a),
  KEY a (a),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t1 (id)
) ENGINE=InnoDB;

CREATE TABLE t3 (
  a varchar(100),
  b varchar(100) ,
  PRIMARY KEY (a, b),
  CONSTRAINT FOREIGN KEY (a) REFERENCES t2 (a)
) ENGINE=InnoDB;

FLUSH TABLES WITH READ LOCK;
--error ER_CANT_UPDATE_WITH_READLOCK
INSERT INTO t1 VALUES ('a');
UNLOCK TABLES;


#
# Verify insert has succeded.
#
--connection node_2
--let $wait_condition = SELECT COUNT(*) = 0 FROM test.t1
--source include/wait_condition.inc

select * from t1;

--connection node_1
select * from t1;


#
# Cleanup
#
DROP TABLE t3, t2, t1;
