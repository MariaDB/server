--source include/galera_cluster.inc
--source include/have_sequence.inc
--source include/force_restart.inc

--connection node_2
--replace_regex /.*galera_buffered_error_log.err.*/galera_buffered_error_log.err/
SELECT @@global.wsrep_buffered_error_log_filename;
SELECT @@global.wsrep_buffered_error_log_buffer_size;
SELECT @@global.wsrep_buffered_error_log_file_size;
SELECT @@global.wsrep_buffered_error_log_rotations;

CREATE TABLE t1(a int not null primary key auto_increment, count int) engine=innodb;

--let $inserts=1000
--let $count=0
--disable_query_log
while($count < $inserts)
{
  --eval insert into t1 values (NULL,$count)
  --eval update t1 set count = $count+100 where count = $count
  --inc $count
}
--enable_query_log

--echo # List error log files - max file number .5
--list_files $MYSQLTEST_VARDIR/mysqld.2/data galera_buffered_error_log*

--echo # Change rotations larger
SET GLOBAL wsrep_buffered_error_log_rotations=6;

--let $inserts=1000
--let $count=0
--disable_query_log
while($count < $inserts)
{
  --eval insert into t1 values (NULL,$count)
  --eval update t1 set count = $count+100 where count = $count
  --inc $count
}
--enable_query_log

--echo # List error log files - max file number .6
--list_files $MYSQLTEST_VARDIR/mysqld.2/data galera_buffered_error_log*

--replace_regex /.*galera_buffered_error_log.err.*/galera_buffered_error_log.err/
SELECT @@global.wsrep_buffered_error_log_filename;
SELECT @@global.wsrep_buffered_error_log_buffer_size;
SELECT @@global.wsrep_buffered_error_log_file_size;
SELECT @@global.wsrep_buffered_error_log_rotations;

--echo # Change rotations smaller and use different name
--disable_query_log
--eval SET GLOBAL wsrep_buffered_error_log_filename="galera_buffered_error_log2.err"
--enable_query_log
SET GLOBAL wsrep_buffered_error_log_rotations=2;

--let $inserts=1000
--let $count=0
--disable_query_log
while($count < $inserts)
{
  --eval insert into t1 values (NULL,$count)
  --eval update t1 set count = $count+100 where count = $count
  --inc $count
}
--enable_query_log

SELECT COUNT(*) AS EXPECT_2000 FROM t1;
DROP TABLE t1;

--echo # List error log files - max file number .2
--list_files $MYSQLTEST_VARDIR/mysqld.2/data galera_buffered_error_log2*

--replace_regex /.*galera_buffered_error_log2.err.*/galera_buffered_error_log2.err/
SELECT @@global.wsrep_buffered_error_log_filename;
SELECT @@global.wsrep_buffered_error_log_buffer_size;
SELECT @@global.wsrep_buffered_error_log_file_size;
SELECT @@global.wsrep_buffered_error_log_rotations;

--echo # Reset
--disable_query_log
--eval SET GLOBAL wsrep_buffered_error_log_filename="galera_buffered_error_log.err"
--enable_query_log
SET @@global.wsrep_buffered_error_log_rotations=5;


