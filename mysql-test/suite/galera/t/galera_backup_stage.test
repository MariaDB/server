#
# Check that BACKUP STAGE BLOCK_DDL desyncs and pauses the node until BACKUP STAGE END:
# - Local DDLs will fail immediately
# - Local DMLs will block until resync
# - Remote txns will be applied after resync (STAGE END).
# 

--source include/galera_cluster.inc
--source include/have_innodb.inc

--connection node_1
CREATE TABLE t1 (f1 varchar(10)) ENGINE=InnoDB;

# First, check that BACKUP STAGE END skipping desyncing stages is fine
BACKUP STAGE START;
BACKUP STAGE FLUSH;
BACKUP STAGE END;

BACKUP STAGE START;
BACKUP STAGE FLUSH;

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connection node_1a
INSERT INTO t1 (f1) values ("node1_1");
ALTER TABLE t1 ADD COLUMN (f2 int(10));

--connection node_2
INSERT INTO t1 (f1) values ("node2_1");
ALTER TABLE t1 ADD COLUMN (f3 int(10));

--connection node_1
# BLOCK_DDL desyncs and pauses the node
BACKUP STAGE BLOCK_DDL;

--connection node_2
INSERT INTO t1 (f1) values("node2_2");
ALTER TABLE t1 ADD COLUMN (f5 int(10));

--connection node_1a
--error 1047
ALTER TABLE t1 ADD COLUMN (f4 int(10));
--send INSERT INTO t1 (f1) values("node1a");

--connection node_1
BACKUP STAGE BLOCK_COMMIT;

--connection node_2
INSERT INTO t1 (f1) values("node2_3");
ALTER TABLE t1 ADD COLUMN (f6 int(10));

--connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connection node_1b
--error 1047
ALTER TABLE t1 ADD COLUMN (f4 int(10));
--send INSERT INTO t1 (f1) values("node1b");

--connect node_1c, 127.0.0.1, root, , test, $NODE_MYPORT_1
--connection node_1c
SET SESSION wsrep_sync_wait=0;
SELECT COUNT(*)=2 FROM t1;
SELECT COUNT(*)=3 FROM information_schema.columns WHERE table_name = 't1';

--connection node_1
# STAGE END resumes and resyncs the node
BACKUP STAGE END;

--connection node_1a
--reap
--connection node_1b
--reap

--connection node_1
SELECT COUNT(*)=6 FROM t1;
SELECT COUNT(*)=5 FROM information_schema.columns WHERE table_name = 't1';

--connection node_2
SELECT COUNT(*)=6 FROM t1;
SELECT COUNT(*)=5 FROM information_schema.columns WHERE table_name = 't1';

--connection node_1
DROP TABLE t1;
call mtr.add_suppression("WSREP: ALTER TABLE isolation failure");
call mtr.add_suppression("greater than drain seqno");
