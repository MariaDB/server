# Connection delay tests for valid user accounts

# ----------------------------------------------------------------------

# Setup
# Install connection_control plugin
INSTALL PLUGIN connection_control SONAME 'CONNECTION_CONTROL_LIB';
INSTALL PLUGIN connection_control_failed_login_attempts SONAME 'CONNECTION_CONTROL_LIB';
# Create user accounts for testing
CREATE USER u1@localhost IDENTIFIED BY 'abcd';
CREATE USER u2@localhost IDENTIFIED BY 'abcd';
CREATE USER u3@localhost IDENTIFIED BY 'abcd';
# Save original values of connection_control variables
SET @saved_connections_threshold = @@global.failed_connections_threshold;
SET @saved_max_delay= @@global.max_connection_delay;
# Set small threshold
SET @@global.failed_connections_threshold = 1;
# Set small max delay
SET @@global.max_connection_delay = 1000;

# ----------------------------------------------------------------------

connect(localhost,u1,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,,,,,;
ERROR 28000: Access denied for user 'u1'@'localhost' (using password: NO)
connect(localhost,u3,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,haha,,,,;
ERROR 28000: Access denied for user 'u3'@'localhost' (using password: YES)
connect(localhost,u2,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,efgh,,,,;
ERROR 28000: Access denied for user 'u2'@'localhost' (using password: YES)
# Check  Connection_control_delay_generated - Should be 0
SHOW STATUS LIKE 'Connection_control_delay_generated';
Variable_name	Value
Connection_control_delay_generated	0
connect(localhost,u1,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,,,,,;
ERROR 28000: Access denied for user 'u1'@'localhost' (using password: NO)
connect(localhost,u2,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,haha,,,,;
ERROR 28000: Access denied for user 'u2'@'localhost' (using password: YES)
connect(localhost,u3,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,efgh,,,,;
ERROR 28000: Access denied for user 'u3'@'localhost' (using password: YES)
connect(localhost,u2,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,,,,,;
ERROR 28000: Access denied for user 'u2'@'localhost' (using password: NO)
connect(localhost,u1,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,haha,,,,;
ERROR 28000: Access denied for user 'u1'@'localhost' (using password: YES)
connect(localhost,u3,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,efgh,,,,;
ERROR 28000: Access denied for user 'u3'@'localhost' (using password: YES)
# Check Connection_control_delay_generated - Should be 6
SHOW STATUS LIKE 'Connection_control_delay_generated';
Variable_name	Value
Connection_control_delay_generated	6
connect(localhost,u2,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,,,,,;
ERROR 28000: Access denied for user 'u2'@'localhost' (using password: NO)
connect(localhost,u1,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,haha,,,,;
ERROR 28000: Access denied for user 'u1'@'localhost' (using password: YES)
connect(localhost,u3,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,efgh,,,,;
ERROR 28000: Access denied for user 'u3'@'localhost' (using password: YES)
# Check Connection_control_delay_generated - Should be 9
SHOW STATUS LIKE 'Connection_control_delay_generated';
Variable_name	Value
Connection_control_delay_generated	9
connect con_u1, localhost, u1,abcd,,,,;
connect con_u2, localhost, u2,abcd,,,,;
connect con_u3, localhost, u3,abcd,,,,;
connection default;
disconnect con_u1;
disconnect con_u2;
disconnect con_u3;
# Successful connection but delays would still be generated
# Should be 12
SHOW STATUS LIKE 'Connection_control_delay_generated';
Variable_name	Value
Connection_control_delay_generated	12
# Setting failed connection threshold should reset delay statistics
SET @@global.failed_connections_threshold = 1;
connect(localhost,u1,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,,,,,;
ERROR 28000: Access denied for user 'u1'@'localhost' (using password: NO)
connect(localhost,u3,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,haha,,,,;
ERROR 28000: Access denied for user 'u3'@'localhost' (using password: YES)
connect(localhost,u2,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,efgh,,,,;
ERROR 28000: Access denied for user 'u2'@'localhost' (using password: YES)
connect(localhost,u1,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,,,,,;
ERROR 28000: Access denied for user 'u1'@'localhost' (using password: NO)
connect(localhost,u3,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,haha,,,,;
ERROR 28000: Access denied for user 'u3'@'localhost' (using password: YES)
connect(localhost,u2,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,efgh,,,,;
ERROR 28000: Access denied for user 'u2'@'localhost' (using password: YES)
# Check Connection_control_delay_generated - Should be 3
SHOW STATUS LIKE 'Connection_control_delay_generated';
Variable_name	Value
Connection_control_delay_generated	3

# ----------------------------------------------------------------------

# Cleanup
connection default;
# Restore original values of conenction_control variables
SET @@global.max_connection_delay= @saved_max_delay;
SET @@global.failed_connections_threshold = @saved_connections_threshold;
# Remove user accounts created for the test
DROP USER u1@localhost;
DROP USER u2@localhost;
DROP USER u3@localhost;
# Uninstall connection_control plugin
UNINSTALL PLUGIN connection_control;
UNINSTALL PLUGIN connection_control_failed_login_attempts;

# ----------------------------------------------------------------------
