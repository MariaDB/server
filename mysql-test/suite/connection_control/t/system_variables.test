# Save the initial number of concurrent sessions
--source include/count_sessions.inc


--echo #-----------------------------------------------------------------------
--echo # Setup
CREATE USER no_privs@localhost IDENTIFIED BY 'abcd';

connect(conn_no_privs, localhost, no_privs, abcd,,,,);
connection default;

--echo #-----------------------------------------------------------------------

--echo # Case 1 : failed_connections_threshold
SET @saved_value = @@global.failed_connections_threshold;
SELECT @saved_value;
SET @@global.failed_connections_threshold = @saved_value;

--echo # 1.1 : Setting failed_connections_threshold to valid
--echo #       value

SET @@global.failed_connections_threshold = 20;
SELECT @@global.failed_connections_threshold;

SET @@global.failed_connections_threshold = 2000;
SELECT @@global.failed_connections_threshold;

SET @@global.failed_connections_threshold = 2147483647;
SELECT @@global.failed_connections_threshold;

SET @@global.failed_connections_threshold = DEFAULT;
SELECT @@global.failed_connections_threshold;

SET @@global.failed_connections_threshold = -20;
SELECT @@global.failed_connections_threshold;


SET @@global.failed_connections_threshold = 9223372036854775808;
SELECT @@global.failed_connections_threshold;

SET @@global.failed_connections_threshold = -9223372036854775808;
SELECT @@global.failed_connections_threshold;


--echo # 1.2 : Setting failed_connections_threshold to
--echo #       invalid value

--error ER_WRONG_TYPE_FOR_VAR
SET @@global.failed_connections_threshold = NULL;
SELECT @@global.failed_connections_threshold;

--error ER_WRONG_TYPE_FOR_VAR
SET @@global.failed_connections_threshold = `SELECT * FROM mysql.user`;
SELECT @@global.failed_connections_threshold;



--echo # Switch to conn_no_privs

connection conn_no_privs;

--echo # 1.3 : Use no_privs@localhost to set
--echo #       failed_connections_threshold to valid value

--error ER_SPECIFIC_ACCESS_DENIED_ERROR
SET @@global.failed_connections_threshold = 2147483647;
SELECT @@global.failed_connections_threshold;

--error ER_SPECIFIC_ACCESS_DENIED_ERROR
SET @@global.failed_connections_threshold = DEFAULT;
SELECT @@global.failed_connections_threshold;

--echo # 1.4 : Use no_privs@localhost to set
--echo #       failed_connections_threshold to invalid value

--error ER_SPECIFIC_ACCESS_DENIED_ERROR
SET @@global.failed_connections_threshold = NULL;
SELECT @@global.failed_connections_threshold;

--error ER_SPECIFIC_ACCESS_DENIED_ERROR
SET @@global.failed_connections_threshold = 9223372036854775808;
SELECT @@global.failed_connections_threshold;

connection default;

SET @@global.failed_connections_threshold = @saved_value;
SELECT @@global.failed_connections_threshold;

--echo #-----------------------------------------------------------------------
--echo # Cleanup

disconnect conn_no_privs;


DROP USER no_privs@localhost;

# Wait till all disconnects are completed.
--source include/wait_until_count_sessions.inc

--echo #-----------------------------------------------------------------------
