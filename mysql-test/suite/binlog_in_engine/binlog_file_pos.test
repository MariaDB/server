--source include/master-slave.inc
--source include/have_binlog_format_row.inc
--source include/have_innodb_binlog.inc

--connection slave
--source include/stop_slave.inc
--connection master
--source include/reset_master.inc
--connection slave
--source include/start_slave.inc
--connection master

CREATE TABLE t1 (a INT PRIMARY KEY, b VARCHAR(4096)) ENGINE=InnoDB;

# Cycle through a few binlog files and see the position updated on the slave.
--connection master
--let $i= 0
while ($i < 10) {
  --let $j= 0
  --disable_query_log
  while ($j < 30) {
    eval INSERT INTO t1 VALUES ($i*100+$j, repeat('.', 4000));
    inc $j;
  }
  --enable_query_log
  --source include/save_master_gtid.inc
  --connection slave
  --source include/sync_with_master_gtid.inc
  --let $i_file= query_get_value(SHOW SLAVE STATUS, Master_Log_File, 1)
  --let $s_file= query_get_value(SHOW SLAVE STATUS, Relay_Master_Log_File, 1)
  --connection master
  --echo Slave current file: $i_file / $s_file
  inc $i;
}

SELECT COUNT(*) FROM t1;
--connection slave
SELECT COUNT(*) FROM t1;

--connection master
DROP TABLE t1;
--source include/rpl_end.inc
