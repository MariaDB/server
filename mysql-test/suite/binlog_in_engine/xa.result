include/reset_master.inc
CREATE TABLE t1(a INT PRIMARY KEY, b INT) ENGINE=InnoDB;
*** Test basic XA COMMIT from same or different client connection.
connect con1,localhost,root,,;
XA START 'a';
INSERT INTO t1 VALUES (1, 0);
INSERT INTO t1 VALUES (2, 0);
INSERT INTO t1 VALUES (3, 0);
XA END 'a';
XA PREPARE 'a';
connection default;
disconnect con1;
connect con2,localhost,root,,;
XA COMMIT 'a';
connection default;
XA START 'b';
UPDATE t1 SET b=2 WHERE a=1;
XA END 'b';
XA PREPARE 'b';
XA COMMIT 'b';
XA START 'c';
UPDATE t1 SET b=3 WHERE a=3;
XA END 'c';
XA COMMIT 'c' ONE PHASE;
SELECT * FROM t1 ORDER BY a;
a	b
1	2
2	0
3	3
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
binlog-000000.ibb	#	Gtid	#	#	GTID #-#-#
binlog-000000.ibb	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (1, 0)
binlog-000000.ibb	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (2, 0)
binlog-000000.ibb	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (3, 0)
binlog-000000.ibb	#	Query	#	#	COMMIT
binlog-000000.ibb	#	Gtid	#	#	GTID #-#-#
binlog-000000.ibb	#	Query	#	#	use `test`; UPDATE t1 SET b=2 WHERE a=1
binlog-000000.ibb	#	Query	#	#	COMMIT
binlog-000000.ibb	#	Gtid	#	#	BEGIN GTID #-#-#
binlog-000000.ibb	#	Query	#	#	use `test`; UPDATE t1 SET b=3 WHERE a=3
binlog-000000.ibb	#	Xid	#	#	COMMIT /* XID */
*** Test that we will not purge a file that is needed by an active XA transaction.
connection default;
ALTER TABLE t1 ADD COLUMN c LONGBLOB;
UPDATE t1 SET b=10 WHERE a=1;
connection con2;
SET SESSION binlog_format=ROW;
XA START 'd';
INSERT INTO t1 VALUES (10, 2, REPEAT('#', 40000));
connect con3,localhost,root,,;
SET SESSION binlog_format=ROW;
XA START 'e';
INSERT INTO t1 VALUES (110, 2, REPEAT('#', 40000));
connection default;
UPDATE t1 SET b=11 WHERE a=1;
FLUSH BINARY LOGS;
UPDATE t1 SET b=12 WHERE a=1;
connection con2;
INSERT INTO t1 VALUES (11, 2, REPEAT('*', 40000));
connection con3;
INSERT INTO t1 VALUES (111, 2, REPEAT('*', 40000));
connection default;
UPDATE t1 SET b=13 WHERE a=1;
FLUSH BINARY LOGS;
UPDATE t1 SET b=14 WHERE a=1;
UPDATE t1 SET b=15 WHERE a=1;
FLUSH BINARY LOGS;
UPDATE t1 SET b=16 WHERE a=1;
FLUSH BINARY LOGS;
connection default;
SET @old_min_slaves= @@GLOBAL.slave_connections_needed_for_purge;
SET GLOBAL slave_connections_needed_for_purge= 0;
PURGE BINARY LOGS TO 'binlog-000001.ibb';
ERROR HY000: A purgeable log is in use, will not purge
connection con2;
XA END 'd';
XA PREPARE 'd';
connection con3;
XA END 'e';
XA PREPARE 'e';
connection default;
PURGE BINARY LOGS TO 'binlog-000001.ibb';
ERROR HY000: A purgeable log is in use, will not purge
connection con2;
XA COMMIT 'd';
connection con3;
XA ROLLBACK 'e';
connection default;
PURGE BINARY LOGS TO 'binlog-000001.ibb';
FLUSH BINARY LOGS;
UPDATE t1 SET b=17 WHERE a=1;
FLUSH BINARY LOGS;
UPDATE t1 SET b=18 WHERE a=1;
PURGE BINARY LOGS TO 'binlog-000001.ibb';
disconnect con2;
disconnect con3;
SET GLOBAL slave_connections_needed_for_purge= @old_min_slaves;
DROP TABLE t1;
