--source include/have_binlog_format_row.inc
--source include/have_innodb_binlog.inc

--source include/reset_master.inc

CREATE TABLE t1(a INT PRIMARY KEY, b INT, c LONGBLOB) ENGINE=InnoDB;

--echo *** Test that an active transaction with OOB data prevents PURGE and RESET MASTER.

--connect con1,localhost,root,,
# Create an active transaction large enough to generate OOB data.
BEGIN;
INSERT INTO t1 VALUES (1, 1, REPEAT('$', 100000));

--connection default
INSERT INTO t1 VALUES (2, 0, 'abd');
FLUSH BINARY LOGS;
INSERT INTO t1 VALUES (3, 0, 'def');
FLUSH BINARY LOGS;
INSERT INTO t1 VALUES (4, 0, 'ghi');
FLUSH BINARY LOGS;

# PURGE and RESET MASTER are blocked because con1 has pending references to
# binlog-000000.ibb
SET @old_min_slaves= @@GLOBAL.slave_connections_needed_for_purge;
SET GLOBAL slave_connections_needed_for_purge= 0;
--error ER_LOG_IN_USE
PURGE BINARY LOGS TO 'binlog-000001.ibb';
--error ER_BINLOG_IN_USE_TRX
RESET MASTER;

# Committing the transaction allows the PURGE and RESET to succeed.
--connection con1
COMMIT;
--disconnect con1

--connection default
PURGE BINARY LOGS TO 'binlog-000001.ibb';
RESET MASTER;

--connection default

SET GLOBAL slave_connections_needed_for_purge= @old_min_slaves;
DROP TABLE t1;
