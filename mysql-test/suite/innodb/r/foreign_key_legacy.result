set default_storage_engine= innodb;
call mtr.add_suppression("Couldn't repair table:");
set @saved_debug_dbug= @@session.debug_dbug;
# Foreign table upgraded first
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
flush tables;
# Data is imported from SYS_FOREIGN[_COLS] on table open
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
flush tables;
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails
drop tables t2, t1;
# Referenced table upgraded first
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
flush tables;
# Data is imported from SYS_FOREIGN[_COLS] on table open
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) NOT NULL,
  PRIMARY KEY (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
drop table t2;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop table t1;
# DROP TABLE
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails
drop tables t2, t1;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
# DROP DATABASE (convert first)
create database D1;
create database D2;
create or replace table D1.t1(x int primary key);
set session debug_dbug= "+d,fk_skip_store";
create or replace table D2.t2(y int references D1.t1(x), x int primary key);
create or replace table D2.t4(x int primary key);
create or replace table D2.t3(y int references D2.t2(x), z int references D2.t4(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql=@fk_sql;
set session debug_dbug= @saved_debug_dbug;
check table D1.t1, D2.t2;
Table	Op	Msg_type	Msg_text
D1.t1	check	Error	Foreign table `D2.t2` does not refer this table
D1.t1	check	Note	Found 1 referenced keys
D1.t1	check	status	Operation failed
D2.t2	check	Error	Foreign table `D2.t3` does not refer this table
D2.t2	check	Note	Found 1 referenced keys
D2.t2	check	Note	Found 1 foreign keys
D2.t2	check	status	Operation failed
check table D1.t1;
Table	Op	Msg_type	Msg_text
D1.t1	check	Note	Found 1 referenced keys
D1.t1	check	status	OK
drop database D1;
Got one of the listed errors
check table D1.t1, D2.t2;
Table	Op	Msg_type	Msg_text
D1.t1	check	Note	Found 1 referenced keys
D1.t1	check	status	OK
D2.t2	check	Error	Foreign table `D2.t3` does not refer this table
D2.t2	check	Note	Found 1 referenced keys
D2.t2	check	Note	Found 1 foreign keys
D2.t2	check	status	Operation failed
drop database D2;
check table D1.t1, D2.t2;
Table	Op	Msg_type	Msg_text
D1.t1	check	status	OK
D2.t2	check	Error	Table 'D2.t2' doesn't exist
D2.t2	check	status	Operation failed
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop database D1;
# DROP DATABASE (no conversion)
create database D1;
create database D2;
create or replace table D1.t1(x int primary key);
set session debug_dbug= "+d,fk_skip_store";
create or replace table D2.t2(y int references D1.t1(x), x int primary key);
create or replace table D2.t4(x int primary key);
create or replace table D2.t3(y int references D2.t2(x), z int references D2.t4(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql=@fk_sql;
set session debug_dbug= @saved_debug_dbug;
drop database D1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails
drop database D2;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop database D1;
# Index errors
create or replace table t1(x int primary key);
create or replace table t2(y int);
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
flush tables;
show create table t2;
ERROR HY000: Index for table 't2' is corrupt; try to repair it
show warnings;
Level	Code	Message
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
Warning	150	Upgrade table t2 with foreign key test_t2_ibfk_1 constraint failed. Foreign key index not found!
Error	1215	Cannot add foreign key constraint for `t2`
Error	1034	Index for table 't2' is corrupt; try to repair it
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(z int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
show create table t2;
ERROR HY000: Index for table 't2' is corrupt; try to repair it
show warnings;
Level	Code	Message
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
Warning	150	Upgrade table t2 with foreign key test_t2_ibfk_1 constraint failed. Foreign key index not found!
Error	1215	Cannot add foreign key constraint for `t2`
Error	1034	Index for table 't2' is corrupt; try to repair it
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(z int primary key);
create or replace table t2(y int references t1(z));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
show create table t2;
ERROR HY000: Index for table 't2' is corrupt; try to repair it
show warnings;
Level	Code	Message
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
Warning	150	Upgrade table t2 with foreign key test_t2_ibfk_1 constraint failed. Referenced key index not found!
Error	1215	Cannot add foreign key constraint for `t2`
Error	1034	Index for table 't2' is corrupt; try to repair it
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
drop tables t2, t1;
# Rename of tables (RENAME TABLE)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
rename table t1 to t0;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t0	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t0` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop table t0;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t2_ibfk_1)
drop tables t2, t0;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
rename table t2 to t3;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t3_ibfk_1	test/t3	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t3_ibfk_1	y	x	0
show create table t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t3_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t3_ibfk_1)
drop tables t3, t1;
# Rename of tables (ALTER TABLE .. RENAME)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t1 rename t0, algorithm=copy;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails
alter table t1 rename t0, algorithm=inplace;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t0	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t0` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop tables t2, t0;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t2 rename t3;
Warnings:
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
show create table t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t2_ibfk_1)
drop tables t3, t1;
# Rename of columns (ALTER TABLE .. CHANGE)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t1 change x z int, algorithm=copy;
ERROR HY000: Can't create table `test`.`t1` (errno: 202 "Table requires foreign keys upgrade")
alter table t1 change x z int, algorithm=inplace;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	z	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`z`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t2 change y z int, algorithm=copy;
ERROR HY000: Cannot drop column 'z': needed in a foreign key constraint 'test_t2_ibfk_1'
alter table t2 change y z int, algorithm=inplace;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `z` int(11) DEFAULT NULL,
  KEY `y` (`z`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`z`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t2_ibfk_1)
drop tables t2, t1;
# Rename of columns (ALTER TABLE .. RENAME COLUMN)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t1 rename column x to z, algorithm=copy;
ERROR HY000: Can't create table `test`.`t1` (errno: 202 "Table requires foreign keys upgrade")
alter table t1 rename column x to z, algorithm=inplace;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	z	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`z`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t2_ibfk_1)
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t2 rename column y to z, algorithm=copy;
ERROR HY000: Cannot drop column 'z': needed in a foreign key constraint 'test_t2_ibfk_1'
alter table t2 rename column y to z, algorithm=inplace;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `z` int(11) DEFAULT NULL,
  KEY `y` (`z`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`z`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t2_ibfk_1)
drop tables t2, t1;
# Add column
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t1 add column z int, algorithm=copy;
ERROR HY000: Can't create table `test`.`t1` (errno: 202 "Table requires foreign keys upgrade")
alter table t1 add column s int as (x) stored, algorithm=copy;
ERROR HY000: Can't create table `test`.`t1` (errno: 202 "Table requires foreign keys upgrade")
alter table t1 add column z int, algorithm=inplace;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
alter table t1 add column s int as (x) stored, algorithm=copy;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) NOT NULL,
  `z` int(11) DEFAULT NULL,
  `s` int(11) GENERATED ALWAYS AS (`x`) STORED,
  PRIMARY KEY (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t2_ibfk_1)
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t2 add column z int;
Warnings:
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
alter table t2 add column s int as (y) stored, algorithm=copy;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  `z` int(11) DEFAULT NULL,
  `s` int(11) GENERATED ALWAYS AS (`y`) STORED,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t2_ibfk_1)
drop tables t2, t1;
# Drop column
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(a int primary key, x int unique);
create or replace table t2(y int references t1(x), b int);
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t1 drop column x, algorithm=copy;
ERROR HY000: Can't create table `test`.`t1` (errno: 202 "Table requires foreign keys upgrade")
alter table t1 change x x char(10);
Got one of the listed errors
alter table t1 drop column x, algorithm=inplace;
ERROR HY000: Cannot drop index 'x': needed in a foreign key constraint
alter table t2 drop column y;
ERROR HY000: Missing index for constraint 'test_t2_ibfk_1' in the foreign table 't2'
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (test_t2_ibfk_1)
drop tables t2, t1;
# Multi-threaded
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
create or replace table t3(y int references t1(x));
create or replace table t4(y int references t1(x));
create or replace table t5(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
connect  con1,localhost,root,,test;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN VALUES ('test/t3_ibfk_1', 'test/t3', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t3_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN VALUES ('test/t4_ibfk_1', 'test/t4', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t4_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN VALUES ('test/t5_ibfk_1', 'test/t5', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t5_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;
check table t2;
connect  con2,localhost,root,,test;
check table t3;
connect  con3,localhost,root,,test;
check table t4;
connection default;
check table t5;
connection con1;
Table	Op	Msg_type	Msg_text
test.t2	check	Note	Found 1 foreign keys
test.t2	check	status	OK
connection con2;
Table	Op	Msg_type	Msg_text
test.t3	check	Note	Found 1 foreign keys
test.t3	check	status	OK
connection con3;
Table	Op	Msg_type	Msg_text
test.t4	check	Note	Found 1 foreign keys
test.t4	check	status	OK
connection default;
Table	Op	Msg_type	Msg_text
test.t5	check	Note	Found 1 foreign keys
test.t5	check	status	OK
disconnect con1;
disconnect con2;
disconnect con3;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
drop tables t5, t4, t3, t2, t1;
# mysql_upgrade
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(a int primary key, x int unique);
create or replace table t2(y int references t1(x), b int);
create or replace table t3(z int references t1(a));
create database db0;
create database db1;
create or replace table db0.t2(y int references test.t1(x), b int);
create or replace table db0.t3(z int references test.t1(a));
create or replace table db1.t2(y int references test.t1(x), b int);
create or replace table db1.t3(z int references test.t1(a));
set session debug_dbug= @saved_debug_dbug;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('test/t3_ibfk_1', 'test/t3', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('db0/t2_ibfk_1', 'db0/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('db0/t3_ibfk_1', 'db0/t3', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('db1/t2_ibfk_1', 'db1/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('db1/t3_ibfk_1', 'db1/t3', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t3_ibfk_1', 0, 'z', 'a');
INSERT INTO SYS_FOREIGN_COLS VALUES ('db0/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('db0/t3_ibfk_1', 0, 'z', 'a');
INSERT INTO SYS_FOREIGN_COLS VALUES ('db1/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('db1/t3_ibfk_1', 0, 'z', 'a');";
set session debug_dbug= @saved_debug_dbug;
Phase 1/8: Checking and upgrading mysql database
Processing databases
mysql
mysql.column_stats                                 OK
mysql.columns_priv                                 OK
mysql.db                                           OK
mysql.event                                        OK
mysql.func                                         OK
mysql.global_priv                                  OK
mysql.gtid_slave_pos                               OK
mysql.help_category                                OK
mysql.help_keyword                                 OK
mysql.help_relation                                OK
mysql.help_topic                                   OK
mysql.index_stats                                  OK
mysql.innodb_index_stats                           OK
mysql.innodb_table_stats                           OK
mysql.plugin                                       OK
mysql.proc                                         OK
mysql.procs_priv                                   OK
mysql.proxies_priv                                 OK
mysql.roles_mapping                                OK
mysql.servers                                      OK
mysql.table_stats                                  OK
mysql.tables_priv                                  OK
mysql.time_zone                                    OK
mysql.time_zone_leap_second                        OK
mysql.time_zone_name                               OK
mysql.time_zone_transition                         OK
mysql.time_zone_transition_type                    OK
mysql.transaction_registry                         OK
Phase 2/8: Installing used storage engines... Skipped
Phase 3/8: Running 'mysql_fix_privilege_tables'
Phase 4/8: Fixing views
mysql.user                                         OK
sys.host_summary                                   OK
sys.host_summary_by_file_io                        OK
sys.host_summary_by_file_io_type                   OK
sys.host_summary_by_stages                         OK
sys.host_summary_by_statement_latency              OK
sys.host_summary_by_statement_type                 OK
sys.innodb_buffer_stats_by_schema                  OK
sys.innodb_buffer_stats_by_table                   OK
sys.innodb_lock_waits                              OK
sys.io_by_thread_by_latency                        OK
sys.io_global_by_file_by_bytes                     OK
sys.io_global_by_file_by_latency                   OK
sys.io_global_by_wait_by_bytes                     OK
sys.io_global_by_wait_by_latency                   OK
sys.latest_file_io                                 OK
sys.memory_by_host_by_current_bytes                OK
sys.memory_by_thread_by_current_bytes              OK
sys.memory_by_user_by_current_bytes                OK
sys.memory_global_by_current_bytes                 OK
sys.memory_global_total                            OK
sys.metrics                                        OK
sys.privileges_by_table_by_level                   OK
sys.processlist                                    OK
sys.ps_check_lost_instrumentation                  OK
sys.schema_auto_increment_columns                  OK
sys.schema_index_statistics                        OK
sys.schema_object_overview                         OK
sys.schema_redundant_indexes                       OK
sys.schema_table_lock_waits                        OK
sys.schema_table_statistics                        OK
sys.schema_table_statistics_with_buffer            OK
sys.schema_tables_with_full_table_scans            OK
sys.schema_unused_indexes                          OK
sys.session                                        OK
sys.session_ssl_status                             OK
sys.statement_analysis                             OK
sys.statements_with_errors_or_warnings             OK
sys.statements_with_full_table_scans               OK
sys.statements_with_runtimes_in_95th_percentile    OK
sys.statements_with_sorting                        OK
sys.statements_with_temp_tables                    OK
sys.user_summary                                   OK
sys.user_summary_by_file_io                        OK
sys.user_summary_by_file_io_type                   OK
sys.user_summary_by_stages                         OK
sys.user_summary_by_statement_latency              OK
sys.user_summary_by_statement_type                 OK
sys.version                                        OK
sys.wait_classes_global_by_avg_latency             OK
sys.wait_classes_global_by_latency                 OK
sys.waits_by_host_by_latency                       OK
sys.waits_by_user_by_latency                       OK
sys.waits_global_by_latency                        OK
sys.x$host_summary                                 OK
sys.x$host_summary_by_file_io                      OK
sys.x$host_summary_by_file_io_type                 OK
sys.x$host_summary_by_stages                       OK
sys.x$host_summary_by_statement_latency            OK
sys.x$host_summary_by_statement_type               OK
sys.x$innodb_buffer_stats_by_schema                OK
sys.x$innodb_buffer_stats_by_table                 OK
sys.x$innodb_lock_waits                            OK
sys.x$io_by_thread_by_latency                      OK
sys.x$io_global_by_file_by_bytes                   OK
sys.x$io_global_by_file_by_latency                 OK
sys.x$io_global_by_wait_by_bytes                   OK
sys.x$io_global_by_wait_by_latency                 OK
sys.x$latest_file_io                               OK
sys.x$memory_by_host_by_current_bytes              OK
sys.x$memory_by_thread_by_current_bytes            OK
sys.x$memory_by_user_by_current_bytes              OK
sys.x$memory_global_by_current_bytes               OK
sys.x$memory_global_total                          OK
sys.x$processlist                                  OK
sys.x$ps_digest_95th_percentile_by_avg_us          OK
sys.x$ps_digest_avg_latency_distribution           OK
sys.x$ps_schema_table_statistics_io                OK
sys.x$schema_flattened_keys                        OK
sys.x$schema_index_statistics                      OK
sys.x$schema_table_lock_waits                      OK
sys.x$schema_table_statistics                      OK
sys.x$schema_table_statistics_with_buffer          OK
sys.x$schema_tables_with_full_table_scans          OK
sys.x$session                                      OK
sys.x$statement_analysis                           OK
sys.x$statements_with_errors_or_warnings           OK
sys.x$statements_with_full_table_scans             OK
sys.x$statements_with_runtimes_in_95th_percentile  OK
sys.x$statements_with_sorting                      OK
sys.x$statements_with_temp_tables                  OK
sys.x$user_summary                                 OK
sys.x$user_summary_by_file_io                      OK
sys.x$user_summary_by_file_io_type                 OK
sys.x$user_summary_by_stages                       OK
sys.x$user_summary_by_statement_latency            OK
sys.x$user_summary_by_statement_type               OK
sys.x$wait_classes_global_by_avg_latency           OK
sys.x$wait_classes_global_by_latency               OK
sys.x$waits_by_host_by_latency                     OK
sys.x$waits_by_user_by_latency                     OK
sys.x$waits_global_by_latency                      OK
Phase 5/8: Fixing table and database names
Phase 6/8: Checking and upgrading tables
Processing databases
db0
db0.t2                                             OK
db0.t3                                             OK
db1
db1.t2                                             OK
db1.t3                                             OK
information_schema
mtr
mtr.global_suppressions                            OK
mtr.test_suppressions                              OK
performance_schema
sys
sys.sys_config                                     OK
test
test.t1                                            OK
test.t2                                            OK
test.t3                                            OK
Phase 7/8: uninstalling plugins
Phase 8/8: Running 'FLUSH PRIVILEGES'
OK
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) NOT NULL,
  `x` int(11) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `x` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
show create table t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `z` int(11) DEFAULT NULL,
  KEY `z` (`z`),
  CONSTRAINT `test_t3_ibfk_1` FOREIGN KEY (`z`) REFERENCES `t1` (`a`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
show create table db0.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `db0_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `test`.`t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
show create table db0.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `z` int(11) DEFAULT NULL,
  KEY `z` (`z`),
  CONSTRAINT `db0_t3_ibfk_1` FOREIGN KEY (`z`) REFERENCES `test`.`t1` (`a`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
show create table db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL,
  KEY `y` (`y`),
  CONSTRAINT `db1_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `test`.`t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
show create table db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `z` int(11) DEFAULT NULL,
  KEY `z` (`z`),
  CONSTRAINT `db1_t3_ibfk_1` FOREIGN KEY (`z`) REFERENCES `test`.`t1` (`a`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop database db0;
drop database db1;
drop tables t3, t2, t1;
# Replication: master old, slave new
include/master-slave.inc
[connection master]
connection master;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key) engine innodb;
create or replace table t2(x int references t1(x)) engine innodb;
set session debug_dbug= @saved_debug_dbug;
connection slave;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `x` int(11) DEFAULT NULL,
  KEY `x` (`x`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`x`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
connection master;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `x` int(11) DEFAULT NULL,
  KEY `x` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
flush tables t2;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
insert t2 values (1);
ERROR 23000: Cannot add or update a child row: a foreign key constraint fails (`test`.`t2`, CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`x`) REFERENCES `t1` (`x`))
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
set session debug_dbug= "+d,fk_skip_store";
create or replace table t2(x int references t1(x)) engine innodb;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t1 rename column x to y, algorithm=inplace;
alter table t2 rename column x to y, algorithm=inplace;
Warnings:
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `x` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`y`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
connection slave;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `x` (`y`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`y`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
connection master;
drop tables t2, t1;
# Replication: master new, slave old
connection master;
create table t1(x int primary key) engine innodb;
create table t2(x int references t1(x)) engine innodb;
connection slave;
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create table t1(x int primary key) engine innodb;
create table t2(x int references t1(x)) engine innodb;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
connection master;
alter table t1 rename column x to y, algorithm=inplace;
alter table t2 rename column x to y, algorithm=inplace;
connection slave;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `x` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`y`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
connection master;
drop tables t2, t1;
# Replication: master old, slave old
connection master;
set session debug_dbug= "+d,fk_skip_store";
create table t1(x int primary key) engine innodb;
create table t2(x int references t1(x)) engine innodb;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
connection slave;
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create table t1(x int primary key) engine innodb;
create table t2(x int references t1(x)) engine innodb;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
connection master;
alter table t1 rename column x to y, algorithm=inplace;
Warnings:
Note	1459	Upgrade required. Please do "REPAIR TABLE `t1`" or dump/reload to fix it!
alter table t2 rename column x to y, algorithm=inplace;
Warnings:
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `x` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`y`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
connection slave;
InnoDB		0 transactions not purged
select * from information_schema.innodb_sys_foreign;
ERROR 42S02: Unknown table 'innodb_sys_foreign'
select * from information_schema.innodb_sys_foreign_cols;
ERROR 42S02: Unknown table 'innodb_sys_foreign_cols'
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `x` (`y`),
  CONSTRAINT `test_t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`y`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
set global innodb_eval_sql= default;
connection master;
drop tables t2, t1;
set global innodb_eval_sql= default;
include/rpl_end.inc
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql= default;
set default_storage_engine= default;
