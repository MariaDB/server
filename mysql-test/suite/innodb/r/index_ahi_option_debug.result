SET @orig_debug=@@debug_dbug;
SET GLOBAL DEBUG_DBUG='+d,index_ahi_option_debug_check';
#
# Test InnoDB index-level adaptive_hash_index options (debug)
#
SET @start_global_value = @@global.innodb_adaptive_hash_index;
SET GLOBAL innodb_adaptive_hash_index=OFF;
CREATE TABLE t1_ahi_default (
id INT PRIMARY KEY,
col1 INT, col2 INT, col3 INT,
INDEX idx_1 (col1) adaptive_hash_index=DEFAULT complete_fields=0 bytes_from_incomplete_field=3 for_equal_hash_point_to_last_record=0,
INDEX idx_2 (col1, col2) adaptive_hash_index=YES complete_fields=1 bytes_from_incomplete_field=2 for_equal_hash_point_to_last_record=0,
INDEX idx_3 (col1, col2, col3) adaptive_hash_index=NO complete_fields=2 bytes_from_incomplete_field=2 for_equal_hash_point_to_last_record=1
) ENGINE=InnoDB STATS_PERSISTENT=0 adaptive_hash_index=DEFAULT;
INSERT INTO t1_ahi_default SELECT seq, seq, seq << 8, seq << 16 FROM seq_0_to_255;
SET GLOBAL innodb_monitor_enable = module_adaptive_hash;
CALL run_and_check_idx(240, 1, 't1_ahi_default');
result_msg
# No AHI used in SELECT (idx_1)
CALL run_and_check_idx(240, 2, 't1_ahi_default');
result_msg
# No AHI used in SELECT (idx_2)
CALL run_and_check_idx(240, 3, 't1_ahi_default');
result_msg
# No AHI used in SELECT (idx_3)
RENAME TABLE t1_ahi_default TO t1;
ALTER TABLE t1 adaptive_hash_index=OFF, ALGORITHM=INSTANT, LOCK=NONE;
RENAME TABLE t1 TO t1_ahi_no;
CALL run_and_check_idx(240, 1, 't1_ahi_no');
result_msg
# No AHI used in SELECT (idx_1)
CALL run_and_check_idx(240, 2, 't1_ahi_no');
result_msg
# No AHI used in SELECT (idx_2)
CALL run_and_check_idx(240, 3, 't1_ahi_no');
result_msg
# No AHI used in SELECT (idx_3)
RENAME TABLE t1_ahi_no TO t1;
ALTER TABLE t1 adaptive_hash_index='ON', ALGORITHM=INSTANT, LOCK=NONE;
RENAME TABLE t1 TO t1_ahi_yes;
CALL run_and_check_idx(240, 1, 't1_ahi_yes');
result_msg
# No AHI used in SELECT (idx_1)
CALL run_and_check_idx(240, 2, 't1_ahi_yes');
result_msg
# No AHI used in SELECT (idx_2)
CALL run_and_check_idx(240, 3, 't1_ahi_yes');
result_msg
# No AHI used in SELECT (idx_3)
ALTER TABLE t1_ahi_yes ADD INDEX idx_4 (col2) complete_fields=2;
ALTER TABLE t1_ahi_yes ADD INDEX idx_5 (col3) bytes_from_incomplete_field=5;
ALTER TABLE t1_ahi_yes ADD INDEX idx_6 (col2, col1) complete_fields=0 bytes_from_incomplete_field=0 for_equal_hash_point_to_last_record=0;
ALTER TABLE t1_ahi_yes ADD INDEX idx_7 (col3, col2) complete_fields=0 bytes_from_incomplete_field=0 for_equal_hash_point_to_last_record=1;
CALL run_and_check_idx(240, 4, 't1_ahi_yes');
result_msg
# No AHI used in SELECT (idx_4)
CALL run_and_check_idx(240, 5, 't1_ahi_yes');
result_msg
# No AHI used in SELECT (idx_5)
CALL run_and_check_idx(240, 6, 't1_ahi_yes');
result_msg
# No AHI used in SELECT (idx_6)
CALL run_and_check_idx(240, 7, 't1_ahi_yes');
result_msg
# No AHI used in SELECT (idx_7)
DROP PROCEDURE run_and_check_idx;
DROP TABLE t1_ahi_yes;
SET @@global.innodb_adaptive_hash_index = @start_global_value;
SET GLOBAL innodb_monitor_disable = module_adaptive_hash;
SET GLOBAL innodb_monitor_disable = default;
SET GLOBAL innodb_monitor_enable = default;
SET GLOBAL DEBUG_DBUG=@orig_debug;
