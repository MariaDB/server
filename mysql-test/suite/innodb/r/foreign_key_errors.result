#
# MDEV-32688: Test innodb_foreign_key_errors status variable
#
# Setup
CREATE TABLE parent (id INT PRIMARY KEY) ENGINE=InnoDB;
CREATE TABLE child (
id INT PRIMARY KEY,
parent_id INT,
FOREIGN KEY (parent_id) REFERENCES parent(id)
) ENGINE=InnoDB;
INSERT INTO parent VALUES (1), (2), (3);
INSERT INTO child VALUES (1, 1), (2, 2);
# Counter starts at 0
SHOW GLOBAL STATUS LIKE 'innodb_foreign_key_errors';
Variable_name	Value
Innodb_foreign_key_errors	0
# Child-side violations (INSERT, UPDATE, REPLACE, INSERT...SELECT)
INSERT INTO child VALUES (10, 999);
ERROR 23000: Cannot add or update a child row: a foreign key constraint fails (`test`.`child`, CONSTRAINT `1` FOREIGN KEY (`parent_id`) REFERENCES `parent` (`id`))
UPDATE child SET parent_id = 888 WHERE id = 1;
ERROR 23000: Cannot add or update a child row: a foreign key constraint fails (`test`.`child`, CONSTRAINT `1` FOREIGN KEY (`parent_id`) REFERENCES `parent` (`id`))
REPLACE INTO child VALUES (30, 777);
ERROR 23000: Cannot add or update a child row: a foreign key constraint fails (`test`.`child`, CONSTRAINT `1` FOREIGN KEY (`parent_id`) REFERENCES `parent` (`id`))
INSERT INTO child (id, parent_id) SELECT 40, 555;
ERROR 23000: Cannot add or update a child row: a foreign key constraint fails (`test`.`child`, CONSTRAINT `1` FOREIGN KEY (`parent_id`) REFERENCES `parent` (`id`))
# Parent-side violations (DELETE, UPDATE)
DELETE FROM parent WHERE id = 1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (`test`.`child`, CONSTRAINT `1` FOREIGN KEY (`parent_id`) REFERENCES `parent` (`id`))
UPDATE parent SET id = 100 WHERE id = 1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (`test`.`child`, CONSTRAINT `1` FOREIGN KEY (`parent_id`) REFERENCES `parent` (`id`))
# Counter after 6 violations
SHOW GLOBAL STATUS LIKE 'innodb_foreign_key_errors';
Variable_name	Value
Innodb_foreign_key_errors	6
# Successful operations should NOT increment
INSERT INTO child VALUES (50, 3);
UPDATE child SET parent_id = 1 WHERE id = 50;
DELETE FROM child WHERE id = 50;
INSERT INTO child VALUES (60, NULL);
DELETE FROM child WHERE id = 60;
# Counter unchanged after successful operations
SHOW GLOBAL STATUS LIKE 'innodb_foreign_key_errors';
Variable_name	Value
Innodb_foreign_key_errors	6
# FOREIGN_KEY_CHECKS=0 should NOT increment
SET FOREIGN_KEY_CHECKS = 0;
INSERT INTO child VALUES (70, 999);
SET FOREIGN_KEY_CHECKS = 1;
DELETE FROM child WHERE id = 70;
# Counter unchanged with FK checks disabled
SHOW GLOBAL STATUS LIKE 'innodb_foreign_key_errors';
Variable_name	Value
Innodb_foreign_key_errors	6
# CASCADE chain failure
CREATE TABLE grandparent (id INT PRIMARY KEY) ENGINE=InnoDB;
CREATE TABLE parent_cascade (
id INT PRIMARY KEY,
gp_id INT,
FOREIGN KEY (gp_id) REFERENCES grandparent(id) ON DELETE RESTRICT
) ENGINE=InnoDB;
CREATE TABLE child_cascade (
id INT PRIMARY KEY,
parent_id INT,
FOREIGN KEY (parent_id) REFERENCES parent_cascade(id) ON DELETE CASCADE
) ENGINE=InnoDB;
INSERT INTO grandparent VALUES (1);
INSERT INTO parent_cascade VALUES (1, 1);
INSERT INTO child_cascade VALUES (1, 1);
DELETE FROM grandparent WHERE id = 1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (`test`.`parent_cascade`, CONSTRAINT `1` FOREIGN KEY (`gp_id`) REFERENCES `grandparent` (`id`))
# Counter after CASCADE chain failure
SHOW GLOBAL STATUS LIKE 'innodb_foreign_key_errors';
Variable_name	Value
Innodb_foreign_key_errors	7
DROP TABLE child_cascade;
DROP TABLE parent_cascade;
DROP TABLE grandparent;
# Counter resets after restart
# restart
SHOW GLOBAL STATUS LIKE 'innodb_foreign_key_errors';
Variable_name	Value
Innodb_foreign_key_errors	0
# Cleanup
DROP TABLE child;
DROP TABLE parent;
