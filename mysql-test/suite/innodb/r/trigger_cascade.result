#
# After update
#
create table t1 (
x int primary key
) engine=innodb;
create table t2 (
x int primary key,
y int,
foreign key (x) references t1(x) on update cascade
) engine=innodb;
create table t3 (
old_x int,
new_x int
) engine=innodb;
create trigger tr after update on t2
for each row
insert into t3 (old_x, new_x) values (old.x, new.x);
insert into t1 (x) values (1);
insert into t2 (x, y) values (1, 20);
update t1 set x = 2;
select * from t3;
old_x	new_x
1	2
update t2 set y = 50;
select * from t3;
old_x	new_x
1	2
2	2
select * from t1;
x
2
select * from t2;
x	y
2	50
drop table t3;
drop table t2;
drop table t1;
#
# After update with counter
#
create table t1(x int primary key) engine=innodb;
create table t2(x int primary key,
foreign key(x) references t1(x) on update cascade) engine=innodb;
create trigger tr_t2 after update on t2
for each row set @counter=@counter+1;
insert into t1 values (1);
insert into t2 values (1);
set @counter=0;
update t1 set x = 2;
select * from t1;
x
2
select * from t2;
x
2
select @counter;
@counter
1
drop table t2;
drop table t1;
#
# Before update
#
create table t1 (
x int primary key
) engine=innodb;
create table t2 (
x int primary key,
y int,
foreign key(x) references t1(x) on update cascade
) engine=innodb;
create trigger tr before update on t2
for each row set new.y = 50;
insert into t1 (x) values (1);
insert into t2 (x, y) values (1,2);
update t1 set x = 2;
select * from t1;
x
2
select * from t2;
x	y
2	50
drop table t2;
drop table t1;
#
# Update, foreign key on secondary index
#
create table t1(x int auto_increment primary key, y int, unique key(y)) engine=innodb;
create table t2(a int primary key, x int, z varchar(20),
foreign key(x) references t1(y) on update cascade) engine=innodb;
create table t3(id int auto_increment primary key, action_x int, action_z varchar(20), note varchar(50)) engine=innodb;
create trigger tr_t2 before update on t2
for each row
insert into t3(action_x, action_z, note) values (old.x, old.z, 'update t2 — old'),
(new.x, new.z, 'update t2 — new');
insert into t1 values (1, 10);
insert into t2 values (1, 10, 'str');
update t1 set y=20 where x=1;
select * from t1;
x	y
1	20
select * from t2;
a	x	z
1	20	str
select * from t3;
id	action_x	action_z	note
1	10	str	update t2 — old
2	20	str	update t2 — new
drop table t3;
drop table t2;
drop table t1;
#
# Update, on update set null cascade
#
create table t1 (
id int primary key,
value varchar(50)
) engine=innodb;
create table t2 (
id int primary key,
t1_id int,
t2_value varchar(50),
foreign key (t1_id) references t1(id) on update set null
) engine=innodb;
create trigger tr_t2_before_update before update on t2
for each row set new.t2_value = 'updated by trigger';
insert into t1 (id, value) values (1, 'parent_row');
insert into t2 (id, t1_id, t2_value) values (1, 1, 'child_row');
select * from t1;
id	value
1	parent_row
select * from t2;
id	t1_id	t2_value
1	1	child_row
update t1 set id = 2 where id = 1;
select * from t1;
id	value
2	parent_row
select * from t2;
id	t1_id	t2_value
1	NULL	updated by trigger
drop table t2;
drop table t1;
#
# Before update, indexes on virtual columns
#
create table t1(x int auto_increment primary key, y int, unique key(y)) engine=innodb;
create table t2(a int primary key, x int,
t int,
z varchar(20) as (concat("test", t)),
y varchar(20) as (concat("test2", t)),
y_another varchar(20) as (concat("test3", x)),
unique(z),
unique(y),
unique(y_another),
foreign key(x) references t1(y) on update cascade) engine=innodb;
create trigger tr before update on t2
for each row set new.t = 50;
insert into t1 (x,y) values (1,1);
insert into t2 (a,x,t) values (1,1,1);
select * from t2;
a	x	t	z	y	y_another
1	1	1	test1	test21	test31
update t1 set y = 2;
select * from t2 force index (z) where z = 'test50';
a	x	t	z	y	y_another
1	2	50	test50	test250	test32
select * from t2 force index (y) where y = 'test250';
a	x	t	z	y	y_another
1	2	50	test50	test250	test32
select * from t2 force index (y_another) where y_another = 'test32';
a	x	t	z	y	y_another
1	2	50	test50	test250	test32
select * from t2;
a	x	t	z	y	y_another
1	2	50	test50	test250	test32
drop table t2;
drop table t1;
#
# Before delete
#
create table t1 (
x int primary key
) engine=innodb;
create table t2 (
x int primary key,
y int,
foreign key(x) references t1(x) on delete cascade
) engine=innodb;
create trigger tr before delete on t2
for each row set @deleted_value = old.y;
insert into t1 (x) values (1);
insert into t2 (x, y) values (1, 100);
delete from t1 where x = 1;
select @deleted_value as deleted_value;
deleted_value
100
select * from t2;
x	y
drop table t2;
drop table t1;
#
# After, before delete
#
create table t1 (
x int primary key
) engine=innodb;
create table t2 (
x int primary key,
y int,
foreign key(x) references t1(x) on delete cascade
) engine=innodb;
create table t3 (
id int auto_increment primary key,
log_event varchar(255)
) engine=innodb;
create trigger tr_before before delete on t2
for each row
set @deleted_value = old.y;
create trigger tr_after after delete on t2
for each row
insert into t3 (log_event) values ('after delete trigger executed');
insert into t1 (x) values (1), (2);
insert into t2 (x, y) values (1, 100), (2, 200);
delete from t1 where x = 1;
select @deleted_value as before_deleted_value;
before_deleted_value
100
select * from t3;
id	log_event
1	after delete trigger executed
select * from t2;
x	y
2	200
select * from t1;
x
2
drop table t3;
drop table t2;
drop table t1;
#
# On delete set null
#
create table t1 (
id int primary key,
value varchar(50)
) engine=innodb;
create table t2 (
id int primary key,
t1_id int,
t2_value varchar(50),
foreign key (t1_id) references t1(id) on delete set null
) engine=innodb;
create trigger tr_t2_before_update before update on t2
for each row set new.t2_value = 'updated by trigger';
insert into t1 (id, value) values (1, 'parent_row');
insert into t2 (id, t1_id, t2_value) values (1, 1, 'child_row');
select * from t1;
id	value
1	parent_row
select * from t2;
id	t1_id	t2_value
1	1	child_row
delete from t1 where id = 1;
select * from t1;
id	value
select * from t2;
id	t1_id	t2_value
1	NULL	updated by trigger
drop table t2;
drop table t1;
#
# Cascade chain
#
create table t1 (
id int primary key
) engine=innodb;
create table t2 (
id int primary key,
foreign key (id) references t1(id) on update cascade
) engine=innodb;
create table t3 (
id int primary key,
foreign key (id) references t2(id) on update cascade
) engine=innodb;
create table update_log (
log_id int auto_increment primary key,
table_name varchar(50),
old_value int,
new_value int
) engine=innodb;
create trigger tr_t2_after_update after update on t2
for each row
insert into update_log(table_name, old_value, new_value)
values ('t2', old.id, new.id);
create trigger tr_t3_after_update after update on t3
for each row
insert into update_log(table_name, old_value, new_value)
values ('t3', old.id, new.id);
insert into t1 (id) values (1);
insert into t2 (id) values (1);
insert into t3 (id) values (1);
update t1 set id = 2;
select * from t1;
id
2
select * from t2;
id
2
select * from t3;
id
2
select * from update_log;
log_id	table_name	old_value	new_value
1	t3	1	2
2	t2	1	2
drop table update_log;
drop table t3;
drop table t2;
drop table t1;
#
# With bit fields
#
create table t1 (
id bit(8) primary key,
flag bit(1) not null default b'0'
) engine=innodb;
create table t2 (
id bit(8) primary key,
t1_id bit(8),
value int,
foreign key (t1_id) references t1(id) on update cascade
) engine=innodb;
create table trigger_log (
log_id int auto_increment primary key,
log_message varchar(255)
) engine=innodb;
create trigger tr_t2_after_update after update on t2
for each row
insert into trigger_log(log_message)
values (concat('t2 updated: ', hex(old.t1_id), ' -> ', hex(new.t1_id)));
insert into t1 (id, flag) values (b'00000001', b'1');
insert into t2 (id, t1_id, value) values (b'00000001', b'00000001', 100);
update t1 set id = b'00000010' where id = b'00000001';
select bin(id), bin(t1_id), value from t2;
bin(id)	bin(t1_id)	value
1	10	100
select * from trigger_log;
log_id	log_message
1	t2 updated: 1 -> 2
drop table trigger_log;
drop table t2;
drop table t1;
#
# With blobs
#
create table t1 (
id int primary key,
blob_data blob
) engine=innodb;
create table t2 (
id int primary key,
t1_id int,
copied_blob_data blob,
foreign key (t1_id) references t1(id) on delete cascade on update cascade
) engine=innodb;
create trigger tr_t2_before_update
before update on t2
for each row
set new.copied_blob_data = concat(old.copied_blob_data, repeat('-updated', 1250));
insert into t1 (id, blob_data) values (1, repeat('a', 1024));
insert into t2 (id, t1_id, copied_blob_data) values (1, 1, repeat('b', 1024));
select * from t2;
id	t1_id	copied_blob_data
1	1	bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
update t1 set id = 2 where id = 1;
select * from t2;
id	t1_id	copied_blob_data
1	2	bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated-updated
drop table t2;
drop table t1;
