SET @saved_change_buffering = @@GLOBAL.innodb_change_buffering;
SET @saved_file_per_table = @@GLOBAL.innodb_file_per_table;
SET @saved_change_buffering_debug = @@GLOBAL.innodb_change_buffering_debug;
SET GLOBAL innodb_change_buffering = NONE;
SET GLOBAL innodb_file_per_table = OFF;
CREATE TABLE t2(c1 INT AUTO_INCREMENT PRIMARY KEY,c2 CHAR(100))ENGINE=InnoDB;
CREATE INDEX i1 ON t2 (c2);
INSERT INTO t2(c2) VALUES('mariadb');
INSERT INTO t2(c2) SELECT c2 FROM t2;
INSERT INTO t2(c2) SELECT c2 FROM t2;
INSERT INTO t2(c2) SELECT c2 FROM t2;
INSERT INTO t2(c2) SELECT c2 FROM t2;
INSERT INTO t2(c2) SELECT c2 FROM t2;
CREATE TABLE t1(c1 INT AUTO_INCREMENT PRIMARY KEY,c2 CHAR(100))ENGINE=InnoDB;
CREATE INDEX i1 ON t1 (c2);
INSERT INTO t1(c2) VALUES('mariadb');
INSERT INTO t1(c2) SELECT c2 FROM t1;
INSERT INTO t1(c2) SELECT c2 FROM t1;
INSERT INTO t1(c2) SELECT c2 FROM t1;
INSERT INTO t1(c2) SELECT c2 FROM t1;
INSERT INTO t1(c2) SELECT c2 FROM t1;
SET GLOBAL innodb_change_buffering = all;
SET GLOBAL innodb_change_buffering_debug = 1;
SET DEBUG_DBUG='+d,ibuf_force_remove_free_page';
INSERT INTO t2(c2) SELECT c2 FROM t2 IGNORE INDEX (i1) LIMIT 4;
INSERT INTO t1(c2) SELECT c2 FROM t1 IGNORE INDEX (i1) LIMIT 4;
SET DEBUG_DBUG='-d,ibuf_force_remove_free_page';
SET GLOBAL innodb_change_buffering_debug = @saved_change_buffering_debug;
SET GLOBAL innodb_change_buffering = @saved_change_buffering;
DROP TABLE t2;
DROP TABLE t1;
SET GLOBAL innodb_file_per_table = @saved_file_per_table;
