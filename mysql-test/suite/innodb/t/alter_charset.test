--source include/have_innodb.inc
--source include/innodb_row_format.inc


SET NAMES utf8mb4;

CREATE TABLE basic (
  a VARCHAR(30) CHARSET utf8mb3,
  b CHAR(30) CHARSET utf8mb3,
  c TEXT CHARSET utf8mb3
  ) ENGINE=INNODB;
INSERT INTO basic VALUES
  ('Ð±Ð±Ð±', 'Ð±Ð±Ð±', 'Ð±Ð±Ð±'),
  ('Ð°Ð°Ð°', 'Ð°Ð°Ð°', 'Ð°Ð°Ð°'),
  ('Ð²Ð²Ð²', 'Ð²Ð²Ð²', 'Ð²Ð²Ð²');
--error ER_ALTER_OPERATION_NOT_SUPPORTED
ALTER TABLE basic MODIFY a VARCHAR(30) CHARSET koi8r, ALGORITHM=NOCOPY;
ALTER TABLE basic MODIFY a VARCHAR(30) CHARSET koi8r, ALGORITHM=INPLACE;
CHECK TABLE basic;
--error ER_ALTER_OPERATION_NOT_SUPPORTED
ALTER TABLE basic MODIFY b CHAR(30) CHARSET koi8r, ALGORITHM=NOCOPY;
ALTER TABLE basic MODIFY b CHAR(30) CHARSET koi8r, ALGORITHM=INPLACE;
CHECK TABLE basic;
--error ER_ALTER_OPERATION_NOT_SUPPORTED
ALTER TABLE basic MODIFY c TEXT CHARSET koi8r, ALGORITHM=NOCOPY;
ALTER TABLE basic MODIFY c TEXT CHARSET koi8r, ALGORITHM=INPLACE;
CHECK TABLE basic;
SELECT
  a, CONVERT(a USING utf8mb3),
  b, CONVERT(b USING utf8mb3),
  c, CONVERT(c USING utf8mb3) FROM basic;
--error ER_ALTER_OPERATION_NOT_SUPPORTED
ALTER TABLE basic CONVERT TO CHARSET utf8mb4, ALGORITHM=NOCOPY;
ALTER TABLE basic CONVERT TO CHARSET utf8mb4, ALGORITHM=INPLACE;
CHECK TABLE basic;
SELECT * FROM basic;
DROP TABLE basic;


CREATE TABLE t1 (
 a VARCHAR(1) COLLATE utf8_bin PRIMARY KEY,
 b VARCHAR(1) COLLATE utf8_bin UNIQUE,
 c VARCHAR(1) COLLATE utf8_bin,

 d CHAR(1) COLLATE utf8_bin UNIQUE,
 e CHAR(1) COLLATE utf8_bin
) ENGINE=InnoDB;
ALTER TABLE t1 MODIFY c VARCHAR(1) COLLATE utf8_general_ci, ALGORITHM=INSTANT;
ALTER TABLE t1 MODIFY b VARCHAR(1) COLLATE utf8_general_ci, ALGORITHM=INPLACE;
ALTER TABLE t1 MODIFY a VARCHAR(1) COLLATE utf8_general_ci, ALGORITHM=INPLACE;

ALTER TABLE t1 MODIFY e CHAR(1) COLLATE utf8_general_ci, ALGORITHM=INSTANT;
ALTER TABLE t1 MODIFY d CHAR(1) COLLATE utf8_general_ci, ALGORITHM=INPLACE;
DROP TABLE t1;


CREATE TABLE char_various (
  a CHAR(5) CHARSET utf8mb3,
  b CHAR(5) CHARSET utf8mb3
) ENGINE=INNODB;
INSERT INTO char_various VALUES ('Ð±Ð±Ð±Ð±Ð±', 'Ð±Ð±Ð±Ð±');
ALTER TABLE char_various CONVERT TO CHARSET koi8r, ALGORITHM=INPLACE;
SELECT * FROM char_various;
ALTER TABLE char_various CONVERT TO CHARSET utf8mb3, ALGORITHM=INPLACE;
SELECT * FROM char_various;
DROP TABLE char_various;


CREATE TABLE conversion_error (
  a CHAR(5) CHARSET utf8mb4
) ENGINE=INNODB;
INSERT INTO conversion_error VALUES ('Ð±Ð±ðŸ˜”Ð±Ð±');
SELECT * FROM conversion_error;
--error ER_TRUNCATED_WRONG_VALUE_FOR_FIELD
ALTER TABLE conversion_error CONVERT TO CHARSET koi8r, ALGORITHM=COPY;
--error ER_TRUNCATED_WRONG_VALUE_FOR_FIELD
ALTER TABLE conversion_error CONVERT TO CHARSET koi8r, ALGORITHM=INPLACE;
DROP TABLE conversion_error;

CREATE TABLE long_string_in_text (a TEXT CHARSET utf8mb4) ENGINE=INNODB;
INSERT INTO long_string_in_text VALUES ('The quick brown fox jumps over the lazy dog');
ALTER TABLE long_string_in_text MODIFY a TEXT CHARSET latin1;
SELECT * FROM long_string_in_text;
DROP TABLE long_string_in_text;


CREATE TABLE all_binaries (
  a TINYBLOB,
  b BLOB,
  c MEDIUMBLOB,
  d LONGBLOB,
  e VARBINARY(150),
  f BINARY(150)
) ENGINE=INNODB;

--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_binaries MODIFY a TINYTEXT, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_binaries MODIFY b TEXT, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_binaries MODIFY c MEDIUMTEXT, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_binaries MODIFY d LONGTEXT, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_binaries MODIFY e VARCHAR(150), ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_binaries MODIFY f CHAR(150), ALGORITHM=INPLACE;

DROP TABLE all_binaries;


CREATE TABLE all_strings (
  a TINYTEXT,
  b TEXT,
  c MEDIUMTEXT,
  d LONGTEXT,
  e VARCHAR(150),
  f CHAR(150)
) ENGINE=INNODB;

--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY a TINYBLOB, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY b BLOB, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY c MEDIUMBLOB, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY d LONGBLOB, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY e VARBINARY(150), ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY f BINARY(150), ALGORITHM=INPLACE;

--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY a TINYTEXT CHARSET binary, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY b TEXT CHARSET binary, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY c MEDIUMTEXT CHARSET binary, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY d LONGTEXT CHARSET binary, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY e VARCHAR(150) CHARSET binary, ALGORITHM=INPLACE;
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
ALTER TABLE all_strings MODIFY f CHAR(150) CHARSET binary, ALGORITHM=INPLACE;

DROP TABLE all_strings;
