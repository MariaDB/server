--source include/have_innodb.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc
#--source include/count_sessions.inc
--source ../encryption/include/have_file_key_management_plugin.inc
#--source include/innodb_page_size.inc

call mtr.add_suppression("InnoDB: There was IO error during writing to external buffer pool file");

--let IBDUMPFILE = `SELECT CONCAT(@@datadir, @@global.innodb_buffer_pool_filename)`

--let $unencrypted_uncompressed=6
--let $unencrypted_row_compressed=5
--let $unencrypted_page_compressed=4
--let $encrypted_uncompressed=3
--let $encrypted_row_compressed=2
--let $encrypted_page_compressed=1
--let $i=$unencrypted_uncompressed

--connect (prevent_purge,localhost,root)
START TRANSACTION WITH CONSISTENT SNAPSHOT;

--connection default

--let $DATADIR = `select @@datadir`
# Set ext buffer pool file size and check it was created, check it's size
--list_files $DATADIR ext_buffer_pool

--disable_query_log
--error 0,ER_UNKNOWN_SYSTEM_VARIABLE
SET @old_innodb_limit_optimistic_insert_debug = @@innodb_limit_optimistic_insert_debug;
SET @old_debug_dbug = @@debug_dbug;
--enable_query_log

--error 0,ER_UNKNOWN_SYSTEM_VARIABLE
SET GLOBAL innodb_limit_optimistic_insert_debug = 3;
SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_count_io_only_for_t';

while($i) {
  SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_disable_LRU_eviction_for_t';
  if ($i == $unencrypted_uncompressed) {
    --echo ###################################################################
    --echo # Testing for unencrypted uncompressed table                      #
    --echo ###################################################################
      CREATE TABLE t (
        `a` INT NOT NULL,
        PRIMARY KEY (`a`)
      ) ENGINE=InnoDB STATS_PERSISTENT=0;
  }
  if ($i == $encrypted_uncompressed) {
    --echo ###################################################################
    --echo # Testing for encrypted uncompressed table                        #
    --echo ###################################################################
      CREATE TABLE t (
        `a` INT NOT NULL,
        PRIMARY KEY (`a`)
      ) ENGINE=InnoDB STATS_PERSISTENT=0 encrypted=yes encryption_key_id=1;
  }
  if ($i == $unencrypted_page_compressed) {
    --echo ###################################################################
    --echo # Testing for unencrypted PAGE_COMPRESSED=1 table                 #
    --echo ###################################################################
      CREATE TABLE t (
        `a` INT NOT NULL,
        PRIMARY KEY (`a`)
      ) ENGINE=InnoDB STATS_PERSISTENT=0 PAGE_COMPRESSED=1;
  }
  if ($i == $unencrypted_row_compressed) {
    --echo ###################################################################
    --echo # Testing for unencrypted ROW_FORMAT=COMPRESSED table             #
    --echo ###################################################################
      CREATE TABLE t (
        `a` INT NOT NULL,
        PRIMARY KEY (`a`)
      ) ENGINE=InnoDB STATS_PERSISTENT=0 ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=1;
  }
  if ($i == $encrypted_page_compressed) {
    --echo ###################################################################
    --echo # Testing for encrypted PAGE_COMPRESSED=1 table                   #
    --echo ###################################################################
      CREATE TABLE t (
        `a` INT NOT NULL,
        PRIMARY KEY (`a`)
      ) ENGINE=InnoDB STATS_PERSISTENT=0 PAGE_COMPRESSED=1 encrypted=yes
        encryption_key_id=1;
  }
  if ($i == $encrypted_row_compressed) {
    --echo ###################################################################
    --echo # Testing for encrypted ROW_FORMAT=COMPRESSED table               #
    --echo ###################################################################
      CREATE TABLE t (
        `a` INT NOT NULL,
        PRIMARY KEY (`a`)
      ) ENGINE=InnoDB STATS_PERSISTENT=0 ROW_FORMAT=COMPRESSED encrypted=yes
        encryption_key_id=1;
  }

  --echo ### Test for write
  SELECT variable_value INTO @prev_flushed_gs
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
  SELECT PAGES_EXTERNALLY_WRITTEN INTO @prev_written_ps
    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;
  SELECT variable_value INTO @prev_reads_gs
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_READS';
  SELECT PAGES_EXTERNALLY_READ INTO @prev_reads_ps
    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;

  --eval SET @start_val = $i*100
  INSERT INTO t SET a = @start_val+1;
  INSERT INTO t SET a = @start_val+2;
  INSERT INTO t SET a = @start_val+3;
  INSERT INTO t SET a = @start_val+4;
  INSERT INTO t SET a = @start_val+5;
  INSERT INTO t SET a = @start_val+6;
  INSERT INTO t SET a = @start_val+7;
  INSERT INTO t SET a = @start_val+8;
  INSERT INTO t SET a = @start_val+9;
  INSERT INTO t SET a = @start_val+10;
  INSERT INTO t SET a = @start_val+11;
  INSERT INTO t SET a = @start_val+12;

  SET GLOBAL DEBUG_DBUG='-d,ib_ext_bp_disable_LRU_eviction_for_t';
  SET GLOBAL innodb_force_LRU_eviction = TRUE;

  --echo # Start waiting for flushed pages
  let $wait_condition =
  SELECT (variable_value-@prev_flushed_gs) >= 9
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
  --source include/wait_condition.inc
  --echo # Stop waiting for flushed pages

  --echo ### Test for synchronous read
  SELECT variable_value-@prev_flushed_gs
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
  SELECT PAGES_EXTERNALLY_WRITTEN-@prev_written_ps
    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;
  SELECT variable_value-@prev_reads_gs
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_READS';
  SELECT PAGES_EXTERNALLY_READ-@prev_reads_ps
    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;

  SELECT * FROM t;

  SELECT variable_value-@prev_flushed_gs
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
  SELECT PAGES_EXTERNALLY_WRITTEN-@prev_written_ps
    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;
  SELECT variable_value-@prev_reads_gs
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_READS';
  SELECT PAGES_EXTERNALLY_READ-@prev_reads_ps
    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;

  # Load buffer pool doesn't work for encrypted pages, compressed pages
  # contain frame=1, that's 
  if ($i >= $unencrypted_page_compressed) {
    --let $j=2
    while($j) {
      if ($j == 2) {
        --echo ### Test for asynchronous read
      }
      if ($j == 1) {
         --echo ### Test for asynchronous read for deleted space
      }

      SELECT variable_value INTO @prev_flushed_gs
        FROM information_schema.global_status
        WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';

      SET GLOBAL innodb_force_LRU_eviction = TRUE;

      let $wait_condition =
      SELECT (variable_value-@prev_flushed_gs) >= 7
        FROM information_schema.global_status
        WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
      --source include/wait_condition.inc

      SELECT variable_value INTO @prev_reads_gs
        FROM information_schema.global_status
        WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_READS';

      --let SPACE_ID=`SELECT space FROM information_schema.innodb_sys_tables WHERE name='test/t'`
      --echo # Write page id's to buffer pool dump file
      perl;
        my $fn = $ENV{'IBDUMPFILE'};
        my $space_id = $ENV{'SPACE_ID'};
        open(my $fh, '>', $fn) || die "perl open($fn): $!";
        print $fh "$space_id,3\n";
        print $fh "$space_id,8\n";
        print $fh "$space_id,9\n";
        print $fh "$space_id,4\n";
        print $fh "$space_id,5\n";
        print $fh "$space_id,6\n";
        print $fh "$space_id,7\n";
        print $fh "$space_id,10\n";
        close($fh);
      EOF

      if ($j == 1) {
        SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_remove_space_on_read_complete';
      }
      SET GLOBAL innodb_buffer_pool_load_now=ON;
      if ($j == 2) {
        --echo # Start waiting for the read pages
        let $wait_condition =
        SELECT (variable_value-@prev_reads_gs) >= 7
          FROM information_schema.global_status
          WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_READS';
        --source include/wait_condition.inc
        --echo # Stop waiting for read epages
      }
      if ($j == 1) {
        --echo # Waiting for read completion error message in error log
        --let SEARCH_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
        --let SEARCH_PATTERN= was freed after read completion to external buffer pool file because the page's space was removed
        --source include/wait_for_pattern_in_file.inc
        SET GLOBAL DEBUG_DBUG='-d,ib_ext_bp_remove_space_on_read_complete';
      }
      SELECT variable_value-@prev_reads_gs
        FROM information_schema.global_status
        WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_READS';
      --dec $j
    }

  --echo ### Testing for removing space between flush and write completion ###

  SELECT variable_value INTO @prev_flushed_gs
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
  SELECT PAGES_EXTERNALLY_WRITTEN INTO @prev_written_ps
    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;

  SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_remove_space_on_write_complete';
  SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_disable_LRU_eviction_for_t';
  SET @start_val = @start_val + 20;
  INSERT INTO t SET a = @start_val+1;
  INSERT INTO t SET a = @start_val+2;
  INSERT INTO t SET a = @start_val+3;
  INSERT INTO t SET a = @start_val+4;
  INSERT INTO t SET a = @start_val+5;
  INSERT INTO t SET a = @start_val+6;
  INSERT INTO t SET a = @start_val+7;
  INSERT INTO t SET a = @start_val+8;
  INSERT INTO t SET a = @start_val+9;
  INSERT INTO t SET a = @start_val+10;
  INSERT INTO t SET a = @start_val+11;
  INSERT INTO t SET a = @start_val+12;
  SET GLOBAL DEBUG_DBUG='-d,ib_ext_bp_disable_LRU_eviction_for_t';
  SET GLOBAL innodb_force_LRU_eviction = TRUE;

  --echo # Waiting for write completion error message in error log
  --let SEARCH_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
  --let SEARCH_PATTERN= was freed after write completion to external buffer pool file because the page's space was removed
  --source include/wait_for_pattern_in_file.inc

  SELECT variable_value-@prev_flushed_gs
    FROM information_schema.global_status
    WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
  SELECT PAGES_EXTERNALLY_WRITTEN-@prev_written_ps
    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;

  SET GLOBAL DEBUG_DBUG='-d,ib_ext_bp_remove_space_on_write_complete';

  }

  DROP TABLE t;
  --dec $i
}

--echo ###################################################################
--echo # Testing for io error on write completion                        #
--echo ###################################################################

SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_disable_LRU_eviction_for_t';

CREATE TABLE t (`a` INT NOT NULL, PRIMARY KEY (`a`))
  ENGINE=InnoDB STATS_PERSISTENT=0;

SELECT variable_value INTO @prev_flushed_gs
  FROM information_schema.global_status
  WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
SELECT PAGES_EXTERNALLY_WRITTEN INTO @prev_written_ps
  FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;

SET @start_val= 0; 
INSERT INTO t SET a = @start_val+1;
INSERT INTO t SET a = @start_val+2;
INSERT INTO t SET a = @start_val+3;
INSERT INTO t SET a = @start_val+4;
INSERT INTO t SET a = @start_val+5;
INSERT INTO t SET a = @start_val+6;
INSERT INTO t SET a = @start_val+7;
INSERT INTO t SET a = @start_val+8;
INSERT INTO t SET a = @start_val+9;
INSERT INTO t SET a = @start_val+10;
INSERT INTO t SET a = @start_val+11;
INSERT INTO t SET a = @start_val+12;
SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_write_io_error';
SET GLOBAL DEBUG_DBUG='-d,ib_ext_bp_disable_LRU_eviction_for_t';
SET GLOBAL innodb_force_LRU_eviction = TRUE;
--let SEARCH_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let SEARCH_PATTERN= There was IO error during writing to external buffer pool file
--source include/wait_for_pattern_in_file.inc
SET GLOBAL DEBUG_DBUG='-d,ib_ext_bp_write_io_error';

SELECT variable_value-@prev_flushed_gs
  FROM information_schema.global_status
  WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
SELECT PAGES_EXTERNALLY_WRITTEN-@prev_written_ps
  FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;

SELECT @@GLOBAL.INNODB_EXTENDED_BUFFER_POOL_SIZE;

--disconnect prevent_purge
--source include/restart_mysqld.inc

#--echo ###################################################################
#--echo # Testing for io error for synchronous read                       #
#--echo ###################################################################
#
#--connect (prevent_purge,localhost,root)
#START TRANSACTION WITH CONSISTENT SNAPSHOT;
#--connection default
#
#SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_disable_LRU_eviction_for_t';
#
#SELECT variable_value INTO @prev_flushed_gs
#  FROM information_schema.global_status
#  WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
#SELECT PAGES_EXTERNALLY_WRITTEN INTO @prev_written_ps
#  FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;
#
#SET @start_val= 100; 
#INSERT INTO t SET a = @start_val+1;
#INSERT INTO t SET a = @start_val+2;
#INSERT INTO t SET a = @start_val+3;
#INSERT INTO t SET a = @start_val+4;
#INSERT INTO t SET a = @start_val+5;
#INSERT INTO t SET a = @start_val+6;
#INSERT INTO t SET a = @start_val+7;
#INSERT INTO t SET a = @start_val+8;
#INSERT INTO t SET a = @start_val+9;
#INSERT INTO t SET a = @start_val+10;
#INSERT INTO t SET a = @start_val+11;
#INSERT INTO t SET a = @start_val+12;
#SET GLOBAL DEBUG_DBUG='-d,ib_ext_bp_disable_LRU_eviction_for_t';
#SET GLOBAL innodb_force_LRU_eviction = TRUE;
#
#--echo # Start waiting for flushed pages
#let $wait_condition =
#SELECT (variable_value-@prev_flushed_gs) >= 9
#  FROM information_schema.global_status
#  WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_PAGES_FLUSHED';
#--source include/wait_condition.inc
#--echo # Stop waiting for flushed pages
#
#SELECT variable_value INTO @prev_reads_gs
#  FROM information_schema.global_status
#  WHERE variable_name LIKE 'INNODB_EXT_BUFFER_POOL_READS';
#SELECT PAGES_EXTERNALLY_READ INTO @prev_reads_ps
#  FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;
#
#SET GLOBAL DEBUG_DBUG='+d,ib_ext_bp_read_io_error';
#SELECT * FROM t;
#
#--let SEARCH_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
#--let SEARCH_PATTERN= There was IO error during syncronous read from external buffer pool file
#--source include/wait_for_pattern_in_file.inc
#SET GLOBAL DEBUG_DBUG='-d,ib_ext_bp_read_io_error';
#
#SELECT @@GLOBAL.INNODB_EXTENDED_BUFFER_POOL_SIZE;
DROP TABLE t;
#
#--source include/restart_mysqld.inc

#--disable_query_log
#SET GLOBAL DEBUG_DBUG=@old_debug_dbug;
#--error 0,ER_UNKNOWN_SYSTEM_VARIABLE
#SET GLOBAL innodb_limit_optimistic_insert_debug = @old_innodb_limit_optimistic_insert_debug;
#--enable_query_log

#--disconnect prevent_purge
#--source include/wait_until_count_sessions.inc
