################################################################################
# This test is to test if mysqld can dump a core without large memory buffers.
# See opt file for the config:
#   (1) --skip-innodb-buffer-pool-in-core-file is set
#   (2) the buffer pool is set to be 1280MB initially, shrink it to 1024MB, then
#       expand it back to 2048MB, then back to original 1280MB.
#       With the large memory buffers the core size will be much greater than 1GB
#       (the actual observed size is ~2.2.G) and without them it will be smaller
#       than 1GB (actually ~770MB)

# madvise MADV_DONTDUMP is non-posix extension available in Linux 3.4
--let $minimum_required_linux_version = 3.4
--source include/linux-version.inc
--source include/have_innodb.inc
--source include/not_valgrind.inc

# Embedded mode doesn't support restart
--source include/not_embedded.inc

--echo # Shutdown server
--source include/shutdown_mysqld.inc

--echo # Restart server with --log-error
--exec echo "restart:--log-error=$MYSQLTEST_VARDIR/log/core_dump_with_resizing.err" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc

--disable_query_log
set @old_innodb_buffer_pool_size = @@innodb_buffer_pool_size;
--enable_query_log

# Shrink buffer pool to 500MB
set global innodb_buffer_pool_size = 512*1024*1024;

# Expand buffer pool back to 2GB
set global innodb_buffer_pool_size = 2048*1024*1024;

# Resize buffer pool back to original 1280MB
--disable_query_log
set global innodb_buffer_pool_size = @old_innodb_buffer_pool_size;
--enable_query_log

SHOW VARIABLES LIKE '%core%';

--let $expected_max_core_size = 1024
--source include/mysqld_core_dump.inc
