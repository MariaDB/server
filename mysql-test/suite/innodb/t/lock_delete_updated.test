--source include/have_innodb.inc
--source include/count_sessions.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc

CREATE TABLE t(a INT PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t VALUES (3);

BEGIN;
UPDATE t SET a = 2;

connect con1,localhost,root;
SET DEBUG_SYNC="lock_wait_start SIGNAL del_locked";
send DELETE FROM t;

connection default;
SET DEBUG_SYNC="now WAIT_FOR del_locked";
UPDATE t SET a = 1;
COMMIT;

connection con1;
reap;
disconnect con1;

connection default;
--echo # The UPDATE changes the PK from 3 to 2 to 1, moving the row behind
--echo # the DELETE scan cursor. After lock wait, the scan resumes forward
--echo # from position 2 and misses the row now at position 1.
SELECT count(*) FROM t;
SET DEBUG_SYNC="reset";
DROP TABLE t;
--source include/wait_until_count_sessions.inc
