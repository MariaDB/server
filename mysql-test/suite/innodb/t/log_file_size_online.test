--source include/have_innodb.inc
--source include/have_sequence.inc
--source include/no_valgrind_without_big.inc

--disable_query_log
call mtr.add_suppression("Plugin 'InnoDB' registration as a STORAGE ENGINE failed");
call mtr.add_suppression("InnoDB: innodb_log_write_ahead_size=\\d+ is not");
--enable_query_log

let SEARCH_FILE = $MYSQLTEST_VARDIR/log/mysqld.1.err;

SET GLOBAL innodb_log_file_size=4194304;
SHOW VARIABLES LIKE 'innodb_log_file_size';
SELECT global_value FROM information_schema.system_variables
WHERE variable_name = 'innodb_log_file_size';

CREATE TABLE t (
  a INT PRIMARY KEY AUTO_INCREMENT,
  b CHAR(255) NOT NULL)
ENGINE=INNODB;

INSERT INTO t SELECT NULL, REPEAT('a', 255) FROM seq_1_to_20000;

let $check_no_innodb=SELECT * FROM INFORMATION_SCHEMA.ENGINES
WHERE engine = 'innodb'
AND support IN ('YES', 'DEFAULT', 'ENABLED');
--let $restart_parameters=--innodb-log-file-size=4198400 --innodb-log-buffer-size=2m --innodb-log-write-ahead-size=4m
--source include/restart_mysqld.inc
eval $check_no_innodb;
--let $restart_parameters=--innodb-log-file-size=4198400 --innodb-log-buffer-size=4m --innodb-log-write-ahead-size=4m
--source include/restart_mysqld.inc
eval $check_no_innodb;
--let $restart_parameters=--innodb-log-file-size=4198400 --innodb-log-write-ahead-size=8193
--source include/restart_mysqld.inc
eval $check_no_innodb;
--let $restart_parameters=--innodb-log-file-size=4198400 --innodb-log-write-ahead-size=8192
--source include/restart_mysqld.inc
eval $check_no_innodb;
--let $restart_parameters=--innodb-log-file-size=4198400 --innodb-log-write-ahead-size=4096
--source include/restart_mysqld.inc

SELECT COUNT(*) FROM t;

SHOW VARIABLES LIKE 'innodb_log_file_size';
let SEARCH_PATTERN = InnoDB: InnoDB: innodb_log_write_ahead_size=\\d+ is not;
--source include/search_pattern_in_file.inc
let SEARCH_PATTERN = InnoDB: Resized log to 4\\.000MiB;
--source include/search_pattern_in_file.inc

UPDATE t SET b='' WHERE a<10;

--error ER_WRONG_ARGUMENTS
SET GLOBAL innodb_log_write_ahead_size=16384;
SELECT @@GLOBAL.innodb_log_write_ahead_size;
SET GLOBAL innodb_log_file_size=5251072;
SET GLOBAL innodb_log_write_ahead_size=8192;
SELECT @@GLOBAL.innodb_log_write_ahead_size;
SHOW VARIABLES LIKE 'innodb_log_file_size';
SELECT global_value FROM information_schema.system_variables
WHERE variable_name = 'innodb_log_file_size';
SET GLOBAL innodb_log_write_ahead_size=4096;
--error ER_WRONG_ARGUMENTS
SET GLOBAL innodb_log_write_ahead_size=16384;
SET GLOBAL innodb_log_write_ahead_size=8192;
SELECT @@GLOBAL.innodb_log_write_ahead_size;

--let $restart_parameters=
--source include/restart_mysqld.inc

SELECT * FROM t WHERE a<10;

SHOW VARIABLES LIKE 'innodb_log_file_size';
let SEARCH_PATTERN = InnoDB: Resized log to 5\\.008MiB;
--source include/search_pattern_in_file.inc

DROP TABLE t;
