--source include/have_innodb.inc

--disable_warnings
DROP TABLE IF EXISTS t3, t2, t1;
--enable_warnings

CREATE TABLE t1 (
    id INT PRIMARY KEY,
    blob_data BLOB
) ENGINE=InnoDB;

CREATE TABLE t2 (
    id INT PRIMARY KEY,
    t1_id INT,
    copied_blob_data BLOB,
    FOREIGN KEY (t1_id) REFERENCES t1(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE t3 (
    id INT AUTO_INCREMENT PRIMARY KEY,
    log_event BLOB
) ENGINE=InnoDB;

CREATE TRIGGER tr_t2_before_update
BEFORE UPDATE ON t2
FOR EACH ROW
SET NEW.copied_blob_data = CONCAT(OLD.copied_blob_data, REPEAT('-updated', 12500)); 

CREATE TRIGGER tr_t2_after_delete
AFTER DELETE ON t2
FOR EACH ROW
INSERT INTO t3 (log_event) VALUES (CONCAT('Deleted row with BLOB: ',OLD.copied_blob_data)); 

INSERT INTO t1 (id, blob_data) VALUES (1, REPEAT('A', 1024));
INSERT INTO t2 (id, t1_id, copied_blob_data) VALUES (1, 1, REPEAT('B', 10240));

SELECT * FROM t2;
#UPDATE t1 SET id = 2 WHERE id = 1;

#Not cascade update - returning correct error
UPDATE t2 SET id = 2 WHERE id = 1; 
SELECT * FROM t2;

#DELETE FROM t1 WHERE id = 2;
#SELECT * FROM t3;

DROP TABLE t3, t2, t1;
