# Connection delay tests for valid user accounts

# ----------------------------------------------------------------------

# Setup
# Create user accounts for testing
CREATE USER u1 IDENTIFIED BY 'abcd';
CREATE USER u2 IDENTIFIED BY 'abcd';
CREATE USER u3 IDENTIFIED BY 'abcd';

# ----------------------------------------------------------------------

# Make enough failed attempts to trigger delays
connect(localhost,u1,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,,,,,;
connect(localhost,u1,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,haha,,,,;
connect(localhost,u1,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u1, localhost, u1,haha,,,,;
connect(localhost,u2,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,efgh,,,,;
connect(localhost,u2,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,,,,,;
connect(localhost,u2,haha,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u2, localhost, u2,haha,,,,;
connect(localhost,u3,,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,,,,,;
connect(localhost,u3,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,efgh,,,,;
connect(localhost,u3,efgh,test,MASTER_PORT,MASTER_SOCKET);
connect fail_con_u3, localhost, u3,efgh,,,,;

# Following attempts will not experience delay in server response , because connection delay is disabled by default
connection default;
# Connection attempt should fail.
NOT FOUND /u1@localhost wait 1000 milliseconds/ in mysqld.1.err
connection default;
# Connection attempt should fail.
NOT FOUND /u2@localhost wait 1000 milliseconds/ in mysqld.1.err
connection default;
# Connection attempt should fail.
NOT FOUND /u3@localhost wait 1000 milliseconds/ in mysqld.1.err
connection default;
# Connection attempt should succeed.
NOT FOUND /u3@localhost wait 1000 milliseconds/ in mysqld.1.err
connection default;
# Connection attempt should succeed.
NOT FOUND /u2@localhost wait 1000 milliseconds/ in mysqld.1.err
connection default;
# Connection attempt should succeed.
NOT FOUND /u1@localhost wait 1000 milliseconds/ in mysqld.1.err

# ----------------------------------------------------------------------

# Cleanup
connection default;
# Remove user accounts created for the test
DROP USER u1;
DROP USER u2;
DROP USER u3;

# ----------------------------------------------------------------------
