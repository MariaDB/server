--source include/have_innodb.inc
--source include/have_plugin_auth.inc
--source include/not_embedded.inc

if (!$SERVER_AUDIT_SO) {
  skip No SERVER_AUDIT plugin;
}

# An unfortunate wait for check-testcase.inc to complete disconnect.
let count_sessions= 1;
source include/wait_until_count_sessions.inc;

let $MYSQLD_DATADIR= `SELECT @@datadir`;
let SEARCH_FILE= $MYSQLD_DATADIR/server_audit_seqnum.log;

# Install the plugin and configure it exactly as in the JIRA ticket
install plugin server_audit soname 'server_audit';

set global server_audit_mode=0;
set global server_audit_file_path='server_audit_seqnum.log';
set global server_audit_output_type=file;
set global server_audit_events='QUERY';
set global server_audit_logging=on;

USE test;

CREATE TABLE source (
  id bigint(20) NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE dest (
  id bigint(20) NOT NULL,
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE dest_2 (
  id bigint(20) NOT NULL,
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

DELIMITER //;
CREATE TRIGGER test_trigger
AFTER INSERT ON source
FOR EACH ROW
INSERT INTO dest (id) VALUES(NEW.id)//
DELIMITER ;//

DELIMITER //;
CREATE TRIGGER test_trigger_2
AFTER INSERT ON dest
FOR EACH ROW
INSERT INTO dest_2 (id) VALUES(NEW.id)//
DELIMITER ;//

DELIMITER //;
CREATE PROCEDURE test_procedure (IN id bigint(20))
NOT DETERMINISTIC MODIFIES SQL DATA
BEGIN
  INSERT INTO source VALUES (id), (NULL);
END;//
DELIMITER ;//

--echo # Insert a row to trigger the AFTER trigger
INSERT INTO source VALUES (NULL);

--echo # Insert another row to see the pattern
INSERT INTO source VALUES (NULL);

--echo # Test with multi-row insert
INSERT INTO source VALUES (NULL), (NULL);

--echo # Test with stored procedure
CALL test_procedure(NULL);

--echo # Clean up
DROP PROCEDURE test_procedure;
DROP TABLE source, dest, dest_2;

--echo # Wait for audit events to be written
--let SEARCH_FILE = $MYSQLD_DATADIR/server_audit_seqnum.log
--let SEARCH_PATTERN = DROP TABLE source, dest
--source include/search_pattern_in_file.inc

set global server_audit_logging=off;
uninstall plugin server_audit;

# Output the log without heavy replacements so we can see the actual order
--replace_regex /\d\d\d\d\d\d\d\d \d\d:\d\d:\d\d/TIMESTAMP/ /\,[^,]+,root,localhost,/,HOSTNAME,root,localhost,/
cat_file $MYSQLD_DATADIR/server_audit_seqnum.log;
remove_file $MYSQLD_DATADIR/server_audit_seqnum.log;
