#
# Setup
#
INSTALL PLUGIN IF NOT EXISTS cleartext_plugin_server SONAME '';
Warnings:
Note	1968	Plugin 'cleartext_plugin_server' already installed
CREATE DATABASE mdev38431_db;
#
# Test 1: Short password - baseline test
#
CREATE USER shortuser IDENTIFIED VIA cleartext_plugin_server USING 'secret';
GRANT ALL ON *.* TO shortuser;
db
mdev38431_db
#
# Test 2: Long password 260 bytes (triggers 3-byte LENENC)
# Before fix: ERROR 1044 Access denied to database 'X' (garbage char)
# After fix: Connects to mdev38431_db correctly
#
CREATE USER longuser IDENTIFIED VIA cleartext_plugin_server USING 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa';
GRANT ALL ON *.* TO longuser;
db
mdev38431_db
#
# Test 3: Even longer password 500 bytes
#
CREATE USER verylonguser IDENTIFIED VIA cleartext_plugin_server USING 'bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb';
GRANT ALL ON *.* TO verylonguser;
db
mdev38431_db
#
# Test 4: COM_CHANGE_USER with short password
# Verify mysql_change_user() works correctly with database parameter
#
CREATE USER changeusertest IDENTIFIED VIA cleartext_plugin_server USING 'changepwd';
GRANT ALL ON *.* TO changeusertest;
SELECT DATABASE() AS db;
db
mdev38431_db
#
# Test 5: COM_CHANGE_USER with long password (260 bytes)
# This works because auth plugin switching sends password in a SECOND packet
# (via ma_net_write), bypassing the 255-byte limit in send_change_user_packet()
#
# Note: If connection used cleartext directly (no auth switch), it would fail
# due to libmariadb's 255-byte limit in send_change_user_packet()
#
CREATE USER changeuserlongpwd IDENTIFIED VIA cleartext_plugin_server USING 'cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc';
GRANT ALL ON *.* TO changeuserlongpwd;
SELECT DATABASE() AS db;
db
mdev38431_db
#
# Test 6: COM_CHANGE_USER with long password - no auth switch
# Connection uses cleartext directly, password goes in first packet
# Requires LENENC support in both client and server for COM_CHANGE_USER
#
connect  cleartext_con, 127.0.0.1, changeuserlongpwd, $change_pwd, mdev38431_db, $MASTER_MYPORT, , , mysql_clear_password;
SELECT DATABASE() AS db;
db
mdev38431_db
SELECT CURRENT_USER() AS user;
user
changeuserlongpwd@%
SELECT DATABASE() AS db;
db
mdev38431_db
connection default;
disconnect cleartext_con;
#
# Cleanup
#
DROP USER shortuser, longuser, verylonguser, changeusertest, changeuserlongpwd;
DROP DATABASE mdev38431_db;
