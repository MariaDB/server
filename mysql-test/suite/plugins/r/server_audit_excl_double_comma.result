#
# Test for double comma handling in SERVER_AUDIT_EXCL_USERS
# Bug: Double commas (e.g., 'user1,,user2') cause incorrect exclusion behavior
# Expected: Only user1 and user2 should be excluded from logging
#
CREATE USER 'audit_user1'@'localhost' IDENTIFIED BY 'password1';
CREATE USER 'audit_user2'@'localhost' IDENTIFIED BY 'password2';
CREATE USER 'audit_user3'@'localhost' IDENTIFIED BY 'password3';
GRANT ALL ON *.* TO 'audit_user1'@'localhost';
GRANT ALL ON *.* TO 'audit_user2'@'localhost';
GRANT ALL ON *.* TO 'audit_user3'@'localhost';
#
# Install the audit plugin
#
INSTALL PLUGIN server_audit SONAME 'server_audit';
#
# Set up audit log file
#
#
# Configure audit with double comma in excl_users
# user1 and user2 should be EXCLUDED (not logged)
# user3 should be INCLUDED (logged)
#
SET GLOBAL server_audit_logging = OFF;
SET GLOBAL server_audit_events = 'QUERY';
SET GLOBAL server_audit_file_path = 'server_audit_excl_double_comma.log';
SET GLOBAL server_audit_output_type = 'FILE';
SET GLOBAL server_audit_excl_users = 'audit_user1,,audit_user2';
SET GLOBAL server_audit_logging = ON;
#
# Connect as user1 - should NOT be logged (excluded)
#
connect  conn1, localhost, audit_user1, password1,;
SELECT 'query_from_user1_EXCLUDED';
query_from_user1_EXCLUDED
query_from_user1_EXCLUDED
disconnect conn1;
#
# Connect as user2 - should NOT be logged (excluded)
#
connect  conn2, localhost, audit_user2, password2,;
SELECT 'query_from_user2_EXCLUDED';
query_from_user2_EXCLUDED
query_from_user2_EXCLUDED
disconnect conn2;
#
# Connect as user3 - SHOULD be logged (not in excl_users)
#
connect  conn3, localhost, audit_user3, password3,;
SELECT 'query_from_user3_SHOULD_LOG';
query_from_user3_SHOULD_LOG
query_from_user3_SHOULD_LOG
disconnect conn3;
connection default;
#
# Cleanup
#
SET GLOBAL server_audit_logging = OFF;
UNINSTALL PLUGIN server_audit;
Warnings:
Warning	1620	Plugin is busy and will be uninstalled on shutdown
DROP USER 'audit_user1'@'localhost';
DROP USER 'audit_user2'@'localhost';
DROP USER 'audit_user3'@'localhost';
#
# Verify audit log - only user3 queries should appear
#
# The audit log should contain queries from user3 only
# user1 and user2 are excluded and should NOT appear
# If the bug exists, user1 and user2 queries will also appear
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = ON',0
TIME,HOSTNAME,audit_user3,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SELECT \'query_from_user3_SHOULD_LOG\'',0
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = OFF',0
#
# Remove the temporary audit log
#
# Test completed - excl_users double comma handling verified
