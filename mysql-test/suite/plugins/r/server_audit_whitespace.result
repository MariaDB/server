
=======================================================================
Test for whitespace handling in SERVER_AUDIT_INCL_USERS
Bug: Whitespace around commas with empty tokens causes all users logged
Expected: Only specified users should be logged
=======================================================================
CREATE USER 'audit_user1'@'localhost' IDENTIFIED BY 'password1';
CREATE USER 'audit_user2'@'localhost' IDENTIFIED BY 'password2';
CREATE USER 'audit_user3'@'localhost' IDENTIFIED BY 'password3';
GRANT ALL ON *.* TO 'audit_user1'@'localhost';
GRANT ALL ON *.* TO 'audit_user2'@'localhost';
GRANT ALL ON *.* TO 'audit_user3'@'localhost';

=======================================================================
Install the audit plugin
=======================================================================
INSTALL PLUGIN server_audit SONAME 'server_audit';

=======================================================================
Set up audit log file
=======================================================================

=======================================================================
TEST 1: Whitespace around commas - 'user1 , user2'
=======================================================================
SET GLOBAL server_audit_logging = OFF;
SET GLOBAL server_audit_events = 'QUERY';
SET GLOBAL server_audit_file_path = 'server_audit_whitespace1.log';
SET GLOBAL server_audit_output_type = 'FILE';
SET GLOBAL server_audit_incl_users = 'audit_user1 , audit_user2';
SET GLOBAL server_audit_logging = ON;
connect  conn1a, localhost, audit_user1, password1,;
SELECT 'whitespace1_test_user1';
whitespace1_test_user1
whitespace1_test_user1
disconnect conn1a;
connect  conn3a, localhost, audit_user3, password3,;
SELECT 'whitespace1_test_user3_NOT_in_list';
whitespace1_test_user3_NOT_in_list
whitespace1_test_user3_NOT_in_list
disconnect conn3a;
connection default;
SET GLOBAL server_audit_logging = OFF;
# Whitespace test 1 - user3 should NOT appear:
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = ON',0
TIME,HOSTNAME,audit_user1,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SELECT \'whitespace1_test_user1\'',0
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = OFF',0

=======================================================================
TEST 2: Whitespace with empty tokens - 'user1  ,   ,  user2'
=======================================================================
SET GLOBAL server_audit_file_path = 'server_audit_whitespace2.log';
SET GLOBAL server_audit_incl_users = 'audit_user1  ,   ,  audit_user2';
SET GLOBAL server_audit_logging = ON;
connect  conn1b, localhost, audit_user1, password1,;
SELECT 'whitespace2_test_user1';
whitespace2_test_user1
whitespace2_test_user1
disconnect conn1b;
connect  conn3b, localhost, audit_user3, password3,;
SELECT 'whitespace2_test_user3_NOT_in_list';
whitespace2_test_user3_NOT_in_list
whitespace2_test_user3_NOT_in_list
disconnect conn3b;
connection default;
SET GLOBAL server_audit_logging = OFF;
# Whitespace test 2 - user3 should NOT appear:
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = ON',0
TIME,HOSTNAME,audit_user1,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SELECT \'whitespace2_test_user1\'',0
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = OFF',0

=======================================================================
Cleanup
=======================================================================
UNINSTALL PLUGIN server_audit;
Warnings:
Warning	1620	Plugin is busy and will be uninstalled on shutdown
DROP USER 'audit_user1'@'localhost';
DROP USER 'audit_user2'@'localhost';
DROP USER 'audit_user3'@'localhost';
# Test completed - whitespace handling verified
