
=======================================================================
Test for leading and trailing commas in SERVER_AUDIT_INCL_USERS
Bug: Edge commas (e.g., ',user1,user2,') cause all users to be logged
Expected: Only user1 and user2 should be logged
=======================================================================
CREATE USER 'audit_user1'@'localhost' IDENTIFIED BY 'password1';
CREATE USER 'audit_user2'@'localhost' IDENTIFIED BY 'password2';
CREATE USER 'audit_user3'@'localhost' IDENTIFIED BY 'password3';
GRANT ALL ON *.* TO 'audit_user1'@'localhost';
GRANT ALL ON *.* TO 'audit_user2'@'localhost';
GRANT ALL ON *.* TO 'audit_user3'@'localhost';

=======================================================================
Install the audit plugin
=======================================================================
INSTALL PLUGIN server_audit SONAME 'server_audit';

=======================================================================
Set up audit log file
=======================================================================

=======================================================================
TEST 1: Leading comma - ',user1,user2'
=======================================================================
SET GLOBAL server_audit_logging = OFF;
SET GLOBAL server_audit_events = 'QUERY';
SET GLOBAL server_audit_file_path = 'server_audit_edge_commas_leading.log';
SET GLOBAL server_audit_output_type = 'FILE';
SET GLOBAL server_audit_incl_users = ',audit_user1,audit_user2';
SET GLOBAL server_audit_logging = ON;
connect  conn1a, localhost, audit_user1, password1,;
SELECT 'leading_test_user1';
leading_test_user1
leading_test_user1
disconnect conn1a;
connect  conn3a, localhost, audit_user3, password3,;
SELECT 'leading_test_user3_NOT_in_list';
leading_test_user3_NOT_in_list
leading_test_user3_NOT_in_list
disconnect conn3a;
connection default;
SET GLOBAL server_audit_logging = OFF;
# Leading comma test - user3 should NOT appear:
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = ON',0
TIME,HOSTNAME,audit_user1,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SELECT \'leading_test_user1\'',0
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = OFF',0

=======================================================================
TEST 2: Trailing comma - 'user1,user2,'
=======================================================================
SET GLOBAL server_audit_file_path = 'server_audit_edge_commas_trailing.log';
SET GLOBAL server_audit_incl_users = 'audit_user1,audit_user2,';
SET GLOBAL server_audit_logging = ON;
connect  conn1b, localhost, audit_user1, password1,;
SELECT 'trailing_test_user1';
trailing_test_user1
trailing_test_user1
disconnect conn1b;
connect  conn3b, localhost, audit_user3, password3,;
SELECT 'trailing_test_user3_NOT_in_list';
trailing_test_user3_NOT_in_list
trailing_test_user3_NOT_in_list
disconnect conn3b;
connection default;
SET GLOBAL server_audit_logging = OFF;
# Trailing comma test - user3 should NOT appear:
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = ON',0
TIME,HOSTNAME,audit_user1,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SELECT \'trailing_test_user1\'',0
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = OFF',0

=======================================================================
TEST 3: Both leading and trailing commas - ',user1,user2,'
=======================================================================
SET GLOBAL server_audit_file_path = 'server_audit_edge_commas_both.log';
SET GLOBAL server_audit_incl_users = ',audit_user1,audit_user2,';
SET GLOBAL server_audit_logging = ON;
connect  conn1c, localhost, audit_user1, password1,;
SELECT 'both_test_user1';
both_test_user1
both_test_user1
disconnect conn1c;
connect  conn3c, localhost, audit_user3, password3,;
SELECT 'both_test_user3_NOT_in_list';
both_test_user3_NOT_in_list
both_test_user3_NOT_in_list
disconnect conn3c;
connection default;
SET GLOBAL server_audit_logging = OFF;
# Both commas test - user3 should NOT appear:
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = ON',0
TIME,HOSTNAME,audit_user1,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SELECT \'both_test_user1\'',0
TIME,HOSTNAME,root,localhost,CONNECTION_ID,QUERY_ID,QUERY,test,'SET GLOBAL server_audit_logging = OFF',0

=======================================================================
Cleanup
=======================================================================
UNINSTALL PLUGIN server_audit;
Warnings:
Warning	1620	Plugin is busy and will be uninstalled on shutdown
DROP USER 'audit_user1'@'localhost';
DROP USER 'audit_user2'@'localhost';
DROP USER 'audit_user3'@'localhost';
# Test completed - edge commas handling verified
