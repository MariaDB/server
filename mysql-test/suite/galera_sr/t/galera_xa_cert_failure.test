#
# Test certification failure on XA PREPARE
#

--source include/galera_cluster.inc

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY, f2 CHAR(64)) ENGINE=InnoDB;

--connection node_1
XA START 'test';
INSERT INTO t1 VALUES (1, 'node_1');
XA END 'test';

#
# Issue conflicting operation on node_2 and block it in apply monitor
# (this transaction is certified, but not applied yet)
#
--connection node_1a
SET SESSION wsrep_sync_wait=0;
--let $galera_sync_point = apply_monitor_slave_enter_sync
--source include/galera_set_sync_point.inc

--connection node_2
INSERT INTO t1 VALUES (1, 'node_2');

--connection node_1a
--source include/galera_wait_sync_point.inc
--source include/galera_clear_sync_point.inc

#
# Issue XA PREPARE and wait for it to replicate (it will fail certification)
#
--let $galera_sync_point = after_replicate_sync
--source include/galera_set_sync_point.inc

--connection node_1
--send XA PREPARE 'test';

--connection node_1a
--let $galera_sync_point = after_replicate_sync apply_monitor_slave_enter_sync
--source include/galera_wait_sync_point.inc
--source include/galera_clear_sync_point.inc

#
# Release both threads
#
--let $galera_sync_point = apply_monitor_slave_enter_sync
--source include/galera_signal_sync_point.inc
--source include/galera_clear_sync_point.inc

--let $galera_sync_point = after_replicate_sync
--source include/galera_signal_sync_point.inc
--source include/galera_clear_sync_point.inc

#
# XA PREPARE is expected to report certification failure
#
--connection node_1
--error ER_XA_RBDEADLOCK
--reap

XA ROLLBACK 'test';
SELECT * FROM t1;

--connection node_2
SELECT * FROM t1;

DROP TABLE t1;
