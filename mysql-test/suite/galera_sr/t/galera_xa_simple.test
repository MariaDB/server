--source include/galera_cluster.inc

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1

#
# Test A: XA transaction replicates a fragment on XA PREPARE
#

--connection node_1
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY);

XA START 'test';
INSERT INTO t1 VALUES (10);
XA END 'test';
XA PREPARE 'test';

# Expect one fragment after XA PREPARE
--connection node_1a
SELECT COUNT(*) `expect 1` FROM mysql.wsrep_streaming_log;

--connection node_2
--echo expect empty set
SELECT * FROM t1;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
--echo expect 10
SELECT * FROM t1;
SELECT COUNT(*) `expect 1` FROM mysql.wsrep_streaming_log;

--connection node_1
XA COMMIT 'test';
--echo expect 10
SELECT * FROM t1;
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_2
--echo expect 10
SELECT * FROM t1;
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_1
DROP TABLE t1;
