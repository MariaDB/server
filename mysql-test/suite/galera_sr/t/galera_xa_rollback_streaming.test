#
# Tests for XA rollback with streaming enabled
#

--source include/galera_cluster.inc

--connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1

#
# Test A: Rollback XA transaction after XA PREPARE
#

--connection node_1
SET SESSION wsrep_trx_fragment_size=1;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY);

XA START 'test';
INSERT INTO t1 VALUES (1);
XA END 'test';
XA PREPARE 'test';

# Expect a fragment after XA PREPARE
--connection node_1a
SELECT COUNT(*) `expect 1` FROM mysql.wsrep_streaming_log;

--connection node_2
SELECT COUNT(*) `expect 1` FROM mysql.wsrep_streaming_log;

--connection node_1
XA ROLLBACK 'test';

SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_2
SELECT * FROM t1;
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

DROP TABLE t1;


#
# Test B: Rollback XA transaction before XA PREPARE
#

--connection node_1
SET SESSION wsrep_trx_fragment_size=1;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY);

XA START 'test';
INSERT INTO t1 VALUES (1);
XA END 'test';

--connection node_2
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_1
XA ROLLBACK 'test';
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_2
SELECT * FROM t1;
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

DROP TABLE t1;


#
# Test C: Rollback XA transaction before XA END should error
#

--connection node_1
SET SESSION wsrep_trx_fragment_size=1;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY);

XA START 'test';
INSERT INTO t1 VALUES (1);

--connection node_2
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_1
--error ER_XAER_RMFAIL
XA ROLLBACK 'test';
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_2
SELECT * FROM t1;
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_1
XA END 'test';
XA ROLLBACK 'test';
DROP TABLE t1;


#
# Test D: Rollback XA transaction after XA PREPARE (streaming replication enabled)
#

--connection node_1
SET SESSION wsrep_trx_fragment_size=1;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY);

# Explicitly set fragmentation before XA START
SET SESSION wsrep_trx_fragment_size=1;

XA START 'test';
INSERT INTO t1 VALUES (1);
XA END 'test';
XA PREPARE 'test';

# Expect two fragments after XA PREPARE
--connection node_1a
SELECT COUNT(*) `expect 2` FROM mysql.wsrep_streaming_log;

--connection node_2
SELECT COUNT(*) `expect 2` FROM mysql.wsrep_streaming_log;

--connection node_1
XA ROLLBACK 'test';

SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_2
SELECT * FROM t1;
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

DROP TABLE t1;


#
# Test E: Rollback XA transaction before XA PREPARE
#

--connection node_1
SET SESSION wsrep_trx_fragment_size=1;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY);

# Explicitly set fragmentation before XA START
SET SESSION wsrep_trx_fragment_size=1;

XA START 'test';
INSERT INTO t1 VALUES (1);
XA END 'test';

--connection node_2
SELECT COUNT(*) `expect 1` FROM mysql.wsrep_streaming_log;

--connection node_1
XA ROLLBACK 'test';
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

--connection node_1a
SELECT * FROM t1;

--connection node_2
SELECT * FROM t1;
SELECT COUNT(*) `expect 0` FROM mysql.wsrep_streaming_log;

DROP TABLE t1;
