#
# This test checks that denies take part in SHOW commands properly.
#
create user foo;
create database some_db;
create table some_db.t1 (id int);
connect  con1,localhost,foo,,;
show tables from some_db;
ERROR 42000: Access denied for user 'foo'@'%' to database 'some_db'
disconnect con1;
connection default;
grant insert on some_db.t1 to foo;
connect  con1,localhost,foo,,;
show tables from some_db;
Tables_in_some_db
t1
disconnect con1;
connection default;
deny insert on some_db.* to foo;
connect  con1,localhost,foo,,;
show databases;
Database
information_schema
test
show tables from some_db;
ERROR 42000: Access denied for user 'foo'@'%' to database 'some_db'
disconnect con1;
connection default;
#
# Test that dropping a user does not give access to connections that
# previously had elements denied.
#
# We will use two users, foo which will receive denies, bar which will
# not. This will showcase the difference in behaviour.
#
create user bar;
#
# This global grant is cached in sctx->master_access on connection.
#
grant select on *.* to foo;
grant select on *.* to bar;
connect  con1,localhost,foo,,;
show tables from some_db;
Tables_in_some_db
t1
disconnect con1;
connection default;
#
# Here we add a mask for some_db, it should no longer be visible to foo.
#
deny select on some_db.* to foo;
connect  con1,localhost,foo,,;
use some_db;
ERROR 42000: Access denied for user 'foo'@'%' to database 'some_db'
show tables from some_db;
ERROR 42000: Access denied for user 'foo'@'%' to database 'some_db'
#
# bar user has access to the database (no denies present)
#
connect  con2,localhost,bar,,;
use some_db;
show tables from some_db;
Tables_in_some_db
t1
#
# Do not disconnect foo & bar, but drop the users.
#
connection default;
drop user foo;
drop user bar;
#
# Our current running connection, because it featured denies previously
# now doesn't have access.
#
connection con1;
use some_db;
ERROR 42000: Access denied for user 'foo'@'%' to database 'some_db'
show tables from some_db;
ERROR 42000: Access denied for user 'foo'@'%' to database 'some_db'
disconnect con1;
#
# However, bar does not have any denies active. In this case we can keep
# the previous MariaDB behaviour of using the "cache" within
# sctx->master_access to grant access.
#
connection con2;
use some_db;
show tables from some_db;
Tables_in_some_db
t1
disconnect con2;
connection default;
drop database some_db;
#
# Test table level denies interacting with show tables
#
create database some_db;
create user foo;
create table some_db.t1 (a int, b int);
create table some_db.t2 (a int, b int);
grant select on *.* to foo;
deny select on some_db.t1 to foo;
deny insert on some_db.t2 to foo;
select user, host, JSON_EXTRACT(priv, '$.deny') from mysql.global_priv
where user = 'foo';
user	host	JSON_EXTRACT(priv, '$.deny')
foo	%	{"table": [{"name": "`some_db`.`t2`", "access": 2}, {"name": "`some_db`.`t1`", "access": 1}], "version_id": VERSION_ID}
connect  con1,localhost,foo,,;
show tables from some_db;
Tables_in_some_db
t2
show columns from some_db.t1;
ERROR 42000: SELECT command denied to user 'foo'@'localhost' for table 't1'
show columns from some_db.t2;
Field	Type	Null	Key	Default	Extra
a	int(11)	YES		NULL	
b	int(11)	YES		NULL	
select table_name, column_name, privileges from information_schema.columns
where table_schema like 'some_db' order by table_name, column_name;
table_name	column_name	privileges
t2	a	select
t2	b	select
disconnect con1;
connection default;
grant insert on some_db.* to foo;
connect  con1,localhost,foo,,;
show tables from some_db;
Tables_in_some_db
t1
t2
#
# See MDEV-28783, this should not error out when global/db grants exist
# (except for SELECT priv).
#
show columns from some_db.t1;
ERROR 42000: SELECT command denied to user 'foo'@'localhost' for table 't1'
show columns from some_db.t2;
Field	Type	Null	Key	Default	Extra
a	int(11)	YES		NULL	
b	int(11)	YES		NULL	
select table_name, column_name, privileges from information_schema.columns
where table_schema like 'some_db' order by table_name, column_name;
table_name	column_name	privileges
t1	a	insert
t1	b	insert
t2	a	select
t2	b	select
disconnect con1;
connection default;
deny insert on some_db.t1 to foo;
deny select on some_db.t2 to foo;
connect  con1,localhost,foo,,;
#
# some_db should still be visible, but it should show up as empty.
#
show databases;
Database
information_schema
mtr
mysql
performance_schema
some_db
sys
test
show tables from some_db;
Tables_in_some_db
show columns from some_db.t1;
ERROR 42000: SELECT command denied to user 'foo'@'localhost' for table 't1'
show columns from some_db.t2;
ERROR 42000: SELECT command denied to user 'foo'@'localhost' for table 't2'
select table_name, column_name, privileges from information_schema.columns
where table_schema like 'some_db' order by table_name, column_name;
table_name	column_name	privileges
disconnect con1;
connection default;
grant select(a) on some_db.t1 to foo;
grant update(a) on some_db.t1 to foo;
connect  con1,localhost,foo,,;
#
# Update privilege on the column is not masked, only see a column.
#
show tables from some_db;
Tables_in_some_db
t1
show columns from some_db.t1;
Field	Type	Null	Key	Default	Extra
a	int(11)	YES		NULL	
show columns from some_db.t2;
ERROR 42000: SELECT command denied to user 'foo'@'localhost' for table 't2'
select table_name, column_name, privileges from information_schema.columns
where table_schema like 'some_db' order by table_name, column_name;
table_name	column_name	privileges
t1	a	update
disconnect con1;
connection default;
drop user foo;
drop database some_db;
