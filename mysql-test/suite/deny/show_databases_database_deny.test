--source include/not_embedded.inc

let $REGEX_VERSION_ID=/$mysql_get_server_version/VERSION_ID/;

--echo ###############################
--echo # Test database level denies. #
--echo ###############################

create user foo;
grant select on *.* to foo;

--echo #
--echo # Test masking database level denies.
--echo #
--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

--echo #
--echo # Mask all rights.
--echo #
deny select on mysql.* to foo;

--connect (con1,localhost,foo,,)
show databases;

disconnect con1;
connection default;

--echo #
--echo # Not all rights masked.
--echo #
grant insert on *.* to foo;
grant insert on mysql.* to foo;

--echo #
--echo # mysql db should now show up in the list because insert is not masked.
--echo #
--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

deny insert on mysql.* to foo;

--echo #
--echo # mysql db should not be present now.
--echo #
--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

grant show databases on *.* to foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

deny show databases on *.* to foo;


--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

show grants for foo;
grant update on mysql.* to foo;

--connect (con1,localhost,foo,,)
--echo #
--echo # Update not masked via database deny, mysql should show up.
--echo #
show databases;
disconnect con1;
connection default;

deny update on mysql.* to foo;

--connect (con1,localhost,foo,,)
--echo #
--echo # Now it should not show up.
--echo #
show grants;
show databases;
disconnect con1;
connection default;

--echo #
--echo # Test masking table level grants with global denies.
--echo #

create table mysql.t1 (a int);

connection default;
grant insert on mysql.t1 to foo;
show grants for foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;

connection default;
grant delete on mysql.t1 to foo;
show grants for foo;

--connect (con1,localhost,foo,,)
--echo #
--echo # mysql should show up because we have delete rights on t1.
--echo #
show databases;
disconnect con1;
connection default;

deny delete on mysql.* to foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

--echo #
--echo # Test masking column level grants with global denies.
--echo #
grant references (a) on mysql.t1 to foo;
show grants for foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

deny references on mysql.* to foo;
show grants for foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

delimiter |;

--echo #
--echo # Test masking procedure / function / package level grants with global
--echo # denies.
--echo #

create procedure mysql.proc_1()
begin
select 1;
end|

create function mysql.func_1() returns int
begin
return 3;
end|

set @old_sql_mode=@@sql_mode|
set sql_mode=ORACLE|

create package mysql.util_functions as
  function f1(id int) return int;
end|

create package body mysql.util_functions as
  function f1(id int) return int as result int;
  begin
    return 10;
  end;
end|


delimiter ;|

grant execute on procedure mysql.proc_1 to foo;

grant execute on function mysql.func_1 to foo;

grant execute on package mysql.util_functions to foo;

set sql_mode=@old_sql_mode;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

deny execute on mysql.* to foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

--replace_regex $REGEX_VERSION_ID
select user, host, JSON_EXTRACT(priv, '$.deny') from mysql.global_priv
where user = 'foo';
show grants for foo;

create database some_db;
grant all on some_db.* to foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

deny all on some_db.* to foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

--echo #
--echo # Removing a deny for show databases globaly should make some_db show up.
--echo #
revoke deny all on *.* from foo;

--connect (con1,localhost,foo,,)
show databases;
disconnect con1;
connection default;

drop database some_db;
drop table mysql.t1;
drop procedure mysql.proc_1;
drop function mysql.func_1;
set @old_sql_mode=@@sql_mode;
set sql_mode=ORACLE;
drop package body mysql.util_functions;
drop package mysql.util_functions;
set sql_mode=@old_sql_mode;
drop user foo;
