CREATE TABLE t1 (a INT) ENGINE=InnoDB;
#
# Test that SET @@session.server_id fails inside explicit transaction
#
BEGIN;
INSERT INTO t1 VALUES (1);
SET @@session.server_id = 100;
ERROR HY000: Cannot set @@session.server_id within a transaction
ROLLBACK;
#
# Test that SET @@session.server_id works outside transaction
#
SET @@session.server_id = 100;
SELECT @@session.server_id;
@@session.server_id
100
#
# Test that SET @@session.server_id fails with autocommit=0
#
SET autocommit = 0;
INSERT INTO t1 VALUES (2);
SET @@session.server_id = 200;
ERROR HY000: Cannot set @@session.server_id within a transaction
ROLLBACK;
SET autocommit = 1;
#
# Test that SET @@session.server_id works after COMMIT
#
BEGIN;
INSERT INTO t1 VALUES (3);
COMMIT;
SET @@session.server_id = 300;
SELECT @@session.server_id;
@@session.server_id
300
#
# Test that SET @@session.server_id fails inside a trigger
#
CREATE TABLE t2 (a INT) ENGINE=InnoDB;
CREATE TRIGGER tr1 BEFORE INSERT ON t2 FOR EACH ROW
SET @@session.server_id = 100;
INSERT INTO t2 VALUES (1);
ERROR HY000: Cannot set @@session.server_id within a trigger or stored program
DROP TRIGGER tr1;
DROP TABLE t2;
#
# Test that SET @@session.server_id fails inside a stored procedure
# called within a transaction
#
CREATE PROCEDURE sp1()
BEGIN
SET @@session.server_id = 100;
END//
BEGIN;
CALL sp1();
ERROR HY000: Cannot set @@session.server_id within a transaction
ROLLBACK;
DROP PROCEDURE sp1;
#
# Test that SET @@session.server_id fails inside a stored procedure
# that starts its own transaction
#
CREATE PROCEDURE sp2()
BEGIN
START TRANSACTION;
INSERT INTO t1 VALUES (1);
SET @@session.server_id = 100;
COMMIT;
END//
CALL sp2();
ERROR HY000: Cannot set @@session.server_id within a transaction
DROP PROCEDURE sp2;
#
# Cleanup
#
DROP TABLE t1;
