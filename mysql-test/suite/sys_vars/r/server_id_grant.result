#
# MDEV-21975 Add BINLOG REPLAY privilege and bind new privileges to gtid_seq_no, preudo_thread_id, server_id, gtid_domain_id
#
SET @global=@@global.server_id;
# Test that "SET GLOBAL server_id" is not allowed without REPLICATION MASTER ADMIN or SUPER
CREATE USER user1@localhost;
GRANT ALL PRIVILEGES ON *.* TO user1@localhost;
REVOKE REPLICATION MASTER ADMIN, SUPER ON *.* FROM user1@localhost;
connect user1,localhost,user1,,;
connection user1;
SET GLOBAL server_id=1;
ERROR 42000: Access denied; you need (at least one of) the SUPER, REPLICATION MASTER ADMIN privilege(s) for this operation
disconnect user1;
connection default;
DROP USER user1@localhost;
# Test that "SET GLOBAL server_id" is allowed with REPLICATION MASTER ADMIN
CREATE USER user1@localhost;
GRANT REPLICATION MASTER ADMIN ON *.* TO user1@localhost;
connect user1,localhost,user1,,;
connection user1;
SET GLOBAL server_id=1;
disconnect user1;
connection default;
DROP USER user1@localhost;
# Test that "SET GLOBAL server_id" is allowed with SUPER
CREATE USER user1@localhost;
GRANT SUPER ON *.* TO user1@localhost;
connect user1,localhost,user1,,;
connection user1;
SET GLOBAL server_id=1;
disconnect user1;
connection default;
DROP USER user1@localhost;
SET @@global.server_id=@global;
SET @session=@@session.server_id;
# Test that "SET server_id" is not allowed without BINLOG REPLAY or SUPER
CREATE USER user1@localhost;
GRANT ALL PRIVILEGES ON *.* TO user1@localhost;
REVOKE BINLOG REPLAY, SUPER ON *.* FROM user1@localhost;
connect user1,localhost,user1,,;
connection user1;
SET server_id=1;
ERROR 42000: Access denied; you need (at least one of) the SUPER, BINLOG REPLAY privilege(s) for this operation
SET SESSION server_id=1;
ERROR 42000: Access denied; you need (at least one of) the SUPER, BINLOG REPLAY privilege(s) for this operation
disconnect user1;
connection default;
DROP USER user1@localhost;
# Test that "SET server_id" is allowed with BINLOG REPLAY
CREATE USER user1@localhost;
GRANT BINLOG REPLAY ON *.* TO user1@localhost;
connect user1,localhost,user1,,;
connection user1;
SET server_id=1;
SET SESSION server_id=1;
disconnect user1;
connection default;
DROP USER user1@localhost;
# Test that "SET server_id" is allowed with SUPER
CREATE USER user1@localhost;
GRANT SUPER ON *.* TO user1@localhost;
connect user1,localhost,user1,,;
connection user1;
SET server_id=1;
SET SESSION server_id=1;
disconnect user1;
connection default;
DROP USER user1@localhost;
SET @@session.server_id=@session;
