--source include/have_innodb.inc
--source include/have_sequence.inc

set FOREIGN_KEY_CHECKS=0;


CREATE TABLE NATION (
  N_NATIONKEY int(11) NOT NULL,
  N_NAME char(25) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  N_REGIONKEY int(11) DEFAULT NULL,
  N_COMMENT varchar(152) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (N_NATIONKEY),
  KEY NATION_REGIONKEY_FKIDX (N_REGIONKEY),
  CONSTRAINT NATION_FK1 FOREIGN KEY (N_REGIONKEY) REFERENCES REGION (R_REGIONKEY)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

insert into NATION (N_NATIONKEY) select seq from seq_0_to_24;
update NATION set N_NAME = 'IRAN' where N_NATIONKEY = 10;

CREATE TABLE SUPPLIER (
  S_SUPPKEY int(11) NOT NULL,
  S_NATIONKEY int(11) DEFAULT NULL,
  S_COMMENT varchar(102) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  S_NAME char(25) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  S_ADDRESS varchar(40) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  S_PHONE char(15) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  S_ACCTBAL decimal(10,2) DEFAULT NULL,
  PRIMARY KEY (S_SUPPKEY),
  KEY SUPPLIER_NATION_FKIDX (S_NATIONKEY),
  CONSTRAINT SUPPLIER_FK1 FOREIGN KEY (S_NATIONKEY) REFERENCES NATION (N_NATIONKEY)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

insert into SUPPLIER (S_SUPPKEY,S_NATIONKEY)
  select seq, seq%24 from seq_1_to_50;

CREATE TABLE LINEITEM (
  L_SHIPDATE date DEFAULT NULL,
  L_ORDERKEY bigint(20) NOT NULL,
  L_DISCOUNT decimal(10,2) NOT NULL,
  L_EXTENDEDPRICE decimal(10,2) NOT NULL,
  L_SUPPKEY int(11) NOT NULL,
  L_QUANTITY int(11) NOT NULL,
  L_RETURNFLAG char(1) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  L_PARTKEY int(11) NOT NULL,
  L_LINESTATUS char(1) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  L_TAX decimal(10,2) NOT NULL,
  L_COMMITDATE date DEFAULT NULL,
  L_RECEIPTDATE date DEFAULT NULL,
  L_SHIPMODE char(10) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  L_LINENUMBER int(11) NOT NULL,
  L_SHIPINSTRUCT char(25) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  L_COMMENT varchar(44) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (L_ORDERKEY,L_LINENUMBER),
  KEY LINEITEM_PART_SUPP_FKIDX (L_PARTKEY,L_SUPPKEY),
  KEY IDX_LINEITEM_ORDERKEY_FKIDX (L_ORDERKEY),
  CONSTRAINT LINEITEM_FK1 FOREIGN KEY (L_ORDERKEY) REFERENCES ORDERS (O_ORDERKEY),
  CONSTRAINT LINEITEM_FK2 FOREIGN KEY (L_PARTKEY, L_SUPPKEY) REFERENCES PARTSUPP (PS_PARTKEY, PS_SUPPKEY)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;


CREATE TABLE ORDERS (
  O_ORDERDATE date DEFAULT NULL,
  O_ORDERKEY bigint(20) NOT NULL,
  O_CUSTKEY int(11) NOT NULL,
  O_ORDERPRIORITY char(15) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  O_SHIPPRIORITY int(11) DEFAULT NULL,
  O_CLERK char(15) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  O_ORDERSTATUS char(1) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  O_TOTALPRICE decimal(10,2) DEFAULT NULL,
  O_COMMENT varchar(79) CHARACTER SET latin1 COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (O_ORDERKEY),
  KEY ORDERS_FK1 (O_CUSTKEY),
  CONSTRAINT ORDERS_FK1 FOREIGN KEY (O_CUSTKEY) REFERENCES CUSTOMER (C_CUSTKEY)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;


insert into ORDERS (O_ORDERKEY, O_CUSTKEY,O_ORDERSTATUS)
  select seq, seq%15000, if(seq%2, 'F', 'A') from seq_1_to_150000;

insert into LINEITEM (L_SHIPDATE, L_ORDERKEY, L_DISCOUNT, L_EXTENDEDPRICE,
L_SUPPKEY, L_QUANTITY, L_PARTKEY, L_TAX, L_RECEIPTDATE, L_LINENUMBER)
select '2025-01-01', seq, 0, 100, seq%50+1, 1, 2, 10,
if(seq%2, '2025-01-02', NULL), 1 from seq_1_to_200000;

set FOREIGN_KEY_CHECKS=1;

explain select s_name, count(*) as numwait
from SUPPLIER, LINEITEM l1, ORDERS, NATION
where s_suppkey = l1.l_suppkey
  and o_orderkey = l1.l_orderkey
  and o_orderstatus = 'F'
  and l1.l_receiptdate > l1.l_commitdate
  and exists
  (
    select * from LINEITEM l2
    where l2.l_orderkey = l1.l_orderkey and l2.l_suppkey <> l1.l_suppkey
  )
  and not exists
  (
    select * from LINEITEM l3
    where l3.l_orderkey = l1.l_orderkey
      and l3.l_suppkey <> l1.l_suppkey
      and l3.l_receiptdate > l3.l_commitdate
  )
  and s_nationkey = n_nationkey
  and n_name = 'IRAN'
group by s_name order by numwait desc, s_name
limit 100;

DROP TABLE IF EXISTS SUPPLIER;
DROP TABLE IF EXISTS LINEITEM;
DROP TABLE IF EXISTS ORDERS;
DROP TABLE IF EXISTS NATION;
