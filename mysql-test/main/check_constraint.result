set @save_check_constraint=@@check_constraint_checks;
create table t1 (a int check(a>10), b int check (b > 20), constraint `min` check (a+b > 100), constraint `max` check (a+b <500)) engine=myisam;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) DEFAULT NULL CHECK (`a` > 10),
  `b` int(11) DEFAULT NULL CHECK (`b` > 20),
  CONSTRAINT `min` CHECK (`a` + `b` > 100),
  CONSTRAINT `max` CHECK (`a` + `b` < 500)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
insert into t1 values (100,100);
insert into t1 values (1,1);
ERROR 23000: CONSTRAINT `a` failed for `test`.`t1`
insert into t1 values (20,1);
ERROR 23000: CONSTRAINT `b` failed for `test`.`t1`
insert into t1 values (20,30);
ERROR 23000: CONSTRAINT `min` failed for `test`.`t1`
insert into t1 values (500,500);
ERROR 23000: CONSTRAINT `max` failed for `test`.`t1`
insert into t1 values (101,101),(102,102),(600,600),(103,103);
ERROR 23000: CONSTRAINT `max` failed for `test`.`t1`
select * from t1;
a	b
100	100
101	101
102	102
truncate table t1;
insert ignore into t1 values (101,101),(102,102),(600,600),(103,103);
Warnings:
Warning	4025	CONSTRAINT `max` failed for `test`.`t1`
select * from t1;
a	b
101	101
102	102
103	103
set check_constraint_checks=0;
truncate table t1;
insert into t1 values (101,101),(102,102),(600,600),(103,103);
select * from t1;
a	b
101	101
102	102
600	600
103	103
set check_constraint_checks=@save_check_constraint;
alter table t1 add c int default 0 check (c < 10);
ERROR 23000: CONSTRAINT `max` failed for `test`.`t1`
set check_constraint_checks=0;
alter table t1 add c int default 0 check (c < 10);
alter table t1 add check (a+b+c < 500);
set check_constraint_checks=@save_check_constraint;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) DEFAULT NULL CHECK (`a` > 10),
  `b` int(11) DEFAULT NULL CHECK (`b` > 20),
  `c` int(11) DEFAULT 0 CHECK (`c` < 10),
  CONSTRAINT `min` CHECK (`a` + `b` > 100),
  CONSTRAINT `max` CHECK (`a` + `b` < 500),
  CONSTRAINT `CONSTRAINT_1` CHECK (`a` + `b` + `c` < 500)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
insert into t1 values(105,105,105);
ERROR 23000: CONSTRAINT `c` failed for `test`.`t1`
insert into t1 values(249,249,9);
ERROR 23000: CONSTRAINT `CONSTRAINT_1` failed for `test`.`t1`
insert into t1 values(105,105,9);
select * from t1;
a	b	c
101	101	0
102	102	0
600	600	0
103	103	0
105	105	9
create table t2 like t1;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `a` int(11) DEFAULT NULL CHECK (`a` > 10),
  `b` int(11) DEFAULT NULL CHECK (`b` > 20),
  `c` int(11) DEFAULT 0 CHECK (`c` < 10),
  CONSTRAINT `min` CHECK (`a` + `b` > 100),
  CONSTRAINT `max` CHECK (`a` + `b` < 500),
  CONSTRAINT `CONSTRAINT_1` CHECK (`a` + `b` + `c` < 500)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
alter table t2 drop constraint c;
ERROR 42000: Can't DROP CONSTRAINT `c`; check that it exists
alter table t2 drop constraint if exists c;
Warnings:
Note	1091	Can't DROP CONSTRAINT `c`; check that it exists
alter table t2 drop constraint min;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `a` int(11) DEFAULT NULL CHECK (`a` > 10),
  `b` int(11) DEFAULT NULL CHECK (`b` > 20),
  `c` int(11) DEFAULT 0 CHECK (`c` < 10),
  CONSTRAINT `max` CHECK (`a` + `b` < 500),
  CONSTRAINT `CONSTRAINT_1` CHECK (`a` + `b` + `c` < 500)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1,t2;
create or replace table t1 (a int, b int, constraint check (a>b));
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL,
  CONSTRAINT `CONSTRAINT_1` CHECK (`a` > `b`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
create or replace table t1 (a int, b int,
constraint CONSTRAINT_1 check (a>1),
constraint check (b>1));
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL,
  CONSTRAINT `CONSTRAINT_1` CHECK (`a` > 1),
  CONSTRAINT `CONSTRAINT_2` CHECK (`b` > 1)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
create or replace table t1 (a int, b int,
constraint CONSTRAINT_1 check (a>1),
constraint check (b>1),
constraint CONSTRAINT_2 check (a>b));
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL,
  CONSTRAINT `CONSTRAINT_1` CHECK (`a` > 1),
  CONSTRAINT `CONSTRAINT_3` CHECK (`b` > 1),
  CONSTRAINT `CONSTRAINT_2` CHECK (`a` > `b`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1;
create table t1(c1 int, c2 int as (c1 + 1), check (c2 > 2));
insert into t1(c1) values(1);
ERROR 23000: CONSTRAINT `CONSTRAINT_1` failed for `test`.`t1`
insert into t1(c1) values(2);
drop table t1;
create or replace table t1( c1 int auto_increment primary key, check( c1 > 0 or c1 is null ) );
ERROR HY000: Function or expression 'AUTO_INCREMENT' cannot be used in the CHECK clause of `c1`
create table t1 (a int check (@b in (select user from mysql.user)));
ERROR HY000: Function or expression 'select ...' cannot be used in the CHECK clause of `a`
create table t1 (a int check (a > @b));
ERROR HY000: Function or expression '@b' cannot be used in the CHECK clause of `a`
create table t1 (a int check (a = 1));
insert t1 values (1);
insert t1 values (2);
ERROR 23000: CONSTRAINT `a` failed for `test`.`t1`
insert t1 values (NULL);
select * from t1;
a
1
NULL
drop table t1;
create table t1 (id int auto_increment primary key, datecol datetime, check (datecol>'0001-01-01 00:00:00'));
insert into t1 (datecol) values (now());
insert into t1 (datecol) values (now());
drop table t1;
CREATE TABLE t1 (
EmployeeID SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
FirstName VARCHAR(30) NOT NULL CHECK (CHAR_LENGTH(FirstName > 2))
);
INSERT INTO t1 VALUES (NULL, 'Ken');
ERROR 22007: Truncated incorrect DECIMAL value: 'Ken'
SHOW WARNINGS;
Level	Code	Message
Error	1292	Truncated incorrect DECIMAL value: 'Ken'
Error	4025	CONSTRAINT `FirstName` failed for `test`.`t1`
INSERT INTO t1 VALUES (NULL, 'Ken'),(NULL, 'Brian');
ERROR 22007: Truncated incorrect DECIMAL value: 'Ken'
SHOW WARNINGS;
Level	Code	Message
Error	1292	Truncated incorrect DECIMAL value: 'Ken'
Error	4025	CONSTRAINT `FirstName` failed for `test`.`t1`
INSERT IGNORE INTO t1 VALUES (NULL, 'Ken');
Warnings:
Warning	1292	Truncated incorrect DECIMAL value: 'Ken'
INSERT IGNORE INTO t1 VALUES (NULL, 'Ken'),(NULL, 'Brian');
Warnings:
Warning	1292	Truncated incorrect DECIMAL value: 'Ken'
Warning	1292	Truncated incorrect DECIMAL value: 'Brian'
set sql_mode="";
INSERT INTO t1 VALUES (NULL, 'Ken');
Warnings:
Warning	1292	Truncated incorrect DECIMAL value: 'Ken'
INSERT INTO t1 VALUES (NULL, 'Ken'),(NULL, 'Brian');
Warnings:
Warning	1292	Truncated incorrect DECIMAL value: 'Ken'
Warning	1292	Truncated incorrect DECIMAL value: 'Brian'
set sql_mode=default;
select * from t1;
EmployeeID	FirstName
1	Ken
2	Ken
3	Brian
4	Ken
5	Ken
6	Brian
drop table t1;
create table t1 (a int auto_increment primary key, b int, check (b > 5));
insert t1 (b) values (1);
ERROR 23000: CONSTRAINT `CONSTRAINT_1` failed for `test`.`t1`
insert t1 (b) values (10);
select * from t1 where a is null;
a	b
set sql_auto_is_null=1;
select * from t1 where a is null;
a	b
1	10
insert t1 (b) values (1);
ERROR 23000: CONSTRAINT `CONSTRAINT_1` failed for `test`.`t1`
drop table t1;
#
# MDEV-25638 Assertion `!result' failed in convert_const_to_int
#
create table t1 (v1 bigint check (v1 not in ('x' , 'x111'))) ;
Warnings:
Warning	1292	Truncated incorrect DECIMAL value: 'x'
Warning	1292	Truncated incorrect DECIMAL value: 'x111'
select * from t1;
v1
Warnings:
Warning	1292	Truncated incorrect DECIMAL value: 'x'
Warning	1292	Truncated incorrect DECIMAL value: 'x111'
select v1 from t1;
v1
select * from t1;
v1
prepare stmt from "select * from t1";
execute stmt;
v1
execute stmt;
v1
flush tables;
select * from t1;
v1
Warnings:
Warning	1292	Truncated incorrect DECIMAL value: 'x'
Warning	1292	Truncated incorrect DECIMAL value: 'x111'
select * from t1;
v1
deallocate prepare stmt;
drop table t1;
#
# MDEV-26061 MariaDB server crash at Field::set_default
#
create table t1 (v2 date check (v1 like default (v1)), v1 date default (from_days ('x')));
Warnings:
Warning	1292	Truncated incorrect INTEGER value: 'x'
insert ignore into t1 values ( 'x' , 'x' ) ;
Warnings:
Warning	1265	Data truncated for column 'v2' at row 1
Warning	1265	Data truncated for column 'v1' at row 1
Warning	1292	Truncated incorrect INTEGER value: 'x'
drop table t1;
#
# End of 10.2 tests
#
#
# MDEV-26061 MariaDB server crash at Field::set_default
#
create table t1 (d timestamp check (default (d) is true)) as select 1;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `d` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp() CHECK (default(`d`) is true),
  `1` int(1) NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1;
#
# End of 10.3 tests
#
#
# MDEV-24274 ALTER TABLE with CHECK CONSTRAINTS gives "Out of Memory" error
#
create table t1 (id varchar(2), constraint id1 check (id regexp '[a-z]'));
alter table t1 force;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` varchar(2) DEFAULT NULL,
  CONSTRAINT `id1` CHECK (`id` regexp '[a-z]')
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
drop table t1;
#
# MDEV-32586 incorrect error about cyclic reference about JSON type virtual column
#
create table t1 (a int, b json as (a));
drop table t1;
create table t1 (a int, b int as (a) check (b > 0));
insert t1 (a) values (1);
insert t1 (a) values (-1);
ERROR 23000: CONSTRAINT `b` failed for `test`.`t1`
drop table t1;
#
# MDEV-24598: duplicate CHECK constraint name
#
create table t (a int check (a>2),
constraint a1 check (a < 5),
constraint a1 check (a > 5));
ERROR HY000: Duplicate CHECK constraint name 'a1'
create table t (a int check (a>2),
constraint a check (a < 5));
ERROR HY000: Duplicate CHECK constraint name 'a'
CREATE TABLE t (
path VARCHAR(100) NOT NULL COLLATE 'utf8_general_ci',
json_c1 JSON NOT NULL DEFAULT '' COLLATE 'utf8mb4_bin',
json_c2 JSON NOT NULL DEFAULT '' COLLATE 'utf8mb4_bin',
comment VARCHAR(100) NULL DEFAULT NULL COLLATE 'utf8_general_ci',
UNIQUE INDEX path (path),
CONSTRAINT json_c1 CHECK (path > 0)
);
ERROR HY000: Duplicate CHECK constraint name 'json_c1'
select * from information_schema.check_constraints where table_name='t';
CONSTRAINT_CATALOG	CONSTRAINT_SCHEMA	TABLE_NAME	CONSTRAINT_NAME	CHECK_CLAUSE
create table t(a int);
alter table t add constraint a check (a > 10);
ERROR HY000: Duplicate CHECK constraint name 'a'
drop table t;
#
# MDEV-24602: cannot specify a name for a column check constraint
#
create table t(t int,
check (t>0),
constraint check(t>1),
constraint t_named check(t>2));
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `t` int(11) DEFAULT NULL,
  CONSTRAINT `CONSTRAINT_1` CHECK (`t` > 0),
  CONSTRAINT `CONSTRAINT_2` CHECK (`t` > 1),
  CONSTRAINT `t_named` CHECK (`t` > 2)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
SELECT CONSTRAINT_NAME, TABLE_NAME, CONSTRAINT_TYPE
FROM information_schema.TABLE_CONSTRAINTS WHERE
TABLE_NAME = 't' AND TABLE_SCHEMA = 'test';
CONSTRAINT_NAME	TABLE_NAME	CONSTRAINT_TYPE
CONSTRAINT_1	t	CHECK
CONSTRAINT_2	t	CHECK
t_named	t	CHECK
SELECT * from INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE
CONSTRAINT_SCHEMA = 'test';
CONSTRAINT_CATALOG	CONSTRAINT_SCHEMA	TABLE_NAME	CONSTRAINT_NAME	CHECK_CLAUSE
def	test	t	CONSTRAINT_1	`t` > 0
def	test	t	CONSTRAINT_2	`t` > 1
def	test	t	t_named	`t` > 2
drop table t;
create table t(t0 int,
t1 int check (t1>0),
t2 int constraint check(t2>0),
t3 int constraint t_field check(t3>0));
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `t0` int(11) DEFAULT NULL,
  `t1` int(11) DEFAULT NULL CHECK (`t1` > 0),
  `t2` int(11) DEFAULT NULL CHECK (`t2` > 0),
  `t3` int(11) DEFAULT NULL CHECK (`t3` > 0)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
SELECT CONSTRAINT_NAME, TABLE_NAME, CONSTRAINT_TYPE
FROM information_schema.TABLE_CONSTRAINTS WHERE
TABLE_NAME = 't' AND TABLE_SCHEMA = 'test';
CONSTRAINT_NAME	TABLE_NAME	CONSTRAINT_TYPE
t1	t	CHECK
t2	t	CHECK
t_field	t	CHECK
SELECT * from INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE
CONSTRAINT_SCHEMA = 'test';
CONSTRAINT_CATALOG	CONSTRAINT_SCHEMA	TABLE_NAME	CONSTRAINT_NAME	CHECK_CLAUSE
def	test	t	t1	`t1` > 0
def	test	t	t2	`t2` > 0
def	test	t	t_field	`t3` > 0
drop table t;
create table t(t1 int constraint t1_check check(t1>0),
t2 int check(t2>0),
t3 int constraint t_field check(t3>0),
t4 int constraint t_field check(t4>0));
ERROR HY000: Duplicate CHECK constraint name 't_field'
create table t(t1 int constraint t1_check check(t1>0),
t2 int check(t2>0),
t3 int constraint t_field check(t3>0),
constraint table_check1 check(t1>0),
constraint table_check1 check(t2>0));
ERROR HY000: Duplicate CHECK constraint name 'table_check1'
create table t(t1 int constraint t1_check check(t1>0),
t2 int check(t2>0),
t3 int constraint t_field check(t3>0),
constraint t_field check(t1>0));
ERROR HY000: Duplicate CHECK constraint name 't_field'
create table t(t1 int constraint t1 check(t1>0));
SELECT * from INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE
CONSTRAINT_SCHEMA = 'test';
CONSTRAINT_CATALOG	CONSTRAINT_SCHEMA	TABLE_NAME	CONSTRAINT_NAME	CHECK_CLAUSE
def	test	t	t1	`t1` > 0
alter table t add constraint t1 check (t1<0);
ERROR HY000: Duplicate CHECK constraint name 't1'
SELECT * from INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE
CONSTRAINT_SCHEMA = 'test';
CONSTRAINT_CATALOG	CONSTRAINT_SCHEMA	TABLE_NAME	CONSTRAINT_NAME	CHECK_CLAUSE
def	test	t	t1	`t1` > 0
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `t1` int(11) DEFAULT NULL CHECK (`t1` > 0)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
alter table t modify column t1 int constraint t1_greater_pi_check check (t1>3.14);
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `t1` int(11) DEFAULT NULL CHECK (`t1` > 3.14)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci
SELECT * from INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE
CONSTRAINT_SCHEMA = 'test';
CONSTRAINT_CATALOG	CONSTRAINT_SCHEMA	TABLE_NAME	CONSTRAINT_NAME	CHECK_CLAUSE
def	test	t	t1_greater_pi_check	`t1` > 3.14
drop table t;
#
# End of 10.4 tests
#
