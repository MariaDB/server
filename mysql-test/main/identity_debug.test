-- source include/have_innodb.inc
-- source include/have_sequence.inc

create table t1(x int GENERATED BY DEFAULT AS IDENTITY CACHE 3, source text) engine=innodb;
let $i=12;

connect con1,localhost,root,,,,;
eval set debug_sync= "ha_write_row_start signal write1 wait_for step1 execute $i";

# We have to use insert...select to avoid row count prediction.
--send
--eval insert t1(source) select 'first' from seq_1_to_$i

connect con2,localhost,root,,;
set debug_sync= "now wait_for write1";
eval set debug_sync= "ha_write_row_start signal write2 wait_for step2 execute $i";
--send
--eval insert t1(source) select 'second' from seq_1_to_$i

connection default;

set debug_sync= "now wait_for write2";
dec $i;
while ($i) {
    set debug_sync= "now signal step1";
    set debug_sync= "now wait_for write1";
    set debug_sync= "now signal step2";
    set debug_sync= "now wait_for write2";
    dec $i;
}
set debug_sync= "now signal step1";
set debug_sync= "now signal step2";

connection con1;
reap;
connection con2;
reap;

connection default;
select * from t1 order by x;

drop table t1;

disconnect con1;
disconnect con2;
