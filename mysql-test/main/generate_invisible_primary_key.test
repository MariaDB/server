#
# Test of sql_generate_invisible_primary_key option (MDEV-21181)
#
SET SESSION debug_dbug="+d,test_invisible_index,test_completely_invisible";

#
# When option is off, invisible PK is not generated
#
CREATE TABLE t0 (c1 INT, c2 INT);
SHOW INDEX FROM t0;

SET sql_generate_invisible_primary_key=ON;

#
# Check that PK index gets created when not specified in CREATE TABLE
#
CREATE TABLE t1 (c1 INT, c2 INT);
SHOW INDEX FROM t1;

INSERT INTO t1 VALUES (3, 0);
INSERT INTO t1 VALUES (4, 0);
SELECT _rowid, t1.* FROM t1;

#
# Check that generated PK persists on ALTER TABLE without new PK
#
ALTER TABLE t1 ADD c3 INT;
SHOW INDEX FROM t1;

#
# Check that adding column with name of generated PK succeeds
#
ALTER TABLE t1 ADD _inv_PK INT;
ALTER TABLE t1 ADD _inv_PK1 INT;
SHOW INDEX FROM t1;

#
# Trying to drop autogenerated PK should fail
#
--error 1091
ALTER TABLE t1 DROP PRIMARY KEY;

#
# Check that generated PK is dropped on ALTER TABLE with new PK
#
ALTER TABLE t1 ADD PRIMARY KEY (c1);
SHOW INDEX FROM t1;
SELECT _rowid, t1.* FROM t1;

#
# Check that user PK that replaced generated PK can be dropped
#
ALTER TABLE t1 DROP PRIMARY KEY;

#
# Check that creating table with column named _inv_PK succeeds
#
CREATE TABLE t2 (c1 INT, c2 INT, _inv_PK INT);
SHOW INDEX FROM t2;

SET SESSION debug_dbug="";

#
# Generated PK should be fully invisible to user
#
CREATE TABLE t3 (c1 INT, c2 INT);
SHOW INDEX FROM t3;

DROP TABLE t0, t1, t2, t3;
SET sql_generate_invisible_primary_key=OFF;
