--source include/not_embedded.inc

--echo #
--echo # MDEV-18323: Convert MySQL JSON type to MariaDB TEXT in mysql_upgrade - apply alter force
--echo #

 let $datadir=`select @@datadir`;


call mtr.add_suppression(" Table rebuild required. Please do \"ALTER TABLE `test.mysql_json` FORCE\" or dump/reload to fix it!");

call mtr.add_suppression("mysqld: Table rebuild required. Please do \"ALTER TABLE `mysql.transaction_registry` FORCE\" or dump/reload to fix it");

call mtr.add_suppression("mysqld: Table rebuild required. Please do \"ALTER TABLE `mysql.innodb_table_stats` FORCE\" or dump/reload to fix it!");

call mtr.add_suppression("mysqld: Table rebuild required. Please do \"ALTER TABLE `mysql.innodb_index_stats` FORCE\" or dump/reload to fix it!");

# Suppressions which are occuring for literals, empty json objects and primitive types
call mtr.add_suppression("mysqld: Table './test/mysql_json' is marked as crashed and should be repaire");

call mtr.add_suppression("Checking table:   './test/mysql_json'");

--echo #
--echo # Test array with JSONB_TYPE_LARGE_OBJECT
--echo #

--copy_file std_data/long_string_JSONB_TYPE_LARGE_OBJECT.frm $datadir/test/mysql_json.frm
--copy_file std_data/long_string_JSONB_TYPE_LARGE_OBJECT.MYI $datadir/test/mysql_json.MYI
--copy_file std_data/long_string_JSONB_TYPE_LARGE_OBJECT.MYD $datadir/test/mysql_json.MYD

--error ER_NOT_FORM_FILE
SELECT * FROM mysql_json;

ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
DROP TABLE test.mysql_json;

--echo #
--echo # Test array with JSONB_TYPE_LARGE_ARRAY
--echo #

--copy_file std_data/bigarray.frm $datadir/test/mysql_json.frm
--copy_file std_data/bigarray.MYI $datadir/test/mysql_json.MYI
--copy_file std_data/bigarray.MYD $datadir/test/mysql_json.MYD

--error ER_NOT_FORM_FILE
SELECT * FROM mysql_json;

ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
DROP TABLE test.mysql_json;
