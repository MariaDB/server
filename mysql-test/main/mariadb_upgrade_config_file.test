--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mysqld]
invalid=true
alter_algorithm=invalid
key_buffer_size=20M
EOF
--exec echo "!include $MYSQLTEST_VARDIR/tmp/tmp2.cnf" >> $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--write_file $MYSQLTEST_VARDIR/tmp/tmp2.cnf
[mysqld]
default_regex_flags=invalid
EOF

--echo Testing --edit=remove
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --edit=remove
--exec head -2 $MYSQLTEST_VARDIR/tmp/tmp1.cnf
--exec cat $MYSQLTEST_VARDIR/tmp/tmp2.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
--remove_file $MYSQLTEST_VARDIR/tmp/tmp2.cnf
--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mysqld]
invalid=true
alter_algorithm=invalid
plugin_load_add=audit_log
EOF
--echo Testing --edit=comment
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --edit=comment
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mysqld]
invalid=true

[mariadbd]
alter_algorithm=invalid

[mysqld]
key_buffer_size=20M
EOF
--echo Testing --edit=inline-old-version
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --current-version=mysql-5.7 --edit=inline-old-version
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mysqld]
invalid=true
key_buffer_size=20M
alter_algorithm=invalid
EOF
--echo Testing --edit=last-old-version
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --current-version=mysql-5.7 --edit=last-old-version
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mariadbd]
invalid1=true
join_buffer_size=5K
invalid2=true

[mysqld]
key_buffer_size=20M
alter_algorithm=invalid
EOF
--echo Testing mariadbd section additions
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --current-version=mysql-5.7 --edit=last-old-version
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mariadbd]
key_buffer_size=20M
EOF
--echo Testing key_buffer_size in mariadbd section
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --current-version=mysql-5.7 --edit=last-old-version
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mysqld]
key_buffer_size=20M
EOF
--echo Testing --no-myisam-files
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --current-version=mysql-5.7 --edit=last-old-version --no-myisam-files
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mysqld]
default_week_format=1
EOF
--echo Testing --add-skip-start-slave
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --current-version=mysql-5.7 --edit=last-old-version --add-skip-slave-start
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mariadbd]
skip_slave_start
EOF
--echo Testing --add-skip-slave-start with skip_start_slave already present
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --current-version=mysql-5.7 --edit=last-old-version --add-skip-slave-start
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--write_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
[mysqld]
key_buffer_size=20M
EOF
--echo Testing --fix-all
--exec $MARIADB_UPGRADE_CONFIG_FILE --defaults-file=$MYSQLTEST_VARDIR/tmp/tmp1.cnf --update --current-version=mysql-5.7 --edit=last-old-version --fix-all
--exec cat $MYSQLTEST_VARDIR/tmp/tmp1.cnf

--remove_file $MYSQLTEST_VARDIR/tmp/tmp1.cnf
