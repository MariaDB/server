--source include/not_embedded.inc
--source include/have_innodb.inc
--source include/hostname_is_not_localhost.inc

# Basic test case for --table (restore single table)
create table t1(i int);
insert t1 values(100);
create view v1 as select 1;

--mkdir $MYSQLTEST_VARDIR/tmp/dump
--exec $MYSQL_DUMP --dir=$MYSQLTEST_VARDIR/tmp/dump test
drop table t1;
--exec $MYSQL_IMPORT --table=test.t1 --dir=$MYSQLTEST_VARDIR/tmp/dump
select * from t1;
--rmdir $MYSQLTEST_VARDIR/tmp/dump

# Test cases for --dir
# test --all-databases
--mkdir $MYSQLTEST_VARDIR/tmp/dump
--exec $MYSQL_DUMP --dir=$MYSQLTEST_VARDIR/tmp/dump --all-databases
--echo # Content of dump directory
--list_files $MYSQLTEST_VARDIR/tmp/dump
--echo # Content of 'test' dump subdirectory
--list_files $MYSQLTEST_VARDIR/tmp/dump/test
--echo # Content of 'mysql' dump subdirectory
--list_files $MYSQLTEST_VARDIR/tmp/dump/mysql
--echo # Content of 'mtr' dump subdirectory
--list_files $MYSQLTEST_VARDIR/tmp/dump/mtr

# Test --dir
--replace_result $MYSQLTEST_VARDIR vardir
# Ignore mtr.test_suppressions (may have suppressions or not), mysql.proc is smaller without perfschema/sys schema
--exec $MYSQL_IMPORT --local --verbose --dir $MYSQLTEST_VARDIR/tmp/dump --ignore-table=mtr.test_suppressions --ignore-table=mysql.proc

drop table t1;
drop view v1;
--rmdir $MYSQLTEST_VARDIR/tmp/dump

# Test foreign keys
create database db2;
use db2;
CREATE TABLE parent (
    id INT NOT NULL,
    PRIMARY KEY (id)
) ENGINE=INNODB;
CREATE TABLE child (
    id INT,
    parent_id INT,
    c CHAR(4),
    INDEX par_ind (parent_id),
    UNIQUE INDEX(c),
    FOREIGN KEY (parent_id)
        REFERENCES parent(id)
        ON DELETE CASCADE,
    CHECK (c >= 'a')
) ENGINE=INNODB;
insert into parent values(1),(2);
insert into child values (1,1,'a'),(1,2,'b'),(2,1,'c'),(2,2,'d');

# Example from https://github.com/mydumper/mydumper/issues/395  (can't repeat now)
CREATE TABLE offices (
  id int NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (id)
) ENGINE=InnoDB;

CREATE TABLE users (
  id int NOT NULL AUTO_INCREMENT,
  office_id int DEFAULT NULL,
  slogan text GENERATED ALWAYS AS (concat('Hello world #',office_id)) STORED,
  PRIMARY KEY (id),
  KEY office_id (office_id),
  CONSTRAINT users_ibfk_1 FOREIGN KEY (office_id) REFERENCES offices (id)
) ENGINE=InnoDB;

insert into offices values();
insert into offices values();
insert into offices values();
insert into offices values();

insert into users (office_id) values (1);
insert into users (office_id) values (2);
insert into users (office_id) values (3);

--mkdir $MYSQLTEST_VARDIR/tmp/dump
--exec $MYSQL_DUMP --dir=$MYSQLTEST_VARDIR/tmp/dump --all-databases

drop database db2;
--replace_result $MYSQLTEST_VARDIR vardir
--exec $MYSQL_IMPORT --local --silent --dir $MYSQLTEST_VARDIR/tmp/dump --database=db2 --parallel=2
use db2;
select * from parent;
select * from child;
show create table parent;
show create table child;
drop database db2;

--echo # Repeat import with --verbose to see "Adding secondary keys" in the output
--replace_result $MYSQLTEST_VARDIR vardir
--exec $MYSQL_IMPORT --verbose --dir $MYSQLTEST_VARDIR/tmp/dump --database=db2

--echo # Repeat import with --verbose and --innodb-optimize-indexes=0, to "not" see "Adding secondary indexes"
--replace_result $MYSQLTEST_VARDIR vardir
--exec $MYSQL_IMPORT --verbose --dir $MYSQLTEST_VARDIR/tmp/dump --database=db2 --innodb-optimize-keys=0
--rmdir $MYSQLTEST_VARDIR/tmp/dump

drop database db2;
create database db2;
use db2;
set rand_seed1=1, rand_seed2=2;

# Test with vector/fulltext/spatial indexes
create table vec (id int auto_increment primary key, v vector(5) not null,
  vector index (v)) ENGINE=InnoDB;
insert vec(v) values (x'e360d63ebe554f3fcdbc523f4522193f5236083d'),
                     (x'f511303f72224a3fdd05fe3eb22a133ffae86a3f'),
                     (x'f09baa3ea172763f123def3e0c7fe53e288bf33e'),
                     (x'b97a523f2a193e3eb4f62e3f2d23583e9dd60d3f'),
                     (x'f7c5df3e984b2b3e65e59d3d7376db3eac63773e'),
                     (x'de01453ffa486d3f10aa4d3fdd66813c71cb163f'),
                     (x'76edfc3e4b57243f10f8423fb158713f020bda3e'),
                     (x'56926c3fdf098d3e2c8c5e3d1ad4953daa9d0b3e'),
                     (x'7b713f3e5258323f80d1113d673b2b3f66e3583f'),
                     (x'6ca1d43e9df91b3fe580da3e1c247d3f147cf33e');
create table ft(v text, fulltext(v)) ENGINE=InnoDB;
insert into ft(v) values ('Once upon a time'),
  ('There was a wicked witch'), ('Who ate everybody up');
create table locations (id int auto_increment primary key, geom geometry NOT NULL) ENGINE=InnoDB;
create spatial index idx_geom on locations (geom);
insert into locations (geom) values (ST_GeomFromText('POINT(40.785091 -73.968285)'));
--mkdir $MYSQLTEST_VARDIR/tmp/dump
--exec $MYSQL_DUMP --dir=$MYSQLTEST_VARDIR/tmp/dump db2

# vector index uses randomization when building the index
# so unless one sets rand_seed variables, results are inherently
# non-repeatable
--append_file $MYSQLTEST_VARDIR/tmp/dump/db2/vec.sql
set rand_seed1=1, rand_seed2=2;
EOF

--echo # use --verbose to see "Adding secondary indexes" in the output
--replace_result $MYSQLTEST_VARDIR vardir
--exec $MYSQL_IMPORT --verbose --dir $MYSQLTEST_VARDIR/tmp/dump --database=db2

# smoke-test restored tables
show index from vec;
show index from locations;
show index from ft;

--replace_regex /(\.\d{5})\d+/\1/
select id,vec_distance_euclidean(v, x'B047263c9f87233fcfd27e3eae493e3f0329f43e') d from vec order by d limit 3;
select * from ft where match(v) against('wicked');

--rmdir $MYSQLTEST_VARDIR/tmp/dump

drop database db2;
create database db2;
use db2;

# Test with triggers (using https://mariadb.com/kb/en/trigger-overview/ example)
CREATE TABLE animals (id mediumint(9)
NOT NULL AUTO_INCREMENT,
name char(30) NOT NULL,
PRIMARY KEY (`id`));

CREATE TABLE animal_count (animals int);
INSERT INTO animal_count (animals) VALUES(0);

CREATE TRIGGER increment_animal
AFTER INSERT ON animals
FOR EACH ROW
UPDATE animal_count SET animal_count.animals = animal_count.animals+1;

INSERT INTO animals (name) VALUES('aardvark');
INSERT INTO animals (name) VALUES('baboon');


--echo # Content of tables before backup
select * from animals;
select * from animal_count;

--mkdir $MYSQLTEST_VARDIR/tmp/dump
--exec $MYSQL_DUMP --dir=$MYSQLTEST_VARDIR/tmp/dump db2
use test;
drop database db2;
--replace_result $MYSQLTEST_VARDIR vardir
--exec $MYSQL_IMPORT --local --verbose --dir $MYSQLTEST_VARDIR/tmp/dump
use db2;
--echo # Content of tables after import
select * from animals;
select * from animal_count;
drop table animals;
drop table animal_count;

# Test VIEW
create table t1 as select 1 as val;
create view a1 as select * from t1;
--rmdir $MYSQLTEST_VARDIR/tmp/dump
--mkdir $MYSQLTEST_VARDIR/tmp/dump
--exec $MYSQL_DUMP --dir=$MYSQLTEST_VARDIR/tmp/dump db2
use test;
drop database db2;
--replace_result $MYSQLTEST_VARDIR vardir
--exec $MYSQL_IMPORT --local --verbose --dir $MYSQLTEST_VARDIR/tmp/dump
use db2;
select * from t1;
select * from a1;
drop database db2;
--rmdir $MYSQLTEST_VARDIR/tmp/dump
use test;

# Test --ignore-database
# Do full backup, drop one db, restore with --ignore-database=db
# Check that database does not exist anymore
create database db;
use db;
create table t1 as select 1 as val;
--mkdir $MYSQLTEST_VARDIR/tmp/dump
--exec $MYSQL_DUMP --dir=$MYSQLTEST_VARDIR/tmp/dump --all-databases
use test;
drop database db;
--replace_result $MYSQLTEST_VARDIR vardir
--exec $MYSQL_IMPORT --local --silent --dir $MYSQLTEST_VARDIR/tmp/dump --ignore-database=db
--error  ER_BAD_DB_ERROR
use db;
use test;

--echo # Test non-existing --dir
--replace_result mariadb-import.exe mariadb-import $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--error 1
--exec $MYSQL_IMPORT --dir $MYSQLTEST_VARDIR/tmp/non_existing 2>&1

--echo # Test too many threads, builtin limit 256
--replace_result mariadb-import.exe mariadb-import $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--error 1
--exec $MYSQL_IMPORT --dir $MYSQLTEST_VARDIR/tmp/dump --parallel=300 2>&1

--rmdir $MYSQLTEST_VARDIR/tmp/dump

--echo #
--echo # Test --hex-blob option for mariadb-import
--echo # Round-trip tests: export with mysqldump --hex-blob, import with mariadb-import --hex-blob
--echo #

USE test;

--echo # Test 1: Round-trip basic BLOB types with --hex-blob
CREATE TABLE t_blob_roundtrip (
  id INT PRIMARY KEY,
  tiny_blob TINYBLOB,
  normal_blob BLOB,
  medium_blob MEDIUMBLOB,
  long_blob LONGBLOB
);

INSERT INTO t_blob_roundtrip VALUES
  (1, 'tiny\0data', 'normal\0blob', 'medium\0blob', 'long\0blob'),
  (2, NULL, NULL, NULL, NULL),
  (3, '', '', '', ''),
  (4, X'DEADBEEF', X'CAFEBABE', X'FEEDFACE', X'BAADF00D'),
  (5, X'00FF00FF', X'A5A5A5A5', X'12345678', X'FFFFFFFF');

--echo # Export with mysqldump --hex-blob --tab
--exec $MYSQL_DUMP --default-character-set=utf8mb4 --skip-comments --hex-blob --tab=$MYSQLTEST_VARDIR/tmp/ test t_blob_roundtrip

--echo # Save original data for comparison
CREATE TABLE t_blob_original LIKE t_blob_roundtrip;
INSERT INTO t_blob_original SELECT * FROM t_blob_roundtrip;

--echo # Drop table and recreate from .sql file
DROP TABLE t_blob_roundtrip;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/t_blob_roundtrip.sql

--echo # Import with mariadb-import --hex-blob
--exec $MYSQL_IMPORT --default-character-set=utf8mb4 --hex-blob test $MYSQLTEST_VARDIR/tmp/t_blob_roundtrip.txt

--echo # Verify data integrity - should return 0 rows (all data matches)
SELECT * FROM t_blob_roundtrip WHERE id NOT IN (SELECT id FROM t_blob_original);
SELECT * FROM t_blob_original WHERE id NOT IN (SELECT id FROM t_blob_roundtrip);
SELECT o.id FROM t_blob_original o, t_blob_roundtrip r
WHERE o.id = r.id
AND (o.tiny_blob IS NOT NULL AND r.tiny_blob IS NOT NULL AND o.tiny_blob != r.tiny_blob);

--echo # Show successful import
SELECT id, HEX(tiny_blob), HEX(normal_blob) FROM t_blob_roundtrip ORDER BY id;

--remove_file $MYSQLTEST_VARDIR/tmp/t_blob_roundtrip.sql
--remove_file $MYSQLTEST_VARDIR/tmp/t_blob_roundtrip.txt
DROP TABLE t_blob_roundtrip;
DROP TABLE t_blob_original;

--echo # Test 2: Round-trip BINARY and VARBINARY types
CREATE TABLE t_binary_roundtrip (
  id INT PRIMARY KEY,
  bin_col BINARY(10),
  varbin_col VARBINARY(100)
);

INSERT INTO t_binary_roundtrip VALUES
  (1, X'0102030405', 'varbinary\0test'),
  (2, NULL, NULL),
  (3, X'00', ''),
  (4, X'FFFFFFFFFFFFFF', X'DEADBEEFCAFEBABE');

--echo # Export with mysqldump --hex-blob --tab
--exec $MYSQL_DUMP --default-character-set=utf8mb4 --skip-comments --hex-blob --tab=$MYSQLTEST_VARDIR/tmp/ test t_binary_roundtrip

CREATE TABLE t_binary_original LIKE t_binary_roundtrip;
INSERT INTO t_binary_original SELECT * FROM t_binary_roundtrip;

DROP TABLE t_binary_roundtrip;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/t_binary_roundtrip.sql

--echo # Import with mariadb-import --hex-blob
--exec $MYSQL_IMPORT --default-character-set=utf8mb4 --hex-blob test $MYSQLTEST_VARDIR/tmp/t_binary_roundtrip.txt

--echo # Verify data integrity
SELECT o.id FROM t_binary_original o, t_binary_roundtrip r
WHERE o.id = r.id
AND ((o.bin_col IS NOT NULL AND r.bin_col IS NOT NULL AND o.bin_col != r.bin_col)
     OR (o.varbin_col IS NOT NULL AND r.varbin_col IS NOT NULL AND o.varbin_col != r.varbin_col));

--echo # Show successful import
SELECT id, HEX(bin_col), HEX(varbin_col) FROM t_binary_roundtrip ORDER BY id;

--remove_file $MYSQLTEST_VARDIR/tmp/t_binary_roundtrip.sql
--remove_file $MYSQLTEST_VARDIR/tmp/t_binary_roundtrip.txt
DROP TABLE t_binary_roundtrip;
DROP TABLE t_binary_original;

--echo # Test 3: Round-trip mixed table (BLOB and non-BLOB columns)
CREATE TABLE t_mixed_roundtrip (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  data BLOB,
  description TEXT,
  binary_data VARBINARY(100)
);

INSERT INTO t_mixed_roundtrip VALUES
  (1, 'First', X'ABCD', 'Description 1', X'1234'),
  (2, 'Second', NULL, 'Description 2', NULL),
  (3, 'Third', '', 'Description 3', ''),
  (4, 'Special\tChars', X'00FF00FF', 'Desc\nWith\nNewlines', X'CAFEBABE');

--echo # Export with mysqldump --hex-blob --tab
--exec $MYSQL_DUMP --default-character-set=utf8mb4 --skip-comments --hex-blob --tab=$MYSQLTEST_VARDIR/tmp/ test t_mixed_roundtrip

CREATE TABLE t_mixed_original LIKE t_mixed_roundtrip;
INSERT INTO t_mixed_original SELECT * FROM t_mixed_roundtrip;

DROP TABLE t_mixed_roundtrip;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/t_mixed_roundtrip.sql

--echo # Import with mariadb-import --hex-blob
--exec $MYSQL_IMPORT --default-character-set=utf8mb4 --hex-blob test $MYSQLTEST_VARDIR/tmp/t_mixed_roundtrip.txt

--echo # Verify all columns match
SELECT o.id FROM t_mixed_original o, t_mixed_roundtrip r
WHERE o.id = r.id
AND (o.name != r.name OR o.description != r.description
     OR (o.data IS NOT NULL AND r.data IS NOT NULL AND o.data != r.data)
     OR (o.binary_data IS NOT NULL AND r.binary_data IS NOT NULL AND o.binary_data != r.binary_data));

--echo # Show successful import
SELECT id, name, HEX(data), description, HEX(binary_data) FROM t_mixed_roundtrip ORDER BY id;

--remove_file $MYSQLTEST_VARDIR/tmp/t_mixed_roundtrip.sql
--remove_file $MYSQLTEST_VARDIR/tmp/t_mixed_roundtrip.txt
DROP TABLE t_mixed_roundtrip;
DROP TABLE t_mixed_original;

--echo # Test 4: Round-trip with --columns parameter (subset of columns)
CREATE TABLE t_columns_test (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  blob1 BLOB,
  blob2 BLOB,
  text_col TEXT
);

INSERT INTO t_columns_test VALUES
  (1, 'Row1', X'ABCD', X'1234', 'Text1'),
  (2, 'Row2', NULL, NULL, 'Text2'),
  (3, 'Row3', X'BEEF', X'CAFE', 'Text3');

--echo # Export with mysqldump --hex-blob --tab
--exec $MYSQL_DUMP --default-character-set=utf8mb4 --skip-comments --hex-blob --tab=$MYSQLTEST_VARDIR/tmp/ test t_columns_test

CREATE TABLE t_columns_original LIKE t_columns_test;
INSERT INTO t_columns_original SELECT * FROM t_columns_test;

DROP TABLE t_columns_test;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/t_columns_test.sql

--echo # Import with --hex-blob and --columns (id, blob1, blob2)
--exec $MYSQL_IMPORT --default-character-set=utf8mb4 --hex-blob --columns=id,name,blob1,blob2,text_col test $MYSQLTEST_VARDIR/tmp/t_columns_test.txt

--echo # Verify blob columns match
SELECT o.id FROM t_columns_original o, t_columns_test r
WHERE o.id = r.id
AND ((o.blob1 IS NOT NULL AND r.blob1 IS NOT NULL AND o.blob1 != r.blob1)
     OR (o.blob2 IS NOT NULL AND r.blob2 IS NOT NULL AND o.blob2 != r.blob2));

--echo # Show successful import
SELECT id, name, HEX(blob1), HEX(blob2), text_col FROM t_columns_test ORDER BY id;

--remove_file $MYSQLTEST_VARDIR/tmp/t_columns_test.sql
--remove_file $MYSQLTEST_VARDIR/tmp/t_columns_test.txt
DROP TABLE t_columns_test;
DROP TABLE t_columns_original;

--echo # Test 5: Import WITHOUT --hex-blob (default behavior - should fail or produce wrong data)
CREATE TABLE t_no_hex_import (
  id INT,
  data BLOB
);

INSERT INTO t_no_hex_import VALUES (1, X'DEADBEEF'), (2, NULL);

--exec $MYSQL_DUMP --default-character-set=utf8mb4 --skip-comments --hex-blob --tab=$MYSQLTEST_VARDIR/tmp/ test t_no_hex_import

CREATE TABLE t_no_hex_original LIKE t_no_hex_import;
INSERT INTO t_no_hex_original SELECT * FROM t_no_hex_import;

DROP TABLE t_no_hex_import;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/t_no_hex_import.sql

--echo # Import WITHOUT --hex-blob - data will be interpreted as ASCII string, not binary
--exec $MYSQL_IMPORT --default-character-set=utf8mb4 test $MYSQLTEST_VARDIR/tmp/t_no_hex_import.txt

--echo # Show data mismatch - imported data is ASCII "DEADBEEF" not binary 0xDEADBEEF
SELECT id, HEX(data) as hex_data, LENGTH(data) as data_length FROM t_no_hex_import ORDER BY id;
--echo # Original was binary (4 bytes), imported is ASCII string (8 bytes)
SELECT id, HEX(data) as hex_data, LENGTH(data) as data_length FROM t_no_hex_original ORDER BY id;

--remove_file $MYSQLTEST_VARDIR/tmp/t_no_hex_import.sql
--remove_file $MYSQLTEST_VARDIR/tmp/t_no_hex_import.txt
DROP TABLE t_no_hex_import;
DROP TABLE t_no_hex_original;

--echo # Test 6: NULL and empty blob handling
CREATE TABLE t_null_empty (
  id INT PRIMARY KEY,
  blob_null BLOB,
  blob_empty BLOB,
  blob_data BLOB
);

INSERT INTO t_null_empty VALUES
  (1, NULL, '', X'ABCD'),
  (2, NULL, '', X'1234');

--exec $MYSQL_DUMP --default-character-set=utf8mb4 --skip-comments --hex-blob --tab=$MYSQLTEST_VARDIR/tmp/ test t_null_empty

CREATE TABLE t_null_empty_original LIKE t_null_empty;
INSERT INTO t_null_empty_original SELECT * FROM t_null_empty;

DROP TABLE t_null_empty;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/t_null_empty.sql

--exec $MYSQL_IMPORT --default-character-set=utf8mb4 --hex-blob test $MYSQLTEST_VARDIR/tmp/t_null_empty.txt

--echo # Verify NULL remains NULL and empty remains empty
SELECT id, blob_null IS NULL as is_null, LENGTH(blob_empty) as empty_length, HEX(blob_data) FROM t_null_empty ORDER BY id;
SELECT o.id FROM t_null_empty_original o, t_null_empty r
WHERE o.id = r.id
AND ((o.blob_null IS NULL) != (r.blob_null IS NULL)
     OR o.blob_empty != r.blob_empty
     OR o.blob_data != r.blob_data);

--remove_file $MYSQLTEST_VARDIR/tmp/t_null_empty.sql
--remove_file $MYSQLTEST_VARDIR/tmp/t_null_empty.txt
DROP TABLE t_null_empty;
DROP TABLE t_null_empty_original;

--echo # Test 7: Table with only BLOB columns
CREATE TABLE t_all_blobs (
  blob1 BLOB,
  blob2 TINYBLOB,
  blob3 MEDIUMBLOB
);

INSERT INTO t_all_blobs VALUES
  (X'ABCDEF', X'123456', X'FEDCBA'),
  (NULL, NULL, NULL),
  (X'FF', X'00', X'AA');

--exec $MYSQL_DUMP --default-character-set=utf8mb4 --skip-comments --hex-blob --tab=$MYSQLTEST_VARDIR/tmp/ test t_all_blobs

CREATE TABLE t_all_blobs_original LIKE t_all_blobs;
INSERT INTO t_all_blobs_original SELECT * FROM t_all_blobs;

DROP TABLE t_all_blobs;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/t_all_blobs.sql

--exec $MYSQL_IMPORT --default-character-set=utf8mb4 --hex-blob test $MYSQLTEST_VARDIR/tmp/t_all_blobs.txt

--echo # Verify all blob columns match
SELECT HEX(blob1), HEX(blob2), HEX(blob3) FROM t_all_blobs ORDER BY blob1;
SELECT o.blob1 FROM t_all_blobs_original o
WHERE NOT EXISTS (
  SELECT * FROM t_all_blobs r
  WHERE (o.blob1 IS NULL AND r.blob1 IS NULL) OR o.blob1 = r.blob1
);

--remove_file $MYSQLTEST_VARDIR/tmp/t_all_blobs.sql
--remove_file $MYSQLTEST_VARDIR/tmp/t_all_blobs.txt
DROP TABLE t_all_blobs;
DROP TABLE t_all_blobs_original;

--echo # Test 8: Round-trip with --dir option
CREATE TABLE t_dir_import (
  id INT PRIMARY KEY,
  data BLOB
);

INSERT INTO t_dir_import VALUES
  (1, X'DEADBEEF'),
  (2, 'test\0data'),
  (3, NULL);

--mkdir $MYSQLTEST_VARDIR/tmp/dump_hex
--exec $MYSQL_DUMP --default-character-set=utf8mb4 --skip-comments --hex-blob --dir=$MYSQLTEST_VARDIR/tmp/dump_hex test

CREATE TABLE t_dir_import_original LIKE t_dir_import;
INSERT INTO t_dir_import_original SELECT * FROM t_dir_import;

DROP TABLE t_dir_import;
--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/dump_hex/test/t_dir_import.sql

--echo # Import with mariadb-import --hex-blob from --dir export
--exec $MYSQL_IMPORT --default-character-set=utf8mb4 --hex-blob test $MYSQLTEST_VARDIR/tmp/dump_hex/test/t_dir_import.txt

--echo # Verify data integrity
SELECT o.id FROM t_dir_import_original o, t_dir_import r
WHERE o.id = r.id
AND ((o.data IS NOT NULL AND r.data IS NOT NULL AND o.data != r.data));

SELECT id, HEX(data) FROM t_dir_import ORDER BY id;

--remove_file $MYSQLTEST_VARDIR/tmp/dump_hex/test/t_dir_import.sql
--remove_file $MYSQLTEST_VARDIR/tmp/dump_hex/test/t_dir_import.txt
--rmdir $MYSQLTEST_VARDIR/tmp/dump_hex/test
--rmdir $MYSQLTEST_VARDIR/tmp/dump_hex
DROP TABLE t_dir_import;
DROP TABLE t_dir_import_original;
