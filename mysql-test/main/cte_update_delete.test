--echo #
--echo # MDEV-37220 Allow UPDATE/DELETE to read from a CTE
--echo #

create table t1
(
  a int not null,
  b int,
  c int,
  d int,
  amount decimal,
  key t1_ix1 (a,b)
);

insert into t1 values (0, NULL, 0, NULL, 10.0000), (1, 1, 1, 1, 10.0000),
(2, 2, 2, 2, 20.0000), (3, 3, 3, 3, 30.0000), (4, 4, 4, 4, 40.0000),
(5, 5, 5, 5, NULL), (6, 6, 6, 6, NULL), (7, 7, 7, 7, 70.0000),
(8, 8, 8, 8, 80.0000);

create table t2
(
  a int NOT NULL,
  b int,
  name varchar(50),
  key t2_ix1 (a,b)
);

insert into t2 values (0, NULL, 'a'), (1, NULL, 'A'), (2, 2, 'B'), (3,3, 'C'),
(4,4, 'D'), (5,5, NULL), (6,6, NULL), (7,7, 'E'), (8,8, 'F'), (9,9, 'G'),
(10,10,'H'), (11,11, NULL), (12,12, NULL);

create table t3
(
  a int,
  b int,
  description varchar(50)
);

let $empty_t3=
truncate t3;
let $fill_t3=
insert into t3 values (1, 1, 'iron'),(2,2,'wood'),(0,NULL, 'gold'),
(3, 3, 'silver'), (4, 4, 'lead'), (5, 5, 'tin'), (6, 6, 'platinum'),
(7, 7, 'aluminium');

create table t4 as select * from t1;
create table t5 as select * from t2;

eval $fill_t3;

select * from t3;

--echo # update, single table syntax, subq in set
let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
update t3
  set t3.a = (select a from cte where b in (select b from cte2) and d = t3.a);
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval prepare s from '$q';
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop prepare s;

--echo # update, single table syntax, subq in set, cte used twice
let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
update t3
  set t3.a = (select a from cte
                where
                  (b in (select b from cte2 where cte2.a = cte.a) or
                  b in (select b from cte2 where cte2.b = cte.a)) and
                  d = t3.a
             );
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval prepare s from '$q';
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop prepare s;

--echo # multi table syntax, subq in set and where
let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
update t3,cte
  set t3.a = cte.a+1 where cte.b in (select b from cte2) and d = t3.a;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;

--echo # multi table syntax, subq in set and where, more complex CTEs
let $q=
with cte as (select t1.* from t1 left join t4 on t1.d = t4.d where t1.c < 5),
  cte2 as (select t2.* from t2, t5 where t2.b < 3 and t2.name = t5.name limit 1)
update t3,cte, t4
  set t3.a = cte.a+1, t4.a = cte.a+2
  where cte.b in (select b from cte2) and cte.d = t3.a and cte.b = t4.a;
eval explain $q;
eval $q;
select * from t3;
select * from t4;
eval $empty_t3;
eval $fill_t3;
drop table t4;
create table t4 as select * from t1;

eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
select * from t4;
eval $empty_t3;
eval $fill_t3;
drop table t4;
create table t4 as select * from t1;
eval prepare s from '$q';
execute s;
select * from t3;
select * from t4;
eval $empty_t3;
eval $fill_t3;
drop table t4;
create table t4 as select * from t1;
execute s;
select * from t3;
select * from t4;
eval $empty_t3;
eval $fill_t3;
drop prepare s;

drop table t4;
create table t4 as select * from t1;

let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
update t3 left join cte on t3.b = cte.b
  set t3.a = cte.a+1 where cte.b in (select b from cte2) and d = t3.a;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;

let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
update t3, cte, cte2 set t3.a = cte.a+2 where cte.b = cte2.b and d = t3.a;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;

let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
update cte, cte2, t3 set t3.a = cte.a+2 where cte.b = cte2.b and d = t3.a;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;

let $q=
with cte as (select * from t1 where c < 5 group by a),
  cte2 as (select * from t2 where b < 3 group by a)
update cte, cte2, t3 set t3.a = cte.a+2 where cte.b = cte2.b and d = t3.a;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;

create view v1 as select * from t1;
let $q=
with cte as (select * from v1 where c < 5 group by a),
  cte2 as (select * from t2 where b < 3 group by a)
update cte, cte2, t3 set t3.a = cte.a+2 where cte.b = cte2.b and d = t3.a;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;

--error 1288
with T as (select * from t1) update T set T.a=3;

--error 1288
with T as (select * from v1) update T set T.a=3;

--error 1288
with T as (select * from t1) delete from T where a=3;

--error 1288
with T as (select * from v1) delete from T where a=3;

drop view v1;

create view v1 as select * from t1 where b IS NOT NULL limit 1;
let $q=
with cte as (select * from v1 where c < 5 group by a),
  cte2 as (select * from t2 where b < 3 group by a)
update cte, cte2, t3 set t3.a = cte.a+2 where d = t3.a;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop view v1;

CREATE FUNCTION f1 () RETURNS BLOB RETURN 1;
CREATE TABLE tf (f1 DATE);
INSERT INTO tf VALUES('2001-01-01');
let $q=
with cte as (select f1 as a, f1() as b, 2 as d from tf),
  cte2 as (select * from t2 where b < 3 group by a)
update cte, cte2, t3 set t3.a = cte.a+2 where cte.b = cte2.b and d = t3.a;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop function f1;
drop table tf;

--echo # delete single table syntax
let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
delete from t3
  where t3.a = (select a from cte where b in (select b from cte2));

eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;


--echo # delete multi table syntax
let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
delete from t3
  using t3, cte
  where t3.a = cte.a and cte.b in (select b from cte2);
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;

--echo # delete multi table syntax, multi table delete
let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
delete from t3, t4
  using t3, t4, cte
  where t3.a = cte.a and cte.b in (select b from cte2)
    and t4.a = t3.a;
eval explain $q;
eval $q;
select * from t3;
select * from t4;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;

--echo # delete multi table syntax, multi table CTEs
let $q=
with cte as (select t1.* from t1 left join t4 on t1.d = t4.d where t1.c < 5),
  cte2 as (select t2.* from t2, t5 where t2.b < 3 and t2.name = t5.name limit 1)
delete from t3
  using t3, cte
  where t3.a = cte.a and cte.b in (select b from cte2);
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval prepare s from '$q';
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop prepare s;



--echo # delete multi table syntax, limit clause in delete
let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
delete from t3
  using t3, cte
  where t3.a = cte.a and cte.b in (select b from cte2) limit 1;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval prepare s from '$q';
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop prepare s;

let $q=
with cte as (select * from t1 where c < 5),
  cte2 as (select * from t2 where b < 3)
delete from t3
  using t3, cte, cte2
  where t3.a = cte.a and cte.b = cte2.b;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;

--echo # recursive CTE, test update on values 1 (NC), 2, 5, 6 from CTE
let $q=
with recursive cte_r(a, c) as
  (
    values (1,5)
    union
    values (2,6)
    union
    select t1.a, t1.b
      from t1, cte_r
      where t1.a = cte_r.a
  )
update t3, cte_r
  set t3.a = 1
  where t3.b = c;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval prepare s from '$q';
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop prepare s;

--echo # recursive CTE, test delete, multi table syntax
let $q=
with recursive cte_r(a, c) as
  (
    values (1,5)
    union
    values (2,6)
    union
    select t1.a, t1.b
      from t1, cte_r
      where t1.a = cte_r.a
  )
delete from t3
  using t3, cte_r
  where t3.b = c;
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval prepare s from '$q';
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop prepare s;

--echo # recursive CTE, test delete, single table syntax
let $q=
with recursive cte_r(a, c) as
  (
    values (1,5)
    union
    values (2,6)
    union
    select t1.a, t1.b
      from t1, cte_r
      where t1.a = cte_r.a
  ),
  cte (a) as
  (
    select a from t2
  )
delete from t3
  where t3.b in (select c from cte_r, cte where cte.a = cte_r.a );
eval explain $q;
eval $q;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval create procedure p() $q;
call p();
drop procedure p;
select * from t3;
eval $empty_t3;
eval $fill_t3;
eval prepare s from '$q';
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
execute s;
select * from t3;
eval $empty_t3;
eval $fill_t3;
drop prepare s;


drop table t1, t2, t3, t4, t5;

--echo # End of 12.2 tests
