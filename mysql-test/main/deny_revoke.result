#
# REVOKE DENY tests
#
CREATE TABLE t1 (a INT, b INT);
CREATE PROCEDURE p1() BEGIN SET @x=1; END;
$$
CREATE FUNCTION f1() RETURNS INT RETURN 1;
$$
CREATE PACKAGE pkg1
PROCEDURE p1();
FUNCTION f1() RETURNS INT;
END;
$$
CREATE PACKAGE BODY pkg1
PROCEDURE p1() BEGIN SET @pkg=2; END;
FUNCTION f1() RETURNS INT BEGIN RETURN 2; END;
END;
$$
CREATE USER u@localhost;
GRANT ALL PRIVILEGES ON *.* to u@localhost;
PREPARE show_denies FROM "SELECT IF(JSON_EXTRACT(Priv, '$.denies') IS NULL OR JSON_LENGTH(JSON_EXTRACT(Priv, '$.denies')) = 0, 'no entries', JSON_PRETTY(JSON_EXTRACT(Priv, '$.denies'))) AS denies FROM mysql.global_priv WHERE User='u' AND Host='localhost'";
#
# Global
#
DENY SELECT ON *.* TO u@localhost;
REVOKE DENY SELECT ON *.* FROM u@localhost;
EXECUTE show_denies;
denies
no entries
#
# Database
#
DENY INSERT ON test.* TO u@localhost;
REVOKE DENY INSERT ON test.* FROM u@localhost;
EXECUTE show_denies;
denies
no entries
# Second revoke should error
REVOKE DENY INSERT ON test.* FROM u@localhost;
ERROR 42000: There is no such grant defined for user 'u' on host 'localhost'
#
# Table
#
DENY UPDATE ON test.t1 TO u@localhost;
SHOW GRANTS FOR u@localhost;
Grants for u@localhost
GRANT ALL PRIVILEGES ON *.* TO `u`@`localhost`
DENY UPDATE ON `test`.`t1` TO `u`@`localhost`
REVOKE DENY UPDATE ON test.t1 FROM u@localhost;
EXECUTE show_denies;
denies
no entries
# Second revoke should error
REVOKE DENY UPDATE ON test.t1 FROM u@localhost;
ERROR 42000: There is no such grant defined for user 'u' on host 'localhost' on table 't1'
#
# Column
#
DENY SELECT (a) ON test.t1 TO u@localhost;
SHOW GRANTS FOR u@localhost;
Grants for u@localhost
GRANT ALL PRIVILEGES ON *.* TO `u`@`localhost`
GRANT SELECT ON `test`.`t1` TO `u`@`localhost`
DENY SELECT (`a`) ON `test`.`t1` TO `u`@`localhost`
REVOKE DENY SELECT (a) ON test.t1 FROM u@localhost;
EXECUTE show_denies;
denies
no entries
# Second revoke should error
REVOKE DENY SELECT (a) ON test.t1 FROM u@localhost;
ERROR 42000: There is no such grant defined for user 'u' on host 'localhost' on table 't1'
#
# Procedure
#
DENY EXECUTE ON PROCEDURE test.p1 TO u@localhost;
SHOW GRANTS FOR u@localhost;
Grants for u@localhost
GRANT ALL PRIVILEGES ON *.* TO `u`@`localhost`
DENY EXECUTE ON PROCEDURE `test`.`p1` TO `u`@`localhost`
REVOKE DENY EXECUTE ON PROCEDURE test.p1 FROM u@localhost;
EXECUTE show_denies;
denies
no entries
# Second revoke should error
REVOKE DENY EXECUTE ON PROCEDURE test.p1 FROM u@localhost;
ERROR 42000: There is no such grant defined for user 'u' on host 'localhost' on routine 'p1'
#
# Function
#
DENY EXECUTE ON FUNCTION test.f1 TO u@localhost;
SHOW GRANTS FOR u@localhost;
Grants for u@localhost
GRANT ALL PRIVILEGES ON *.* TO `u`@`localhost`
DENY EXECUTE ON FUNCTION `test`.`f1` TO `u`@`localhost`
REVOKE DENY EXECUTE ON FUNCTION test.f1 FROM u@localhost;
EXECUTE show_denies;
denies
no entries
# Second revoke should error
REVOKE DENY EXECUTE ON FUNCTION test.f1 FROM u@localhost;
ERROR 42000: There is no such grant defined for user 'u' on host 'localhost' on routine 'f1'
#
# Package
#
DENY EXECUTE ON PACKAGE test.pkg1 TO u@localhost;
SHOW GRANTS FOR u@localhost;
Grants for u@localhost
GRANT ALL PRIVILEGES ON *.* TO `u`@`localhost`
DENY EXECUTE ON PACKAGE `test`.`pkg1` TO `u`@`localhost`
REVOKE DENY EXECUTE ON PACKAGE test.pkg1 FROM u@localhost;
EXECUTE show_denies;
denies
no entries
# Second revoke should error
REVOKE DENY EXECUTE ON PACKAGE test.pkg1 FROM u@localhost;
ERROR 42000: There is no such grant defined for user 'u' on host 'localhost' on routine 'pkg1'
#
# Package body
#
DENY EXECUTE ON PACKAGE BODY test.pkg1 TO u@localhost;
SHOW GRANTS FOR u@localhost;
Grants for u@localhost
GRANT ALL PRIVILEGES ON *.* TO `u`@`localhost`
DENY EXECUTE ON PACKAGE BODY `test`.`pkg1` TO `u`@`localhost`
REVOKE DENY EXECUTE ON PACKAGE BODY test.pkg1 FROM u@localhost;
EXECUTE show_denies;
denies
no entries
# Second revoke should error
REVOKE DENY EXECUTE ON PACKAGE BODY test.pkg1 FROM u@localhost;
ERROR 42000: There is no such grant defined for user 'u' on host 'localhost' on routine 'pkg1'
DEALLOCATE PREPARE show_denies;
DROP USER u@localhost;
DROP PACKAGE BODY pkg1;
DROP PACKAGE pkg1;
DROP FUNCTION f1;
DROP PROCEDURE p1;
DROP TABLE t1;
