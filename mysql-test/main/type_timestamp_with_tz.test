SET time_zone='+04:00';

# TODO: metadata

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE TABLE t1 AS SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' AS c1;

# TODO: this does not produce an error
#--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
#SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' AS c1
#UNION
#SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00';


# Move this to timestamp_at_time_zone.test
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT POINT(1,1) AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT ROW(1,1) AT TIME ZONE '+00:00';


--echo #
--echo # ORDER BY
--echo #

# Fixed length sort keys
CREATE TABLE t1 (a datetime);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:01');
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1;
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1 DESC;
--source include/analyze-format.inc
ANALYZE FORMAT=JSON
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1;
DROP TABLE t1;

# Packed sort keys
CREATE TABLE t1 (a datetime, b text character set utf8);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00',''),('2001-01-01 00:00:01','');
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1, b;
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1 DESC, b;
--source include/analyze-format.inc
ANALYZE FORMAT=JSON
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1, b;
DROP TABLE t1;


--echo #
--echo # Comparison
--echo #

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00','+00:00')=
       TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00','+00:00')<
       TIMESTAMP_TZ('2001-01-01 10:00:01','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:01','+00:00')>
       TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00')=
       TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00')<
       TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00')>
       TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;


--echo #
--echo # BETWEEN
--echo #

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;


SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1'     ,'+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0'     ,'+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.999999','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1'     ,'+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.11'    ,'+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.999999','+04:00') AS c1;


--echo #
--echo # IN
--echo #

CREATE TABLE t1 (a datetime);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:01');

SELECT
  a,
  TIMESTAMP_TZ(a, '+00:00') IN (
    TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00'),
    TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00')) AS c1
FROM t1;

SELECT
  a,
  TIMESTAMP_TZ(a, '+00:00') IN (
    TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00'),
    TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00')) AS c1
FROM t1;


SELECT
  a,
  ROW(1, TIMESTAMP_TZ(a, '+00:00')) IN (
    ROW(1,TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00')),
    ROW(1,TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00'))) AS c1
FROM t1;

SELECT
  a,
  ROW(1,TIMESTAMP_TZ(a, '+00:00')) IN (
    ROW(1,TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00')),
    ROW(1,TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00'))) AS c1
FROM t1;

DROP TABLE t1;


--echo #
--echo # Unary operations
--echo #

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT ROUND('2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT FLOOR('2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT CEILING('2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT ABS('2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT -('2001-01-01 10:00:00' AT TIME ZONE '+00:00');


--echo #
--echo # Dyadic operations
--echo #

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' + 1;
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' - 1;
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' * 1;
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' / 1;
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' MOD 1;

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 + '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 - '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 * '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 / '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 MOD '2001-01-01 10:00:00' AT TIME ZONE '+00:00';

--echo #
--echo # LEAST/GREATEST
--echo #

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', 1);

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', 1);
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT GREATEST(1, '2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', '');
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT GREATEST('', '2001-01-01 10:00:00' AT TIME ZONE '+00:00');


SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
             '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
SELECT LEAST(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;

SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
                '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
SELECT GREATEST(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;


CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:00.999999');
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT LEAST(a, TIMESTAMP_TZ(a,'+00:00')) FROM t1;
SELECT
  a,
  LEAST(TIMESTAMP_TZ(a,'+00:00'),
        TIMESTAMP_TZ('2001-01-01 04:00:00.999000','+04:00')) AS l
FROM t1;
DROP TABLE t1;


--echo #
--echo # Hybrid functions
--echo #

SELECT COALESCE('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
SELECT COALESCE(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;

# These returns an error
#CREATE TABLE t1 (a TIMESTAMP);
#SELECT COALESCE(a, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') FROM t1;
#SELECT COALESCE('2001-01-01 10:00:00' AT TIME ZONE '+00:00', a) FROM t1;
#DROP TABLE t1;


--echo #
--echo # CASE
--echo #

CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 04:00:00'),
('2001-01-01 00:00:00.999999');
SELECT
  a,
  CASE TIMESTAMP_TZ(a,'+00:00')
    WHEN TIMESTAMP_TZ('2001-01-01 04:00:00','+00:00') THEN 1
    WHEN TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00') THEN 4
    ELSE 0
  END AS c1
FROM t1;
DROP TABLE t1;


--echo #
--echo # GROUP BY
--echo #

# Covers Item_copy:

SET time_zone='+04:00';
CREATE OR REPLACE TABLE t1 (a INT, b TIMESTAMP) ENGINE=MyISAM;
INSERT INTO t1 VALUES (1,'2018-06-19 00:00:00');
SELECT NULLIF(TIMESTAMP_TZ(b,'+00:00'), NULL) AS f, MAX(a) FROM t1 GROUP BY f;
DROP TABLE t1;
SET time_zone=DEFAULT;


--echo #
--echo # MIN and MAX
--echo #

CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');
SELECT MIN(TIMESTAMP_TZ(a, '+00:00')) FROM t1;
SELECT MAX(TIMESTAMP_TZ(a, '+00:00')) FROM t1;
DROP TABLE t1;


--echo #
--echo # Subselect
--echo #

CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1=(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1);

SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')=
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')=
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;

SELECT (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 ORDER BY a LIMIT 1) <
       (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 ORDER BY a DESC LIMIT 1) AS c1;

SELECT (SELECT MIN(TIMESTAMP_TZ(a, '+00:00')) FROM t1) <
       (SELECT MAX(TIMESTAMP_TZ(a, '+00:00')) FROM t1) AS c1;

DROP TABLE t1;


--echo #
--echo # Prepared statements
--echo #

EXECUTE IMMEDIATE
  'SELECT ? AS p'
USING
  TIMESTAMP_TZ('2001-01-01 10:20:30', '+04:00');

CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00'), ('2001-01-01 10:00:01');
EXECUTE IMMEDIATE
  'SELECT * FROM t1 WHERE TIMESTAMP_TZ(a,''+04:00'')=?'
USING
  TIMESTAMP_TZ('2001-01-01 10:00:00', '+04:00');
DROP TABLE t1;

--echo #
--echo # Prepared statements - bad example.
--echo # This behaviour will change to return the time zone in the output.
--echo # This should be fixed together with MDEV-14271.
--echo #

EXECUTE IMMEDIATE
  'SELECT CONCAT(?) AS p'
USING
  TIMESTAMP_TZ('2001-01-01 10:20:30', '+04:00');

SET time_zone=DEFAULT;
