--echo #
--echo # Test to inspect the range_selectivity returned by Histogram_json and Histogram_binary
--echo # todo: should be merged with statistics_json.test
--echo #

set @save_histogram_type=@@histogram_type;
set @save_histogram_size=@@histogram_size;

create table ten(a int primary key);
insert into ten values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);

create table t1_bin (a varchar(255));
insert into t1_bin select concat('a-', a) from ten;

set histogram_size=100;
analyze table t1_bin persistent for all;
select hex(histogram) from mysql.column_stats where table_name='t1_bin';
explain extended select * from t1_bin where a between 'a-3a' and 'zzzzzzzzz';
analyze select * from t1_bin where a between 'a-3a' and 'zzzzzzzzz';

create table t1_json (a varchar(255));
insert into t1_json select concat('a-', a) from ten;
set histogram_type=json;
analyze table t1_json persistent for all;
select * from mysql.column_stats where table_name='t1_json';
explain extended select * from t1_json where a between 'a-3a' and 'zzzzzzzzz';
analyze select * from t1_json where a between 'a-3a' and 'zzzzzzzzz';


create table t2_bin(a int);
insert into t2_bin select a*10 from ten;
set histogram_type=@save_histogram_type;
analyze table t2_bin persistent for all;
explain extended select * from t2_bin where a between '44' and '55';
analyze select * from t2_bin where a between '44' and '55';

create table t2_json(a int);
insert into t2_json select a*10 from ten;
set histogram_type=json;
analyze table t2_json persistent for all;
select * from mysql.column_stats where table_name='t2_json';
explain extended select * from t2_json where a between '44' and '55';
analyze select * from t2_json where a between '44' and '55';

--source include/have_sequence.inc
create table users (
  city varchar(100)
);
set histogram_size=50;
insert into users select 'Moscow' from seq_1_to_99;
insert into users select 'Helsinki' from seq_1_to_2;
set histogram_type=json;
analyze table users persistent for all;
select histogram from mysql.column_stats where table_name='users';
explain extended select * from users where city <= 'Moscow';
analyze select * from users where city <= 'Moscow';


drop table t1_bin;
drop table t1_json;
drop table t2_bin;
drop table t2_json;
drop table users;

