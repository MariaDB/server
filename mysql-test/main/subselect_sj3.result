#
# MDEV-37732 In MDEV-36861, analyze Q21
#
create table t1 (a int not null, b int, c int) engine=innodb;
create table t2 (d int primary key, e int, f int) engine=innodb;
create table t3 (g int primary key, h int, i int) engine=innodb;
create index t1_ix1 on t1 (a);
create index t1_ix2 on t1 (b);
insert into t1 select seq, seq/3, seq from seq_1_to_1000;
insert into t1 select seq, seq/3, seq+100 from seq_1_to_1000;
insert into t1 select seq, seq/3, seq+200 from seq_1_to_1000;
insert into t2 select seq, seq*2, seq*3 from seq_1_to_1000;
insert into t3 select seq, seq*3, seq*4 from seq_1_to_1000;
analyze table t1, t2, t3;
Table	Op	Msg_type	Msg_text
test.t1	analyze	status	Engine-independent statistics collected
test.t1	analyze	status	OK
test.t2	analyze	status	Engine-independent statistics collected
test.t2	analyze	status	OK
test.t3	analyze	status	Engine-independent statistics collected
test.t3	analyze	status	OK
explain select e, count(*) as foo
from t2, t3, t1
where d = b
and g = c
and exists
(
select * from t1 d1
where d1.a = t1.a
and d1.c <> t1.c
);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	d1	ALL	t1_ix1	NULL	NULL	NULL	3000	Start temporary
1	PRIMARY	t1	ref	t1_ix1,t1_ix2	t1_ix1	4	test.d1.a	3	Using where; End temporary
1	PRIMARY	t2	eq_ref	PRIMARY	PRIMARY	4	test.t1.b	1	
1	PRIMARY	t3	eq_ref	PRIMARY	PRIMARY	4	test.t1.c	1	
set @new_mode_save = @@new_mode;
set @@new_mode = "FIX_DUPLICATE_WEEDOUT";
explain select e, count(*) as foo
from t2, t3, t1
where d = b
and g = c
and exists
(
select * from t1 d1
where d1.a = t1.a
and d1.c <> t1.c
);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	t1_ix1,t1_ix2	NULL	NULL	NULL	3000	Using where
1	PRIMARY	t2	eq_ref	PRIMARY	PRIMARY	4	test.t1.b	1	
1	PRIMARY	t3	eq_ref	PRIMARY	PRIMARY	4	test.t1.c	1	
1	PRIMARY	d1	ref	t1_ix1	t1_ix1	4	test.t1.a	3	Using where; FirstMatch(t3)
set @@new_mode = @new_mode_save;
drop table t1, t2, t3;
# End of 11.8 tests
