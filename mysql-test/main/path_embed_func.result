#
# MDEV-34391 Path resolution
# Stored function tests with embedded PATH
#
CREATE DATABASE test2;
CREATE FUNCTION test2.func2() RETURNS TEXT
BEGIN
RETURN 'test2.func2';
END;
$$
CREATE DATABASE test3;
CREATE FUNCTION test3.func2() RETURNS TEXT
BEGIN
RETURN 'test3.func2';
END;
$$
CREATE DATABASE test4;
CREATE FUNCTION test4.func4() RETURNS TEXT
BEGIN
RETURN 'test4.func4';
END;
$$
#
# Embed a path in a stored function
#
CREATE FUNCTION func() RETURNS TEXT
PATH 'test2'
BEGIN
RETURN func2();
END;
$$
SELECT func();
func()
test2.func2
SET PATH 'test3';
SELECT test.func();
test.func()
test2.func2
DROP FUNCTION func;
SET PATH 'CURRENT_SCHEMA';
#
# Ensure that multiple references are resolved properly
#
CREATE FUNCTION func() RETURNS TEXT
PATH 'test2'
BEGIN
RETURN CONCAT(func2(), '+', func2());
END;
$$
SELECT func();
func()
test2.func2+test2.func2
SET PATH 'test3';
SELECT test.func();
test.func()
test2.func2+test2.func2
DROP FUNCTION func;
SET PATH 'CURRENT_SCHEMA';
#
# Use multiple schemas in embedded PATH
#
CREATE FUNCTION func() RETURNS TEXT
PATH 'test2,test3,test4'
BEGIN
RETURN CONCAT(func2(), '+', func2(), '+', func4());
END;
$$
SELECT func();
func()
test2.func2+test2.func2+test4.func4
SET PATH 'test3';
SELECT test.func();
test.func()
test2.func2+test2.func2+test4.func4
DROP FUNCTION func;
SET PATH 'CURRENT_SCHEMA';
#
# Use empty PATH in stored routine (resolution should fail)
#
CREATE FUNCTION func() RETURNS TEXT
PATH ''
BEGIN
RETURN func2();
END;
$$
SELECT func();
ERROR 42000: FUNCTION test.func2 does not exist
#
# ALTER FUNCTION's previously empty PATH
#
ALTER FUNCTION func PATH 'test2';
SELECT func();
func()
test2.func2
DROP FUNCTION func;
#
# No PATH specified in stored routine
# Resolution follows the caller's PATH
#
CREATE FUNCTION func() RETURNS TEXT
BEGIN
RETURN func2();
END;
$$
SELECT func();
ERROR 42000: FUNCTION test.func2 does not exist
SET PATH 'CURRENT_SCHEMA,test2';
SELECT func();
func()
test2.func2
DROP FUNCTION func;
DROP DATABASE test2;
DROP DATABASE test3;
DROP DATABASE test4;
