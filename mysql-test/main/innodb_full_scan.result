#
# MDEV-24813 Locking full table scan fails to use table-level locking
#
CREATE TABLE t (a INT PRIMARY KEY) ENGINE=InnoDB;
insert into t values (42);
# SELECT
set global innodb_monitor_enable="lock_rec_lock_created";
BEGIN;
SELECT * FROM t LOCK IN SHARE MODE;
a
42
COMMIT;
## +0, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
0
BEGIN;
SELECT * FROM t for update;
a
42
COMMIT;
## +0, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
0
## SELECT without explicit transaction
SELECT * FROM t;
a
42
### +0, was +0
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
0
# SELECT with a condition
BEGIN;
select * from t where a > 10 lock in share mode;
a
42
COMMIT;
### +1, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
1
BEGIN;
SELECT * FROM t where a > 10 for update;
a
42
COMMIT;
## +1, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
2
## SELECT with a condition without explicit transaction
SELECT * FROM t where a > 10;
a
42
### +0, was +0
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
2
DROP TABLE t;
# INSERT INTO ... SELECT with UNION
create table t1 (a int primary key, b int) engine=innodb;
insert into t1 select seq, seq from seq_1_to_100;
create table t2 (a int, b int) engine=innodb;
insert into t2
select * from t1 where t1.a = 10
UNION
select * from t1;
## +1, was +3
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
3
insert into t2
select * from t1
UNION
select * from t1 where t1.a = 10;
## +1, was +3
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
4
insert into t2
select * from t1 where t1.a > 10
UNION
select * from t1;
## +1, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
5
insert into t2
select * from t1
UNION
select * from t1 where t1.a > 10;
## +0, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
5
drop table t1, t2;
# CREATE ... SELECT with UNION
create table t1 (a int primary key, b int) engine=innodb;
insert into t1 select seq, seq from seq_1_to_100;
create table t2 (a int, b int) engine=innodb
select * from t1 where t1.a = 10
UNION
select * from t1;
## +1, was +3
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
6
create or replace table t2 (a int, b int) engine=innodb
select * from t1
UNION
select * from t1 where t1.a = 10;
## +1, was +3
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
7
create or replace table t2 (a int, b int) engine=innodb
select * from t1 where t1.a > 10
UNION
select * from t1;
## +1, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
8
create or replace table t2 (a int, b int) engine=innodb
select * from t1
UNION
select * from t1 where t1.a > 10;
## +0, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
8
drop table t1, t2;
# UPDATE
create table t1 (a int primary key, b int) engine=innodb;
insert into t1 select seq, seq from seq_1_to_100;
UPDATE t1 SET b = b + 3;
## +0, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
8
UPDATE t1 SET b = b + 3 WHERE a = 10;
## +1, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
9
UPDATE t1 SET b = b + 3 WHERE a > 10;
## +1, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
10
# DELETE
DELETE FROM t1;
## +0, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
10
DELETE FROM t1 WHERE a = 10;
## +1, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
11
DELETE FROM t1 WHERE a > 10;
## +1, was +1
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
12
drop table t1;
# JOIN
create table t1 (a int primary key, b int) engine=innodb;
insert into t1 select seq, seq from seq_1_to_100;
create table t2 (a int primary key, b int) engine=innodb;
insert into t2 select seq, seq from seq_1_to_100;
begin;
select * from t1 join t2 on t1.a = t2.a LOCK IN SHARE MODE;
commit;
## +1, was +2
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
13
begin;
select * from t1 join t2 on t1.a = t2.b LOCK IN SHARE MODE;
commit;
## +2, was +2
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
15
begin;
select * from t1 join t2 on t1.b = t2.b LOCK IN SHARE MODE;
commit;
## +1, was +2
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
16
drop table t1, t2;
# Full index scan
create table t10 (a int, b varchar(100), index(a)) engine=innodb;
insert into t10 select seq, uuid() from seq_1_to_10000;
create table t11(a int) engine=innodb;
insert into t11 select a from t10;
## +0, was +11
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
16
drop table t10, t11;
create table t10 (a int, b varchar(100), index(a)) engine=innodb;
insert into t10 select seq, uuid() from seq_1_to_10000;
create table t11(a int) engine=innodb;
insert into t11 select a from t10 order by a desc;
## +0, was +11
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
16
drop table t10, t11;
# Range access
create table t10 (a int, b varchar(100), index(a)) engine=innodb;
insert into t10 select seq, uuid() from seq_1_to_10000;
create table t11(a int) engine=innodb;
explain
insert into t11 select a from t10 where a > 30;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t10	range	a	a	5	NULL	10000	Using where; Using index
insert into t11 select a from t10 where a > 30;
## +11, was +11
SELECT COUNT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME = 'lock_rec_lock_created';
COUNT
27
drop table t10, t11;
set global innodb_monitor_enable=default;
Warnings:
Warning	1230	Default value is not defined for this set option. Please specify correct counter or module name.
