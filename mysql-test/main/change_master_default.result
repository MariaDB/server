# Start of main.change_master_default
CREATE PROCEDURE show_defaultable_fields()
SELECT connection_name,
connect_retry,
master_ssl_allowed,
master_ssl_ca_file,
master_ssl_ca_path,
master_ssl_cert,
master_ssl_cipher,
master_ssl_key,
`master_ssl_verify_server_cert`, # MDEV-38194
master_ssl_crl,
master_ssl_crlpath,
using_gtid,
master_retry_count,
slave_heartbeat_period
FROM information_schema.slave_status ORDER BY connection_name;
CHANGE MASTER 'unset' TO master_host='127.0.1.1';
CHANGE MASTER 'defaulted' TO
master_connect_retry= DEFAULT,
master_ssl= DEFAULT,
master_ssl_ca= DEFAULT,
master_ssl_capath= DEFAULT,
master_ssl_cert= DEFAULT,
master_ssl_cipher= DEFAULT,
master_ssl_key= DEFAULT,
master_ssl_verify_server_cert= DEFAULT,
master_ssl_crl= DEFAULT,
master_ssl_crlpath= DEFAULT,
master_use_gtid= DEFAULT,
master_retry_count= DEFAULT,
master_heartbeat_period= DEFAULT,
master_host= '127.0.1.2';
CHANGE MASTER TO # Default master does not replace named masters
master_connect_retry= 90,
master_ssl= FALSE,
master_ssl_ca= 'specified_ca',
master_ssl_capath= 'specified_capath',
master_ssl_cert= 'specified_cert',
master_ssl_cipher= 'specified_cipher',
master_ssl_key= 'specified_key',
master_ssl_verify_server_cert= FALSE,
master_ssl_crl= 'specified_crl',
master_ssl_crlpath= 'specified_crlpath',
master_use_gtid= NO,
master_retry_count= 150000,
master_heartbeat_period= 45,
master_host='127.0.0.1';
CALL show_defaultable_fields();
connection_name	
connect_retry	90
master_ssl_allowed	No
master_ssl_ca_file	specified_ca
master_ssl_ca_path	specified_capath
master_ssl_cert	specified_cert
master_ssl_cipher	specified_cipher
master_ssl_key	specified_key
master_ssl_verify_server_cert	No
master_ssl_crl	specified_crl
master_ssl_crlpath	specified_crlpath
using_gtid	No
master_retry_count	150000
slave_heartbeat_period	45.000
connection_name	defaulted
connect_retry	60
master_ssl_allowed	Yes
master_ssl_ca_file	
master_ssl_ca_path	
master_ssl_cert	
master_ssl_cipher	
master_ssl_key	
master_ssl_verify_server_cert	Yes
master_ssl_crl	
master_ssl_crlpath	
using_gtid	Slave_Pos
master_retry_count	100000
slave_heartbeat_period	60.000
connection_name	unset
connect_retry	60
master_ssl_allowed	Yes
master_ssl_ca_file	
master_ssl_ca_path	
master_ssl_cert	
master_ssl_cipher	
master_ssl_key	
master_ssl_verify_server_cert	Yes
master_ssl_crl	
master_ssl_crlpath	
using_gtid	Slave_Pos
master_retry_count	100000
slave_heartbeat_period	60.000
# Those set or left as `DEFAULT` should pick up changes to defaults.
# restart: --skip-slave-start --master-connect-retry=30 --skip-master-ssl --master-ssl-ca=default_ca --master-ssl-capath=default_capath --master-ssl-cert=default_cert --master-ssl-cipher=default_cipher --master-ssl-key=default_key --skip-master-ssl-verify-server-cert --master-ssl-crl=default_crl --master-ssl-crlpath=default_crlpath --master-use-gtid=CURRENT_POS --master-retry-count=50000 --master-heartbeat-period=15
CALL show_defaultable_fields();
connection_name	
connect_retry	90
master_ssl_allowed	No
master_ssl_ca_file	specified_ca
master_ssl_ca_path	specified_capath
master_ssl_cert	specified_cert
master_ssl_cipher	specified_cipher
master_ssl_key	specified_key
master_ssl_verify_server_cert	No
master_ssl_crl	specified_crl
master_ssl_crlpath	specified_crlpath
using_gtid	No
master_retry_count	150000
slave_heartbeat_period	45.000
connection_name	defaulted
connect_retry	30
master_ssl_allowed	No
master_ssl_ca_file	default_ca
master_ssl_ca_path	default_capath
master_ssl_cert	default_cert
master_ssl_cipher	default_cipher
master_ssl_key	default_key
master_ssl_verify_server_cert	No
master_ssl_crl	default_crl
master_ssl_crlpath	default_crlpath
using_gtid	Current_Pos
master_retry_count	50000
slave_heartbeat_period	15.000
connection_name	unset
connect_retry	30
master_ssl_allowed	No
master_ssl_ca_file	default_ca
master_ssl_ca_path	default_capath
master_ssl_cert	default_cert
master_ssl_cipher	default_cipher
master_ssl_key	default_key
master_ssl_verify_server_cert	No
master_ssl_crl	default_crl
master_ssl_crlpath	default_crlpath
using_gtid	Current_Pos
master_retry_count	50000
slave_heartbeat_period	15.000
SET @@GLOBAL.slave_net_timeout= 100;
SELECT connection_name, slave_heartbeat_period
FROM information_schema.slave_status ORDER BY connection_name;
connection_name	slave_heartbeat_period
	45.000
defaulted	15.000
unset	15.000
CHANGE MASTER TO
master_connect_retry= DEFAULT,
master_ssl= DEFAULT,
master_ssl_ca= DEFAULT,
master_ssl_capath= DEFAULT,
master_ssl_cert= DEFAULT,
master_ssl_cipher= DEFAULT,
master_ssl_key= DEFAULT,
master_ssl_verify_server_cert= DEFAULT,
master_ssl_crl= DEFAULT,
master_ssl_crlpath= DEFAULT,
master_use_gtid= DEFAULT,
master_retry_count= DEFAULT,
master_heartbeat_period= DEFAULT;
CALL show_defaultable_fields();
connection_name	
connect_retry	30
master_ssl_allowed	No
master_ssl_ca_file	default_ca
master_ssl_ca_path	default_capath
master_ssl_cert	default_cert
master_ssl_cipher	default_cipher
master_ssl_key	default_key
master_ssl_verify_server_cert	No
master_ssl_crl	default_crl
master_ssl_crlpath	default_crlpath
using_gtid	Current_Pos
master_retry_count	50000
slave_heartbeat_period	15.000
connection_name	defaulted
connect_retry	30
master_ssl_allowed	No
master_ssl_ca_file	default_ca
master_ssl_ca_path	default_capath
master_ssl_cert	default_cert
master_ssl_cipher	default_cipher
master_ssl_key	default_key
master_ssl_verify_server_cert	No
master_ssl_crl	default_crl
master_ssl_crlpath	default_crlpath
using_gtid	Current_Pos
master_retry_count	50000
slave_heartbeat_period	15.000
connection_name	unset
connect_retry	30
master_ssl_allowed	No
master_ssl_ca_file	default_ca
master_ssl_ca_path	default_capath
master_ssl_cert	default_cert
master_ssl_cipher	default_cipher
master_ssl_key	default_key
master_ssl_verify_server_cert	No
master_ssl_crl	default_crl
master_ssl_crlpath	default_crlpath
using_gtid	Current_Pos
master_retry_count	50000
slave_heartbeat_period	15.000
RESET REPLICA 'unset' ALL;
CHANGE MASTER 'unset' TO master_host='127.0.1.3';
# Validate command line options
# restart_abort: --master-heartbeat-period=''
# restart_abort: --master-heartbeat-period=123abc
# restart_abort: --master-heartbeat-period=-1
# restart_abort: --master-heartbeat-period=4294967.296
# restart: --skip-slave-start --master-heartbeat-period=0.000499
SELECT connection_name, slave_heartbeat_period
FROM information_schema.slave_status ORDER BY connection_name;
connection_name	slave_heartbeat_period
	0.000
defaulted	0.000
unset	0.000
CALL mtr.add_suppression('.*master-heartbeat-period.+0.*disabl.+');
FOUND 1 /\[Warning\] .*master-heartbeat-period.+0.*disabl.+/ in mysqld.1.err
# restart: --skip-slave-start --skip-master-ssl --master-ssl --skip-master-ssl-verify-server-cert --master-ssl-verify-server-cert --master-use-gtid=NO --autoset-master-use-gtid --master-heartbeat-period=45 --autoset-master-heartbeat-period
CALL show_defaultable_fields();
connection_name	
connect_retry	60
master_ssl_allowed	Yes
master_ssl_ca_file	
master_ssl_ca_path	
master_ssl_cert	
master_ssl_cipher	
master_ssl_key	
master_ssl_verify_server_cert	Yes
master_ssl_crl	
master_ssl_crlpath	
using_gtid	Slave_Pos
master_retry_count	100000
slave_heartbeat_period	60.000
connection_name	defaulted
connect_retry	60
master_ssl_allowed	Yes
master_ssl_ca_file	
master_ssl_ca_path	
master_ssl_cert	
master_ssl_cipher	
master_ssl_key	
master_ssl_verify_server_cert	Yes
master_ssl_crl	
master_ssl_crlpath	
using_gtid	Slave_Pos
master_retry_count	100000
slave_heartbeat_period	60.000
connection_name	unset
connect_retry	60
master_ssl_allowed	Yes
master_ssl_ca_file	
master_ssl_ca_path	
master_ssl_cert	
master_ssl_cipher	
master_ssl_key	
master_ssl_verify_server_cert	Yes
master_ssl_crl	
master_ssl_crlpath	
using_gtid	Slave_Pos
master_retry_count	100000
slave_heartbeat_period	60.000
# Clean-up
DROP PROCEDURE show_defaultable_fields;
RESET REPLICA 'unset' ALL;
RESET REPLICA 'defaulted' ALL;
RESET REPLICA ALL;
# End of main.change_master_default
