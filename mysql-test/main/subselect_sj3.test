--source include/have_innodb.inc
--source include/have_sequence.inc
--source include/innodb_stable_estimates.inc

--echo #
--echo # MDEV-37732 In MDEV-36861, analyze Q21
--echo #

create table t1 (a int not null, b int, c int) engine=innodb;
create table t2 (d int primary key, e int, f int) engine=innodb;
create table t3 (g int primary key, h int, i int) engine=innodb;

create index t1_ix1 on t1 (a);
create index t1_ix2 on t1 (b);

insert into t1 select seq, seq/3, seq from seq_1_to_1000;
insert into t1 select seq, seq/3, seq+100 from seq_1_to_1000;
insert into t1 select seq, seq/3, seq+200 from seq_1_to_1000;

insert into t2 select seq, seq*2, seq*3 from seq_1_to_1000;
insert into t3 select seq, seq*3, seq*4 from seq_1_to_1000;

analyze table t1, t2, t3;

let $q=select e, count(*) as foo
  from t2, t3, t1
  where d = b
    and g = c
    and exists
    (
      select * from t1 d1
        where d1.a = t1.a
          and d1.c <> t1.c
    );

eval explain $q;

set @new_mode_save = @@new_mode;
set @@new_mode = "FIX_DUPLICATE_WEEDOUT";

eval explain $q;

set @@new_mode = @new_mode_save;

drop table t1, t2, t3;

--echo # End of 11.8 tests
