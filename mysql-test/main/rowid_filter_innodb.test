--source include/have_innodb.inc

SET SESSION STORAGE_ENGINE='InnoDB';

--source rowid_filter.test
--source include/have_sequence.inc

--echo #
--echo # MDEV-18755: possible RORI-plan and possible plan with range filter
--echo #

create table t1 (
  pk int not null primary key, f1 varchar(10), f2 varchar(30), a int(10),
  key (f1), key (f2)
) engine=innodb;

insert into t1 values
  (2,'a','a',2),(3,'a','a',null),(4,'a','a',55),(5,'a','a',4),(6,'a','a',0),
  (7,'a','a',1),(8,'a','a',4),(9,'a','a',null),(10,'a','a',0),(11,'a','a',0),
  (12,'a','a',null),(13,'a','a',49778),(14,'a','a',6),(15,'a','a',3),
  (16,'a','a',233),(17,'a','a',-1),(18,'a','a',5),(19,'a','a',-1),
  (20,'a','a',null),(21,'a','a',0),(22,'a','a',null),(23,'a','a',53840),
  (24,'a','a',null),(25,'a','a',null),(26,'a','a',5),(27,'a','a',43454),
  (28,'a','a',0),(29,'a','a',0),(30,'a','a',null),(59,'a','a',null),
  (60,'a','a',null),(61,'a','a',-1),(62,'a','a',null),(63,'a','a',0),
  (64,'a','a',14468),(65,'a','a',0),(66,'a','a',28),(67,'a','a',null),
  (68,'a','a',14983),(69,'a','a',null),(70,'a','a',3),(71,'a','a',null),
  (72,'a','a',null),(73,'a','a',237),(74,'a','a',2),(75,'a','a',0),
  (76,'a','a',6),(77,'a','a',5),(78,'a','a',0),(79,'a','a',1),(80,'a','a',-1),
  (81,'a','a',20),(82,'a','a',0),(83,'a','a',0),(84,'a','a',null),
  (85,'a','a',-1),(86,'a','a',5),(87,'a','a',null),(88,'a','a',160),
  (89,null,null,null),(90,'a','a',14785),(91,'a','a',0),(92,'a','a',null);

let $q=
( select * from t1
    where (f1 is null and f2 is null) and (f2 between 'a' and 'z' or f1 in ('a')))
  union
( select * from t1
    where (f1 is null and f2 is null) and (f2 between 'a' and 'z' or f1 in ('a')));

eval $q;
eval explain $q;
eval explain format=json $q;

drop table t1;

--echo #
--echo # MDEV-19195: possible RORI-plan and possible plan with range filter
--echo #             for not first joined table
--echo #

create table t1 (id int not null primary key) engine=innodb;
insert into t1 values (2),(1);

create table t2 (y int,x int,index (x),index (y)) engine=innodb;
insert into t2 values
  (4,1),(4,777),(2,1),(2,888),(111,1),(222,1),(333,345),(444,1),
  (555,555),(666,1);

let $q=
select * from t1 join t2 on t1.id = t2.x where t2.y = 2 and t1.id = 1;

eval $q;
eval explain extended $q;

drop table t1, t2;


--echo #
--echo # MDEV-19820: use of rowid filter for innodb table without primary key
--echo #

create table t1 (a int, b int, key (b), key (a)) engine=innodb;
insert into t1
select (rand(1)*1000)/10, (rand(1001)*1000)/50 from seq_1_to_1000;
analyze table t1;

let $q=
select count(*) from t1 where a in (22,83,11) and b=2;
let $q1=
select * from t1 where a in (22,83,11) and b=2;

set @save_optimizer_switch= @@optimizer_switch;

set optimizer_switch='rowid_filter=off';
eval $q;
eval explain extended $q;
eval $q1;

set optimizer_switch='rowid_filter=on';
eval $q;
eval explain extended $q;
eval $q1;

drop table t1;
set optimizer_switch=@save_optimizer_switch;

SET SESSION STORAGE_ENGINE=DEFAULT;

--echo #
--echo # MDEV-19919: use of rowid filter for innodb table + ORDER BY
--echo #

SET @stats.save= @@innodb_stats_persistent;
SET GLOBAL innodb_stats_persistent= ON;

CREATE TABLE t1 (
    a INT,
    b VARCHAR(10),
    c VARCHAR(1024),
    KEY (b),
    KEY (c)
) ENGINE=InnoDB;

INSERT INTO t1 VALUES
  (1,'w','z'), (1,'X','o'), (1,'q','c'), (5,'w','c'), (2,'j','m'),
  (2,'Q','s'), (9,'e','J'), (2,'p','W'), (9,'o','F'), (2,'g','S'),
  (1,'Y','a'), (NULL,'Y','p'), (NULL,'s','x'), (NULL,'i','S'),
  (1,'l','q'), (7,'r','e'), (4,'b','h'), (NULL,'E','c'),
  (NULL,'M','a'), (3,'e','X'), (NULL,'p','r'), (9,'e','i'),
  (3,'g','x'), (2,'h','y');

ANALYZE TABLE t1;

EXPLAIN EXTENDED
SELECT a FROM t1 WHERE c < 'k' AND b > 't' ORDER BY a;

SELECT a FROM t1 WHERE c < 'k' AND b > 't' ORDER BY a;

DROP TABLE t1;
SET GLOBAL innodb_stats_persistent= @stats.save;
