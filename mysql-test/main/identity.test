--source include/have_log_bin.inc

let $mysqldumpfile = $MYSQLTEST_VARDIR/tmp/mysqldumpfile.sql;
let $table_name = test.t;

create table t(x int generated by default on null as identity, key(x));
show create table t;
insert t(x) values(null);
drop table t;

create table t(x int generated by default as identity, key(x));
insert t() values();
show create table t;
insert t(x) values(default),(default),(default);
insert t(x) values(-1), (-33);
insert t() values();
select * from t;
flush table t;
insert t() values(42);
insert t() values();
select * from t;
alter table t force;
show create table t;
insert t() values();
select * from t;

--exec $MYSQL_DUMP test t > $mysqldumpfile
--source include/mysqldump.inc

--echo # Next insert id is adjusted to the explicit value
create table t(x int generated by default as identity, key(x)) AUTO_INCREMENT=10;
show create table t;
insert t(x) values(default),(20),(default);
insert t(x) values(default),(21),(default);
select * from t;
insert t(x) values(default),(25);
--echo # We should see AUTO_INCREMENT=26
show create table t;
--exec $MYSQL_DUMP test t > $mysqldumpfile
--source include/mysqldump.inc


--echo # GENERATED ALWAYS
create table t(x int generated always as identity, key(x)) AUTO_INCREMENT=100;
insert into t() values();
--error ER_WARNING_NON_DEFAULT_VALUE_FOR_GENERATED_COLUMN
insert into t(x) values(2);
select * from t;
--exec $MYSQL_DUMP test t > $mysqldumpfile
drop table t;
--exec $MYSQL test < $mysqldumpfile
show create table t;
insert into t() values();
select * from t;
show create table t;
drop table t;


--echo # Expression with IDENTITY
create table t(x int generated by default as identity, key(x),
               check (x % 2 != 0), y int default(x * 2), z int as (x-1));
show create table t;
set statement auto_increment_increment= 2 for
    insert t() values(),(),();
select * from t;
--error ER_CONSTRAINT_FAILED
alter table t add check(x < 5);
alter table t add check(x < 6);
drop table t;


--echo # Zeroes and defaults handling

--echo # default(col) is disabled for identity
--error ER_WRONG_ARGUMENTS
create table t(x int generated by default as identity, y int default(default(x)));

create table t(x int generated by default as identity, y int default(x));
insert t(x) values (1), (0), (default);
select * from t;
--error ER_WRONG_ARGUMENTS
select default(x) from t;
insert t() values ();
insert t(x) values (default);
select * from t;
--error ER_WRONG_ARGUMENTS
insert t(x) values (default(x));
update t set x= default;
--error ER_WRONG_ARGUMENTS
update t set x= default(x);
select * from t;
update t, t as t1 set t.x=default where t.x = t1.x order by t.x;
select * from t;
--echo # Ensure that 'update t set x= default' saved the new value persistently.
flush table t;
insert t(x) values (default);
select * from t;

--echo # Values aren't changed, zeroes are preserved.
alter table t add z int, algorithm=copy;
select * from t;
drop table t;

--echo # Syntax
create table t(x int generated by default as identity increment by -1 minvalue 9, key(x));
show create table t;
drop table t;

create table t(x int generated by default as identity cache -2 maxvalue -1000 start with 0, key(x));
show create table t;
drop table t;

create table t(x int generated by default as identity nominvalue nomaxvalue nocache, key(x));
show create table t;
drop table t;


--echo # Compatibility options that are ignored
create table t(x int generated by default as identity
                     scale extend shard extend keep, key(x));
drop table t;
create table t(x int generated by default as identity
                     scale noextend shard noextend keep, key(x));
drop table t;
create table t(x int generated by default as identity
                     scale shard keep, key(x));
drop table t;
create table t(x int generated by default as identity
                     noscale noshard nokeep, key(x));
drop table t;


--echo IDENTITY is created without specifying a key
create table t(x int generated by default as identity start with 10);
insert t() values(),(),();
select * from t;
--exec $MYSQL_DUMP test t > $mysqldumpfile
--source include/mysqldump.inc
