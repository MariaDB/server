--source include/not_embedded.inc

--echo #
--echo # MDEV-37442: Illegal mix of collations during "mariadb-dump --system=user"
--echo #
--echo # When a server is migrated from MySQL 8.0, the mysql.user, mysql.role_edges
--echo # and mysql.default_roles tables retain their original utf8mb4 collations.
--echo # If the user and role tables end up with different utf8mb4 collations
--echo # (e.g. utf8mb4_general_ci vs utf8mb4_unicode_ci), MariaDB's mysqldump
--echo # --system=user fails with "Illegal mix of collations" when joining the
--echo # tables because no explicit collation was specified on the JOIN keys.
--echo #
--echo # Fix: Added COLLATE utf8mb4_bin on every JOIN key so the explicit
--echo # collation always wins over any implicit column collation.
--echo #

--echo # Simulate the mismatch: a user table with utf8mb4_general_ci joined
--echo # against role_edges with utf8mb4_unicode_ci.  Both have IMPLICIT
--echo # coercibility, so MariaDB cannot resolve the conflict automatically.
--echo # This is the same type of error that mysqldump triggered on a migrated
--echo # server.  COLLATE utf8mb4_bin (EXPLICIT coercibility) resolves it.

CREATE TEMPORARY TABLE t_mysql_user (
  User  char(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  Host  char(60) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT ''
);
CREATE TEMPORARY TABLE t_role_edges (
  FROM_HOST char(60) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '',
  FROM_USER char(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT ''
);
INSERT INTO t_mysql_user VALUES ('mdev37442_user', '%');
INSERT INTO t_role_edges    VALUES ('', 'mdev37442_role');

--echo # Without COLLATE: utf8mb4_general_ci (IMPLICIT) vs utf8mb4_unicode_ci (IMPLICIT)
--echo # -> ERROR 1267: Illegal mix of collations
--error ER_CANT_AGGREGATE_2COLLATIONS
SELECT u.User FROM t_mysql_user u
  JOIN t_role_edges e ON u.User = e.FROM_USER;

--echo # With COLLATE utf8mb4_bin: EXPLICIT coercibility wins on both sides -> OK
SELECT u.User FROM t_mysql_user u
  JOIN t_role_edges e ON u.User = e.FROM_USER COLLATE utf8mb4_bin;

DROP TEMPORARY TABLE t_mysql_user, t_role_edges;

--echo #
--echo # Create the full MySQL-origin role tables and verify that
--echo # mysqldump --system=user completes without error.

--disable_warnings
DROP TABLE IF EXISTS mysql.role_edges;
DROP TABLE IF EXISTS mysql.default_roles;
--enable_warnings

CREATE TABLE mysql.role_edges (
  FROM_HOST            char(60)  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  FROM_USER            char(32)  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  TO_HOST              char(60)  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  TO_USER              char(32)  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  WITH_ADMIN_OPTION    enum('N','Y') CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT 'N',
  PRIMARY KEY (FROM_HOST, FROM_USER, TO_HOST, TO_USER)
) DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE mysql.default_roles (
  HOST              char(60)  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  USER              char(32)  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  DEFAULT_ROLE_HOST char(60)  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  DEFAULT_ROLE_USER char(32)  CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  PRIMARY KEY (HOST, USER, DEFAULT_ROLE_HOST, DEFAULT_ROLE_USER)
) DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

INSERT INTO mysql.role_edges VALUES ('', 'mdev37442_role', '%', 'mdev37442_user', 'N');
INSERT INTO mysql.default_roles VALUES ('%', 'mdev37442_user', '', 'mdev37442_role');

--echo # mysqldump --system=user must succeed despite the collation difference.
--exec $MYSQL_DUMP --skip-comments --system=user > $MYSQLTEST_VARDIR/tmp/mdev37442.sql

--echo # Cleanup
DROP TABLE mysql.role_edges;
DROP TABLE mysql.default_roles;
--remove_file $MYSQLTEST_VARDIR/tmp/mdev37442.sql

