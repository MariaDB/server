--source include/not_embedded.inc
--source include/have_sequence.inc
--echo #enable both optimizer_trace, and optimizer_record_context
set optimizer_record_context=ON;
set optimizer_trace=1;

create database db1;
use db1;

create table t1
(
    a int, b int,
    index t1_idx_a (a),
    index t1_idx_b (b),
    index t1_idx_ab (a, b)
);

insert into t1 select seq%2, seq%3 from seq_1_to_20;

create table t2 (
    a int,
    index t2_idx_a (a)
);
insert into t2 select seq%6 from seq_1_to_30;

create view view1 as (
    select t1.a as a, t1.b as b, t2.a as c from (t1 join t2) where t1.a = t2.a and t1.a = 5
);

--echo # analyze all the tables

set session use_stat_tables='COMPLEMENTARY';
analyze table t1 persistent for all;
analyze table t2 persistent for all;

--echo #
--echo # simple query using one table
--echo #
select count(*) from t1;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

--echo #
--echo # simple query using join of two tables
--echo #
select count(*) from t1, t2 where t1.a = t2.a;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

--echo #
--echo # negative test
--echo # simple query using join of two tables
--echo # there should be no result
--echo #
set optimizer_record_context=OFF;
select count(*) from t1, t2 where t1.a = t2.a;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

set optimizer_record_context=ON;

--echo #
--echo # there should be no duplicate information
--echo #
select * from view1 union select * from view1;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

--echo #
--echo # test for update
--echo #
update t1 set t1.b = t1.a;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

--echo #
--echo # test for insert as select
--echo #
insert into t1 (select t2.a as a, t2.a as b from t2);

--source include/get_rec_idx_ranges_from_opt_ctx.inc

analyze table t1 persistent for all;

--echo #
--echo # range analysis tests
--echo #

--echo #
--echo # simple query with or condition on 2 columns
--echo #
analyze select * from t1 where t1.a between 1 and 5 or t1.b between 6 and 10;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

--echo #
--echo # simple query with or condition on the same column
--echo #
analyze select * from t1 where t1.a between 1 and 5 or t1.a between 6 and 10;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

--echo #
--echo # negative test on the simple query with or condition on 2 columns
--echo #
set optimizer_record_context=OFF;
analyze select * from t1 where t1.a between 1 and 5 or t1.b between 6 and 10;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

set optimizer_record_context=ON;

--echo #
--echo # simple query with or condition on 2 columns
--echo # testing all the stats information
--echo #
analyze select * from t1 where t1.a between 1 and 5 or t1.b between 6 and 10;

--source include/get_rec_idx_ranges_from_opt_ctx.inc

drop view view1;
drop table t1;
drop table t2;

--echo #
--echo # union query with const tables
--echo # testing the INSERT statements
--echo #
set optimizer_record_context=OFF;

create table t1 (a int not null auto_increment,
                 b int,
                 primary key (a)
);

insert into t1 select seq, seq%5 from seq_1_to_20;

analyze table t1 persistent for all;

set optimizer_record_context=ON;

analyze select * from t1 where t1.a=5 and t1.b=0 union select * from t1 where t1.a=4 and t1.b=4;

set @const_table_inserts=
    (select REGEXP_SUBSTR(
         context,
         '(REPLACE INTO.*)([\n\r].*)*(?=set @opt_context)'
        )
        from information_schema.optimizer_context
    );

select @const_table_inserts;

drop table t1;

--echo #
--echo # Single table with a unique index containing few columns.
--echo # query with const tables and
--echo # testing the INSERT statements
--echo #
set optimizer_record_context=OFF;

create table t1 (
    a int,
    b int,
    c int,
    unique index idx_ab(a, b)
);

insert into t1 select seq%10, seq%3, seq%2 from seq_1_to_20;

analyze table t1 persistent for all;

set optimizer_record_context=ON;

analyze select * from t1 where t1.a=1 and t1.b=1;

set @const_table_inserts=
    (select REGEXP_SUBSTR(
         context,
         '(REPLACE INTO.*)([\n\r].*)*(?=set @opt_context)'
        )
        from information_schema.optimizer_context
    );

select @const_table_inserts;

drop table t1;
drop database db1;
