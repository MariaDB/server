--source include/not_embedded.inc

--echo #
--echo # Test DENY representation as JSON in mysql.global_priv table
--echo #

SET @q_show_denies =
  'SELECT User, Host,
          JSON_PRETTY(JSON_EXTRACT(Priv, ''$.denies'')) AS denies_pretty
   FROM mysql.global_priv
   WHERE JSON_LENGTH(JSON_EXTRACT(Priv, ''$.denies'')) > 0
   ORDER BY User, Host';

PREPARE show_denies FROM @q_show_denies;

CREATE USER u;
CREATE DATABASE d;

DENY SELECT,INSERT ON mysql.* TO u;
DENY UPDATE ON d.* TO u;

EXECUTE show_denies;

REVOKE DENY SELECT  ON mysql.* FROM u;

EXECUTE show_denies;

REVOKE DENY INSERT  ON mysql.* FROM u;
EXECUTE show_denies;

REVOKE DENY UPDATE ON d.* FROM u;

EXECUTE show_denies;

--echo # Table level
DENY SELECT,INSERT ON mysql.global_priv TO u;
EXECUTE show_denies;
REVOKE DENY INSERT,SELECT ON mysql.global_priv FROM u;
EXECUTE show_denies;

DENY SELECT(USER) ON mysql.global_priv TO u;
EXECUTE show_denies;

DENY UPDATE(USER) ON mysql.global_priv TO u;
EXECUTE show_denies;

DENY SELECT ON *.* TO u;
EXECUTE show_denies;

CREATE TABLE sensitive_data (
  id INT,
  public_info VARCHAR(50),
  salary DECIMAL(10,2),
  ssn VARCHAR(11),
  address VARCHAR(100)
);

DENY SELECT(salary,ssn) ON sensitive_data TO u;

EXECUTE show_denies;

GRANT ALL PRIVILEGES on *.* TO u WITH GRANT OPTION;
REVOKE ALL PRIVILEGES, GRANT OPTION FROM u;

--echo # REVOKE ALL PRIVILEGES clears DENY entries
SHOW GRANTS FOR u;
EXECUTE show_denies;

DEALLOCATE PREPARE show_denies;
DROP USER u;
DROP DATABASE d;
DROP TABLE sensitive_data;
