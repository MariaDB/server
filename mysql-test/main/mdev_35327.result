#
# MDEV-35327: Add VEC_DISTANCE_MANHATTAN function
#
#
# Checking for argument validity
#
SELECT VEC_DISTANCE_MANHATTAN(VEC_FromText('[1,2]'));
ERROR 42000: Incorrect parameter count in the call to native function 'VEC_DISTANCE_MANHATTAN'
SELECT VEC_DISTANCE_MANHATTAN(NULL, VEC_FromText('[1,2]'));
VEC_DISTANCE_MANHATTAN(NULL, VEC_FromText('[1,2]'))
NULL
# Checking for mismatched dimensions
SELECT VEC_DISTANCE_MANHATTAN(VEC_FromText('[1,1,1]'),VEC_FromText('[1,2]'));
VEC_DISTANCE_MANHATTAN(VEC_FromText('[1,1,1]'),VEC_FromText('[1,2]'))
NULL
#
# Basic math check
#
SELECT VEC_DISTANCE_MANHATTAN(VEC_FromText('[1,2,3]'), VEC_FromText('[2,3,4]'));
VEC_DISTANCE_MANHATTAN(VEC_FromText('[1,2,3]'), VEC_FromText('[2,3,4]'))
3
#
# Without Vector Index
#
CREATE TABLE t1 (id INT, v VECTOR(3) NOT NULL);
INSERT INTO t1 VALUES (1, VEC_FromText('[2,2,2]')), (2, VEC_FromText('[0,0,5]')), (3, VEC_FromText('[1,1,1]'));
# Manhattan distance:- 6,5,3 Euclidean distance:- 3.46,5,1.73
# Manhattan | Euclidean
# P3          P3
# P2          P1   
# P1          P2   
# output should be 3,5,6 and ordering should be P3 < P2 < P1
SELECT id, VEC_DISTANCE_MANHATTAN(v, VEC_FromText('[0,0,0]')) as dist FROM t1 ORDER BY dist;
id	dist
3	3
2	5
1	6
# Comparison with Euclidean distance
SELECT id, VEC_DISTANCE_EUCLIDEAN(v, VEC_FromText('[0,0,0]')) as dist FROM t1 ORDER BY dist;
id	dist
3	1.7320508075688772
1	3.4641016151377544
2	5
#
# With Vector Index
#
CREATE VECTOR INDEX idx ON t1(v) DISTANCE=manhattan;
# Output should be 3,5 and 6 again
SELECT id, VEC_DISTANCE_MANHATTAN(v, VEC_FromText('[0,0,0]')) as dist FROM t1 ORDER BY dist LIMIT 3;
id	dist
3	3
2	5
1	6
# Checking if the vector index is actually implemented using manhattan distance
EXPLAIN SELECT id FROM t1 FORCE INDEX (idx) 
ORDER BY VEC_DISTANCE_MANHATTAN(v, VEC_FromText('[0,0,0]')) LIMIT 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	index	NULL	idx	14	NULL	1	
# Cleanup
DROP TABLE t1;
# Miscellaneous Tests
SELECT VEC_DISTANCE_MANHATTAN(VEC_FromText('[-1,-1]'), VEC_FromText('[1,1]')) as neg_test;
neg_test
4
SELECT VEC_DISTANCE_MANHATTAN(VEC_FromText('[1.5, 2.5]'), VEC_FromText('[1.5, 2.5]')) as zero_dist;
zero_dist
0
SELECT VEC_DISTANCE_MANHATTAN(VEC_FromText('[1.1]'), VEC_FromText('[2.2]')) as float_test;
float_test
1.100000023841858
