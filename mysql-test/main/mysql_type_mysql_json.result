#
# MDEV-18323: Convert MySQL JSON type to MariaDB TEXT in mysql_upgrade - apply alter force
#
call mtr.add_suppression(" Table rebuild required. Please do \"ALTER TABLE `test.mysql_json` FORCE\" or dump/reload to fix it!");
call mtr.add_suppression("mysqld: Table rebuild required. Please do \"ALTER TABLE `mysql.transaction_registry` FORCE\" or dump/reload to fix it");
call mtr.add_suppression("mysqld: Table rebuild required. Please do \"ALTER TABLE `mysql.innodb_table_stats` FORCE\" or dump/reload to fix it!");
call mtr.add_suppression("mysqld: Table rebuild required. Please do \"ALTER TABLE `mysql.innodb_index_stats` FORCE\" or dump/reload to fix it!");
call mtr.add_suppression("mysqld: Table './test/mysql_json' is marked as crashed and should be repaire");
call mtr.add_suppression("Checking table:   './test/mysql_json'");
#
# Test ALTER TABLE FORCE of mysql json table
#
SELECT * FROM test.mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE test.mysql_json FORCE;
SELECT * FROM test.mysql_json;
t
{"key1":"val1","key2":"val2"}
# Try one more time to alter force
ALTER TABLE test.mysql_json FORCE;
SELECT * FROM test.mysql_json;
t
{"key1":"val1","key2":"val2"}
DROP TABLE test.mysql_json;
#
# Array test with json object
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
t
{"a":[1,2],"b":["x","y"]}
DROP TABLE test.mysql_json;
#
# Empty object and array
#
SELECT * FROM test.mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE test.mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
t
{}
[]
DROP TABLE test.mysql_json;
#
# Test literals
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
t
true
false
null
DROP TABLE test.mysql_json;
#
# Test ints - int64
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
t
18446744073709551615
DROP TABLE test.mysql_json;
#
# Test ints - negative values
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
t
{"neg":-10}
DROP TABLE test.mysql_json;
#
# Test ints - mixed values worked
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
t
0
-127
128
32767
-32768
65535
65536
-2147483648
2147483647
4294967295
-9223372036854775807
9223372036854775807
18446744073709551615
DROP TABLE test.mysql_json;
#
# Test floats
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
t
3.14
-5678.987
DROP TABLE test.mysql_json;
#
# Strings
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
t
"test1"
{"":""}
[""]
DROP TABLE test.mysql_json;
#
# Test array with json object
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
t
{"a":[1,2],"b":["x","y"]}
DROP TABLE test.mysql_json;
#
# Test array with json array
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
j
[1,2,3,4,5,[],"a","b","c"]
DROP TABLE test.mysql_json;
#
# Date and time (casting in mysql)
#
# ---Opaque types ---
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
t
2015-01-15 23:24:25.000000
23:24:25.000000
2015-01-15
2015-01-15 23:24:25.000000
DROP TABLE test.mysql_json;
#
# --- opaque_mysql_type_decimal ---
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
i
3.14
DROP TABLE test.mysql_json;
#
# --- opaque data types ---
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
c	i
opaque_mysql_type_set	"b,c"
opaque_mysql_type_enum	"b"
opaque_mysql_type_date	2015-01-15
opaque_mysql_type_time	23:24:25.000000
opaque_mysql_type_datetime	2015-01-15 23:24:25.000000
opaque_mysql_type_geom	{"type":"Point","coordinates":[1,1]}
opaque_mysql_type_bit	"base64:type:yv4="
opaque_mysql_type_year	"base64:type:MjAxOQ=="
opaque_mysql_type_blob	"base64:type:yv66vg=="
opaque_mysql_type_longblob	"base64:type:yv66vg=="
opaque_mysql_type_mediumblob	"base64:type:yv66vg=="
opaque_mysql_type_tinyblob	"base64:type:yv66vg=="
opaque_mysql_type_varbinary	NULL
opaque_mysql_type_binary	NULL
opaque_mysql_type_varchar	"base64:type:Zm9v"
opaque_mysql_type_string	NULL
DROP TABLE test.mysql_json;
#
# --- auto convert utf8mb4 ---
#
call mtr.add_suppression("Table './test/mysql_json' is marked as crashed and should be repaired");
call mtr.add_suppression("Checking table:   './test/mysql_json'");
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
t
[]
"base64:type:yv4="
"base64:type:yv66vg=="
DROP TABLE test.mysql_json;
#
# --- utf8 characters ---
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
Warnings:
Error	145	Table './test/mysql_json' is marked as crashed and should be repaired
Error	1034	1 client is using or hasn't closed the table properly
SELECT * FROM test.mysql_json;
i
"Anel Husaković - test: đžšćč"
DROP TABLE test.mysql_json;
#
# Test - mix of everything
#
SELECT * FROM mysql_json;
ERROR HY000: Incorrect information in file: './test/mysql_json.frm'
ALTER TABLE mysql_json FORCE;
SELECT * FROM test.mysql_json;
c1
{"key1":"value_1","key256":"value_256"}
["val3","val4"]
["val5",{"key3":"val6","key4":"val7"}]
{"neg":-10}
{"neg":-1234567890,"pos":9876543210}
{"a":[1,2],"b":["x","y"]}
0
-127
128
32767
-32768
65535
65536
-2147483648
2147483647
4294967295
-9223372036854775807
9223372036854775807
18446744073709551615
-3.14
151.23
"scalar_string"
true
false
null
"literals"
1.8446744073709552e19
{}
[]
2015-01-15 23:24:25.000000
23:24:25.000000
2015-01-15
{"type":"Point","coordinates":[1,1]}
2015-01-15 23:24:25.000000
[]
"base64:type:yv4="
DROP TABLE test.mysql_json;
