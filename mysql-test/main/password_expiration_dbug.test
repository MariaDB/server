#
# Test password expiration INTERVAL and default_password_lifetime options
#

--source include/have_debug.inc
--source include/not_embedded.inc

set @old_dbug= @@global.debug_dbug;
set global debug_dbug= "+d,password_expiration_interval_sec";

--echo #
--echo # PASSWORD EXPIRE DEFAULT should use the default_password_lifetime 
--echo # system var to set the number of days till expiration
--echo #
set global disconnect_on_expired_password= ON;
set global default_password_lifetime= 2;
create user user1@localhost password expire default;

set @tstamp_expired= UNIX_TIMESTAMP() - 3;
update mysql.global_priv set
    priv=json_set(priv, '$.password_last_changed', @tstamp_expired)
    where user='user1';
flush privileges;

--replace_result $MASTER_MYPORT MYSQL_PORT $MASTER_MYSOCK MYSQL_SOCK
--error ER_MUST_CHANGE_PASSWORD_LOGIN
connect(con1,localhost,user1);
drop user user1@localhost;

--echo #
--echo # PASSWORD EXPIRE INTERVAL should expire a client's password after
--echo # X seconds and not before
--echo #
set global disconnect_on_expired_password= ON;
create user user1@localhost password expire interval 2 day;
--replace_result $MASTER_MYPORT MYSQL_PORT $MASTER_MYSOCK MYSQL_SOCK
connect(con1,localhost,user1);
disconnect con1;
connection default;

set @tstamp_expired= UNIX_TIMESTAMP() - 3;
update mysql.global_priv set
    priv=json_set(priv, '$.password_last_changed', @tstamp_expired)
    where user='user1';
flush privileges;

--replace_result $MASTER_MYPORT MYSQL_PORT $MASTER_MYSOCK MYSQL_SOCK
--error ER_MUST_CHANGE_PASSWORD_LOGIN
connect(con1,localhost,user1);
drop user user1@localhost;

--echo #
--echo # PASSWORD EXPIRE NEVER should override the other policies and never
--echo # expire a client's password
--echo #
set global disconnect_on_expired_password= ON;
create user user1@localhost password expire interval 2 day;
alter user user1@localhost password expire never;

set @tstamp_expired= UNIX_TIMESTAMP() - 3;
update mysql.global_priv set
    priv=json_set(priv, '$.password_last_changed', @tstamp_expired)
    where user='user1';
flush privileges;

--replace_result $MASTER_MYPORT MYSQL_PORT $MASTER_MYSOCK MYSQL_SOCK
connect(con1,localhost,user1);
disconnect con1;
connection default;
drop user user1@localhost;

set global debug_dbug= @old_dbug;
set global disconnect_on_expired_password= default;
set global default_password_lifetime= default;

