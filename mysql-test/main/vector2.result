# Aria doesn't support VECTOR yet
create table t1(v blob not null, vector index(v)) engine=aria;
ERROR HY000: Table storage engine 'Aria' does not support the create option 'VECTOR'
#
# MDEV-35038 Server crash in Index_statistics::get_avg_frequency upon EITS collection for vector index
#
create table t (a int, v blob not null, vector index (v));
analyze table t persistent for columns() indexes (v);
Table	Op	Msg_type	Msg_text
test.t	analyze	status	Engine-independent statistics collected
test.t	analyze	status	Table is already up to date
drop table t;
#
# MDEV-35033 LeakSanitizer errors in my_malloc / safe_mutex_lazy_init_deadlock_detection / MHNSW_Context::alloc_node and alike
#
call mtr.add_suppression('mariadbd: Can''t find record in ''t''');
create table t (a int, v blob not null, vector index (v));
insert into t values (1,vec_fromtext('[0]'));
update t set v = vec_fromtext('[0,0]');
ERROR 22007: Incorrect vector value: '...' for column `test`.`t`.`v` at row 1
update t set a = 2;
ERROR HY000: Can't find record in 't'
set global mhnsw_cache_size = 1048576;
insert into t  values (2,x'00000000');
drop table t;
set global mhnsw_cache_size = default;
#
# MDEV-35029 ASAN errors in Lex_ident<Compare_ident_ci>::is_valid_ident upon DDL on table with vector index
#
create table t (a int, v blob not null, vector key (v) distance_function=euclidean);
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `a` int(11) DEFAULT NULL,
  `v` blob NOT NULL,
  VECTOR KEY `v` (`v`) `distance_function`=euclidean
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci
set session mhnsw_max_edges_per_node = @@mhnsw_max_edges_per_node + 1;
create table t2 like t;
alter table t force;
drop table t, t2;
#
# MDEV-35043 Unsuitable error upon an attempt to create MEMORY table with vector key
#
create table t (v binary(255) not null, vector index(v)) engine=memory;
ERROR HY000: Table storage engine 'MEMORY' does not support the create option 'VECTOR'
#
# MDEV-35042 Vector indexes are allowed for MERGE tables, but do not
#
create table t (a int, v blob not null, vector index(v)) engine=myisam;
create table tm (a int, v blob not null, vector index(v)) engine=merge union=(t);
ERROR HY000: Table storage engine 'MERGE' does not support the create option 'VECTOR'
drop table t;
#
# MDEV-35078 Server crash or ASAN errors in mhnsw_insert
#
set session mhnsw_max_edges_per_node = 4;
create table t (a int, v blob not null);
insert into t select seq, x'00000000' from seq_1_to_10;
alter table t add vector(v);
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `a` int(11) DEFAULT NULL,
  `v` blob NOT NULL,
  VECTOR KEY `v` (`v`) `max_edges_per_node`=4
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci
create table x like t;
show create table x;
Table	Create Table
x	CREATE TABLE `x` (
  `a` int(11) DEFAULT NULL,
  `v` blob NOT NULL,
  VECTOR KEY `v` (`v`) `max_edges_per_node`=4
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci
insert into t values (11,x'00000000');
drop table t, x;
set session mhnsw_max_edges_per_node = default;
#
# MDEV-35092 Server crash, hang or ASAN errors in mysql_create_frm_image upon using non-default table options and system variables
#
set mhnsw_distance_function= cosine;
create table t (a int, v blob not null);
prepare stmt from 'alter table t drop index if exists v, add vector (v) max_edges_per_node=10';
execute stmt;
Warnings:
Note	1091	Can't DROP INDEX `v`; check that it exists
execute stmt;
show create table t;
Table	Create Table
t	CREATE TABLE `t` (
  `a` int(11) DEFAULT NULL,
  `v` blob NOT NULL,
  VECTOR KEY `v` (`v`) `max_edges_per_node`=10 `distance_function`='cosine'
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci
drop table t;
set mhnsw_distance_function= default;
