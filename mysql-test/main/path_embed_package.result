#
# MDEV-34391 Path resolution
# Embed PATH to PACKAGE and PACKAGE's routines
#
CREATE DATABASE test2;
CREATE DATABASE test3;
CREATE FUNCTION test2.func2() RETURNS TEXT
BEGIN
RETURN 'test2.func2';
END;
$$
CREATE FUNCTION test3.func2() RETURNS TEXT
BEGIN
RETURN 'test3.func2';
END;
$$
CREATE PROCEDURE test2.proc2(OUT a TEXT)
BEGIN
SET a:='test2.proc2';
END;
$$
CREATE PROCEDURE test3.proc2(OUT a TEXT)
BEGIN
SET a:='test3.proc2';
END;
$$
# Path embedded in PACKAGE's routines
CREATE PACKAGE pkg_r_emb
FUNCTION ff() RETURNS TEXT;
FUNCTION fp() RETURNS TEXT;
PROCEDURE pf();
PROCEDURE pp();
END;
$$
CREATE PACKAGE BODY pkg_r_emb
FUNCTION ff() RETURNS TEXT
PATH 'test2'
  BEGIN
RETURN func2();
END;
FUNCTION fp() RETURNS TEXT
PATH 'test2'
  BEGIN
DECLARE a TEXT;
CALL proc2(a);
RETURN a;
END;
PROCEDURE pf()
PATH 'test2'
  BEGIN
SELECT func2();
END;
PROCEDURE pp()
PATH 'test2'
  BEGIN
DECLARE a TEXT;
CALL proc2(a);
SELECT a;
END;
END;
$$
# Path embedded in a PACKAGE
CREATE PACKAGE pkg_emb
PATH 'test2'
  FUNCTION ff() RETURNS TEXT;
FUNCTION fp() RETURNS TEXT;
PROCEDURE pf();
PROCEDURE pp();
END;
$$
CREATE PACKAGE BODY pkg_emb
PATH 'test2'
  DECLARE a TEXT;
FUNCTION ff() RETURNS TEXT
BEGIN
RETURN func2();
END;
FUNCTION fp() RETURNS TEXT
BEGIN
DECLARE a TEXT;
CALL proc2(a);
RETURN a;
END;
PROCEDURE pf()
BEGIN
SELECT func2();
END;
PROCEDURE pp()
BEGIN
DECLARE a TEXT;
CALL proc2(a);
SELECT a;
END;
CALL proc2(a);
END;
$$
# Path embedded in PACKAGE and PACAKGE's routines
CREATE PACKAGE pkg_emb_r_emb
PATH 'test3'
  FUNCTION ff() RETURNS TEXT;
FUNCTION fp() RETURNS TEXT;
PROCEDURE pf();
PROCEDURE pp();
END;
$$
CREATE PACKAGE BODY pkg_emb_r_emb
PATH 'test3'
  DECLARE a TEXT;
FUNCTION ff() RETURNS TEXT
PATH 'test2'
  BEGIN
RETURN func2();
END;
FUNCTION fp() RETURNS TEXT
PATH 'test2'
  BEGIN
DECLARE a TEXT;
CALL proc2(a);
RETURN a;
END;
PROCEDURE pf()
PATH 'test2'
  BEGIN
SELECT func2();
END;
PROCEDURE pp()
PATH 'test2'
  BEGIN
DECLARE a TEXT;
CALL proc2(a);
SELECT a;
END;
CALL proc2(a);
END;
$$
CREATE PACKAGE pkg_emb_inner_block
PATH 'test2'
  FUNCTION ff() RETURNS TEXT;
FUNCTION fp() RETURNS TEXT;
PROCEDURE pf();
PROCEDURE pp();
END;
$$
CREATE PACKAGE BODY pkg_emb_inner_block
PATH 'test2'
  DECLARE a TEXT;
FUNCTION ff() RETURNS TEXT
BEGIN
DECLARE a TEXT;
BEGIN
SET a:= func2();
END;
RETURN a;
END;
FUNCTION fp() RETURNS TEXT
BEGIN
DECLARE a TEXT;
BEGIN
CALL proc2(a);
END;
RETURN a;
END;
PROCEDURE pf()
BEGIN
BEGIN
SELECT func2();
END;
END;
PROCEDURE pp()
BEGIN
DECLARE a TEXT;
BEGIN
CALL proc2(a);
END;
SELECT a;
END;
CALL proc2(a);
END;
$$
# sp-cache-invalidate
SELECT pkg_r_emb.ff();
pkg_r_emb.ff()
test2.func2
# sp-cache-invalidate
SELECT pkg_r_emb.fp();
pkg_r_emb.fp()
test2.proc2
# sp-cache-invalidate
CALL pkg_r_emb.pf();
func2()
test2.func2
# sp-cache-invalidate
CALL pkg_r_emb.pp();
a
test2.proc2
SELECT pkg_r_emb.ff();
pkg_r_emb.ff()
test2.func2
SELECT pkg_r_emb.fp();
pkg_r_emb.fp()
test2.proc2
CALL pkg_r_emb.pf();
func2()
test2.func2
CALL pkg_r_emb.pp();
a
test2.proc2
# sp-cache-invalidate
SELECT pkg_emb.ff();
pkg_emb.ff()
test2.func2
# sp-cache-invalidate
SELECT pkg_emb.fp();
pkg_emb.fp()
test2.proc2
# sp-cache-invalidate
CALL pkg_emb.pf();
func2()
test2.func2
# sp-cache-invalidate
CALL pkg_emb.pp();
a
test2.proc2
SELECT pkg_emb.ff();
pkg_emb.ff()
test2.func2
SELECT pkg_emb.fp();
pkg_emb.fp()
test2.proc2
CALL pkg_emb.pf();
func2()
test2.func2
CALL pkg_emb.pp();
a
test2.proc2

# PACKAGE's ROUTINE PATH overrides PACKAGE PATHs

SELECT pkg_emb_r_emb.ff();
pkg_emb_r_emb.ff()
test2.func2
SELECT pkg_emb_r_emb.fp();
pkg_emb_r_emb.fp()
test2.proc2
CALL pkg_emb_r_emb.pf();
func2()
test2.func2
CALL pkg_emb_r_emb.pp();
a
test2.proc2

# Inner sp-block within PACKAGE routine uses the PACKAGE's PATH

SELECT pkg_emb_inner_block.ff();
pkg_emb_inner_block.ff()
test2.func2
SELECT pkg_emb_inner_block.fp();
pkg_emb_inner_block.fp()
test2.proc2
CALL pkg_emb_inner_block.pf();
func2()
test2.func2
CALL pkg_emb_inner_block.pp();
a
test2.proc2
#
# Parse error when PATH is embedded in a PACKAGE's routine
#
CREATE PACKAGE pkg_emb_parse_error
FUNCTION f1() RETURNS TEXT;
END;
$$
CREATE PACKAGE BODY pkg_emb_parse_error
FUNCTION f1() RETURNS TEXT
PATH 'test2'
  BEGIN
1;
END;
END;
$$
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '1;
END;
END' at line 5
SELECT @@session.path$$
@@session.path
`CURRENT_SCHEMA`
DROP PACKAGE pkg_emb_parse_error$$
CREATE PACKAGE pkg_emb_parse_error
PROCEDURE p1();
END;
$$
CREATE PACKAGE BODY pkg_emb_parse_error
PROCEDURE p1()
PATH 'test2'
  BEGIN
1;
END;
END;
$$
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '1;
END;
END' at line 5
SELECT @@session.path$$
@@session.path
`CURRENT_SCHEMA`
DROP PACKAGE pkg_emb_parse_error$$
DROP DATABASE test2;
DROP DATABASE test3;
DROP PACKAGE pkg_r_emb;
DROP PACKAGE pkg_emb;
DROP PACKAGE pkg_emb_r_emb;
DROP PACKAGE pkg_emb_inner_block;
