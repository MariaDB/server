#
# DENY case-insensitive matching (lower_case_table_names=1)
#
CREATE USER u_deny@localhost;
CREATE DATABASE DbCase;
CREATE TABLE DbCase.T (a int);
DENY SELECT ON DbCase.T TO u_deny@localhost;
DENY INSERT, UPDATE ON dbcase.t TO u_deny@localhost;
GRANT SELECT, INSERT, UPDATE ON DbCase.T TO u_deny@localhost;
# DENY entry in mysql.global_priv should be lowercased
SELECT JSON_UNQUOTE(JSON_EXTRACT(Priv, '$.denies[0].db')) AS db,
JSON_UNQUOTE(JSON_EXTRACT(Priv, '$.denies[0].table')) AS tbl,
JSON_EXTRACT(Priv, '$.denies[0].bits') AS bits
FROM mysql.global_priv
WHERE User='u_deny' AND Host='localhost';
db	tbl	bits
dbcase	t	7
# Force mixed-case JSON to simulate migration from case-sensitive to lowercase=1
UPDATE mysql.global_priv
SET Priv=JSON_SET(Priv, '$.denies[0].db','DbCase', '$.denies[0].table','T')
WHERE User='u_deny' AND Host='localhost';
SELECT JSON_UNQUOTE(JSON_EXTRACT(Priv, '$.denies[0].db')) AS db,
JSON_UNQUOTE(JSON_EXTRACT(Priv, '$.denies[0].table')) AS tbl,
JSON_EXTRACT(Priv, '$.denies[0].bits') AS bits
FROM mysql.global_priv
WHERE User='u_deny' AND Host='localhost';
db	tbl	bits
DbCase	T	7
FLUSH PRIVILEGES;
connect  con1,localhost,u_deny,,DbCase;
SELECT * FROM T;
ERROR 42000: SELECT command denied to user 'u_deny'@'localhost' for table `dbcase`.`t`
INSERT INTO T VALUES (1);
ERROR 42000: INSERT command denied to user 'u_deny'@'localhost' for table `dbcase`.`t`
UPDATE T SET a=2 WHERE a=1;
ERROR 42000: UPDATE command denied to user 'u_deny'@'localhost' for table `dbcase`.`t`
disconnect con1;
connection default;
# SHOW GRANTS should collapse to a single deny entry
SHOW GRANTS FOR u_deny@localhost;
Grants for u_deny@localhost
DENY SELECT, INSERT, UPDATE ON `dbcase`.`t` TO `u_deny`@`localhost`
GRANT SELECT, INSERT, UPDATE ON `dbcase`.`t` TO `u_deny`@`localhost`
GRANT USAGE ON *.* TO `u_deny`@`localhost`
REVOKE DENY SELECT, INSERT, UPDATE ON DBCASE.T FROM u_deny@localhost;
# SHOW GRANTS should no longer list a DENY entry
SHOW GRANTS FOR u_deny@localhost;
Grants for u_deny@localhost
DENY SELECT, INSERT, UPDATE ON `dbcase`.`t` TO `u_deny`@`localhost`
GRANT SELECT, INSERT, UPDATE ON `dbcase`.`t` TO `u_deny`@`localhost`
GRANT USAGE ON *.* TO `u_deny`@`localhost`
DROP USER u_deny@localhost;
DROP DATABASE DbCase;
