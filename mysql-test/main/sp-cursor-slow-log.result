#
# MDEV-33830 Support for cursors on prepared statements
#
SET global log_output='TABLE';
SET log_slow_disabled_statements='';
CREATE PROCEDURE p1()
BEGIN
DECLARE c0 CURSOR FOR SELECT SLEEP(0.1);
OPEN c0;
CLOSE c0;
END;
$$
TRUNCATE mysql.slow_log;
SET long_query_time=0.01;
CALL p1;
SELECT sql_text FROM mysql.slow_log;;
sql_text	CALL p1
SET long_query_time=default;
DROP PROCEDURE p1;
TRUNCATE mysql.slow_log;
CREATE PROCEDURE p1()
BEGIN
DECLARE c0 SYS_REFCURSOR;
OPEN c0 FOR SELECT SLEEP(0.1);
CLOSE c0;
END;
$$
TRUNCATE mysql.slow_log;
SET long_query_time=0.01;
CALL p1;
SELECT sql_text FROM mysql.slow_log;;
sql_text	CALL p1
SET long_query_time=default;
DROP PROCEDURE p1;
TRUNCATE mysql.slow_log;
CREATE PROCEDURE p1()
BEGIN
DECLARE c0 CURSOR FOR stmt0;
PREPARE stmt0 FROM 'SELECT SLEEP(0.1)';
OPEN c0;
CLOSE c0;
DEALLOCATE PREPARE stmt0;
END;
$$
TRUNCATE mysql.slow_log;
SET long_query_time=0.01;
CALL p1;
SELECT sql_text FROM mysql.slow_log;;
sql_text	DEALLOCATE PREPARE stmt0
sql_text	CALL p1
SET long_query_time=default;
DROP PROCEDURE p1;
TRUNCATE mysql.slow_log;
CREATE PROCEDURE p1()
BEGIN
DECLARE c0 SYS_REFCURSOR;
OPEN c0 FOR 'SELECT SLEEP(0.1)';
CLOSE c0;
END;
$$
TRUNCATE mysql.slow_log;
SET long_query_time=0.01;
CALL p1;
SELECT sql_text FROM mysql.slow_log;;
sql_text	CALL p1
SET long_query_time=default;
DROP PROCEDURE p1;
TRUNCATE mysql.slow_log;
SET log_slow_disabled_statements=default;
SET global log_output=default;
#
# MDEV-38359 Assertion `!thd->free_list' failed in bool MYSQL_QUERY_LOG::write(THD *, time_t, const char *, size_t, ulonglong, ulonglong, bool, const char *, size_t)
#
SET GLOBAL slow_query_log=ON;
CREATE PROCEDURE p1()
BEGIN DECLARE c sys_refcursor;
OPEN c FOR SELECT SLEEP(1);
CLOSE c;
END;
$$
connect  con1,localhost,root,,;
connection con1;
SET SESSION log_slow_verbosity='explain';
SET log_slow_disabled_statements=admin;
SET long_query_time=1;
USE test;
CALL p1();
disconnect con1;
connection default;
DROP PROCEDURE p1;
