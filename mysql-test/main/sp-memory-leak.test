--echo #
--echo # MDEV-30680 Warning: Memory not freed: 280 on mangled query, LeakSanitizer: detected memory leaks
--echo #

DELIMITER $$;
--error ER_PARSE_ERROR
BEGIN NOT ATOMIC
  IF SCALAR() expected_THEN_here;
END
$$
DELIMITER ;$$


DELIMITER $$;
--error ER_PARSE_ERROR
BEGIN NOT ATOMIC
  WHILE SCALAR() expected_DO_here;
END
$$
DELIMITER ;$$


DELIMITER $$;
--error ER_PARSE_ERROR
BEGIN NOT ATOMIC
  REPEAT SELECT 1; UNTIL SCALAR() expected_END_here;
END
$$
DELIMITER ;$$


--echo #
--echo # MDEV-31578 DECLARE CURSOR: "Memory not freed: 280 bytes lost" on syntax error
--echo #

DELIMITER $$;
--error ER_PARSE_ERROR
BEGIN NOT ATOMIC
  DECLARE cur CURSOR (a INT) FOR SELECT a+1;
  OPEN cur(sp_followed_by_syntax_error();
  CLOSE cur;
END;
$$
DELIMITER ;$$

DELIMITER $$;
--error ER_PARSE_ERROR
BEGIN NOT ATOMIC
  DECLARE cur CURSOR (a INT) FOR SELECT a+1;
  OPEN cur(1,sp_followed_by_syntax_error();
  CLOSE cur;
END;
$$
DELIMITER ;$$

--echo #
--echo # MDEV-37109: Assertion in alloc_root fails when calling stored procedure with view
--echo #

create function f1() returns int
  return 42;

create view v1 as select f1();

delimiter //;

create procedure sp1()
begin
  declare a int;
  set a = (select * from v1);
end;
//

create function f2() returns int
begin
  call sp1();
  return 42;
end;
//

delimiter ;//

select f2();
call sp1();

drop view v1;
drop function f1;
drop function f2;
drop procedure sp1;

--echo # End of 10.6 tests
