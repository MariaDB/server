#
# Test DENY representation as JSON in mysql.global_priv table
#
SET @q_show_denies =
'SELECT User, Host,
          JSON_PRETTY(JSON_EXTRACT(Priv, ''$.denies'')) AS denies_pretty
   FROM mysql.global_priv
   WHERE JSON_LENGTH(JSON_EXTRACT(Priv, ''$.denies'')) > 0
   ORDER BY User, Host';
PREPARE show_denies FROM @q_show_denies;
CREATE USER u;
CREATE DATABASE d;
DENY SELECT,INSERT ON mysql.* TO u;
DENY UPDATE on d.* to u;
EXECUTE show_denies;
User	Host	denies_pretty
u	%	[
    {
        "type": "db",
        "db": "mysql",
        "deny": 3
    },
    {
        "type": "db",
        "db": "d",
        "deny": 4
    }
]
REVOKE DENY SELECT  ON mysql.* FROM u;
EXECUTE show_denies;
User	Host	denies_pretty
u	%	[
    {
        "type": "db",
        "db": "mysql",
        "deny": 2
    },
    {
        "type": "db",
        "db": "d",
        "deny": 4
    }
]
REVOKE DENY INSERT  ON mysql.* FROM u;
EXECUTE show_denies;
User	Host	denies_pretty
u	%	[
    {
        "type": "db",
        "db": "d",
        "deny": 4
    }
]
REVOKE DENY UPDATE ON d.* FROM u;
EXECUTE show_denies;
User	Host	denies_pretty
DENY SELECT,INSERT on mysql.global_priv to u;
EXECUTE show_denies;
User	Host	denies_pretty
u	%	[
    {
        "type": "table",
        "db": "mysql",
        "table": "global_priv",
        "deny": 3
    }
]
REVOKE DENY INSERT,SELECT  ON mysql.global_priv FROM u;
EXECUTE show_denies;
User	Host	denies_pretty
DENY SELECT(USER) on mysql.global_priv to u;
execute show_denies;
User	Host	denies_pretty
u	%	[
    {
        "type": "column",
        "db": "mysql",
        "table": "global_priv",
        "column": "USER",
        "deny": 1
    }
]
DENY UPDATE(user) on mysql.global_priv to u;
EXECUTE show_denies;
User	Host	denies_pretty
u	%	[
    {
        "type": "column",
        "db": "mysql",
        "table": "global_priv",
        "column": "USER",
        "deny": 5
    }
]
DENY SELECT on *.* to u;
EXECUTE show_denies;
User	Host	denies_pretty
u	%	[
    {
        "type": "column",
        "db": "mysql",
        "table": "global_priv",
        "column": "USER",
        "deny": 5
    },
    {
        "type": "global",
        "deny": 1
    }
]
DEALLOCATE PREPARE show_denies;
DROP USER u;
DROP DATABASE d;
