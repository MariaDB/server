CREATE TABLE t1 (a int, b varchar(32));
INSERT INTO t1 VALUES
(7,'ggggggg'), (1,'a'), (3,'ccc'),
(4,'dddd'), (1,'A'), (2,'BB'), (4,'DDDD'),
(5,'EEEEE'), (7,'GGGGGGG'), (2,'bb');
CREATE TABLE t1c SELECT * FROM t1;
CREATE TABLE t2 (c int);
INSERT INTO t2 VALUES 
(4), (5), (7), (1);
CREATE TABLE t2c SELECT * FROM t2;
CREATE VIEW v1 AS SELECT a, UPPER(b) FROM t1;
UPDATE t1 SET a = 1337 WHERE a=2 RETURNING * ;
a	b
1337	BB
1337	bb
SELECT * FROM t1;
a	b
7	ggggggg
1	a
3	ccc
4	dddd
1	A
1337	BB
4	DDDD
5	EEEEE
7	GGGGGGG
1337	bb
UPDATE t1 SET a = 1338 WHERE a=1337 RETURNING b;
b
BB
bb
SELECT * FROM t1;
a	b
7	ggggggg
1	a
3	ccc
4	dddd
1	A
1338	BB
4	DDDD
5	EEEEE
7	GGGGGGG
1338	bb
UPDATE t1 SET b = "AAA" WHERE a=1338 RETURNING b;
b
AAA
AAA
SELECT * FROM t1;
a	b
7	ggggggg
1	a
3	ccc
4	dddd
1	A
1338	AAA
4	DDDD
5	EEEEE
7	GGGGGGG
1338	AAA
UPDATE t1 SET b = "BBBB" WHERE a=1338 RETURNING c;
ERROR 42S22: Unknown column 'c' in 'field list'
UPDATE t1 SET b = "AaAbbB1" WHERE a=1 RETURNING a, UPPER(b), 1338-1;
a	UPPER(b)	1338-1
1	AAABBB1	1337
1	AAABBB1	1337
SELECT * FROM t1;
a	b
7	ggggggg
1	AaAbbB1
3	ccc
4	dddd
1	AaAbbB1
1338	AAA
4	DDDD
5	EEEEE
7	GGGGGGG
1338	AAA
UPDATE t1 SET a = 13 WHERE a < 0 RETURNING b;
b
SELECT * FROM t1;
a	b
7	ggggggg
1	AaAbbB1
3	ccc
4	dddd
1	AaAbbB1
1338	AAA
4	DDDD
5	EEEEE
7	GGGGGGG
1338	AAA
UPDATE t1 SET b = "BBA" WHERE a=1 RETURNING MAX(a);
ERROR HY000: Invalid use of group function
DELETE FROM t1;
INSERT INTO t1 SELECT * FROM t1c;
UPDATE t1 SET b = "LessThanFive" WHERE a < 5 RETURNING a, (SELECT MIN(c) FROM t2 WHERE c=a+1);
a	(SELECT MIN(c) FROM t2 WHERE c=a+1)
1	NULL
3	4
4	5
1	NULL
2	NULL
4	5
2	NULL
SELECT * FROM t1;
a	b
7	ggggggg
1	LessThanFive
3	LessThanFive
4	LessThanFive
1	LessThanFive
2	LessThanFive
4	LessThanFive
5	EEEEE
7	GGGGGGG
2	LessThanFive
DELETE FROM t1;
INSERT INTO t1 SELECT * FROM t1c;
UPDATE t2 SET c = 7 WHERE c < 5
RETURNING (SELECT GROUP_CONCAT(b) FROM t1 GROUP BY a HAVING a=c);
(SELECT GROUP_CONCAT(b) FROM t1 GROUP BY a HAVING a=c)
GGGGGGG,ggggggg
GGGGGGG,ggggggg
SELECT * FROM t2;
c
7
5
7
7
DELETE FROM t2;
INSERT INTO t2 SELECT * FROM t2c;
CREATE FUNCTION f(arg INT) RETURNS TEXT
BEGIN
RETURN (SELECT GROUP_CONCAT(b) FROM t1 WHERE a=arg);
END|
UPDATE t2 SET c = 7 WHERE c < 5 RETURNING f(c);
f(c)
ggggggg,GGGGGGG
ggggggg,GGGGGGG
SELECT * FROM t2;
c
7
5
7
7
DELETE FROM t2;
INSERT INTO t2 SELECT * FROM t2c;
DROP FUNCTION f;
UPDATE v1 SET a = a+1 WHERE a < 5 RETURNING *;
a	UPPER(b)
2	A
4	CCC
5	DDDD
2	A
3	BB
5	DDDD
3	BB
SELECT * FROM t1;
a	b
7	ggggggg
2	a
4	ccc
5	dddd
2	A
3	BB
5	DDDD
5	EEEEE
7	GGGGGGG
3	bb
DELETE FROM t1;
INSERT INTO t1 SELECT * FROM t1c;
CREATE VIEW v11(a,c) AS SELECT a, COUNT(b) FROM t1 GROUP BY a;
UPDATE v11 SET a = a + 1 WHERE a < 5 RETURNING * ;
ERROR HY000: The target table v11 of the UPDATE is not updatable
DROP VIEW v11;
PREPARE stmt FROM 
"UPDATE t1 SET a = 22 WHERE a=2 ORDER BY b LIMIT 1 RETURNING *, a, UPPER(b)";
EXECUTE stmt;
a	b	a	UPPER(b)
22	BB	22	BB
SELECT * FROM t1;
a	b
7	ggggggg
1	a
3	ccc
4	dddd
1	A
22	BB
4	DDDD
5	EEEEE
7	GGGGGGG
2	bb
EXECUTE stmt;
a	b	a	UPPER(b)
22	bb	22	BB
SELECT * FROM t1;
a	b
7	ggggggg
1	a
3	ccc
4	dddd
1	A
22	BB
4	DDDD
5	EEEEE
7	GGGGGGG
22	bb
EXECUTE stmt;
a	b	a	UPPER(b)
SELECT * FROM t1;
a	b
7	ggggggg
1	a
3	ccc
4	dddd
1	A
22	BB
4	DDDD
5	EEEEE
7	GGGGGGG
22	bb
DEALLOCATE PREPARE stmt;
ANALYZE UPDATE t2 SET c = 10 WHERE c < 7
RETURNING (SELECT GROUP_CONCAT(b) FROM t1 GROUP BY a HAVING a=c);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t2	ALL	NULL	NULL	NULL	NULL	4	4.00	100.00	75.00	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	10	10.00	100.00	100.00	Using filesort
SELECT * FROM t2;
c
10
10
7
10
DELETE FROM t2;
INSERT INTO t2 SELECT * FROM t2c;
EXPLAIN UPDATE t2 SET c = 10 WHERE c < 7
RETURNING (SELECT GROUP_CONCAT(b) FROM t1 GROUP BY a HAVING a=c);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t2	ALL	NULL	NULL	NULL	NULL	4	Using where
2	DEPENDENT SUBQUERY	t1	ALL	NULL	NULL	NULL	NULL	10	Using filesort
SELECT * FROM t2;
c
4
5
7
1
DELETE FROM t2;
INSERT INTO t2 SELECT * FROM t2c;
DROP VIEW v1;
DROP TABLE t1,t2;
DROP TABLE t1c,t2c;
CREATE TABLE t1 (i1 int);
INSERT INTO t1 VALUES (1),(2);
CREATE TABLE t2 (i2 int);
INSERT INTO t2 VALUES (1),(2);
UPDATE t1 set i1 = 3 ORDER BY i1 RETURNING ( SELECT i2 FROM t2 );
ERROR 21000: Subquery returns more than 1 row
DROP TABLE t1,t2;
CREATE TABLE t3 (id int, val varchar(32), PRIMARY KEY (id));
INSERT INTO t3 VALUES (1, 'a');
INSERT INTO t3 VALUES (3, 'b');
INSERT INTO t3 VALUES (4, 'c');
INSERT INTO t3 VALUES (5, 'd');
UPDATE IGNORE t3 SET id= id+1 RETURNING id;
id
2
6
SELECT * FROM t3;
id	val
2	a
3	b
4	c
6	d
UPDATE IGNORE t3 SET id= 5 RETURNING id;
id
5
UPDATE IGNORE t3 SET id= 5 RETURNING id;
id
SELECT * FROM t3;
id	val
5	a
3	b
4	c
6	d
DROP TABLE t3;
