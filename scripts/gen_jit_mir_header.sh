#!/usr/bin/env bash

# Copyright (c) 2025 MariaDB Corporation
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1335  USA */

#-------------
# This script fix mir codegen and save it to "sql_mir_code_update.h" header in C++ constexpr string_view
# Need to be used in root directory of mariadb server
#-------------

SRC="sql/sql_update_jit.c"
MIR="sql_update_jit.mir"
HDR="sql/mir_code_update.h"

if ! which c2m >/dev/null 2>&1; then
  echo "C to MIR compiler (c2m) Not found. Install it: https://github.com/vnmakarov/mir/blob/master/INSTALL.md"
  exit 1
fi

set -euo pipefail

c2m $SRC -S -o $MIR

grep -v $'^\t*export\tupdate_row_jit' "$MIR" | \
sed '1 a\
export	update_row_jit
' > "$MIR.tmp"

mv $MIR.tmp $MIR

sed -E -i.bak '
  s|^([[:space:]]*bf[[:space:]]+L[0-9]+,[[:space:]]*)([0-9]+)$|\1$\2|
' "$MIR" && rm -f "$MIR.bak"

sed -E -i.bak '
  s|(U0_updated,[[:space:]]*)i0_will_batch|\1\$5|g
' "$MIR" && rm -f "$MIR.bak"

sed -E -i.bak '
  s|(i0_error,[[:space:]]*)i0_code_err_record_is_same|\1\$9|g
' "$MIR" && rm -f "$MIR.bak"

{
  echo '// CODE GENERATED BY CODEGEN SCRIPT, DO NOT EDIT!'
  echo 'constexpr std::string_view mir_code_update_template = R"('
  cat $MIR
  echo ')";'
} > "$HDR"

rm $MIR
echo "MIR code-gen successfull"
