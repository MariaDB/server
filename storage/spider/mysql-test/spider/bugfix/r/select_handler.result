for master_1
for child2
for child3
set spider_same_server_link= 1;
CREATE SERVER srv FOREIGN DATA WRAPPER mysql
OPTIONS (SOCKET "$MASTER_1_MYSOCK", DATABASE 'test',user 'root');
# basic case
create table t2 (c int);
create table t1 (c int) ENGINE=Spider REMOTE_SERVER=srv REMOTE_TABLE=t2;
insert into t1 values (1), (2), (3);
select c from t1;
c
1
2
3
drop table t1, t2;
# join
create table t1 (c int);
create table ts1 (c int) ENGINE=Spider REMOTE_SERVER=srv REMOTE_TABLE=t1;
create table t2 (c int);
create table ts2 (c int) ENGINE=Spider REMOTE_SERVER=srv REMOTE_TABLE=t2;
insert into ts1 values (1), (2), (3);
insert into ts2 values (2), (3), (4);
## joining two spider tables goes through sh
explain select * from ts1 join ts2 on (ts1.c = ts2.c);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
select * from ts1 join ts2 on (ts1.c = ts2.c);
c	c
2	2
3	3
## joining one spider table with a nonspider table does not go
## through sh
explain select * from t1 join ts2 on (t1.c = ts2.c);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	ts2	ALL	NULL	NULL	NULL	NULL	2	
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	3	Using where; Using join buffer (flat, BNL join)
select * from t1 join ts2 on (t1.c = ts2.c);
c	c
2	2
3	3
drop table ts2, t2;
drop table ts1, t1;
# union
create table t2 (c int);
create table t1 (c int) ENGINE=Spider REMOTE_SERVER=srv REMOTE_TABLE=t2;
create table t4 (c int);
create table t3 (c int) ENGINE=Spider REMOTE_SERVER=srv REMOTE_TABLE=t4;
insert into t1 values (1), (2), (3);
insert into t3 values (4), (5), (6);
explain select c from t1 union all select c from t3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
2	UNION	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
select c from t1 union all select c from t3;
c
1
2
3
4
5
6
drop table t1, t2, t3, t4;
# single partition
create table t2 (c int);
create table t1 (c int) ENGINE=Spider REMOTE_SERVER=srv
PARTITION BY RANGE (c) (
PARTITION p VALUES LESS THAN MAXVALUE REMOTE_TABLE=t2
);
insert into t1 values (1), (2), (3);
explain
select * from t1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
select * from t1;
c
1
2
3
drop table t1, t2;
# multiple partitions
create table t3 (c int);
create table t2 (c int);
create table t1 (c int) ENGINE=Spider REMOTE_SERVER=srv
PARTITION BY RANGE (c) (
PARTITION p1 VALUES LESS THAN (3) REMOTE_TABLE=t2,
PARTITION p2 VALUES LESS THAN MAXVALUE REMOTE_TABLE=t3
);
insert into t1 values (1), (2), (3);
## single read partition: sh
explain
select * from t1 partition (p2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
select * from t1 partition (p2);
c
3
## single read partition after pruning: gbh (see also MDEV-20250)
explain
select * from t1 where c > 2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
select * from t1 where c > 2;
c
3
drop table t1, t2, t3;
#
# MDEV-37110 Spider select handler: implement one that handles
# testcases showcasing problems with the gbh
#
## SpdSkipConst: (MDEV-26345) the const item is SELECTed by
## gbh, but its results discarded when storing to the temp table
create table t2 (a int, b int, PRIMARY KEY (a, b));
create table t1 (a int, b int, PRIMARY KEY (a, b)) ENGINE=Spider
REMOTE_SERVER=srv REMOTE_TABLE=t2;
insert into t1 VALUES (1,4), (1,2), (2,11);
explain
SELECT MIN(b), a FROM t1 WHERE a=1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
SELECT MIN(b), a FROM t1 WHERE a=1;
MIN(b)	a
2	1
explain
SELECT MAX(b), a FROM t1 WHERE a<3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
SELECT MAX(b), a FROM t1 WHERE a<3;
MAX(b)	a
11	1
drop table t1, t2;
## SpdSkipConst: (MDEV-26345) the const item is SELECTed by
## gbh, but its results discarded when storing to the temp table
create table t2 (a int, b int, c int, PRIMARY KEY (a, b));
create table t1 (a int, b int, c int, PRIMARY KEY (a, b)) ENGINE=Spider
REMOTE_SERVER=srv REMOTE_TABLE=t2;
insert into t2 VALUES (1,4,1), (1,2,2), (2,11,3);
explain
SELECT MIN(b), a, c FROM t1 WHERE a=1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
SELECT MIN(b), a, c FROM t1 WHERE a=1;
MIN(b)	a	c
2	1	2
drop table t1, t2;
## SpdExtraFields: (MDEV-26345) auxiliary fields should not be
## SELECTed by gbh
create table t2 (a int, b int);
create table t1 (a int, b int) ENGINE=Spider
REMOTE_SERVER=srv REMOTE_TABLE=t2;
insert into t1 VALUES (1,1), (1,1), (2,2), (2,2);
explain
select distinct count(a) from t1 group by b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Storage engine handles GROUP BY
select distinct count(a) from t1 group by b;
count(a)
2
drop table t1, t2;
## SpdExtraFields: (MDEV-26345) having should still work with
## gbh, despite referring to auxiliary field items which are
## not SELECTed
create table t2 (c int);
create table t1 (c int) ENGINE=Spider REMOTE_SERVER=srv REMOTE_TABLE=t2;
insert into t1 values (1),(3),(5),(7),(9),(11),(13),(15);
select count(c) as d from t1 having d > 5;
d
8
drop table t1, t2;
## SpdInvalidQuery: (MDEV-33560) in predicate to subquery
## conversion. semi join and tvc in query. gbh cannot handle
## this
set @old_spider_disable_select_handler=@@spider_disable_select_handler;
set spider_disable_select_handler=0;
create table t2 (c int, d int, primary key (c));
create table t1 (c int, d int, primary key (c))
ENGINE=SPIDER REMOTE_SERVER=srv REMOTE_TABLE=t2;
insert into t2 select seq, seq from seq_1_to_100;
set in_predicate_conversion_threshold= 2;
explain select * from t1 where c in (23, 37, 55, 89);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PUSHED SELECT	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
select * from t1 where c in (23, 37, 55, 89);
c	d
23	23
37	37
55	55
89	89
## default value - ok with gbh
set in_predicate_conversion_threshold= 1000;
explain select * from t1 where c in (23, 37, 55, 89);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PUSHED SELECT	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
select * from t1 where c in (23, 37, 55, 89);
c	d
23	23
37	37
55	55
89	89
drop table t1, t2;
set spider_disable_select_handler=@old_spider_disable_select_handler;
## SpdInvalidQuery: (MDEV-26247) right join to left join with
## bad ON. gbh is not created because of the invalid query
CREATE TABLE t1 (a int);
CREATE TABLE t2 (a int);
CREATE TABLE t3 (a int);
CREATE TABLE t1s (a int) engine=spider remote_server=srv remote_table=t1;
CREATE TABLE t2s (a int) engine=spider remote_server=srv remote_table=t2;
CREATE TABLE t3s (a int) engine=spider remote_server=srv remote_table=t3;
INSERT INTO t1s VALUES (1);
INSERT INTO t2s VALUES (1), (2);
INSERT INTO t3s VALUES (1), (2), (3);
explain
select * from t1s left join t2s on t1s.a = t2s.a right join t3s on t3s.a = t1s.a;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t3s	ALL	NULL	NULL	NULL	NULL	2	
1	SIMPLE	t1s	ALL	NULL	NULL	NULL	NULL	2	Using where; Using join buffer (flat, BNL join)
1	SIMPLE	t2s	ALL	NULL	NULL	NULL	NULL	2	Using where; Using join buffer (incremental, BNL join)
select * from t1s left join t2s on t1s.a = t2s.a right join t3s on t3s.a = t1s.a;
a	a	a
1	1	1
NULL	NULL	2
NULL	NULL	3
drop table t1,t2,t3,t1s,t2s,t3s;
## SpdInvalidQuery: (MDEV-32907) gbh cannot handle this because
## the query is invalid at execution stage
create table t2 (c int);
create table t1 (c int) ENGINE=Spider REMOTE_SERVER=srv REMOTE_TABLE=t2;
insert into t1 values (3), (NULL);
explain select nvl(sum(c), 0) from t1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	2	
select nvl(sum(c), 0) from t1;
nvl(sum(c), 0)
3
drop table t1, t2;
#
# MDEV-37410 XAER_OUTSIDE in bb-main-mdev-27260
#
CREATE TABLE ti (c INT) ENGINE=InnoDB;
CREATE TABLE t1 (c INT KEY) ENGINE=Spider REMOTE_SERVER=srv REMOTE_TABLE=ti;
set @old_autocommit=@@autocommit;
set autocommit=OFF;
XA START 'a';
SELECT 1 FROM t1;
ERROR XAE08: XAER_DUPID: The XID already exists
DELETE t2.* FROM t1 t2 WHERE (SELECT 1 FROM t1);
Got one of the listed errors
xa end 'a';
xa rollback 'a';
drop table t1, ti;
set autocommit=@old_autocommit;
drop server srv;
for master_1
for child2
for child3
