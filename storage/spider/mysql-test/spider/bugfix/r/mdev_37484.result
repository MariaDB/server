#
# MDEV-37484: `Sql_cmd_dml::execute_inner`, `Sql_cmd_update::execute_inner` do not call Select handler for the engine involved
#
for master_1
for child2
for child3
set spider_same_server_link=1;
CREATE SERVER s FOREIGN DATA WRAPPER MYSQL OPTIONS (SOCKET "$MASTER_1_MYSOCK", DATABASE 'test', user 'root');
create table product_tag(product_id bigint);
create table product (
`product_id` bigint(20) DEFAULT NULL,
`price` bigint(20) DEFAULT NULL,
`short_description` varchar(7998) DEFAULT NULL,
`brand` varchar(254) DEFAULT NULL,
`modified_dtm` datetime DEFAULT NULL,
`created_dtm` datetime DEFAULT NULL,
`modified_by` int(11) DEFAULT NULL
);
insert into product_tag values (1),(2),(3),(4);
insert into product values (1,22,'fes','rets','2011-12-12 12:12:12','2011-12-13 1:1:10',343);
insert into product values (3,22,'fes','rets','2011-12-12 12:12:12','2011-12-13 1:1:10',343);
create table product_tag_spider (product_id bigint) ENGINE=SPIDER REMOTE_SERVER=s REMOTE_TABLE=product_tag;
create table product_spider (
`product_id` bigint(20) DEFAULT NULL,
`price` bigint(20) DEFAULT NULL,
`short_description` varchar(7998) DEFAULT NULL,
`brand` varchar(254) DEFAULT NULL,
`modified_dtm` datetime DEFAULT NULL,
`created_dtm` datetime DEFAULT NULL,
`modified_by` int(11) DEFAULT NULL
) ENGINE=SPIDER REMOTE_SERVER=s REMOTE_TABLE=product;
select * from product_spider order by product_id;
product_id	price	short_description	brand	modified_dtm	created_dtm	modified_by
1	22	fes	rets	2011-12-12 12:12:12	2011-12-13 01:01:10	343
3	22	fes	rets	2011-12-12 12:12:12	2011-12-13 01:01:10	343
explain update
product_spider p join
(select product_id from product_tag_spider limit 1000) t using (product_id)
set brand=p.product_id, price=555, modified_dtm='2011-12-15 15:15:30',
short_description=concat(short_description,modified_by);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	p	ALL	NULL	NULL	NULL	NULL	2	Using where with pushed condition
1	PRIMARY	<derived2>	ref	key0	key0	9	test.p.product_id	1	
2	DERIVED	product_tag_spider	ALL	NULL	NULL	NULL	NULL	4	
update
product_spider p join
(select product_id from product_tag_spider limit 1000) t using (product_id)
set brand=p.product_id, price=555, modified_dtm='2011-12-15 15:15:30',
short_description=concat(short_description,modified_by);
select * from product_spider order by product_id;
product_id	price	short_description	brand	modified_dtm	created_dtm	modified_by
1	555	fes343	1	2011-12-15 15:15:30	2011-12-13 01:01:10	343
3	555	fes343	3	2011-12-15 15:15:30	2011-12-13 01:01:10	343
drop table product, product_tag, product_spider, product_tag_spider;
create table t1 (id int);
create table t2 (id int, op varchar(10), op_count int DEFAULT 0);
insert into t1 values (1),(2),(3),(4);
insert into t2 (id, op) values (1, 'inserted'), (2, 'inserted'), (3, 'inserted'), (4, 'inserted');
CREATE TABLE t1_SPIDER (id int) ENGINE=SPIDER REMOTE_SERVER=s REMOTE_TABLE=t1;
CREATE TABLE t2_SPIDER (id int, op varchar(10), op_count int DEFAULT 0) ENGINE=SPIDER REMOTE_SERVER=s REMOTE_TABLE=t2;
select * from t2_SPIDER order by id;
id	op	op_count
1	inserted	0
2	inserted	0
3	inserted	0
4	inserted	0
# Update tests
explain update t2_SPIDER inner join t1_SPIDER on t2_SPIDER.id = t1_SPIDER.id
set t2_SPIDER.op = 'updated', t2_SPIDER.op_count = t2_SPIDER.op_count + 1
where t2_SPIDER.id in (1, 2);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t2_SPIDER	ALL	NULL	NULL	NULL	NULL	4	Using where with pushed condition
1	SIMPLE	t1_SPIDER	ALL	NULL	NULL	NULL	NULL	4	Using where
update t2_SPIDER inner join t1_SPIDER on t2_SPIDER.id = t1_SPIDER.id
set t2_SPIDER.op = 'updated', t2_SPIDER.op_count = t2_SPIDER.op_count + 1
where t2_SPIDER.id in (1, 2);
select * from t2_SPIDER order by id;
id	op	op_count
1	updated	1
2	updated	1
3	inserted	0
4	inserted	0
PREPARE stmt_update FROM
'update t2_SPIDER inner join t1_SPIDER on t2_SPIDER.id = t1_SPIDER.id set t2_SPIDER.op_count = t2_SPIDER.op_count + 1, t2_SPIDER.op="updated" where t2_SPIDER.id in (1, 2)';
EXECUTE stmt_update;
DEALLOCATE PREPARE stmt_update;
select * from t2_SPIDER order by id;
id	op	op_count
1	updated	2
2	updated	2
3	inserted	0
4	inserted	0
# Delete tests
explain
delete t2_SPIDER from t2_SPIDER inner join t1_SPIDER on t2_SPIDER.id = t1_SPIDER.id and t2_SPIDER.op = 'updated';
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t2_SPIDER	ALL	NULL	NULL	NULL	NULL	4	Using where with pushed condition
1	SIMPLE	t1_SPIDER	ALL	NULL	NULL	NULL	NULL	4	Using where
delete t2_SPIDER from t2_SPIDER inner join t1_SPIDER on t2_SPIDER.id = t1_SPIDER.id and t2_SPIDER.op = 'updated';
select * from t2_SPIDER order by id;
id	op	op_count
3	inserted	0
4	inserted	0
PREPARE stmt_delete FROM
'delete t2_SPIDER from t2_SPIDER inner join t1_SPIDER on t2_SPIDER.id = t1_SPIDER.id where t2_SPIDER.id = 3';
EXECUTE stmt_delete;
DEALLOCATE PREPARE stmt_delete;
select * from t2_SPIDER order by id;
id	op	op_count
4	inserted	0
drop table t1, t2, t1_SPIDER, t2_SPIDER;
drop server s;
for master_1
for child2
for child3
#
# end of test MDEV-37484
#
