--disable_query_log
--disable_result_log
--source ../../t/test_init.inc
--enable_result_log
--enable_query_log
set spider_same_server_link= 1;
set spider_disable_select_handler= 0;
evalp CREATE SERVER srv FOREIGN DATA WRAPPER mysql
OPTIONS (SOCKET "$MASTER_1_MYSOCK", DATABASE 'test',user 'root');

--echo # basic case
create table t2 (c int);
create table t1 (c int) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';
insert into t1 values (1), (2), (3);
select c from t1;
drop table t1, t2;

--echo # join
create table t1 (c int);
create table ts1 (c int) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t1"';
create table t2 (c int);
create table ts2 (c int) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';
insert into ts1 values (1), (2), (3);
insert into ts2 values (2), (3), (4);
--echo ## joining two spider tables goes through sh
explain select * from ts1 join ts2 on (ts1.c = ts2.c);
select * from ts1 join ts2 on (ts1.c = ts2.c);
--echo ## joining one spider table with a nonspider table does not go
--echo ## through sh
explain select * from t1 join ts2 on (t1.c = ts2.c);
select * from t1 join ts2 on (t1.c = ts2.c);
drop table ts2, t2;
drop table ts1, t1;

--echo # union
create table t2 (c int);
create table t1 (c int) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';
create table t4 (c int);
create table t3 (c int) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t4"';
insert into t1 values (1), (2), (3);
insert into t3 values (4), (5), (6);
explain select c from t1 union all select c from t3;
select c from t1 union all select c from t3;
drop table t1, t2, t3, t4;

--echo # single partition
create table t2 (c int);
create table t1 (c int) ENGINE=Spider
WRAPPER=mysql REMOTE_SERVER=srv
PARTITION BY RANGE (c) (
  PARTITION p VALUES LESS THAN MAXVALUE REMOTE_TABLE=t2
);
insert into t1 values (1), (2), (3);
explain
select * from t1;
select * from t1;
drop table t1, t2;

--echo # multiple partitions
create table t3 (c int);
create table t2 (c int);
create table t1 (c int) ENGINE=Spider
WRAPPER=mysql REMOTE_SERVER=srv
PARTITION BY RANGE (c) (
  PARTITION p1 VALUES LESS THAN (3) REMOTE_TABLE=t2,
  PARTITION p2 VALUES LESS THAN MAXVALUE REMOTE_TABLE=t3
);
insert into t1 values (1), (2), (3);
--echo ## single read partition: sh
explain
select * from t1 partition (p2);
select * from t1 partition (p2);
--echo ## single read partition after pruning: gbh (see also MDEV-20250)
explain
select * from t1 where c > 2;
select * from t1 where c > 2;
drop table t1, t2, t3;

--echo #
--echo # MDEV-37110 Spider select handler: implement one that handles
--echo # testcases showcasing problems with the gbh
--echo #

--echo ## SpdSkipConst: (MDEV-26345) the const item is SELECTed by
--echo ## gbh, but its results discarded when storing to the temp table
create table t2 (a int, b int, PRIMARY KEY (a, b));
create table t1 (a int, b int, PRIMARY KEY (a, b)) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';
insert into t1 VALUES (1,4), (1,2), (2,11);
explain
SELECT MIN(b), a FROM t1 WHERE a=1;
SELECT MIN(b), a FROM t1 WHERE a=1;
explain
SELECT MAX(b), a FROM t1 WHERE a<3;
SELECT MAX(b), a FROM t1 WHERE a<3;
drop table t1, t2;

--echo ## SpdSkipConst: (MDEV-26345) the const item is SELECTed by
--echo ## gbh, but its results discarded when storing to the temp table
create table t2 (a int, b int, c int, PRIMARY KEY (a, b));
create table t1 (a int, b int, c int, PRIMARY KEY (a, b)) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';
insert into t2 VALUES (1,4,1), (1,2,2), (2,11,3);
explain
SELECT MIN(b), a, c FROM t1 WHERE a=1;
SELECT MIN(b), a, c FROM t1 WHERE a=1;
drop table t1, t2;

--echo ## SpdExtraFields: (MDEV-26345) auxiliary fields should not be
--echo ## SELECTed by gbh
create table t2 (a int, b int);
create table t1 ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';
insert into t1 VALUES (1,1), (1,1), (2,2), (2,2);
explain
select distinct count(a) from t1 group by b;
select distinct count(a) from t1 group by b;
drop table t1, t2;

--echo ## SpdExtraFields: (MDEV-26345) having should still work with
--echo ## gbh, despite referring to auxiliary field items which are
--echo ## not SELECTed
create table t2 (c int);
create table t1 (c int) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';
insert into t1 values (1),(3),(5),(7),(9),(11),(13),(15);
select count(c) as d from t1 having d > 5;
drop table t1, t2;

--echo ## SpdInvalidQuery: (MDEV-33560) in predicate to subquery
--echo ## conversion. semi join and tvc in query. gbh cannot handle
--echo ## this
--source include/have_sequence.inc
create table t2 (c int, d int, primary key (c));
create table t1 (c int, d int, primary key (c))
ENGINE=SPIDER COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';
insert into t2 select seq, seq from seq_1_to_100;
set in_predicate_conversion_threshold= 2;
explain select * from t1 where c in (23, 37, 55, 89);
select * from t1 where c in (23, 37, 55, 89);
--echo ## default value - ok with gbh
set in_predicate_conversion_threshold= 1000;
explain select * from t1 where c in (23, 37, 55, 89);
select * from t1 where c in (23, 37, 55, 89);
drop table t1, t2;

--echo ## SpdInvalidQuery: (MDEV-26247) right join to left join with
--echo ## bad ON. gbh is not created because of the invalid query
CREATE TABLE t1 (a int);
CREATE TABLE t2 (a int);
CREATE TABLE t3 (a int);

CREATE TABLE t1s (a int) engine=spider remote_server=srv remote_table=t1;
CREATE TABLE t2s (a int) engine=spider remote_server=srv remote_table=t2;
CREATE TABLE t3s (a int) engine=spider remote_server=srv remote_table=t3;

INSERT INTO t1s VALUES (1);
INSERT INTO t2s VALUES (1), (2);
INSERT INTO t3s VALUES (1), (2), (3);

explain
select * from t1s left join t2s on t1s.a = t2s.a right join t3s on t3s.a = t1s.a;
select * from t1s left join t2s on t1s.a = t2s.a right join t3s on t3s.a = t1s.a;

drop table t1,t2,t3,t1s,t2s,t3s;

--echo ## SpdInvalidQuery: (MDEV-32907) gbh cannot handle this because
--echo ## the query is invalid at execution stage
create table t2 (c int);
create table t1 (c int) ENGINE=Spider
COMMENT='WRAPPER "mysql", srv "srv",TABLE "t2"';

insert into t1 values (3), (NULL);

explain select nvl(sum(c), 0) from t1;
select nvl(sum(c), 0) from t1;
drop table t1, t2;

--echo #
--echo # MDEV-37410 XAER_OUTSIDE in bb-main-mdev-27260
--echo #

--source include/have_innodb.inc
CREATE TABLE ti (c INT) ENGINE=InnoDB;
CREATE TABLE t1 (c INT KEY) ENGINE=Spider WRAPPER=mysql REMOTE_SERVER=srv REMOTE_TABLE=ti;
set @old_autocommit=@@autocommit;
set autocommit=OFF;
XA START 'a';
--error ER_XAER_DUPID
SELECT 1 FROM t1;
--error ER_XAER_DUPID
DELETE t2.* FROM t1 t2 WHERE (SELECT 1 FROM t1);
xa end 'a';
xa rollback 'a';
drop table t1, ti;
set autocommit=@old_autocommit;

drop server srv;
--disable_query_log
--disable_result_log
--source ../../t/test_deinit.inc
--enable_result_log
--enable_query_log
