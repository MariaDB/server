--source include/have_innodb.inc
--source hashicorp_plugin.inc

--echo #
--echo # MDEV-30847: HashiCorp Plugin: Provide cache flush for key rotation
--echo #

--exec vault secrets disable flush_test > /dev/null
--exec vault secrets enable -path /flush_test -version=2 kv > /dev/null
--exec vault kv put /flush_test/1 data="59af70fb2f9f9e0acbff9af9c81dec91" > /dev/null
--exec vault kv put /flush_test/1 data="526540c9854d26cea56a463e4ccff3ec" > /dev/null
--exec vault kv put /flush_test/2 data="32913cf9ff0afb47c9b531f218bbec48" > /dev/null
--exec vault kv put /flush_test/3 data="c675d7268a20635bb179eae5b40eb576" > /dev/null
--exec vault kv put /flush_test/2 data="dc315931aa81efc3ce085f3a2744d270" > /dev/null

--echo # restart the server with encryption
--let $vault_defaults=--plugin-load-add=hashicorp_key_management --hashicorp_key_management=force --hashicorp-key-management-check-kv-version=on --hashicorp-key-management-vault-url=$VAULT_ADDR/v1/flush_test/ --hashicorp-key-management-token=$VAULT_TOKEN
--let $innodb_defaults=--innodb-encrypt-tables=ON --innodb-encrypt-log=ON --innodb-tablespaces-encryption=ON
--let $restart_parameters=$vault_defaults $innodb_defaults
--let $restart_noprint=2
--source include/restart_mysqld.inc

CREATE TABLE t1 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
CREATE TABLE t2 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
CREATE TABLE t3 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=3;

--echo # list the encryption keys in cache and used by innodb
--sorted_result
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
SELECT * FROM INFORMATION_SCHEMA.HASHICORP_KEY_MANAGEMENT_CACHE ORDER BY KEY_ID;

SELECT NAME, CURRENT_KEY_ID, CURRENT_KEY_VERSION
FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE NAME LIKE "test%"
ORDER BY CURRENT_KEY_ID;

--echo # update keys
--exec vault kv put /flush_test/2 data="ccfd67f4adc5e0d51ecc7362bcffb4f8" > /dev/null
--exec vault kv put /flush_test/3 data="933a02ce942a2ce312e00462cd32ca04" > /dev/null
--exec vault kv put /flush_test/4 data="5215842b20fce6f96c8fe7722da5dad2" > /dev/null

--echo # flush the cache to clear out the cached keys
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;

--echo # empty cache
--sorted_result
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;

--echo # gets key-2 and key-3 to cache
CREATE TABLE t4 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
CREATE TABLE t5 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=3;

--sorted_result
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
SELECT * FROM INFORMATION_SCHEMA.HASHICORP_KEY_MANAGEMENT_CACHE ORDER BY KEY_ID;

--echo # trigger caching of all used keys along with their latest versions
SELECT NAME, CURRENT_KEY_ID, CURRENT_KEY_VERSION
FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE NAME LIKE "test%"
ORDER BY CURRENT_KEY_ID, NAME;

--sorted_result
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;

--echo # Verify privileges for FLUSH and SHOW
CREATE USER user@localhost;

--echo # Remove necessary privileges for user
GRANT ALL PRIVILEGES ON *.* TO user@localhost;
REVOKE RELOAD ON *.* FROM user@localhost;
REVOKE PROCESS ON *.* FROM user@localhost;

CONNECT conn1, localhost, user, , test;

--echo # "Access Denied" error for SHOW
--error ER_SPECIFIC_ACCESS_DENIED_ERROR
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;

SELECT * FROM INFORMATION_SCHEMA.HASHICORP_KEY_MANAGEMENT_CACHE ORDER BY KEY_ID;

--echo # "Access Denied" error for FLUSH
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
--error ER_SPECIFIC_ACCESS_DENIED_ERROR
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;

CONNECTION default;
DISCONNECT conn1;

--echo # Grant specific privileges to user
GRANT RELOAD ON *.* TO user@localhost;
GRANT PROCESS ON *.* TO user@localhost;
CONNECT conn1, localhost, user, , test;

--echo # Verify SHOW and FLUSH working
--sorted_result
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
SELECT * FROM INFORMATION_SCHEMA.HASHICORP_KEY_MANAGEMENT_CACHE ORDER BY KEY_ID;

# test for FLUSH command
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;

# Verify if FLUSH worked, expect empty result
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;

CONNECTION default;
DISCONNECT conn1;

DROP USER user@localhost;

DROP TABLE t1, t2, t3, t4, t5;

--exec vault secrets disable flush_test > /dev/null

--echo # End of 12.3 tests
