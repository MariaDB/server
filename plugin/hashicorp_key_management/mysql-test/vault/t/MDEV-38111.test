--source include/have_innodb.inc
--source hashicorp_plugin.inc

--echo #
--echo # MDEV-38111: SIGSEGV when multiple servers use the same Vault KV storage for encrypted tables
--echo #

--exec vault secrets disable flush_race_test > /dev/null
--exec vault secrets enable -path /flush_race_test -version=2 kv > /dev/null
--exec vault kv put /flush_race_test/1 data="59af70fb2f9f9e0acbff9af9c81dec91" > /dev/null
--exec vault kv put /flush_race_test/2 data="526540c9854d26cea56a463e4ccff3ec" > /dev/null

--echo # restart the server with encryption
--let $vault_defaults=--plugin-load-add=hashicorp_key_management --hashicorp_key_management=force --hashicorp-key-management-check-kv-version=on --hashicorp-key-management-vault-url=$VAULT_ADDR/v1/flush_race_test/ --hashicorp-key-management-token=$VAULT_TOKEN
--let $innodb_defaults=--innodb-encrypt-tables=ON --innodb-encrypt-log=ON --innodb-tablespaces-encryption=ON --innodb-encryption-threads=4 --innodb-encryption-rotate-key-age=1
--let $restart_parameters=$vault_defaults $innodb_defaults
--let $restart_noprint=2
--source include/restart_mysqld.inc

CREATE OR REPLACE TABLE t1 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;

--let $i = 10
while ($i > 0)
{
  CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
  FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
  CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
  DROP TABLE t3;
  CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
  FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;

  --dec $i
}

# Cleanup
DROP TABLE t1, t2, t4;

--let $tables_count= `select count(*) + @@global.innodb_undo_tablespaces + 1 from information_schema.tables where engine = 'InnoDB'`

--echo # Wait max 10 min for key encryption threads to encrypt all spaces
--let $wait_timeout= 600
--let $wait_condition=SELECT COUNT(*) >= $tables_count FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
--source include/wait_condition.inc

--exec vault secrets disable flush_race_test > /dev/null

--echo # End of 12.3 tests
