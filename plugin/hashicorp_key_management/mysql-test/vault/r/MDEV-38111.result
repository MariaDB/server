#
# MDEV-38111: SIGSEGV when multiple servers use the same Vault KV storage for encrypted tables
#
# restart the server with encryption
CREATE OR REPLACE TABLE t1 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE OR REPLACE TABLE t2 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
CREATE TABLE t3 (c1 INT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTED=NO;
DROP TABLE t3;
CREATE OR REPLACE TABLE t4 (c1 INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
DROP TABLE t1, t2, t4;
# Wait max 10 min for key encryption threads to encrypt all spaces
# End of 12.3 tests
