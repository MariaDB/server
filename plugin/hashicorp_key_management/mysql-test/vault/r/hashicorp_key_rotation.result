#
# MDEV-30847: HashiCorp Plugin: Provide cache flush for key rotation
#
# restart the server with encryption
CREATE TABLE t1 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;
CREATE TABLE t2 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
CREATE TABLE t3 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=3;
# list the encryption keys in cache and used by innodb
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
KEY_ID	KEY_VERSION
1	2
2	2
3	1
SELECT * FROM INFORMATION_SCHEMA.HASHICORP_KEY_MANAGEMENT_CACHE ORDER BY KEY_ID;
KEY_ID	KEY_VERSION
1	2
2	2
3	1
SELECT NAME, CURRENT_KEY_ID, CURRENT_KEY_VERSION
FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE NAME LIKE "test%"
ORDER BY CURRENT_KEY_ID;
NAME	CURRENT_KEY_ID	CURRENT_KEY_VERSION
test/t1	1	2
test/t2	2	2
test/t3	3	1
# update keys
# flush the cache to clear out the cached keys
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
# empty cache
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
KEY_ID	KEY_VERSION
# gets key-2 and key-3 to cache
CREATE TABLE t4 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
CREATE TABLE t5 (i INT) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=3;
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
KEY_ID	KEY_VERSION
2	3
3	2
SELECT * FROM INFORMATION_SCHEMA.HASHICORP_KEY_MANAGEMENT_CACHE ORDER BY KEY_ID;
KEY_ID	KEY_VERSION
2	3
3	2
# trigger caching of all used keys along with their latest versions
SELECT NAME, CURRENT_KEY_ID, CURRENT_KEY_VERSION
FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE NAME LIKE "test%"
ORDER BY CURRENT_KEY_ID;
NAME	CURRENT_KEY_ID	CURRENT_KEY_VERSION
test/t1	1	2
test/t4	2	3
test/t2	2	3
test/t5	3	2
test/t3	3	2
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
KEY_ID	KEY_VERSION
1	2
2	3
3	2
# Verify privileges for FLUSH and SHOW
CREATE USER user@localhost;
# Remove necessary privileges for user
GRANT ALL PRIVILEGES ON *.* TO user@localhost;
REVOKE RELOAD ON *.* FROM user@localhost;
REVOKE PROCESS ON *.* FROM user@localhost;
CONNECT conn1, localhost, user, , test;
# "Access Denied" error for SHOW
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
ERROR 42000: Access denied; you need (at least one of) the PROCESS privilege(s) for this operation
SELECT * FROM INFORMATION_SCHEMA.HASHICORP_KEY_MANAGEMENT_CACHE ORDER BY KEY_ID;
KEY_ID	KEY_VERSION
# "Access Denied" error for FLUSH
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
ERROR 42000: Access denied; you need (at least one of) the RELOAD privilege(s) for this operation
connection default;
disconnect conn1;
# Grant specific privileges to user
GRANT RELOAD ON *.* TO user@localhost;
GRANT PROCESS ON *.* TO user@localhost;
CONNECT conn1, localhost, user, , test;
# Verify SHOW and FLUSH working
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
KEY_ID	KEY_VERSION
1	2
2	3
3	2
SELECT * FROM INFORMATION_SCHEMA.HASHICORP_KEY_MANAGEMENT_CACHE ORDER BY KEY_ID;
KEY_ID	KEY_VERSION
1	2
2	3
3	2
FLUSH HASHICORP_KEY_MANAGEMENT_CACHE;
SHOW HASHICORP_KEY_MANAGEMENT_CACHE;
KEY_ID	KEY_VERSION
connection default;
disconnect conn1;
DROP USER user@localhost;
DROP TABLE t1, t2, t3, t4, t5;
# End of 12.3 tests
