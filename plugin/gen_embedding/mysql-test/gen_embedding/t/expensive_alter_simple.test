source include/have_gen_embedding.inc;

--replace_result $OPENAI_PORT OPENAI_PORT
eval set generate_embedding_openai_host="http://127.0.0.1:$OPENAI_PORT/success";

drop table if exists exp_test_new;
create table exp_test_new (
    doc text,
    embedding vector(1536) as (generate_embedding_openai(doc, "text-embedding-ada-002")) stored
) engine=MyISAM;

let $expensive_calls_begin= `$get_expensive_calls`;
insert into exp_test_new (doc) values ("abc");
let $expensive_calls= `$get_expensive_calls`;
let $res= `select $expensive_calls - $expensive_calls_begin`;
echo $res;

alter table exp_test_new add x int;
let $expensive_calls= `$get_expensive_calls`;
let $res= `select $expensive_calls - $expensive_calls_begin`;
echo $res;
select doc, x, embedding is null from exp_test_new;

drop table exp_test_new;