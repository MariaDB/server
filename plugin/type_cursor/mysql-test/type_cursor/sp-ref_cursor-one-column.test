SET sql_mode=ORACLE;

--echo #
--echo # MDEV-10152 Add support for TYPE .. IS REF CURSOR
--echo #


--echo ################### RECORD + XXX

# RECORD + SCALAR
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  v0 INT;
BEGIN
  OPEN c0 FOR SELECT 10;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;


# RECORD + SCALAR(col%TYPE)
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  v0 t1.a%TYPE;
BEGIN
  OPEN c0 FOR SELECT a FROM t1;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# RECORD + RECORD
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  r0 rec0_t;
BEGIN
  OPEN c0 FOR SELECT 10;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;


# RECORD + RECORD(col%TYPE)
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT);
  TYPE rec1_t IS RECORD (a t1.a%TYPE);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  r0 rec1_t;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# RECORD + table%ROWTYPE
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  r0 t1%ROWTYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# RECORD + cursor%ROWTYPE
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  CURSOR c1 IS SELECT * FROM t1;
  c0 cur0_t;
  r0 c1%ROWTYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


--echo ################### RECORD(col%TYPE) + XXX

# RECORD(col%TYPE) + SCALAR
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a t1.a%TYPE);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  v0 INT;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# RECORD(col%TYPE) + SCALAR(col%TYPE)
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a t1.a%TYPE);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  v0 t1.a%TYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# RECORD(col%TYPE) + RECORD
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a t1.a%TYPE);
  TYPE rec1_t IS RECORD (a INT);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  r0 rec1_t;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;

# RECORD(col%TYPE) + RECORD(col%TYPE)
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a t1.a%TYPE);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  v0 t1.a%TYPE;
BEGIN
  OPEN c0 FOR SELECT 10;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;

# RECORD(col%TYPE) + table%ROWTYPE
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a t1.a%TYPE);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
  r0 t1%ROWTYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# RECORD(col%TYPE) + cursor%ROWTYPE
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a t1.a%TYPE);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  CURSOR c1 IS SELECT * FROM t1;
  c0 cur0_t;
  r0 c1%ROWTYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


--echo ################### table%ROWTYPE + XXX

# table%ROWTYPE + SCALAR
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE cur0_t IS REF CURSOR RETURN t1%ROWTYPE;
  c0 cur0_t;
  v0 INT;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# table%ROWTYPE + SCALAR(col%TYPE)
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE cur0_t IS REF CURSOR RETURN t1%ROWTYPE;
  c0 cur0_t;
  v0 t1.a%TYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# table%ROWTYPE + RECORD
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE rec1_t IS RECORD (a INT);
  TYPE cur0_t IS REF CURSOR RETURN t1%ROWTYPE;
  c0 cur0_t;
  r0 rec1_t;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;

# table%ROWTYPE + RECORD(col%TYPE)
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE cur0_t IS REF CURSOR RETURN t1%ROWTYPE;
  c0 cur0_t;
  v0 t1.a%TYPE;
BEGIN
  OPEN c0 FOR SELECT 10;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;

# table%ROWTYPE + table%ROWTYPE
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE cur0_t IS REF CURSOR RETURN t1%ROWTYPE;
  c0 cur0_t;
  r0 t1%ROWTYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# table%ROWTYPE + cursor%ROWTYPE
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  TYPE cur0_t IS REF CURSOR RETURN t1%ROWTYPE;
  CURSOR c1 IS SELECT * FROM t1;
  c0 cur0_t;
  r0 c1%ROWTYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


--echo ################### cursor%ROWTYPE + XXX

# cursor%ROWYPE + SCALAR
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  CURSOR c1 IS SELECT * FROM t1;
  TYPE cur0_t IS REF CURSOR RETURN c1%ROWTYPE;
  c0 cur0_t;
  v0 INT;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# cursor%ROWYPE + SCALAR(col%TYPE)
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  CURSOR c1 IS SELECT * FROM t1;
  TYPE cur0_t IS REF CURSOR RETURN c1%ROWTYPE;
  c0 cur0_t;
  v0 t1.a%TYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# cursor%ROWYPE + RECORD
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  CURSOR c1 IS SELECT * FROM t1;
  TYPE rec1_t IS RECORD (a INT);
  TYPE cur0_t IS REF CURSOR RETURN c1%ROWTYPE;
  c0 cur0_t;
  r0 rec1_t;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;

# cursor%ROWYPE + RECORD(col%TYPE)
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  CURSOR c1 IS SELECT * FROM t1;
  TYPE cur0_t IS REF CURSOR RETURN c1%ROWTYPE;
  c0 cur0_t;
  v0 t1.a%TYPE;
BEGIN
  OPEN c0 FOR SELECT 10;
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;

# cursor%ROWYPE + table%ROWTYPE
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  CURSOR c1 IS SELECT * FROM t1;
  TYPE cur0_t IS REF CURSOR RETURN c1%ROWTYPE;
  c0 cur0_t;
  r0 t1%ROWTYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;


# cursor%ROWYPE + cursor%ROWTYPE
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (10);
DELIMITER $$;
CREATE PROCEDURE p1 IS
  CURSOR c1 IS SELECT * FROM t1;
  TYPE cur0_t IS REF CURSOR RETURN c1%ROWTYPE;
  c0 cur0_t;
  r0 c1%ROWTYPE;
BEGIN
  OPEN c0 FOR SELECT * FROM t1;
  FETCH c0 INTO r0;
  CLOSE c0;
  SELECT r0.a;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
DROP TABLE t1;
