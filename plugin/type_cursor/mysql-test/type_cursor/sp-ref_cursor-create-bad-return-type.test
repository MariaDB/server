# Unexpected data types in the RETURN clause

SET sql_mode=ORACLE;

--echo #
--echo # MDEV-10152 Add support for TYPE .. IS REF CURSOR
--echo #

DELIMITER $$;
--error ER_PARSE_ERROR
CREATE PROCEDURE p1 IS
  TYPE cur_t IS REF CURSOR RETURN INT;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


DELIMITER $$;
--error ER_PARSE_ERROR
CREATE PROCEDURE p1 IS
  TYPE cur_t IS REF CURSOR RETURN ROW(a INT, b VARCHAR(10));
BEGIN
  NULL;
END;
$$
DELIMITER ;$$

DELIMITER $$;
--error ER_UNKNOWN_DATA_TYPE
CREATE PROCEDURE p1 IS
  TYPE cur_t IS REF CURSOR RETURN unknown_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


#
# Make sure SYS_REFCURSOR or REF CURSOR cannot be used
# inside another REF CURSOR
#

DELIMITER $$;
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE PROCEDURE p1 AS
  TYPE rec0_t IS RECORD (a INT, b SYS_REFCURSOR);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$

DELIMITER $$;
--error ER_UNKNOWN_DATA_TYPE
CREATE PROCEDURE p1 AS
  TYPE cur0_t IS REF CURSOR;
  TYPE rec0_t IS RECORD (a INT, b cur0_t); -- This fails: unknown type cur0_t
  TYPE cur1_t IS REF CURSOR RETURN rec0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$

DELIMITER $$;
--error ER_UNKNOWN_DATA_TYPE
CREATE PROCEDURE p1 AS
  TYPE rec0_t IS RECORD (a INT, b VARCHAR(2));
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  TYPE rec1_t IS RECORD (a INT, b cur0_t); -- This fails: unknown type cur0_t
  TYPE cur1_t IS REF CURSOR RETURN rec1_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


# REF CURSOR cannot return REF CURSOR

DELIMITER $$;
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT, b VARCHAR(10));
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  TYPE cur1_t IS REF CURSOR RETURN cur0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


# REF CURSOR cannot return assoc array

DELIMITER $$;
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE PROCEDURE p1 IS
  TYPE assoc_t IS TABLE OF INT INDEX BY INT;
  TYPE cur_t IS REF CURSOR RETURN assoc_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


# REF CURSOR cannot be inside a RECORD

DELIMITER $$;
--error ER_UNKNOWN_DATA_TYPE
CREATE OR REPLACE PROCEDURE p1 IS
  TYPE assoc0_t IS TABLE OF INT INDEX BY INT;
  TYPE rec0_t IS RECORD (a INT, b assoc0_t);
  -- The error happens on the above line
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


# SYS_REFCURSOR cannot be a member in a RECORD

DELIMITER $$;
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT, b SYS_REFCURSOR);
  TYPE cur0_t IS REF CURSOR RETURN rec0_t;
  c0 cur0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


# Using %TYPE

DELIMITER $$;
--error ER_SP_UNDECLARED_VAR
CREATE PROCEDURE p1 IS
  TYPE cur0_t IS REF CURSOR RETURN v0%TYPE;
  c0 cur0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


DELIMITER $$;
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE PROCEDURE p1 IS
  v0 INT;
  TYPE cur0_t IS REF CURSOR RETURN v0%TYPE;
  c0 cur0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


DELIMITER $$;
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE OR REPLACE PROCEDURE p1 IS
  TYPE rec0_t IS RECORD (a INT, b SYS_REFCURSOR);
  r0 rec0_t;
  TYPE cur0_t IS REF CURSOR RETURN r0%TYPE;
  c0 cur0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$


DELIMITER $$;
--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE OR REPLACE PROCEDURE p1 IS
  r0 ROW (a INT, b SYS_REFCURSOR);
  TYPE cur0_t IS REF CURSOR RETURN r0%TYPE;
  c0 cur0_t;
BEGIN
  NULL;
END;
$$
DELIMITER ;$$
