SET sql_mode=ORACLE;


CREATE TABLE t1 (a INT, b VARCHAR(10));
DELIMITER $$;
CREATE PROCEDURE p1 AS
BEGIN
  PREPARE stmt FROM 'INSERT INTO t1 VALUES (:a,:b)';
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':a', 0);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':b', 'b00');
  EXECUTE stmt;
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':a', 1);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':b', 'b01');
  EXECUTE stmt;
END;
$$
DELIMITER ;$$
CALL p1;
SELECT * FROM t1;
DROP PROCEDURE p1;
DROP TABLE t1;


# The same parameter can be set more than one time
# If a parameter is not set, an error is raised

CREATE TABLE t1 (a INT, b VARCHAR(10));
DELIMITER $$;
CREATE PROCEDURE p1(do_set_b BOOL, do_execute BOOL) AS
BEGIN
  PREPARE stmt FROM 'INSERT INTO t1 VALUES (:a,:b)';
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':a', 0);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':a', 1);
  IF do_set_b THEN
    DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':b', 'b01');
  END IF;
  IF do_execute THEN
    EXECUTE stmt;
  END IF;
END;
$$
DELIMITER ;$$
CALL p1(FALSE, FALSE);
--error ER_WRONG_ARGUMENTS
CALL p1(FALSE, TRUE);
CALL p1(TRUE, TRUE);
SELECT * FROM t1;
DROP PROCEDURE p1;
DROP TABLE t1;


# Duplicate parameter name:
# - PREPARE does not fail
# - DBMS_SQL_BIND_PARAM_BY_NAME does not fail
# - EXECUTE fails

CREATE TABLE t1 (a INT, b VARCHAR(10));
DELIMITER $$;
CREATE PROCEDURE p1(do_execute BOOL) AS
BEGIN
  PREPARE stmt FROM 'INSERT INTO t1 VALUES (:a,:a)';
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':a', 0);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':a', 1); -- Sets the left :a again
  IF do_execute THEN
    EXECUTE stmt;
  END IF;
END;
$$
DELIMITER ;$$
CALL p1(FALSE);
--error ER_WRONG_ARGUMENTS
CALL p1(TRUE);
SELECT * FROM t1;
DROP PROCEDURE p1;
DROP TABLE t1;


# Parameter names can be passed to DBMS_SQL_BIND_PARAM_BY_NAME without colon
# Parameter names are case insensitive

CREATE TABLE t1 (a INT, b VARCHAR(10));
DELIMITER $$;
CREATE PROCEDURE p1 AS
BEGIN
  PREPARE stmt FROM 'INSERT INTO t1 VALUES (:a,:b)';
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':a', 0);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':b', 'b00');
  EXECUTE stmt;
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'A', 1);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'B', 'b01');
  EXECUTE stmt;
END;
$$
DELIMITER ;$$
CALL p1;
SELECT * FROM t1;
DROP PROCEDURE p1;
DROP TABLE t1;


# Parameter values set by DBMS_SQL_BIND_PARAM_BY_NAME must be preserved
# for the next execution

CREATE TABLE t1 (a INT, b VARCHAR(10), c DECIMAL(12,2));
DELIMITER $$;
CREATE OR REPLACE PROCEDURE p1 AS
BEGIN
  PREPARE stmt FROM 'INSERT INTO t1 VALUES(:a,:b,:c)';
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'a', 10);
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'b', 'b01');
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'c', 10.12);
  EXECUTE stmt;
  EXECUTE stmt;
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'a', NULL);
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'b', NULL);
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'c', NULL);
  EXECUTE stmt;
  EXECUTE stmt;
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'a', 20);
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'b', 'b02');
  SELECT DBMS_SQL_BIND_PARAM_BY_NAME('stmt', 'c', 20.12);
  EXECUTE stmt;
  EXECUTE stmt;
END;
$$
DELIMITER ;$$
CALL p1();
SELECT * FROM t1;
DROP PROCEDURE p1;
DROP TABLE t1;


DELIMITER $$;
CREATE PROCEDURE p1 AS
  v0 INT := 10;
  v1 VARCHAR(10) := 'v10';
BEGIN
  PREPARE stmt FROM 'SELECT :p0,:p1';
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':p0', v0);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':p1', v1);
  EXECUTE stmt;
  v0:= 11;
  v1:= 'v11';
  EXECUTE stmt; -- This still selects (10,'v10')
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':p0', v0);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':p1', v1);
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;


DELIMITER $$;
CREATE PROCEDURE p1 AS
  v0 TEXT;
  c0 SYS_REFCURSOR;
BEGIN
  PREPARE stmt FROM 'SELECT 123';
  OPEN c0 FOR 'PS:stmt';
  FETCH c0 INTO v0;
  CLOSE c0;
  SELECT v0;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;


DELIMITER $$;
CREATE PROCEDURE p1 AS
  c0 SYS_REFCURSOR;
BEGIN
  PREPARE stmt FROM 'SELECT :a';
  OPEN c0 FOR 'PS:stmt';
END;
$$
DELIMITER ;$$
--error ER_WRONG_ARGUMENTS
CALL p1;
DROP PROCEDURE p1;


DELIMITER $$;
CREATE PROCEDURE p1 AS
  v0 INTEGER;
  v1 TEXT;
  c0 SYS_REFCURSOR;
BEGIN
  PREPARE stmt FROM 'SELECT :p0,:p1';
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':p0', 10);
  DO DBMS_SQL_BIND_PARAM_BY_NAME('stmt', ':p1', 'p10');
  OPEN c0 FOR 'PS:stmt';
  FETCH c0 INTO v0, v1;
  CLOSE c0;
  SELECT v0, v1;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;

# DBMS_SQL_COLUMN_VALUE - bad destination argument
DELIMITER $$;
CREATE PROCEDURE p1() AS
  c0 SYS_REFCURSOR;
BEGIN
  DO DBMS_SQL_COLUMN_VALUE(c0, 1, 10/*expect a variable here*/);
END;
$$
DELIMITER ;$$
--error ER_WRONG_ARGUMENTS
CALL p1;
DROP PROCEDURE p1;


# DBMS_SQL_COLUMN_VALUE - not opened cursor
DELIMITER $$;
CREATE PROCEDURE p1() AS
  v00 INT;
  c0 SYS_REFCURSOR;
BEGIN
  DO DBMS_SQL_COLUMN_VALUE(c0, 1, v00);
  SELECT v00;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;

# DBMS_SQL_COLUMN_VALUE - COLUMN_VALUE without FETCH
# TODO: Stays on the last position???
DELIMITER $$;
CREATE PROCEDURE p1() AS
  v00 INT;
  V10 VARCHAR(10);
  c0 SYS_REFCURSOR;
BEGIN
  OPEN c0 FOR SELECT 0,'s0' UNION SELECT 1,'s1';
  DO DBMS_SQL_COLUMN_VALUE(c0, 1, v00);
  DO DBMS_SQL_COLUMN_VALUE(c0, 2, v10);
  SELECT v00, v10;
END;
$$
DELIMITER ;$$
CALL p1();
DROP PROCEDURE p1;


# DBMS_SQL_COLUMN_VALUE - bad and good column positions
DELIMITER $$;
CREATE PROCEDURE p1(col1 INT, col2 INT) AS
  v00_dummy INT;
  v10_dummy VARCHAR(10);
  v00 INT;
  V10 VARCHAR(10);
  c0 SYS_REFCURSOR;
BEGIN
  OPEN c0 FOR SELECT 0,'s0' UNION SELECT 1,'s1';
  FETCH c0 INTO v00_dummy,v10_dummy;
  FETCH c0 INTO v00_dummy,v10_dummy;
  DO DBMS_SQL_COLUMN_VALUE(c0, col1, v00);
  DO DBMS_SQL_COLUMN_VALUE(c0, col2, v10);
  SELECT v00, v10;
END;
$$
DELIMITER ;$$
CALL p1(NULL,NULL);
CALL p1(0,1);
CALL p1(-1,0);
CALL p1(1,3);
CALL p1(1,2);
DROP PROCEDURE p1;


# FETCH + SYS_REFCURSOR

DELIMITER $$;
CREATE PROCEDURE p1 AS
  v00 INT;
  V10 VARCHAR(10);
  c0 SYS_REFCURSOR;
BEGIN
  OPEN c0 FOR SELECT 0,'s0' UNION SELECT 1,'s1';
  FETCH c0;
  SELECT DBMS_SQL_COLUMN_VALUE(c0,1,v00);
  SELECT DBMS_SQL_COLUMN_VALUE(c0,2,v10);
  SELECT v00, v10, c0%FOUND;

  FETCH c0;
  SELECT DBMS_SQL_COLUMN_VALUE(c0,1,v00);
  SELECT DBMS_SQL_COLUMN_VALUE(c0,2,v10);
  SELECT v00, v10, c0%FOUND;

  FETCH c0;
  SELECT DBMS_SQL_COLUMN_VALUE(c0,1,v00);
  SELECT DBMS_SQL_COLUMN_VALUE(c0,2,v10);
  SELECT v00, v10, c0%FOUND;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;


# FETCH + static cursor

DELIMITER $$;
CREATE PROCEDURE p1 AS
  v00 INT;
  V10 VARCHAR(10);
  CURSOR c0 IS SELECT 0,'s0' UNION SELECT 1,'s1';
BEGIN
  OPEN c0;
  FETCH c0;
  FETCH c0 INTO v00, v10;
  SELECT v00, v10, c0%FOUND;

  FETCH c0 INTO v00, v10;
  SELECT v00, v10, c0%FOUND;
END;
$$
DELIMITER ;$$
CALL p1;
DROP PROCEDURE p1;
